var fe=Object.defineProperty;var he=(D,y,F)=>y in D?fe(D,y,{enumerable:!0,configurable:!0,writable:!0,value:F}):D[y]=F;var ae=(D,y,F)=>(he(D,typeof y!="symbol"?y+"":y,F),F);(function(){const y=document.createElement("link").relList;if(y&&y.supports&&y.supports("modulepreload"))return;for(const O of document.querySelectorAll('link[rel="modulepreload"]'))R(O);new MutationObserver(O=>{for(const U of O)if(U.type==="childList")for(const K of U.addedNodes)K.tagName==="LINK"&&K.rel==="modulepreload"&&R(K)}).observe(document,{childList:!0,subtree:!0});function F(O){const U={};return O.integrity&&(U.integrity=O.integrity),O.referrerpolicy&&(U.referrerPolicy=O.referrerpolicy),O.crossorigin==="use-credentials"?U.credentials="include":O.crossorigin==="anonymous"?U.credentials="omit":U.credentials="same-origin",U}function R(O){if(O.ep)return;O.ep=!0;const U=F(O);fetch(O.href,U)}})();let OPTIONS={};function setOptions(D){OPTIONS=D}let FILEINFO={};function setFileInfo(D){FILEINFO=D}let editorModeData="humdrum";const editorMode=()=>editorModeData,setEditorMode=D=>{if(!["humdrum","xml","musedata"].includes(D)){console.log("Invalid editor mode");return}return editorModeData=D,editorModeData};window.Range=function(){console.log("Range is undefined")};const global_verovioOptions={GOTOTOPOFNOTATION:!1,SCALE:40,SPACING_STAFF:12,SPACING_SYSTEM:18,LYRIC_SIZE:4.5,FONT:"Leland",BREAKS:!1,ZOOM:.4},global_editorOptions={INPUT_FONT_SIZE:1,EditorLine:-1,TABSIZE:12,EDITINGID:null,SAVEFILENAME:"data.txt",SPACINGADJUSTMENT:0},global_cursor={HIGHLIGHTQUERY:null,CursorNote:null,RestoreCursorNote:""};window.global_cursor=global_cursor;const global_playerOptions={PLAY:!1,PAUSE:!1},global_interface={InputVisible:!1,LastInputWidth:0,OriginalClef:!1,UndoHide:!1,ApplyZoom:!1,ShowingIndex:!1,FreezeRendering:!1};window.AKey="KeyA";window.BKey="KeyB";window.CKey="KeyC";window.DKey="KeyD";window.EKey="KeyE";window.FKey="KeyF";window.GKey="KeyG";window.HKey="KeyH";window.IKey="KeyI";window.JKey="KeyJ";window.KKey="KeyK";window.LKey="KeyL";window.MKey="KeyM";window.NKey="KeyN";window.OKey="KeyO";window.PKey="KeyP";window.QKey="KeyQ";window.RKey="KeyR";window.SKey="KeyS";window.TKey="KeyT";window.UKey="KeyU";window.VKey="KeyV";window.WKey="KeyW";window.XKey="KeyX";window.YKey="KeyY";window.ZKey="KeyZ";window.ZeroKey="Digit0";window.OneKey="Digit1";window.TwoKey="Digit2";window.ThreeKey="Digit3";window.FourKey="Digit4";window.FiveKey="Digit5";window.SixKey="Digit6";window.SevenKey="Digit7";window.EightKey="Digit8";window.NineKey="Digit9";window.BackKey="Backspace";window.BackQuoteKey="Backquote";window.BackSlashKey="Backslash";window.CommaKey="Comma";window.DeleteKey="Delete";window.DotKey="Period";window.EnterKey="Enter";window.EscKey="Escape";window.MinusKey="Minus";window.SemiColonKey="Semicolon";window.SingleQuoteKey="Quote";window.SlashKey="Slash";window.SpaceKey="Space";window.TabKey="Tab";window.BracketLeftKey="BracketLeft";window.BracketRightKey="BracketRight";window.EqualKey="Equal";window.ControlLeftKey="ControlLeft";window.ControlRightKey="ControlRight";window.ShiftLeftKey="ShiftLeft";window.ShiftRightKey="ShiftRight";window.LeftKey="ArrowLeft";window.UpKey="ArrowUp";window.RightKey="ArrowRight";window.DownKey="ArrowDown";window.PgUpKey="PageUp";window.PgDnKey="PageDown";window.EndKey="End";window.HomeKey="Home";window.F1Key="F1";window.F2Key="F2";window.F3Key="F3";window.F4Key="F4";window.F5Key="F5";window.F6Key="F6";window.F7Key="F7";window.F8Key="F8";window.F9Key="F9";window.F10Key="F10";window.F11Key="F11";window.F12Key="F12";window.TEMPO=200;function SPLITTER(){return this.mouseState=0,this.positionX=null,this.leftContent=null,this.splitContent=null,this.splitWidth=5,this.minXPos=100,this.maxXPos=2e3,this.rightPadding=10,this.defaultPos=400,this.snapTolerance=30,this}SPLITTER.prototype.setPositionX=function(D){D<this.defaultPos+this.snapTolerance&&D>this.defaultPos-this.snapTolerance&&(D=this.defaultPos),D<0&&(D=0),D>this.maxXPos&&(D=this.maxXPos),this.positionX=D,this.leftContent||(this.leftContent=document.querySelector("#input")),this.splitContent||(this.splitContent=document.querySelector("#splitter")),this.rightContent||(this.rightContent=document.querySelector("#output")),this.leftContent&&(this.leftContent.style.left=0,this.leftContent.style.width=D+"px"),this.splitContent&&(this.splitContent.style.left=D+"px")};const splitter=new SPLITTER;let editor$6,configureAce=!0;function getAceEditor(){return editor$6||setupAceEditor("input"),editor$6}function setupAceEditor(D){editor$6=ace.edit(D),window.EDITOR=editor$6,editor$6.on("ready",()=>{configureAce||setEditorModeAndKeyboard()});let y="/apprepository/vhvWs/scripts/ace";ace.config.set("basePath",y),ace.config.set("modePath",y),ace.config.set("workerPath",y),ace.config.set("themePath",y),configureAce&&(configureAceEditor(),configureAce=!1)}function configureAceEditor(){editor$6.getSession().setUseWorker(!0),editor$6.$blockScrolling=1/0,editor$6.setAutoScrollEditorIntoView(!0),editor$6.setBehavioursEnabled(!1),editor$6.commands.removeCommand("fold",!0),editor$6.commands.removeCommand("unfold",!0),editor$6.getSession().setTabSize(global_editorOptions.TABSIZE),editor$6.getSession().setUseSoftTabs(!1),editor$6.getSession().setNewLineMode("unix"),editor$6.setShowPrintMargin(!1),window.Range=ace.require("ace/range").Range,editor$6.renderer.$cursorLayer.smoothBlinking=!0,editor$6.renderer.$cursorLayer.setBlinking(!0),editor$6.renderer.setOption("minLines",50),editor$6.renderer.setOption("hScrollBarAlwaysVisible",!0),editor$6.renderer.setOption("vScrollBarAlwaysVisible",!0);var D=document.querySelector(".ace_content .ace_cursor-layer");D&&(CURSOR_OBSERVER=new MutationObserver(customCursor),CURSOR_OBSERVER.observe(D,{attributes:!0})),editor$6.setTheme("ace/theme/humdrum_light")}var CURSOR_OBSERVER,CURSOR_DISPLAY;function customCursor(){let D=document.activeElement.nodeName,y=editor$6.renderer.$cursorLayer.cursor,F=null;for(let R=0;R<y.classList.length;R++){if(y.classList[R]=="blurred"){F="blurred";break}if(y.classList[R]=="focused"){F="focused";break}}D==="TEXTAREA"?F!="focused"&&(CURSOR_DISPLAY||(CURSOR_DISPLAY=!0),y.classList.add("focused"),y.classList.remove("blurred"),editor$6.renderer.$cursorLayer.setBlinking(!0),editor$6.renderer.$cursorLayer.showCursor()):CURSOR_DISPLAY&&F!="blurred"&&(y.classList.add("blurred"),y.classList.remove("focused"),editor$6.renderer.$cursorLayer.showCursor(),editor$6.renderer.$cursorLayer.setBlinking(!0))}function setupSplitter(){var D=document.querySelector("#splitter");!D||(splitter.leftContent||(splitter.leftContent=document.querySelector("#input")),splitter.splitContent||(splitter.splitContent=document.querySelector("#splitter")),splitter.rightContent||(splitter.rightContent=document.querySelector("#output")),D.addEventListener("mousedown",function(y){splitter.mouseState=1,splitter.leftContent||(splitter.leftContent=document.querySelector("#input")),splitter.splitContent||(splitter.splitContent=document.querySelector("#splitter")),splitter.rightContent||(splitter.rightContent=document.querySelector("#output")),splitter.setPositionX(y.pageX)}),window.addEventListener("mouseup",function(y){splitter.mouseState!=0&&(splitter.mouseState=0,editor$6.resize(),displayNotation())}),window.addEventListener("mousemove",function(y){if(splitter.mouseState){var F=splitter.minXPos;if(y.pageX<F){y.pageX<F-70&&(splitter.setPositionX(0),global_interface.InputVisible=!1);return}splitter.setPositionX(y.pageX),global_interface.InputVisible=!0}}))}function getReferenceRecords(D){var y=D.split(/\r?\n/),F={},R;for(let X=y.length-1;X>=0;X--){if(R=y[X].match(/^\!\!\!([^\s]+):\s*(.*)\s*$/)){var O=R[1],U=R[2];F[O]=U,(R=O.match(/(.*)@@(.*)/))&&(F[R[1]]=U),(R=O.match(/(.*)@(.*)/))&&(F[R[1]]=U)}(R=y[X].match(/^\!?\!\!title:\s*(.*)\s*/))&&(F.title=R[1])}(!F.title||F.title.match(/^\s*$/))&&(F.title=FILEINFO["title-expansion"]);var K=0,B="",G="",q;if(F.title&&!F.title.match(/^\s*$/)){for(var W=F.title;(R=W.match(/@\{([^\}]*)\}/))&&(B="",G="",O="",(R=W.match(/@\{([^\}]*)\}\{([^\}]*)\}\{([^\}]*)\}/))?(B=R[1],O=R[2],G=R[3],W=W.replace(/@\{([^\}]*)\}\{([^\}]*)\}\{([^\}]*)\}/,"ZZZZZ")):(R=W.match(/@\{([^\}]*)\}\{([^\}]*)\}/))?(B=R[1],O=R[2],G="",W=W.replace(/@\{([^\}]*)\}\{([^\}]*)\}/,"ZZZZZ")):(R=W.match(/@\{([^\}]*)\}/))&&(B="",O=R[1],G="",W=W.replace(/@\{([^\}]*)\}/,"ZZZZZ")),!(!O||O.match(/^\s*$/)||(F[O]?q=B+F[O]+G:q="",W=W.replace(/ZZZZZ/,q),K++,K>20))););F.title=W}return F}function getStaffCount(D){for(var y=0,F=D.split(/\r?\n/),R=0;R<F.length;R++)if(!!F[R].match(/^\*\*/)){for(var O=F[R].split(/\t+/),U=0,K=0,B=0;B<O.length;B++)O[B]==="**kern"?U++:O[B]==="**mens"&&K++;K>0&&(U=0),y=K+U;break}return y}function diatonicToHumdrum(D){D=parseInt(D);var y=parseInt(D/7),F=D%7,R="x";F==0?R="c":F==1?R="d":F==2?R="e":F==3?R="f":F==4?R="g":F==5?R="a":F==6&&(R="b");var O,U,K="";if(y<4)for(R=R.toUpperCase(),U=4-y,O=0;O<U;O++)K+=R;else for(U=y-3,O=0;O<U;O++)K+=R;return K}function humdrumToDiatonic(D){var y=D.length,F=0,R=D.charAt(0),O=R.toLowerCase();R===O?F=3+y:F=4-y;var U=0;return O==="d"?U=1:O==="e"?U=2:O==="f"?U=3:O==="g"?U=4:O==="a"?U=5:O==="b"&&(U=6),7*F+U}function transposeDiatonic(D,y){var F=D.length;if(y=parseInt(y),F==0)return"";var R=humdrumToDiatonic(D);return R+=y,R<1||R>=70?D:diatonicToHumdrum(R)}function getFieldAndSubtoken(D,y){var F={field:-1,subspine:-1};if(D.match(/^[*!=]/)||D=="")return F;var R=0,O=0,U;for(U=0;U<y;U++)U>0&&D[U]=="	"&&D[U-1]!="	"?(R++,O=0):D[U]==" "&&O++;var K=!1;if(O>0)K=!0;else for(U=y;U<D.length;U++)if(D[U]==" "){K=!0;break}else if(D[U]=="	")break;return K&&O++,R++,F.field=R,F.subspine=O,F}const editor$5=getAceEditor();if(!editor$5)throw new Error("Ace Editor is undefined");function insertMarkedNoteRdf(){var D=20,y="",F,R,O=getAceEditor().session.getLength();for(R=O-1;R>=0&&!(O-R>D);R--){var U=editor$5.session.getLine(R);if((F=U.match(/^!!!RDF\*\*kern:\s+([^\s])\s*=.*mark.*\s+note/))&&(y=F[1]),y!=="")break}if(y==="")for(R=0;R<O&&!(R>D||(U=editor$5.session.getLine(R),(F=U.match(/^\!\!\!RDF\*\*kern:\s+([^\s])\s*=.*mark.*\s+note/))&&(y=F[1]),y!==""));R++);if(y!=="")return y;var K="";y===""?(K+="!!!RDF**kern: @ = marked note",y="@"):K+="!!!RDF**kern: "+y+" = marked note";var B=global_interface.FreezeRendering;return global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0),editor$5.session.insert({row:editor$5.session.getLength(),column:0},`
`+K),global_interface.FreezeRendering=B,y}function insertDirectionRdfs(){var D=20,y="",F="",R,O,U=editor$5.session.getLength();for(O=U-1;O>=0&&!(U-O>D);O--){var K=editor$5.session.getLine(O);if((R=K.match(/^!!!RDF\*\*kern:\s+([^\s])\s*=.*above/))?y=R[1]:(R=K.match(/^!!!RDF\*\*kern:\s+([^\s])\s*=.*below/))&&(F=R[1]),y!==""&&F!=="")break}if(y===""||F==="")for(O=0;O<U&&!(O>D||(K=editor$5.session.getLine(O),(R=K.match(/^\!\!\!RDF\*\*kern:\s+([^\s])\s*=.*above/))?y=R[1]:(R=K.match(/^\!\!\!RDF\*\*kern:\s+([^\s])\s*=.*below/))&&(F=R[1]),y!==""&&F!==""));O++);if(y!==""&&F!=="")return[y,F];var B="";y===""?(B+=`!!!RDF**kern: > = above
`,y=">"):B+="!!!RDF**kern: "+y+` = above
`,F===""?(B+="!!!RDF**kern: < = below",F="<"):B+="!!!RDF**kern: "+F+" = below";var G=global_interface.FreezeRendering;return global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0),editor$5.session.insert({row:editor$5.session.getLength(),column:0},`
`+B),global_interface.FreezeRendering=G,[y,F]}function insertEditorialAccidentalRdf(){var D=20,y="",F,R,O=editor$5.session.getLength();for(R=O-1;R>=0&&!(O-R>D);R--){var U=editor$5.session.getLine(R);if((F=U.match(/^!!!RDF\*\*kern:\s+([^\s])\s*=.*edit.*\s+acc/))&&(y=F[1]),y!=="")break}if(y==="")for(R=0;R<O&&!(R>D||(U=editor$5.session.getLine(R),(F=U.match(/^\!\!\!RDF\*\*kern:\s+([^\s])\s*=.*edit.*\s+acc/))&&(y=F[1]),y!==""));R++);if(y!=="")return y;var K="";y===""?(K+=`!!!RDF**kern: i = editorial accidental
`,y="i"):K+="!!!RDF**kern: "+y+` = editorial accidental
`;var B=global_interface.FreezeRendering;return global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0),editor$5.session.insert({row:editor$5.session.getLength(),column:0},`
`+K),global_interface.FreezeRendering=B,y}const scriptRel="modulepreload",assetsURL=function(D){return"/apprepository/vhvWs/"+D},seen={},__vitePreload=function(y,F,R){return!F||F.length===0?y():Promise.all(F.map(O=>{if(O=assetsURL(O),O in seen)return;seen[O]=!0;const U=O.endsWith(".css"),K=U?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${O}"]${K}`))return;const B=document.createElement("link");if(B.rel=U?"stylesheet":scriptRel,U||(B.as="script",B.crossOrigin=""),B.href=O,document.head.appendChild(B),U)return new Promise((G,q)=>{B.addEventListener("load",G),B.addEventListener("error",()=>q(new Error(`Unable to preload CSS for ${O}`)))})})).then(()=>y())},score=!0,collaboration=!0,videoConference=!0,soundEditor=!0,actions$1=!0,CONFIG={score,collaboration,videoConference,soundEditor,actions:actions$1},create$4=()=>new Map,copy=D=>{const y=create$4();return D.forEach((F,R)=>{y.set(R,F)}),y},setIfUndefined=(D,y,F)=>{let R=D.get(y);return R===void 0&&D.set(y,R=F()),R},map$1=(D,y)=>{const F=[];for(const[R,O]of D)F.push(y(O,R));return F},any=(D,y)=>{for(const[F,R]of D)if(y(R,F))return!0;return!1},create$3=()=>new Set,last=D=>D[D.length-1],appendTo=(D,y)=>{for(let F=0;F<y.length;F++)D.push(y[F])},from=Array.from;class Observable{constructor(){this._observers=create$4()}on(y,F){setIfUndefined(this._observers,y,create$3).add(F)}once(y,F){const R=(...O)=>{this.off(y,R),F(...O)};this.on(y,R)}off(y,F){const R=this._observers.get(y);R!==void 0&&(R.delete(F),R.size===0&&this._observers.delete(y))}emit(y,F){return from((this._observers.get(y)||create$4()).values()).forEach(R=>R(...F))}destroy(){this._observers=create$4()}}const floor=Math.floor,abs=Math.abs,log10=Math.log10,min=(D,y)=>D<y?D:y,max=(D,y)=>D>y?D:y,isNegativeZero=D=>D!==0?D<0:1/D<0,fromCharCode=String.fromCharCode,toLowerCase=D=>D.toLowerCase(),trimLeftRegex=/^\s*/g,trimLeft=D=>D.replace(trimLeftRegex,""),fromCamelCaseRegex=/([A-Z])/g,fromCamelCase=(D,y)=>trimLeft(D.replace(fromCamelCaseRegex,F=>`${y}${toLowerCase(F)}`));typeof TextEncoder<"u"&&new TextEncoder;let utf8TextDecoder=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});utf8TextDecoder&&utf8TextDecoder.decode(new Uint8Array).length===1&&(utf8TextDecoder=null);const undefinedToNull=D=>D===void 0?null:D;class VarStoragePolyfill{constructor(){this.map=new Map}setItem(y,F){this.map.set(y,F)}getItem(y){return this.map.get(y)}}let _localStorage=new VarStoragePolyfill,usePolyfill=!0;try{typeof localStorage<"u"&&(_localStorage=localStorage,usePolyfill=!1)}catch{}const varStorage=_localStorage,onChange=D=>usePolyfill||addEventListener("storage",D),isNode=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name),isBrowser=typeof window<"u"&&!isNode;typeof navigator<"u"&&/Mac/.test(navigator.platform);let params;const computeParams=()=>{if(params===void 0)if(isNode){params=create$4();const D=process.argv;let y=null;for(let F=0;F<D.length;F++){const R=D[F];R[0]==="-"?(y!==null&&params.set(y,""),y=R):y!==null&&(params.set(y,R),y=null)}y!==null&&params.set(y,"")}else typeof location=="object"?(params=create$4(),(location.search||"?").slice(1).split("&").forEach(D=>{if(D.length!==0){const[y,F]=D.split("=");params.set(`--${fromCamelCase(y,"-")}`,F),params.set(`-${fromCamelCase(y,"-")}`,F)}})):params=create$4();return params},hasParam=D=>computeParams().has(D),getVariable=D=>undefinedToNull(isNode?process.env[D.toUpperCase()]:varStorage.getItem(D)),hasConf=D=>hasParam("--"+D)||getVariable(D)!==null;hasConf("production");const BIT1=1,BIT2=2,BIT3=4,BIT4=8,BIT6=32,BIT7=64,BIT8=128,BITS5=31,BITS6=63,BITS7=127,BITS31=2147483647;class Decoder{constructor(y){this.arr=y,this.pos=0}}const createDecoder=D=>new Decoder(D),hasContent=D=>D.pos!==D.arr.length,readUint8Array=(D,y)=>{const F=createUint8ArrayViewFromArrayBuffer(D.arr.buffer,D.pos+D.arr.byteOffset,y);return D.pos+=y,F},readVarUint8Array=D=>readUint8Array(D,readVarUint(D)),readUint8=D=>D.arr[D.pos++],readVarUint=D=>{let y=0,F=0;for(;;){const R=D.arr[D.pos++];if(y=y|(R&BITS7)<<F,F+=7,R<BIT8)return y>>>0;if(F>35)throw new Error("Integer out of range!")}},readVarInt=D=>{let y=D.arr[D.pos++],F=y&BITS6,R=6;const O=(y&BIT7)>0?-1:1;if((y&BIT8)===0)return O*F;for(;;){if(y=D.arr[D.pos++],F=F|(y&BITS7)<<R,R+=7,y<BIT8)return O*(F>>>0);if(R>41)throw new Error("Integer out of range!")}},readVarString=D=>{let y=readVarUint(D);if(y===0)return"";{let F=String.fromCodePoint(readUint8(D));if(--y<100)for(;y--;)F+=String.fromCodePoint(readUint8(D));else for(;y>0;){const R=y<1e4?y:1e4,O=D.arr.subarray(D.pos,D.pos+R);D.pos+=R,F+=String.fromCodePoint.apply(null,O),y-=R}return decodeURIComponent(escape(F))}},readFromDataView=(D,y)=>{const F=new DataView(D.arr.buffer,D.arr.byteOffset+D.pos,y);return D.pos+=y,F},readFloat32=D=>readFromDataView(D,4).getFloat32(0,!1),readFloat64=D=>readFromDataView(D,8).getFloat64(0,!1),readBigInt64=D=>readFromDataView(D,8).getBigInt64(0,!1),readAnyLookupTable=[D=>{},D=>null,readVarInt,readFloat32,readFloat64,readBigInt64,D=>!1,D=>!0,readVarString,D=>{const y=readVarUint(D),F={};for(let R=0;R<y;R++){const O=readVarString(D);F[O]=readAny(D)}return F},D=>{const y=readVarUint(D),F=[];for(let R=0;R<y;R++)F.push(readAny(D));return F},readVarUint8Array],readAny=D=>readAnyLookupTable[127-readUint8(D)](D);class RleDecoder extends Decoder{constructor(y,F){super(y),this.reader=F,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),hasContent(this)?this.count=readVarUint(this)+1:this.count=-1),this.count--,this.s}}class UintOptRleDecoder extends Decoder{constructor(y){super(y),this.s=0,this.count=0}read(){if(this.count===0){this.s=readVarInt(this);const y=isNegativeZero(this.s);this.count=1,y&&(this.s=-this.s,this.count=readVarUint(this)+2)}return this.count--,this.s}}class IntDiffOptRleDecoder extends Decoder{constructor(y){super(y),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const y=readVarInt(this),F=y&1;this.diff=y>>1,this.count=1,F&&(this.count=readVarUint(this)+2)}return this.s+=this.diff,this.count--,this.s}}class StringDecoder{constructor(y){this.decoder=new UintOptRleDecoder(y),this.str=readVarString(this.decoder),this.spos=0}read(){const y=this.spos+this.decoder.read(),F=this.str.slice(this.spos,y);return this.spos=y,F}}const createUint8ArrayFromLen=D=>new Uint8Array(D),createUint8ArrayViewFromArrayBuffer=(D,y,F)=>new Uint8Array(D,y,F),createUint8ArrayFromArrayBuffer=D=>new Uint8Array(D),toBase64Browser=D=>{let y="";for(let F=0;F<D.byteLength;F++)y+=fromCharCode(D[F]);return btoa(y)},toBase64Node=D=>Buffer.from(D.buffer,D.byteOffset,D.byteLength).toString("base64"),fromBase64Browser=D=>{const y=atob(D),F=createUint8ArrayFromLen(y.length);for(let R=0;R<y.length;R++)F[R]=y.charCodeAt(R);return F},fromBase64Node=D=>{const y=Buffer.from(D,"base64");return new Uint8Array(y.buffer,y.byteOffset,y.byteLength)},toBase64=isBrowser?toBase64Browser:toBase64Node,fromBase64=isBrowser?fromBase64Browser:fromBase64Node,copyUint8Array=D=>{const y=createUint8ArrayFromLen(D.byteLength);return y.set(D),y},isInteger=Number.isInteger||(D=>typeof D=="number"&&isFinite(D)&&floor(D)===D);class Encoder{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const createEncoder=()=>new Encoder,length$1=D=>{let y=D.cpos;for(let F=0;F<D.bufs.length;F++)y+=D.bufs[F].length;return y},toUint8Array=D=>{const y=new Uint8Array(length$1(D));let F=0;for(let R=0;R<D.bufs.length;R++){const O=D.bufs[R];y.set(O,F),F+=O.length}return y.set(createUint8ArrayViewFromArrayBuffer(D.cbuf.buffer,0,D.cpos),F),y},verifyLen=(D,y)=>{const F=D.cbuf.length;F-D.cpos<y&&(D.bufs.push(createUint8ArrayViewFromArrayBuffer(D.cbuf.buffer,0,D.cpos)),D.cbuf=new Uint8Array(max(F,y)*2),D.cpos=0)},write=(D,y)=>{const F=D.cbuf.length;D.cpos===F&&(D.bufs.push(D.cbuf),D.cbuf=new Uint8Array(F*2),D.cpos=0),D.cbuf[D.cpos++]=y},writeUint8=write,writeVarUint=(D,y)=>{for(;y>BITS7;)write(D,BIT8|BITS7&y),y>>>=7;write(D,BITS7&y)},writeVarInt=(D,y)=>{const F=isNegativeZero(y);for(F&&(y=-y),write(D,(y>BITS6?BIT8:0)|(F?BIT7:0)|BITS6&y),y>>>=6;y>0;)write(D,(y>BITS7?BIT8:0)|BITS7&y),y>>>=7},writeVarString=(D,y)=>{const F=unescape(encodeURIComponent(y)),R=F.length;writeVarUint(D,R);for(let O=0;O<R;O++)write(D,F.codePointAt(O))},writeBinaryEncoder=(D,y)=>writeUint8Array(D,toUint8Array(y)),writeUint8Array=(D,y)=>{const F=D.cbuf.length,R=D.cpos,O=min(F-R,y.length),U=y.length-O;D.cbuf.set(y.subarray(0,O),R),D.cpos+=O,U>0&&(D.bufs.push(D.cbuf),D.cbuf=new Uint8Array(max(F*2,U)),D.cbuf.set(y.subarray(O)),D.cpos=U)},writeVarUint8Array=(D,y)=>{writeVarUint(D,y.byteLength),writeUint8Array(D,y)},writeOnDataView=(D,y)=>{verifyLen(D,y);const F=new DataView(D.cbuf.buffer,D.cpos,y);return D.cpos+=y,F},writeFloat32=(D,y)=>writeOnDataView(D,4).setFloat32(0,y,!1),writeFloat64=(D,y)=>writeOnDataView(D,8).setFloat64(0,y,!1),writeBigInt64=(D,y)=>writeOnDataView(D,8).setBigInt64(0,y,!1),floatTestBed=new DataView(new ArrayBuffer(4)),isFloat32=D=>(floatTestBed.setFloat32(0,D),floatTestBed.getFloat32(0)===D),writeAny=(D,y)=>{switch(typeof y){case"string":write(D,119),writeVarString(D,y);break;case"number":isInteger(y)&&y<=BITS31?(write(D,125),writeVarInt(D,y)):isFloat32(y)?(write(D,124),writeFloat32(D,y)):(write(D,123),writeFloat64(D,y));break;case"bigint":write(D,122),writeBigInt64(D,y);break;case"object":if(y===null)write(D,126);else if(y instanceof Array){write(D,117),writeVarUint(D,y.length);for(let F=0;F<y.length;F++)writeAny(D,y[F])}else if(y instanceof Uint8Array)write(D,116),writeVarUint8Array(D,y);else{write(D,118);const F=Object.keys(y);writeVarUint(D,F.length);for(let R=0;R<F.length;R++){const O=F[R];writeVarString(D,O),writeAny(D,y[O])}}break;case"boolean":write(D,y?120:121);break;default:write(D,127)}};class RleEncoder extends Encoder{constructor(y){super(),this.w=y,this.s=null,this.count=0}write(y){this.s===y?this.count++:(this.count>0&&writeVarUint(this,this.count-1),this.count=1,this.w(this,y),this.s=y)}}const flushUintOptRleEncoder=D=>{D.count>0&&(writeVarInt(D.encoder,D.count===1?D.s:-D.s),D.count>1&&writeVarUint(D.encoder,D.count-2))};class UintOptRleEncoder{constructor(){this.encoder=new Encoder,this.s=0,this.count=0}write(y){this.s===y?this.count++:(flushUintOptRleEncoder(this),this.count=1,this.s=y)}toUint8Array(){return flushUintOptRleEncoder(this),toUint8Array(this.encoder)}}const flushIntDiffOptRleEncoder=D=>{if(D.count>0){const y=D.diff<<1|(D.count===1?0:1);writeVarInt(D.encoder,y),D.count>1&&writeVarUint(D.encoder,D.count-2)}};class IntDiffOptRleEncoder{constructor(){this.encoder=new Encoder,this.s=0,this.count=0,this.diff=0}write(y){this.diff===y-this.s?(this.s=y,this.count++):(flushIntDiffOptRleEncoder(this),this.count=1,this.diff=y-this.s,this.s=y)}toUint8Array(){return flushIntDiffOptRleEncoder(this),toUint8Array(this.encoder)}}class StringEncoder{constructor(){this.sarr=[],this.s="",this.lensE=new UintOptRleEncoder}write(y){this.s+=y,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(y.length)}toUint8Array(){const y=new Encoder;return this.sarr.push(this.s),this.s="",writeVarString(y,this.sarr.join("")),writeUint8Array(y,this.lensE.toUint8Array()),toUint8Array(y)}}const isoCrypto=typeof crypto>"u"?null:crypto,cryptoRandomBuffer=isoCrypto!==null?D=>{const y=new ArrayBuffer(D),F=new Uint8Array(y);return isoCrypto.getRandomValues(F),y}:D=>{const y=new ArrayBuffer(D),F=new Uint8Array(y);for(let R=0;R<D;R++)F[R]=Math.ceil(Math.random()*4294967295>>>0);return y},uint32=()=>new Uint32Array(cryptoRandomBuffer(4))[0],uuidv4Template=[1e7]+-1e3+-4e3+-8e3+-1e11,uuidv4=()=>uuidv4Template.replace(/[018]/g,D=>(D^uint32()&15>>D/4).toString(16)),create$2=D=>new Error(D),methodUnimplemented=()=>{throw create$2("Method unimplemented")},unexpectedCase=()=>{throw create$2("Unexpected case")},keys=Object.keys,map=(D,y)=>{const F=[];for(const R in D)F.push(y(D[R],R));return F},length=D=>keys(D).length,every=(D,y)=>{for(const F in D)if(!y(D[F],F))return!1;return!0},hasProperty=(D,y)=>Object.prototype.hasOwnProperty.call(D,y),equalFlat=(D,y)=>D===y||length(D)===length(y)&&every(D,(F,R)=>(F!==void 0||hasProperty(y,R))&&y[R]===F),callAll=(D,y,F=0)=>{try{for(;F<D.length;F++)D[F](...y)}finally{F<D.length&&callAll(D,y,F+1)}},equalityStrict=(D,y)=>D===y,equalityDeep=(D,y)=>{if(D==null||y==null)return equalityStrict(D,y);if(D.constructor!==y.constructor)return!1;if(D===y)return!0;switch(D.constructor){case ArrayBuffer:D=new Uint8Array(D),y=new Uint8Array(y);case Uint8Array:{if(D.byteLength!==y.byteLength)return!1;for(let F=0;F<D.length;F++)if(D[F]!==y[F])return!1;break}case Set:{if(D.size!==y.size)return!1;for(const F of D)if(!y.has(F))return!1;break}case Map:{if(D.size!==y.size)return!1;for(const F of D.keys())if(!y.has(F)||!equalityDeep(D.get(F),y.get(F)))return!1;break}case Object:if(length(D)!==length(y))return!1;for(const F in D)if(!hasProperty(D,F)||!equalityDeep(D[F],y[F]))return!1;break;case Array:if(D.length!==y.length)return!1;for(let F=0;F<D.length;F++)if(!equalityDeep(D[F],y[F]))return!1;break;default:return!1}return!0},create$1=Symbol;class Pair{constructor(y,F){this.left=y,this.right=F}}const create=(D,y)=>new Pair(D,y),doc=typeof document<"u"?document:{};typeof DOMParser<"u"&&new DOMParser;const mapToStyleString=D=>map$1(D,(y,F)=>`${F}:${y};`).join("");doc.ELEMENT_NODE;doc.TEXT_NODE;doc.CDATA_SECTION_NODE;doc.COMMENT_NODE;doc.DOCUMENT_NODE;doc.DOCUMENT_TYPE_NODE;doc.DOCUMENT_FRAGMENT_NODE;const getUnixTime=Date.now,BOLD=create$1(),UNBOLD=create$1(),BLUE=create$1(),GREY=create$1(),GREEN=create$1(),RED=create$1(),PURPLE=create$1(),ORANGE=create$1(),UNCOLOR=create$1(),_browserStyleMap={[BOLD]:create("font-weight","bold"),[UNBOLD]:create("font-weight","normal"),[BLUE]:create("color","blue"),[GREEN]:create("color","green"),[GREY]:create("color","grey"),[RED]:create("color","red"),[PURPLE]:create("color","purple"),[ORANGE]:create("color","orange"),[UNCOLOR]:create("color","black")},_nodeStyleMap={[BOLD]:"\x1B[1m",[UNBOLD]:"\x1B[2m",[BLUE]:"\x1B[34m",[GREEN]:"\x1B[32m",[GREY]:"\x1B[37m",[RED]:"\x1B[31m",[PURPLE]:"\x1B[35m",[ORANGE]:"\x1B[38;5;208m",[UNCOLOR]:"\x1B[0m"},computeBrowserLoggingArgs=D=>{const y=[],F=[],R=create$4();let O=[],U=0;for(;U<D.length;U++){const K=D[U],B=_browserStyleMap[K];if(B!==void 0)R.set(B.left,B.right);else if(K.constructor===String||K.constructor===Number){const G=mapToStyleString(R);U>0||G.length>0?(y.push("%c"+K),F.push(G)):y.push(K)}else break}for(U>0&&(O=F,O.unshift(y.join("")));U<D.length;U++){const K=D[U];K instanceof Symbol||O.push(K)}return O},computeNodeLoggingArgs=D=>{const y=[],F=[];let R=0;for(;R<D.length;R++){const O=D[R],U=_nodeStyleMap[O];if(U!==void 0)y.push(U);else if(O.constructor===String||O.constructor===Number)y.push(O);else break}for(R>0&&(y.push("\x1B[0m"),F.push(y.join("")));R<D.length;R++){const O=D[R];O instanceof Symbol||F.push(O)}return F},computeLoggingArgs=isNode?computeNodeLoggingArgs:computeBrowserLoggingArgs,print=(...D)=>{console.log(...computeLoggingArgs(D)),vconsoles.forEach(y=>y.print(D))},vconsoles=new Set,createIterator=D=>({[Symbol.iterator](){return this},next:D}),iteratorFilter=(D,y)=>createIterator(()=>{let F;do F=D.next();while(!F.done&&!y(F.value));return F}),iteratorMap=(D,y)=>createIterator(()=>{const{done:F,value:R}=D.next();return{done:F,value:F?void 0:y(R)}});class AbstractConnector extends Observable{constructor(y,F){super(),this.doc=y,this.awareness=F}}class DeleteItem{constructor(y,F){this.clock=y,this.len=F}}class DeleteSet{constructor(){this.clients=new Map}}const iterateDeletedStructs=(D,y,F)=>y.clients.forEach((R,O)=>{const U=D.doc.store.clients.get(O);for(let K=0;K<R.length;K++){const B=R[K];iterateStructs(D,U,B.clock,B.len,F)}}),findIndexDS=(D,y)=>{let F=0,R=D.length-1;for(;F<=R;){const O=floor((F+R)/2),U=D[O],K=U.clock;if(K<=y){if(y<K+U.len)return O;F=O+1}else R=O-1}return null},isDeleted=(D,y)=>{const F=D.clients.get(y.client);return F!==void 0&&findIndexDS(F,y.clock)!==null},sortAndMergeDeleteSet=D=>{D.clients.forEach(y=>{y.sort((O,U)=>O.clock-U.clock);let F,R;for(F=1,R=1;F<y.length;F++){const O=y[R-1],U=y[F];O.clock+O.len>=U.clock?O.len=max(O.len,U.clock+U.len-O.clock):(R<F&&(y[R]=U),R++)}y.length=R})},mergeDeleteSets=D=>{const y=new DeleteSet;for(let F=0;F<D.length;F++)D[F].clients.forEach((R,O)=>{if(!y.clients.has(O)){const U=R.slice();for(let K=F+1;K<D.length;K++)appendTo(U,D[K].clients.get(O)||[]);y.clients.set(O,U)}});return sortAndMergeDeleteSet(y),y},addToDeleteSet=(D,y,F,R)=>{setIfUndefined(D.clients,y,()=>[]).push(new DeleteItem(F,R))},createDeleteSet=()=>new DeleteSet,createDeleteSetFromStructStore=D=>{const y=createDeleteSet();return D.clients.forEach((F,R)=>{const O=[];for(let U=0;U<F.length;U++){const K=F[U];if(K.deleted){const B=K.id.clock;let G=K.length;if(U+1<F.length)for(let q=F[U+1];U+1<F.length&&q.deleted;q=F[++U+1])G+=q.length;O.push(new DeleteItem(B,G))}}O.length>0&&y.clients.set(R,O)}),y},writeDeleteSet=(D,y)=>{writeVarUint(D.restEncoder,y.clients.size),y.clients.forEach((F,R)=>{D.resetDsCurVal(),writeVarUint(D.restEncoder,R);const O=F.length;writeVarUint(D.restEncoder,O);for(let U=0;U<O;U++){const K=F[U];D.writeDsClock(K.clock),D.writeDsLen(K.len)}})},readDeleteSet=D=>{const y=new DeleteSet,F=readVarUint(D.restDecoder);for(let R=0;R<F;R++){D.resetDsCurVal();const O=readVarUint(D.restDecoder),U=readVarUint(D.restDecoder);if(U>0){const K=setIfUndefined(y.clients,O,()=>[]);for(let B=0;B<U;B++)K.push(new DeleteItem(D.readDsClock(),D.readDsLen()))}}return y},readAndApplyDeleteSet=(D,y,F)=>{const R=new DeleteSet,O=readVarUint(D.restDecoder);for(let U=0;U<O;U++){D.resetDsCurVal();const K=readVarUint(D.restDecoder),B=readVarUint(D.restDecoder),G=F.clients.get(K)||[],q=getState(F,K);for(let W=0;W<B;W++){const X=D.readDsClock(),j=X+D.readDsLen();if(X<q){q<j&&addToDeleteSet(R,K,q,j-q);let Z=findIndexSS(G,X),J=G[Z];for(!J.deleted&&J.id.clock<X&&(G.splice(Z+1,0,splitItem(y,J,X-J.id.clock)),Z++);Z<G.length&&(J=G[Z++],J.id.clock<j);)J.deleted||(j<J.id.clock+J.length&&G.splice(Z,0,splitItem(y,J,j-J.id.clock)),J.delete(y))}else addToDeleteSet(R,K,X,j-X)}}if(R.clients.size>0){const U=new UpdateEncoderV2;return writeVarUint(U.restEncoder,0),writeDeleteSet(U,R),U.toUint8Array()}return null},generateNewClientId=uint32;class Doc extends Observable{constructor({guid:y=uuidv4(),collectionid:F=null,gc:R=!0,gcFilter:O=()=>!0,meta:U=null,autoLoad:K=!1}={}){super(),this.gc=R,this.gcFilter=O,this.clientID=generateNewClientId(),this.guid=y,this.collectionid=F,this.share=new Map,this.store=new StructStore,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=K,this.autoLoad=K,this.meta=U}load(){const y=this._item;y!==null&&!this.shouldLoad&&transact(y.parent.doc,F=>{F.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(Array.from(this.subdocs).map(y=>y.guid))}transact(y,F=null){transact(this,y,F)}get(y,F=AbstractType){const R=setIfUndefined(this.share,y,()=>{const U=new F;return U._integrate(this,null),U}),O=R.constructor;if(F!==AbstractType&&O!==F)if(O===AbstractType){const U=new F;U._map=R._map,R._map.forEach(K=>{for(;K!==null;K=K.left)K.parent=U}),U._start=R._start;for(let K=U._start;K!==null;K=K.right)K.parent=U;return U._length=R._length,this.share.set(y,U),U._integrate(this,null),U}else throw new Error(`Type with the name ${y} has already been defined with a different constructor`);return R}getArray(y=""){return this.get(y,YArray)}getText(y=""){return this.get(y,YText)}getMap(y=""){return this.get(y,YMap)}getXmlFragment(y=""){return this.get(y,YXmlFragment)}toJSON(){const y={};return this.share.forEach((F,R)=>{y[R]=F.toJSON()}),y}destroy(){from(this.subdocs).forEach(F=>F.destroy());const y=this._item;if(y!==null){this._item=null;const F=y.content;y.deleted?F.doc=null:(F.doc=new Doc({guid:this.guid,...F.opts}),F.doc._item=y),transact(y.parent.doc,R=>{y.deleted||R.subdocsAdded.add(F.doc),R.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}on(y,F){super.on(y,F)}off(y,F){super.off(y,F)}}class DSDecoderV1{constructor(y){this.restDecoder=y}resetDsCurVal(){}readDsClock(){return readVarUint(this.restDecoder)}readDsLen(){return readVarUint(this.restDecoder)}}class UpdateDecoderV1 extends DSDecoderV1{readLeftID(){return createID(readVarUint(this.restDecoder),readVarUint(this.restDecoder))}readRightID(){return createID(readVarUint(this.restDecoder),readVarUint(this.restDecoder))}readClient(){return readVarUint(this.restDecoder)}readInfo(){return readUint8(this.restDecoder)}readString(){return readVarString(this.restDecoder)}readParentInfo(){return readVarUint(this.restDecoder)===1}readTypeRef(){return readVarUint(this.restDecoder)}readLen(){return readVarUint(this.restDecoder)}readAny(){return readAny(this.restDecoder)}readBuf(){return copyUint8Array(readVarUint8Array(this.restDecoder))}readJSON(){return JSON.parse(readVarString(this.restDecoder))}readKey(){return readVarString(this.restDecoder)}}class DSDecoderV2{constructor(y){this.dsCurrVal=0,this.restDecoder=y}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=readVarUint(this.restDecoder),this.dsCurrVal}readDsLen(){const y=readVarUint(this.restDecoder)+1;return this.dsCurrVal+=y,y}}class UpdateDecoderV2 extends DSDecoderV2{constructor(y){super(y),this.keys=[],readVarUint(y),this.keyClockDecoder=new IntDiffOptRleDecoder(readVarUint8Array(y)),this.clientDecoder=new UintOptRleDecoder(readVarUint8Array(y)),this.leftClockDecoder=new IntDiffOptRleDecoder(readVarUint8Array(y)),this.rightClockDecoder=new IntDiffOptRleDecoder(readVarUint8Array(y)),this.infoDecoder=new RleDecoder(readVarUint8Array(y),readUint8),this.stringDecoder=new StringDecoder(readVarUint8Array(y)),this.parentInfoDecoder=new RleDecoder(readVarUint8Array(y),readUint8),this.typeRefDecoder=new UintOptRleDecoder(readVarUint8Array(y)),this.lenDecoder=new UintOptRleDecoder(readVarUint8Array(y))}readLeftID(){return new ID(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new ID(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return readAny(this.restDecoder)}readBuf(){return readVarUint8Array(this.restDecoder)}readJSON(){return readAny(this.restDecoder)}readKey(){const y=this.keyClockDecoder.read();if(y<this.keys.length)return this.keys[y];{const F=this.stringDecoder.read();return this.keys.push(F),F}}}class DSEncoderV1{constructor(){this.restEncoder=createEncoder()}toUint8Array(){return toUint8Array(this.restEncoder)}resetDsCurVal(){}writeDsClock(y){writeVarUint(this.restEncoder,y)}writeDsLen(y){writeVarUint(this.restEncoder,y)}}class UpdateEncoderV1 extends DSEncoderV1{writeLeftID(y){writeVarUint(this.restEncoder,y.client),writeVarUint(this.restEncoder,y.clock)}writeRightID(y){writeVarUint(this.restEncoder,y.client),writeVarUint(this.restEncoder,y.clock)}writeClient(y){writeVarUint(this.restEncoder,y)}writeInfo(y){writeUint8(this.restEncoder,y)}writeString(y){writeVarString(this.restEncoder,y)}writeParentInfo(y){writeVarUint(this.restEncoder,y?1:0)}writeTypeRef(y){writeVarUint(this.restEncoder,y)}writeLen(y){writeVarUint(this.restEncoder,y)}writeAny(y){writeAny(this.restEncoder,y)}writeBuf(y){writeVarUint8Array(this.restEncoder,y)}writeJSON(y){writeVarString(this.restEncoder,JSON.stringify(y))}writeKey(y){writeVarString(this.restEncoder,y)}}class DSEncoderV2{constructor(){this.restEncoder=createEncoder(),this.dsCurrVal=0}toUint8Array(){return toUint8Array(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(y){const F=y-this.dsCurrVal;this.dsCurrVal=y,writeVarUint(this.restEncoder,F)}writeDsLen(y){y===0&&unexpectedCase(),writeVarUint(this.restEncoder,y-1),this.dsCurrVal+=y}}class UpdateEncoderV2 extends DSEncoderV2{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new IntDiffOptRleEncoder,this.clientEncoder=new UintOptRleEncoder,this.leftClockEncoder=new IntDiffOptRleEncoder,this.rightClockEncoder=new IntDiffOptRleEncoder,this.infoEncoder=new RleEncoder(writeUint8),this.stringEncoder=new StringEncoder,this.parentInfoEncoder=new RleEncoder(writeUint8),this.typeRefEncoder=new UintOptRleEncoder,this.lenEncoder=new UintOptRleEncoder}toUint8Array(){const y=createEncoder();return writeVarUint(y,0),writeVarUint8Array(y,this.keyClockEncoder.toUint8Array()),writeVarUint8Array(y,this.clientEncoder.toUint8Array()),writeVarUint8Array(y,this.leftClockEncoder.toUint8Array()),writeVarUint8Array(y,this.rightClockEncoder.toUint8Array()),writeVarUint8Array(y,toUint8Array(this.infoEncoder)),writeVarUint8Array(y,this.stringEncoder.toUint8Array()),writeVarUint8Array(y,toUint8Array(this.parentInfoEncoder)),writeVarUint8Array(y,this.typeRefEncoder.toUint8Array()),writeVarUint8Array(y,this.lenEncoder.toUint8Array()),writeUint8Array(y,toUint8Array(this.restEncoder)),toUint8Array(y)}writeLeftID(y){this.clientEncoder.write(y.client),this.leftClockEncoder.write(y.clock)}writeRightID(y){this.clientEncoder.write(y.client),this.rightClockEncoder.write(y.clock)}writeClient(y){this.clientEncoder.write(y)}writeInfo(y){this.infoEncoder.write(y)}writeString(y){this.stringEncoder.write(y)}writeParentInfo(y){this.parentInfoEncoder.write(y?1:0)}writeTypeRef(y){this.typeRefEncoder.write(y)}writeLen(y){this.lenEncoder.write(y)}writeAny(y){writeAny(this.restEncoder,y)}writeBuf(y){writeVarUint8Array(this.restEncoder,y)}writeJSON(y){writeAny(this.restEncoder,y)}writeKey(y){this.keyMap.get(y)===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(y)):this.keyClockEncoder.write(this.keyClock++)}}const writeStructs=(D,y,F,R)=>{R=max(R,y[0].id.clock);const O=findIndexSS(y,R);writeVarUint(D.restEncoder,y.length-O),D.writeClient(F),writeVarUint(D.restEncoder,R);const U=y[O];U.write(D,R-U.id.clock);for(let K=O+1;K<y.length;K++)y[K].write(D,0)},writeClientsStructs=(D,y,F)=>{const R=new Map;F.forEach((O,U)=>{getState(y,U)>O&&R.set(U,O)}),getStateVector(y).forEach((O,U)=>{F.has(U)||R.set(U,0)}),writeVarUint(D.restEncoder,R.size),Array.from(R.entries()).sort((O,U)=>U[0]-O[0]).forEach(([O,U])=>{writeStructs(D,y.clients.get(O),O,U)})},readClientsStructRefs=(D,y)=>{const F=create$4(),R=readVarUint(D.restDecoder);for(let O=0;O<R;O++){const U=readVarUint(D.restDecoder),K=new Array(U),B=D.readClient();let G=readVarUint(D.restDecoder);F.set(B,{i:0,refs:K});for(let q=0;q<U;q++){const W=D.readInfo();switch(BITS5&W){case 0:{const X=D.readLen();K[q]=new GC(createID(B,G),X),G+=X;break}case 10:{const X=readVarUint(D.restDecoder);K[q]=new Skip(createID(B,G),X),G+=X;break}default:{const X=(W&(BIT7|BIT8))===0,j=new Item(createID(B,G),null,(W&BIT8)===BIT8?D.readLeftID():null,null,(W&BIT7)===BIT7?D.readRightID():null,X?D.readParentInfo()?y.get(D.readString()):D.readLeftID():null,X&&(W&BIT6)===BIT6?D.readString():null,readItemContent(D,W));K[q]=j,G+=j.length}}}}return F},integrateStructs=(D,y,F)=>{const R=[];let O=Array.from(F.keys()).sort((Z,J)=>Z-J);if(O.length===0)return null;const U=()=>{if(O.length===0)return null;let Z=F.get(O[O.length-1]);for(;Z.refs.length===Z.i;)if(O.pop(),O.length>0)Z=F.get(O[O.length-1]);else return null;return Z};let K=U();if(K===null&&R.length===0)return null;const B=new StructStore,G=new Map,q=(Z,J)=>{const Q=G.get(Z);(Q==null||Q>J)&&G.set(Z,J)};let W=K.refs[K.i++];const X=new Map,j=()=>{for(const Z of R){const J=Z.id.client,Q=F.get(J);Q?(Q.i--,B.clients.set(J,Q.refs.slice(Q.i)),F.delete(J),Q.i=0,Q.refs=[]):B.clients.set(J,[Z]),O=O.filter(ee=>ee!==J)}R.length=0};for(;;){if(W.constructor!==Skip){const J=setIfUndefined(X,W.id.client,()=>getState(y,W.id.client))-W.id.clock;if(J<0)R.push(W),q(W.id.client,W.id.clock-1),j();else{const Q=W.getMissing(D,y);if(Q!==null){R.push(W);const ee=F.get(Q)||{refs:[],i:0};if(ee.refs.length===ee.i)q(Q,getState(y,Q)),j();else{W=ee.refs[ee.i++];continue}}else(J===0||J<W.length)&&(W.integrate(D,J),X.set(W.id.client,W.id.clock+W.length))}}if(R.length>0)W=R.pop();else if(K!==null&&K.i<K.refs.length)W=K.refs[K.i++];else{if(K=U(),K===null)break;W=K.refs[K.i++]}}if(B.clients.size>0){const Z=new UpdateEncoderV2;return writeClientsStructs(Z,B,new Map),writeVarUint(Z.restEncoder,0),{missing:G,update:Z.toUint8Array()}}return null},writeStructsFromTransaction=(D,y)=>writeClientsStructs(D,y.doc.store,y.beforeState),readUpdateV2=(D,y,F,R=new UpdateDecoderV2(D))=>transact(y,O=>{O.local=!1;let U=!1;const K=O.doc,B=K.store,G=readClientsStructRefs(R,K),q=integrateStructs(O,B,G),W=B.pendingStructs;if(W){for(const[j,Z]of W.missing)if(Z<getState(B,j)){U=!0;break}if(q){for(const[j,Z]of q.missing){const J=W.missing.get(j);(J==null||J>Z)&&W.missing.set(j,Z)}W.update=mergeUpdatesV2([W.update,q.update])}}else B.pendingStructs=q;const X=readAndApplyDeleteSet(R,O,B);if(B.pendingDs){const j=new UpdateDecoderV2(createDecoder(B.pendingDs));readVarUint(j.restDecoder);const Z=readAndApplyDeleteSet(j,O,B);X&&Z?B.pendingDs=mergeUpdatesV2([X,Z]):B.pendingDs=X||Z}else B.pendingDs=X;if(U){const j=B.pendingStructs.update;B.pendingStructs=null,applyUpdateV2(O.doc,j)}},F,!1),readUpdate$1=(D,y,F)=>readUpdateV2(D,y,F,new UpdateDecoderV1(D)),applyUpdateV2=(D,y,F,R=UpdateDecoderV2)=>{const O=createDecoder(y);readUpdateV2(O,D,F,new R(O))},applyUpdate=(D,y,F)=>applyUpdateV2(D,y,F,UpdateDecoderV1),writeStateAsUpdate=(D,y,F=new Map)=>{writeClientsStructs(D,y.store,F),writeDeleteSet(D,createDeleteSetFromStructStore(y.store))},encodeStateAsUpdateV2=(D,y=new Uint8Array([0]),F=new UpdateEncoderV2)=>{const R=decodeStateVector(y);writeStateAsUpdate(F,D,R);const O=[F.toUint8Array()];if(D.store.pendingDs&&O.push(D.store.pendingDs),D.store.pendingStructs&&O.push(diffUpdateV2(D.store.pendingStructs.update,y)),O.length>1){if(F.constructor===UpdateEncoderV1)return mergeUpdates(O.map((U,K)=>K===0?U:convertUpdateFormatV2ToV1(U)));if(F.constructor===UpdateEncoderV2)return mergeUpdatesV2(O)}return O[0]},encodeStateAsUpdate=(D,y)=>encodeStateAsUpdateV2(D,y,new UpdateEncoderV1),readStateVector=D=>{const y=new Map,F=readVarUint(D.restDecoder);for(let R=0;R<F;R++){const O=readVarUint(D.restDecoder),U=readVarUint(D.restDecoder);y.set(O,U)}return y},decodeStateVector=D=>readStateVector(new DSDecoderV1(createDecoder(D))),writeStateVector=(D,y)=>(writeVarUint(D.restEncoder,y.size),y.forEach((F,R)=>{writeVarUint(D.restEncoder,R),writeVarUint(D.restEncoder,F)}),D),writeDocumentStateVector=(D,y)=>writeStateVector(D,getStateVector(y.store)),encodeStateVectorV2=(D,y=new DSEncoderV2)=>(D instanceof Map?writeStateVector(y,D):writeDocumentStateVector(y,D),y.toUint8Array()),encodeStateVector=D=>encodeStateVectorV2(D,new DSEncoderV1);class EventHandler{constructor(){this.l=[]}}const createEventHandler=()=>new EventHandler,addEventHandlerListener=(D,y)=>D.l.push(y),removeEventHandlerListener=(D,y)=>{const F=D.l,R=F.length;D.l=F.filter(O=>y!==O),R===D.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},callEventHandlerListeners=(D,y,F)=>callAll(D.l,[y,F]);class ID{constructor(y,F){this.client=y,this.clock=F}}const compareIDs=(D,y)=>D===y||D!==null&&y!==null&&D.client===y.client&&D.clock===y.clock,createID=(D,y)=>new ID(D,y),writeID=(D,y)=>{writeVarUint(D,y.client),writeVarUint(D,y.clock)},readID=D=>createID(readVarUint(D),readVarUint(D)),findRootTypeKey=D=>{for(const[y,F]of D.doc.share.entries())if(F===D)return y;throw unexpectedCase()},isParentOf=(D,y)=>{for(;y!==null;){if(y.parent===D)return!0;y=y.parent._item}return!1},logType=D=>{const y=[];let F=D._start;for(;F;)y.push(F),F=F.right;console.log("Children: ",y),console.log("Children content: ",y.filter(R=>!R.deleted).map(R=>R.content))};class PermanentUserData{constructor(y,F=y.getMap("users")){const R=new Map;this.yusers=F,this.doc=y,this.clients=new Map,this.dss=R;const O=(U,K)=>{const B=U.get("ds"),G=U.get("ids"),q=W=>this.clients.set(W,K);B.observe(W=>{W.changes.added.forEach(X=>{X.content.getContent().forEach(j=>{j instanceof Uint8Array&&this.dss.set(K,mergeDeleteSets([this.dss.get(K)||createDeleteSet(),readDeleteSet(new DSDecoderV1(createDecoder(j)))]))})})}),this.dss.set(K,mergeDeleteSets(B.map(W=>readDeleteSet(new DSDecoderV1(createDecoder(W)))))),G.observe(W=>W.changes.added.forEach(X=>X.content.getContent().forEach(q))),G.forEach(q)};F.observe(U=>{U.keysChanged.forEach(K=>O(F.get(K),K))}),F.forEach(O)}setUserMapping(y,F,R,{filter:O=()=>!0}={}){const U=this.yusers;let K=U.get(R);K||(K=new YMap,K.set("ids",new YArray),K.set("ds",new YArray),U.set(R,K)),K.get("ids").push([F]),U.observe(B=>{setTimeout(()=>{const G=U.get(R);if(G!==K){K=G,this.clients.forEach((X,j)=>{R===X&&K.get("ids").push([j])});const q=new DSEncoderV1,W=this.dss.get(R);W&&(writeDeleteSet(q,W),K.get("ds").push([q.toUint8Array()]))}},0)}),y.on("afterTransaction",B=>{setTimeout(()=>{const G=K.get("ds"),q=B.deleteSet;if(B.local&&q.clients.size>0&&O(B,q)){const W=new DSEncoderV1;writeDeleteSet(W,q),G.push([W.toUint8Array()])}})})}getUserByClientId(y){return this.clients.get(y)||null}getUserByDeletedId(y){for(const[F,R]of this.dss.entries())if(isDeleted(R,y))return F;return null}}class RelativePosition{constructor(y,F,R,O=0){this.type=y,this.tname=F,this.item=R,this.assoc=O}}const relativePositionToJSON=D=>{const y={};return D.type&&(y.type=D.type),D.tname&&(y.tname=D.tname),D.item&&(y.item=D.item),D.assoc!=null&&(y.assoc=D.assoc),y},createRelativePositionFromJSON=D=>new RelativePosition(D.type==null?null:createID(D.type.client,D.type.clock),D.tname||null,D.item==null?null:createID(D.item.client,D.item.clock),D.assoc==null?0:D.assoc);class AbsolutePosition{constructor(y,F,R=0){this.type=y,this.index=F,this.assoc=R}}const createAbsolutePosition=(D,y,F=0)=>new AbsolutePosition(D,y,F),createRelativePosition=(D,y,F)=>{let R=null,O=null;return D._item===null?O=findRootTypeKey(D):R=createID(D._item.id.client,D._item.id.clock),new RelativePosition(R,O,y,F)},createRelativePositionFromTypeIndex=(D,y,F=0)=>{let R=D._start;if(F<0){if(y===0)return createRelativePosition(D,null,F);y--}for(;R!==null;){if(!R.deleted&&R.countable){if(R.length>y)return createRelativePosition(D,createID(R.id.client,R.id.clock+y),F);y-=R.length}if(R.right===null&&F<0)return createRelativePosition(D,R.lastId,F);R=R.right}return createRelativePosition(D,null,F)},writeRelativePosition=(D,y)=>{const{type:F,tname:R,item:O,assoc:U}=y;if(O!==null)writeVarUint(D,0),writeID(D,O);else if(R!==null)writeUint8(D,1),writeVarString(D,R);else if(F!==null)writeUint8(D,2),writeID(D,F);else throw unexpectedCase();return writeVarInt(D,U),D},encodeRelativePosition=D=>{const y=createEncoder();return writeRelativePosition(y,D),toUint8Array(y)},readRelativePosition=D=>{let y=null,F=null,R=null;switch(readVarUint(D)){case 0:R=readID(D);break;case 1:F=readVarString(D);break;case 2:y=readID(D)}const O=hasContent(D)?readVarInt(D):0;return new RelativePosition(y,F,R,O)},decodeRelativePosition=D=>readRelativePosition(createDecoder(D)),createAbsolutePositionFromRelativePosition=(D,y)=>{const F=y.store,R=D.item,O=D.type,U=D.tname,K=D.assoc;let B=null,G=0;if(R!==null){if(getState(F,R.client)<=R.clock)return null;const q=followRedone(F,R),W=q.item;if(!(W instanceof Item))return null;if(B=W.parent,B._item===null||!B._item.deleted){G=W.deleted||!W.countable?0:q.diff+(K>=0?0:1);let X=W.left;for(;X!==null;)!X.deleted&&X.countable&&(G+=X.length),X=X.left}}else{if(U!==null)B=y.get(U);else if(O!==null){if(getState(F,O.client)<=O.clock)return null;const{item:q}=followRedone(F,O);if(q instanceof Item&&q.content instanceof ContentType)B=q.content.type;else return null}else throw unexpectedCase();K>=0?G=B._length:G=0}return createAbsolutePosition(B,G,D.assoc)},compareRelativePositions=(D,y)=>D===y||D!==null&&y!==null&&D.tname===y.tname&&compareIDs(D.item,y.item)&&compareIDs(D.type,y.type)&&D.assoc===y.assoc;class Snapshot{constructor(y,F){this.ds=y,this.sv=F}}const equalSnapshots=(D,y)=>{const F=D.ds.clients,R=y.ds.clients,O=D.sv,U=y.sv;if(O.size!==U.size||F.size!==R.size)return!1;for(const[K,B]of O.entries())if(U.get(K)!==B)return!1;for(const[K,B]of F.entries()){const G=R.get(K)||[];if(B.length!==G.length)return!1;for(let q=0;q<B.length;q++){const W=B[q],X=G[q];if(W.clock!==X.clock||W.len!==X.len)return!1}}return!0},encodeSnapshotV2=(D,y=new DSEncoderV2)=>(writeDeleteSet(y,D.ds),writeStateVector(y,D.sv),y.toUint8Array()),encodeSnapshot=D=>encodeSnapshotV2(D,new DSEncoderV1),decodeSnapshotV2=(D,y=new DSDecoderV2(createDecoder(D)))=>new Snapshot(readDeleteSet(y),readStateVector(y)),decodeSnapshot=D=>decodeSnapshotV2(D,new DSDecoderV1(createDecoder(D))),createSnapshot=(D,y)=>new Snapshot(D,y),emptySnapshot=createSnapshot(createDeleteSet(),new Map),snapshot=D=>createSnapshot(createDeleteSetFromStructStore(D.store),getStateVector(D.store)),isVisible=(D,y)=>y===void 0?!D.deleted:y.sv.has(D.id.client)&&(y.sv.get(D.id.client)||0)>D.id.clock&&!isDeleted(y.ds,D.id),splitSnapshotAffectedStructs=(D,y)=>{const F=setIfUndefined(D.meta,splitSnapshotAffectedStructs,create$3),R=D.doc.store;F.has(y)||(y.sv.forEach((O,U)=>{O<getState(R,U)&&getItemCleanStart(D,createID(U,O))}),iterateDeletedStructs(D,y.ds,O=>{}),F.add(y))},createDocFromSnapshot=(D,y,F=new Doc)=>{if(D.gc)throw new Error("originDoc must not be garbage collected");const{sv:R,ds:O}=y,U=new UpdateEncoderV2;return D.transact(K=>{let B=0;R.forEach(G=>{G>0&&B++}),writeVarUint(U.restEncoder,B);for(const[G,q]of R){if(q===0)continue;q<getState(D.store,G)&&getItemCleanStart(K,createID(G,q));const W=D.store.clients.get(G)||[],X=findIndexSS(W,q-1);writeVarUint(U.restEncoder,X+1),U.writeClient(G),writeVarUint(U.restEncoder,0);for(let j=0;j<=X;j++)W[j].write(U,0)}writeDeleteSet(U,O)}),applyUpdateV2(F,U.toUint8Array(),"snapshot"),F};class StructStore{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const getStateVector=D=>{const y=new Map;return D.clients.forEach((F,R)=>{const O=F[F.length-1];y.set(R,O.id.clock+O.length)}),y},getState=(D,y)=>{const F=D.clients.get(y);if(F===void 0)return 0;const R=F[F.length-1];return R.id.clock+R.length},addStruct=(D,y)=>{let F=D.clients.get(y.id.client);if(F===void 0)F=[],D.clients.set(y.id.client,F);else{const R=F[F.length-1];if(R.id.clock+R.length!==y.id.clock)throw unexpectedCase()}F.push(y)},findIndexSS=(D,y)=>{let F=0,R=D.length-1,O=D[R],U=O.id.clock;if(U===y)return R;let K=floor(y/(U+O.length-1)*R);for(;F<=R;){if(O=D[K],U=O.id.clock,U<=y){if(y<U+O.length)return K;F=K+1}else R=K-1;K=floor((F+R)/2)}throw unexpectedCase()},find=(D,y)=>{const F=D.clients.get(y.client);return F[findIndexSS(F,y.clock)]},getItem=find,findIndexCleanStart=(D,y,F)=>{const R=findIndexSS(y,F),O=y[R];return O.id.clock<F&&O instanceof Item?(y.splice(R+1,0,splitItem(D,O,F-O.id.clock)),R+1):R},getItemCleanStart=(D,y)=>{const F=D.doc.store.clients.get(y.client);return F[findIndexCleanStart(D,F,y.clock)]},getItemCleanEnd=(D,y,F)=>{const R=y.clients.get(F.client),O=findIndexSS(R,F.clock),U=R[O];return F.clock!==U.id.clock+U.length-1&&U.constructor!==GC&&R.splice(O+1,0,splitItem(D,U,F.clock-U.id.clock+1)),U},replaceStruct=(D,y,F)=>{const R=D.clients.get(y.id.client);R[findIndexSS(R,y.id.clock)]=F},iterateStructs=(D,y,F,R,O)=>{if(R===0)return;const U=F+R;let K=findIndexCleanStart(D,y,F),B;do B=y[K++],U<B.id.clock+B.length&&findIndexCleanStart(D,y,U),O(B);while(K<y.length&&y[K].id.clock<U)};class Transaction{constructor(y,F,R){this.doc=y,this.deleteSet=new DeleteSet,this.beforeState=getStateVector(y.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=F,this.meta=new Map,this.local=R,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set}}const writeUpdateMessageFromTransaction=(D,y)=>y.deleteSet.clients.size===0&&!any(y.afterState,(F,R)=>y.beforeState.get(R)!==F)?!1:(sortAndMergeDeleteSet(y.deleteSet),writeStructsFromTransaction(D,y),writeDeleteSet(D,y.deleteSet),!0),addChangedTypeToTransaction=(D,y,F)=>{const R=y._item;(R===null||R.id.clock<(D.beforeState.get(R.id.client)||0)&&!R.deleted)&&setIfUndefined(D.changed,y,create$3).add(F)},tryToMergeWithLeft=(D,y)=>{const F=D[y-1],R=D[y];F.deleted===R.deleted&&F.constructor===R.constructor&&F.mergeWith(R)&&(D.splice(y,1),R instanceof Item&&R.parentSub!==null&&R.parent._map.get(R.parentSub)===R&&R.parent._map.set(R.parentSub,F))},tryGcDeleteSet=(D,y,F)=>{for(const[R,O]of D.clients.entries()){const U=y.clients.get(R);for(let K=O.length-1;K>=0;K--){const B=O[K],G=B.clock+B.len;for(let q=findIndexSS(U,B.clock),W=U[q];q<U.length&&W.id.clock<G;W=U[++q]){const X=U[q];if(B.clock+B.len<=X.id.clock)break;X instanceof Item&&X.deleted&&!X.keep&&F(X)&&X.gc(y,!1)}}}},tryMergeDeleteSet=(D,y)=>{D.clients.forEach((F,R)=>{const O=y.clients.get(R);for(let U=F.length-1;U>=0;U--){const K=F[U],B=min(O.length-1,1+findIndexSS(O,K.clock+K.len-1));for(let G=B,q=O[G];G>0&&q.id.clock>=K.clock;q=O[--G])tryToMergeWithLeft(O,G)}})},tryGc=(D,y,F)=>{tryGcDeleteSet(D,y,F),tryMergeDeleteSet(D,y)},cleanupTransactions=(D,y)=>{if(y<D.length){const F=D[y],R=F.doc,O=R.store,U=F.deleteSet,K=F._mergeStructs;try{sortAndMergeDeleteSet(U),F.afterState=getStateVector(F.doc.store),R._transaction=null,R.emit("beforeObserverCalls",[F,R]);const B=[];F.changed.forEach((G,q)=>B.push(()=>{(q._item===null||!q._item.deleted)&&q._callObserver(F,G)})),B.push(()=>{F.changedParentTypes.forEach((G,q)=>B.push(()=>{(q._item===null||!q._item.deleted)&&(G=G.filter(W=>W.target._item===null||!W.target._item.deleted),G.forEach(W=>{W.currentTarget=q}),G.sort((W,X)=>W.path.length-X.path.length),callEventHandlerListeners(q._dEH,G,F))})),B.push(()=>R.emit("afterTransaction",[F,R]))}),callAll(B,[])}finally{R.gc&&tryGcDeleteSet(U,O,R.gcFilter),tryMergeDeleteSet(U,O),F.afterState.forEach((W,X)=>{const j=F.beforeState.get(X)||0;if(j!==W){const Z=O.clients.get(X),J=max(findIndexSS(Z,j),1);for(let Q=Z.length-1;Q>=J;Q--)tryToMergeWithLeft(Z,Q)}});for(let W=0;W<K.length;W++){const{client:X,clock:j}=K[W].id,Z=O.clients.get(X),J=findIndexSS(Z,j);J+1<Z.length&&tryToMergeWithLeft(Z,J+1),J>0&&tryToMergeWithLeft(Z,J)}if(!F.local&&F.afterState.get(R.clientID)!==F.beforeState.get(R.clientID)&&(R.clientID=generateNewClientId(),print(ORANGE,BOLD,"[yjs] ",UNBOLD,RED,"Changed the client-id because another client seems to be using it.")),R.emit("afterTransactionCleanup",[F,R]),R._observers.has("update")){const W=new UpdateEncoderV1;writeUpdateMessageFromTransaction(W,F)&&R.emit("update",[W.toUint8Array(),F.origin,R,F])}if(R._observers.has("updateV2")){const W=new UpdateEncoderV2;writeUpdateMessageFromTransaction(W,F)&&R.emit("updateV2",[W.toUint8Array(),F.origin,R,F])}const{subdocsAdded:B,subdocsLoaded:G,subdocsRemoved:q}=F;(B.size>0||q.size>0||G.size>0)&&(B.forEach(W=>{W.clientID=R.clientID,W.collectionid==null&&(W.collectionid=R.collectionid),R.subdocs.add(W)}),q.forEach(W=>R.subdocs.delete(W)),R.emit("subdocs",[{loaded:G,added:B,removed:q},R,F]),q.forEach(W=>W.destroy())),D.length<=y+1?(R._transactionCleanups=[],R.emit("afterAllTransactions",[R,D])):cleanupTransactions(D,y+1)}}},transact=(D,y,F=null,R=!0)=>{const O=D._transactionCleanups;let U=!1;D._transaction===null&&(U=!0,D._transaction=new Transaction(D,F,R),O.push(D._transaction),O.length===1&&D.emit("beforeAllTransactions",[D]),D.emit("beforeTransaction",[D._transaction,D]));try{y(D._transaction)}finally{U&&O[0]===D._transaction&&cleanupTransactions(O,0)}};class StackItem{constructor(y,F){this.insertions=F,this.deletions=y,this.meta=new Map}}const popStackItem=(D,y,F)=>{let R=null,O=null;const U=D.doc,K=D.scope;if(transact(U,B=>{for(;y.length>0&&R===null;){const G=U.store,q=y.pop(),W=new Set,X=[];let j=!1;iterateDeletedStructs(B,q.insertions,Z=>{if(Z instanceof Item){if(Z.redone!==null){let{item:J,diff:Q}=followRedone(G,Z.id);Q>0&&(J=getItemCleanStart(B,createID(J.id.client,J.id.clock+Q))),Z=J}!Z.deleted&&K.some(J=>isParentOf(J,Z))&&X.push(Z)}}),iterateDeletedStructs(B,q.deletions,Z=>{Z instanceof Item&&K.some(J=>isParentOf(J,Z))&&!isDeleted(q.insertions,Z.id)&&W.add(Z)}),W.forEach(Z=>{j=redoItem(B,Z,W,X)!==null||j});for(let Z=X.length-1;Z>=0;Z--){const J=X[Z];D.deleteFilter(J)&&(J.delete(B),j=!0)}R=j?q:null}B.changed.forEach((G,q)=>{G.has(null)&&q._searchMarker&&(q._searchMarker.length=0)}),O=B},D),R!=null){const B=O.changedParentTypes;D.emit("stack-item-popped",[{stackItem:R,type:F,changedParentTypes:B},D])}return R};class UndoManager extends Observable{constructor(y,{captureTimeout:F=500,deleteFilter:R=()=>!0,trackedOrigins:O=new Set([null])}={}){super(),this.scope=y instanceof Array?y:[y],this.deleteFilter=R,O.add(this),this.trackedOrigins=O,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.doc=this.scope[0].doc,this.lastChange=0,this.doc.on("afterTransaction",U=>{if(!this.scope.some(X=>U.changedParentTypes.has(X))||!this.trackedOrigins.has(U.origin)&&(!U.origin||!this.trackedOrigins.has(U.origin.constructor)))return;const K=this.undoing,B=this.redoing,G=K?this.redoStack:this.undoStack;K?this.stopCapturing():B||(this.redoStack=[]);const q=new DeleteSet;U.afterState.forEach((X,j)=>{const Z=U.beforeState.get(j)||0,J=X-Z;J>0&&addToDeleteSet(q,j,Z,J)});const W=getUnixTime();if(W-this.lastChange<F&&G.length>0&&!K&&!B){const X=G[G.length-1];X.deletions=mergeDeleteSets([X.deletions,U.deleteSet]),X.insertions=mergeDeleteSets([X.insertions,q])}else G.push(new StackItem(U.deleteSet,q));!K&&!B&&(this.lastChange=W),iterateDeletedStructs(U,U.deleteSet,X=>{X instanceof Item&&this.scope.some(j=>isParentOf(j,X))&&keepItem(X,!0)}),this.emit("stack-item-added",[{stackItem:G[G.length-1],origin:U.origin,type:K?"redo":"undo",changedParentTypes:U.changedParentTypes},this])})}clear(){this.doc.transact(y=>{const F=R=>{iterateDeletedStructs(y,R.deletions,O=>{O instanceof Item&&this.scope.some(U=>isParentOf(U,O))&&keepItem(O,!1)})};this.undoStack.forEach(F),this.redoStack.forEach(F)}),this.undoStack=[],this.redoStack=[]}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let y;try{y=popStackItem(this,this.undoStack,"undo")}finally{this.undoing=!1}return y}redo(){this.redoing=!0;let y;try{y=popStackItem(this,this.redoStack,"redo")}finally{this.redoing=!1}return y}}function*lazyStructReaderGenerator(D){const y=readVarUint(D.restDecoder);for(let F=0;F<y;F++){const R=readVarUint(D.restDecoder),O=D.readClient();let U=readVarUint(D.restDecoder);for(let K=0;K<R;K++){const B=D.readInfo();if(B===10){const G=readVarUint(D.restDecoder);yield new Skip(createID(O,U),G),U+=G}else if((BITS5&B)!==0){const G=(B&(BIT7|BIT8))===0,q=new Item(createID(O,U),null,(B&BIT8)===BIT8?D.readLeftID():null,null,(B&BIT7)===BIT7?D.readRightID():null,G?D.readParentInfo()?D.readString():D.readLeftID():null,G&&(B&BIT6)===BIT6?D.readString():null,readItemContent(D,B));yield q,U+=q.length}else{const G=D.readLen();yield new GC(createID(O,U),G),U+=G}}}}class LazyStructReader{constructor(y,F){this.gen=lazyStructReaderGenerator(y),this.curr=null,this.done=!1,this.filterSkips=F,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===Skip);return this.curr}}const logUpdate=D=>logUpdateV2(D,UpdateDecoderV1),logUpdateV2=(D,y=UpdateDecoderV2)=>{const F=[],R=new y(createDecoder(D)),O=new LazyStructReader(R,!1);for(let K=O.curr;K!==null;K=O.next())F.push(K);print("Structs: ",F);const U=readDeleteSet(R);print("DeleteSet: ",U)};class LazyStructWriter{constructor(y){this.currClient=0,this.startClock=0,this.written=0,this.encoder=y,this.clientStructs=[]}}const mergeUpdates=D=>mergeUpdatesV2(D,UpdateDecoderV1,UpdateEncoderV1),encodeStateVectorFromUpdateV2=(D,y=DSEncoderV2,F=UpdateDecoderV2)=>{const R=new y,O=new LazyStructReader(new F(createDecoder(D)),!1);let U=O.curr;if(U!==null){let K=0,B=U.id.client,G=U.id.clock!==0,q=G?0:U.id.clock+U.length;for(;U!==null;U=O.next())B!==U.id.client&&(q!==0&&(K++,writeVarUint(R.restEncoder,B),writeVarUint(R.restEncoder,q)),B=U.id.client,q=0,G=U.id.clock!==0),U.constructor===Skip&&(G=!0),G||(q=U.id.clock+U.length);q!==0&&(K++,writeVarUint(R.restEncoder,B),writeVarUint(R.restEncoder,q));const W=createEncoder();return writeVarUint(W,K),writeBinaryEncoder(W,R.restEncoder),R.restEncoder=W,R.toUint8Array()}else return writeVarUint(R.restEncoder,0),R.toUint8Array()},encodeStateVectorFromUpdate=D=>encodeStateVectorFromUpdateV2(D,DSEncoderV1,UpdateDecoderV1),parseUpdateMetaV2=(D,y=UpdateDecoderV2)=>{const F=new Map,R=new Map,O=new LazyStructReader(new y(createDecoder(D)),!1);let U=O.curr;if(U!==null){let K=U.id.client,B=U.id.clock;for(F.set(K,B);U!==null;U=O.next())K!==U.id.client&&(R.set(K,B),F.set(U.id.client,U.id.clock),K=U.id.client),B=U.id.clock+U.length;R.set(K,B)}return{from:F,to:R}},parseUpdateMeta=D=>parseUpdateMetaV2(D,UpdateDecoderV1),sliceStruct=(D,y)=>{if(D.constructor===GC){const{client:F,clock:R}=D.id;return new GC(createID(F,R+y),D.length-y)}else if(D.constructor===Skip){const{client:F,clock:R}=D.id;return new Skip(createID(F,R+y),D.length-y)}else{const F=D,{client:R,clock:O}=F.id;return new Item(createID(R,O+y),null,createID(R,O+y-1),null,F.rightOrigin,F.parent,F.parentSub,F.content.splice(y))}},mergeUpdatesV2=(D,y=UpdateDecoderV2,F=UpdateEncoderV2)=>{if(D.length===1)return D[0];const R=D.map(W=>new y(createDecoder(W)));let O=R.map(W=>new LazyStructReader(W,!0)),U=null;const K=new F,B=new LazyStructWriter(K);for(;O=O.filter(j=>j.curr!==null),O.sort((j,Z)=>{if(j.curr.id.client===Z.curr.id.client){const J=j.curr.id.clock-Z.curr.id.clock;return J===0?j.curr.constructor===Z.curr.constructor?0:j.curr.constructor===Skip?1:-1:J}else return Z.curr.id.client-j.curr.id.client}),O.length!==0;){const W=O[0],X=W.curr.id.client;if(U!==null){let j=W.curr,Z=!1;for(;j!==null&&j.id.clock+j.length<=U.struct.id.clock+U.struct.length&&j.id.client>=U.struct.id.client;)j=W.next(),Z=!0;if(j===null||j.id.client!==X||Z&&j.id.clock>U.struct.id.clock+U.struct.length)continue;if(X!==U.struct.id.client)writeStructToLazyStructWriter(B,U.struct,U.offset),U={struct:j,offset:0},W.next();else if(U.struct.id.clock+U.struct.length<j.id.clock)if(U.struct.constructor===Skip)U.struct.length=j.id.clock+j.length-U.struct.id.clock;else{writeStructToLazyStructWriter(B,U.struct,U.offset);const J=j.id.clock-U.struct.id.clock-U.struct.length;U={struct:new Skip(createID(X,U.struct.id.clock+U.struct.length),J),offset:0}}else{const J=U.struct.id.clock+U.struct.length-j.id.clock;J>0&&(U.struct.constructor===Skip?U.struct.length-=J:j=sliceStruct(j,J)),U.struct.mergeWith(j)||(writeStructToLazyStructWriter(B,U.struct,U.offset),U={struct:j,offset:0},W.next())}}else U={struct:W.curr,offset:0},W.next();for(let j=W.curr;j!==null&&j.id.client===X&&j.id.clock===U.struct.id.clock+U.struct.length&&j.constructor!==Skip;j=W.next())writeStructToLazyStructWriter(B,U.struct,U.offset),U={struct:j,offset:0}}U!==null&&(writeStructToLazyStructWriter(B,U.struct,U.offset),U=null),finishLazyStructWriting(B);const G=R.map(W=>readDeleteSet(W)),q=mergeDeleteSets(G);return writeDeleteSet(K,q),K.toUint8Array()},diffUpdateV2=(D,y,F=UpdateDecoderV2,R=UpdateEncoderV2)=>{const O=decodeStateVector(y),U=new R,K=new LazyStructWriter(U),B=new F(createDecoder(D)),G=new LazyStructReader(B,!1);for(;G.curr;){const W=G.curr,X=W.id.client,j=O.get(X)||0;if(G.curr.constructor===Skip){G.next();continue}if(W.id.clock+W.length>j)for(writeStructToLazyStructWriter(K,W,max(j-W.id.clock,0)),G.next();G.curr&&G.curr.id.client===X;)writeStructToLazyStructWriter(K,G.curr,0),G.next();else for(;G.curr&&G.curr.id.client===X&&G.curr.id.clock+G.curr.length<=j;)G.next()}finishLazyStructWriting(K);const q=readDeleteSet(B);return writeDeleteSet(U,q),U.toUint8Array()},diffUpdate=(D,y)=>diffUpdateV2(D,y,UpdateDecoderV1,UpdateEncoderV1),flushLazyStructWriter=D=>{D.written>0&&(D.clientStructs.push({written:D.written,restEncoder:toUint8Array(D.encoder.restEncoder)}),D.encoder.restEncoder=createEncoder(),D.written=0)},writeStructToLazyStructWriter=(D,y,F)=>{D.written>0&&D.currClient!==y.id.client&&flushLazyStructWriter(D),D.written===0&&(D.currClient=y.id.client,D.encoder.writeClient(y.id.client),writeVarUint(D.encoder.restEncoder,y.id.clock+F)),y.write(D.encoder,F),D.written++},finishLazyStructWriting=D=>{flushLazyStructWriter(D);const y=D.encoder.restEncoder;writeVarUint(y,D.clientStructs.length);for(let F=0;F<D.clientStructs.length;F++){const R=D.clientStructs[F];writeVarUint(y,R.written),writeUint8Array(y,R.restEncoder)}},convertUpdateFormat=(D,y,F)=>{const R=new y(createDecoder(D)),O=new LazyStructReader(R,!1),U=new F,K=new LazyStructWriter(U);for(let G=O.curr;G!==null;G=O.next())writeStructToLazyStructWriter(K,G,0);finishLazyStructWriting(K);const B=readDeleteSet(R);return writeDeleteSet(U,B),U.toUint8Array()},convertUpdateFormatV2ToV1=D=>convertUpdateFormat(D,UpdateDecoderV2,UpdateEncoderV1);class YEvent{constructor(y,F){this.target=y,this.currentTarget=y,this.transaction=F,this._changes=null,this._keys=null,this._delta=null}get path(){return getPathTo(this.currentTarget,this.target)}deletes(y){return isDeleted(this.transaction.deleteSet,y.id)}get keys(){if(this._keys===null){const y=new Map,F=this.target;this.transaction.changed.get(F).forEach(O=>{if(O!==null){const U=F._map.get(O);let K,B;if(this.adds(U)){let G=U.left;for(;G!==null&&this.adds(G);)G=G.left;if(this.deletes(U))if(G!==null&&this.deletes(G))K="delete",B=last(G.content.getContent());else return;else G!==null&&this.deletes(G)?(K="update",B=last(G.content.getContent())):(K="add",B=void 0)}else if(this.deletes(U))K="delete",B=last(U.content.getContent());else return;y.set(O,{action:K,oldValue:B})}}),this._keys=y}return this._keys}get delta(){return this.changes.delta}adds(y){return y.id.clock>=(this.transaction.beforeState.get(y.id.client)||0)}get changes(){let y=this._changes;if(y===null){const F=this.target,R=create$3(),O=create$3(),U=[];if(y={added:R,deleted:O,delta:U,keys:this.keys},this.transaction.changed.get(F).has(null)){let B=null;const G=()=>{B&&U.push(B)};for(let q=F._start;q!==null;q=q.right)q.deleted?this.deletes(q)&&!this.adds(q)&&((B===null||B.delete===void 0)&&(G(),B={delete:0}),B.delete+=q.length,O.add(q)):this.adds(q)?((B===null||B.insert===void 0)&&(G(),B={insert:[]}),B.insert=B.insert.concat(q.content.getContent()),R.add(q)):((B===null||B.retain===void 0)&&(G(),B={retain:0}),B.retain+=q.length);B!==null&&B.retain===void 0&&G()}this._changes=y}return y}}const getPathTo=(D,y)=>{const F=[];for(;y._item!==null&&y!==D;){if(y._item.parentSub!==null)F.unshift(y._item.parentSub);else{let R=0,O=y._item.parent._start;for(;O!==y._item&&O!==null;)O.deleted||R++,O=O.right;F.unshift(R)}y=y._item.parent}return F},maxSearchMarker=80;let globalSearchMarkerTimestamp=0;class ArraySearchMarker{constructor(y,F){y.marker=!0,this.p=y,this.index=F,this.timestamp=globalSearchMarkerTimestamp++}}const refreshMarkerTimestamp=D=>{D.timestamp=globalSearchMarkerTimestamp++},overwriteMarker=(D,y,F)=>{D.p.marker=!1,D.p=y,y.marker=!0,D.index=F,D.timestamp=globalSearchMarkerTimestamp++},markPosition=(D,y,F)=>{if(D.length>=maxSearchMarker){const R=D.reduce((O,U)=>O.timestamp<U.timestamp?O:U);return overwriteMarker(R,y,F),R}else{const R=new ArraySearchMarker(y,F);return D.push(R),R}},findMarker=(D,y)=>{if(D._start===null||y===0||D._searchMarker===null)return null;const F=D._searchMarker.length===0?null:D._searchMarker.reduce((U,K)=>abs(y-U.index)<abs(y-K.index)?U:K);let R=D._start,O=0;for(F!==null&&(R=F.p,O=F.index,refreshMarkerTimestamp(F));R.right!==null&&O<y;){if(!R.deleted&&R.countable){if(y<O+R.length)break;O+=R.length}R=R.right}for(;R.left!==null&&O>y;)R=R.left,!R.deleted&&R.countable&&(O-=R.length);for(;R.left!==null&&R.left.id.client===R.id.client&&R.left.id.clock+R.left.length===R.id.clock;)R=R.left,!R.deleted&&R.countable&&(O-=R.length);return F!==null&&abs(F.index-O)<R.parent.length/maxSearchMarker?(overwriteMarker(F,R,O),F):markPosition(D._searchMarker,R,O)},updateMarkerChanges=(D,y,F)=>{for(let R=D.length-1;R>=0;R--){const O=D[R];if(F>0){let U=O.p;for(U.marker=!1;U&&(U.deleted||!U.countable);)U=U.left,U&&!U.deleted&&U.countable&&(O.index-=U.length);if(U===null||U.marker===!0){D.splice(R,1);continue}O.p=U,U.marker=!0}(y<O.index||F>0&&y===O.index)&&(O.index=max(y,O.index+F))}},getTypeChildren=D=>{let y=D._start;const F=[];for(;y;)F.push(y),y=y.right;return F},callTypeObservers=(D,y,F)=>{const R=D,O=y.changedParentTypes;for(;setIfUndefined(O,D,()=>[]).push(F),D._item!==null;)D=D._item.parent;callEventHandlerListeners(R._eH,F,y)};class AbstractType{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=createEventHandler(),this._dEH=createEventHandler(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(y,F){this.doc=y,this._item=F}_copy(){throw methodUnimplemented()}clone(){throw methodUnimplemented()}_write(y){}get _first(){let y=this._start;for(;y!==null&&y.deleted;)y=y.right;return y}_callObserver(y,F){!y.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(y){addEventHandlerListener(this._eH,y)}observeDeep(y){addEventHandlerListener(this._dEH,y)}unobserve(y){removeEventHandlerListener(this._eH,y)}unobserveDeep(y){removeEventHandlerListener(this._dEH,y)}toJSON(){}}const typeListSlice=(D,y,F)=>{y<0&&(y=D._length+y),F<0&&(F=D._length+F);let R=F-y;const O=[];let U=D._start;for(;U!==null&&R>0;){if(U.countable&&!U.deleted){const K=U.content.getContent();if(K.length<=y)y-=K.length;else{for(let B=y;B<K.length&&R>0;B++)O.push(K[B]),R--;y=0}}U=U.right}return O},typeListToArray=D=>{const y=[];let F=D._start;for(;F!==null;){if(F.countable&&!F.deleted){const R=F.content.getContent();for(let O=0;O<R.length;O++)y.push(R[O])}F=F.right}return y},typeListToArraySnapshot=(D,y)=>{const F=[];let R=D._start;for(;R!==null;){if(R.countable&&isVisible(R,y)){const O=R.content.getContent();for(let U=0;U<O.length;U++)F.push(O[U])}R=R.right}return F},typeListForEach=(D,y)=>{let F=0,R=D._start;for(;R!==null;){if(R.countable&&!R.deleted){const O=R.content.getContent();for(let U=0;U<O.length;U++)y(O[U],F++,D)}R=R.right}},typeListMap=(D,y)=>{const F=[];return typeListForEach(D,(R,O)=>{F.push(y(R,O,D))}),F},typeListCreateIterator=D=>{let y=D._start,F=null,R=0;return{[Symbol.iterator](){return this},next:()=>{if(F===null){for(;y!==null&&y.deleted;)y=y.right;if(y===null)return{done:!0,value:void 0};F=y.content.getContent(),R=0,y=y.right}const O=F[R++];return F.length<=R&&(F=null),{done:!1,value:O}}}},typeListGet=(D,y)=>{const F=findMarker(D,y);let R=D._start;for(F!==null&&(R=F.p,y-=F.index);R!==null;R=R.right)if(!R.deleted&&R.countable){if(y<R.length)return R.content.getContent()[y];y-=R.length}},typeListInsertGenericsAfter=(D,y,F,R)=>{let O=F;const U=D.doc,K=U.clientID,B=U.store,G=F===null?y._start:F.right;let q=[];const W=()=>{q.length>0&&(O=new Item(createID(K,getState(B,K)),O,O&&O.lastId,G,G&&G.id,y,null,new ContentAny(q)),O.integrate(D,0),q=[])};R.forEach(X=>{if(X===null)q.push(X);else switch(X.constructor){case Number:case Object:case Boolean:case Array:case String:q.push(X);break;default:switch(W(),X.constructor){case Uint8Array:case ArrayBuffer:O=new Item(createID(K,getState(B,K)),O,O&&O.lastId,G,G&&G.id,y,null,new ContentBinary(new Uint8Array(X))),O.integrate(D,0);break;case Doc:O=new Item(createID(K,getState(B,K)),O,O&&O.lastId,G,G&&G.id,y,null,new ContentDoc(X)),O.integrate(D,0);break;default:if(X instanceof AbstractType)O=new Item(createID(K,getState(B,K)),O,O&&O.lastId,G,G&&G.id,y,null,new ContentType(X)),O.integrate(D,0);else throw new Error("Unexpected content type in insert operation")}}}),W()},lengthExceeded=create$2("Length exceeded!"),typeListInsertGenerics=(D,y,F,R)=>{if(F>y._length)throw lengthExceeded;if(F===0)return y._searchMarker&&updateMarkerChanges(y._searchMarker,F,R.length),typeListInsertGenericsAfter(D,y,null,R);const O=F,U=findMarker(y,F);let K=y._start;for(U!==null&&(K=U.p,F-=U.index,F===0&&(K=K.prev,F+=K&&K.countable&&!K.deleted?K.length:0));K!==null;K=K.right)if(!K.deleted&&K.countable){if(F<=K.length){F<K.length&&getItemCleanStart(D,createID(K.id.client,K.id.clock+F));break}F-=K.length}return y._searchMarker&&updateMarkerChanges(y._searchMarker,O,R.length),typeListInsertGenericsAfter(D,y,K,R)},typeListDelete=(D,y,F,R)=>{if(R===0)return;const O=F,U=R,K=findMarker(y,F);let B=y._start;for(K!==null&&(B=K.p,F-=K.index);B!==null&&F>0;B=B.right)!B.deleted&&B.countable&&(F<B.length&&getItemCleanStart(D,createID(B.id.client,B.id.clock+F)),F-=B.length);for(;R>0&&B!==null;)B.deleted||(R<B.length&&getItemCleanStart(D,createID(B.id.client,B.id.clock+R)),B.delete(D),R-=B.length),B=B.right;if(R>0)throw lengthExceeded;y._searchMarker&&updateMarkerChanges(y._searchMarker,O,-U+R)},typeMapDelete=(D,y,F)=>{const R=y._map.get(F);R!==void 0&&R.delete(D)},typeMapSet=(D,y,F,R)=>{const O=y._map.get(F)||null,U=D.doc,K=U.clientID;let B;if(R==null)B=new ContentAny([R]);else switch(R.constructor){case Number:case Object:case Boolean:case Array:case String:B=new ContentAny([R]);break;case Uint8Array:B=new ContentBinary(R);break;case Doc:B=new ContentDoc(R);break;default:if(R instanceof AbstractType)B=new ContentType(R);else throw new Error("Unexpected content type")}new Item(createID(K,getState(U.store,K)),O,O&&O.lastId,null,null,y,F,B).integrate(D,0)},typeMapGet=(D,y)=>{const F=D._map.get(y);return F!==void 0&&!F.deleted?F.content.getContent()[F.length-1]:void 0},typeMapGetAll=D=>{const y={};return D._map.forEach((F,R)=>{F.deleted||(y[R]=F.content.getContent()[F.length-1])}),y},typeMapHas=(D,y)=>{const F=D._map.get(y);return F!==void 0&&!F.deleted},typeMapGetSnapshot=(D,y,F)=>{let R=D._map.get(y)||null;for(;R!==null&&(!F.sv.has(R.id.client)||R.id.clock>=(F.sv.get(R.id.client)||0));)R=R.left;return R!==null&&isVisible(R,F)?R.content.getContent()[R.length-1]:void 0},createMapIterator=D=>iteratorFilter(D.entries(),y=>!y[1].deleted);class YArrayEvent extends YEvent{constructor(y,F){super(y,F),this._transaction=F}}class YArray extends AbstractType{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(y){const F=new YArray;return F.push(y),F}_integrate(y,F){super._integrate(y,F),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new YArray}clone(){const y=new YArray;return y.insert(0,this.toArray().map(F=>F instanceof AbstractType?F.clone():F)),y}get length(){return this._prelimContent===null?this._length:this._prelimContent.length}_callObserver(y,F){super._callObserver(y,F),callTypeObservers(this,y,new YArrayEvent(this,y))}insert(y,F){this.doc!==null?transact(this.doc,R=>{typeListInsertGenerics(R,this,y,F)}):this._prelimContent.splice(y,0,...F)}push(y){this.insert(this.length,y)}unshift(y){this.insert(0,y)}delete(y,F=1){this.doc!==null?transact(this.doc,R=>{typeListDelete(R,this,y,F)}):this._prelimContent.splice(y,F)}get(y){return typeListGet(this,y)}toArray(){return typeListToArray(this)}slice(y=0,F=this.length){return typeListSlice(this,y,F)}toJSON(){return this.map(y=>y instanceof AbstractType?y.toJSON():y)}map(y){return typeListMap(this,y)}forEach(y){typeListForEach(this,y)}[Symbol.iterator](){return typeListCreateIterator(this)}_write(y){y.writeTypeRef(YArrayRefID)}}const readYArray=D=>new YArray;class YMapEvent extends YEvent{constructor(y,F,R){super(y,F),this.keysChanged=R}}class YMap extends AbstractType{constructor(y){super(),this._prelimContent=null,y===void 0?this._prelimContent=new Map:this._prelimContent=new Map(y)}_integrate(y,F){super._integrate(y,F),this._prelimContent.forEach((R,O)=>{this.set(O,R)}),this._prelimContent=null}_copy(){return new YMap}clone(){const y=new YMap;return this.forEach((F,R)=>{y.set(R,F instanceof AbstractType?F.clone():F)}),y}_callObserver(y,F){callTypeObservers(this,y,new YMapEvent(this,y,F))}toJSON(){const y={};return this._map.forEach((F,R)=>{if(!F.deleted){const O=F.content.getContent()[F.length-1];y[R]=O instanceof AbstractType?O.toJSON():O}}),y}get size(){return[...createMapIterator(this._map)].length}keys(){return iteratorMap(createMapIterator(this._map),y=>y[0])}values(){return iteratorMap(createMapIterator(this._map),y=>y[1].content.getContent()[y[1].length-1])}entries(){return iteratorMap(createMapIterator(this._map),y=>[y[0],y[1].content.getContent()[y[1].length-1]])}forEach(y){const F={};return this._map.forEach((R,O)=>{R.deleted||y(R.content.getContent()[R.length-1],O,this)}),F}[Symbol.iterator](){return this.entries()}delete(y){this.doc!==null?transact(this.doc,F=>{typeMapDelete(F,this,y)}):this._prelimContent.delete(y)}set(y,F){return this.doc!==null?transact(this.doc,R=>{typeMapSet(R,this,y,F)}):this._prelimContent.set(y,F),F}get(y){return typeMapGet(this,y)}has(y){return typeMapHas(this,y)}clear(){this.doc!==null?transact(this.doc,y=>{this.forEach(function(F,R,O){typeMapDelete(y,O,R)})}):this._prelimContent.clear()}_write(y){y.writeTypeRef(YMapRefID)}}const readYMap=D=>new YMap,equalAttrs=(D,y)=>D===y||typeof D=="object"&&typeof y=="object"&&D&&y&&equalFlat(D,y);class ItemTextListPosition{constructor(y,F,R,O){this.left=y,this.right=F,this.index=R,this.currentAttributes=O}forward(){switch(this.right===null&&unexpectedCase(),this.right.content.constructor){case ContentFormat:this.right.deleted||updateCurrentAttributes(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const findNextPosition=(D,y,F)=>{for(;y.right!==null&&F>0;){switch(y.right.content.constructor){case ContentFormat:y.right.deleted||updateCurrentAttributes(y.currentAttributes,y.right.content);break;default:y.right.deleted||(F<y.right.length&&getItemCleanStart(D,createID(y.right.id.client,y.right.id.clock+F)),y.index+=y.right.length,F-=y.right.length);break}y.left=y.right,y.right=y.right.right}return y},findPosition=(D,y,F)=>{const R=new Map,O=findMarker(y,F);if(O){const U=new ItemTextListPosition(O.p.left,O.p,O.index,R);return findNextPosition(D,U,F-O.index)}else{const U=new ItemTextListPosition(null,y._start,0,R);return findNextPosition(D,U,F)}},insertNegatedAttributes=(D,y,F,R)=>{for(;F.right!==null&&(F.right.deleted===!0||F.right.content.constructor===ContentFormat&&equalAttrs(R.get(F.right.content.key),F.right.content.value));)F.right.deleted||R.delete(F.right.content.key),F.forward();const O=D.doc,U=O.clientID;R.forEach((K,B)=>{const G=F.left,q=F.right,W=new Item(createID(U,getState(O.store,U)),G,G&&G.lastId,q,q&&q.id,y,null,new ContentFormat(B,K));W.integrate(D,0),F.right=W,F.forward()})},updateCurrentAttributes=(D,y)=>{const{key:F,value:R}=y;R===null?D.delete(F):D.set(F,R)},minimizeAttributeChanges=(D,y)=>{for(;D.right!==null;){if(!(D.right.deleted||D.right.content.constructor===ContentFormat&&equalAttrs(y[D.right.content.key]||null,D.right.content.value)))break;D.forward()}},insertAttributes=(D,y,F,R)=>{const O=D.doc,U=O.clientID,K=new Map;for(const B in R){const G=R[B],q=F.currentAttributes.get(B)||null;if(!equalAttrs(q,G)){K.set(B,q);const{left:W,right:X}=F;F.right=new Item(createID(U,getState(O.store,U)),W,W&&W.lastId,X,X&&X.id,y,null,new ContentFormat(B,G)),F.right.integrate(D,0),F.forward()}}return K},insertText=(D,y,F,R,O)=>{F.currentAttributes.forEach((j,Z)=>{O[Z]===void 0&&(O[Z]=null)});const U=D.doc,K=U.clientID;minimizeAttributeChanges(F,O);const B=insertAttributes(D,y,F,O),G=R.constructor===String?new ContentString(R):R instanceof AbstractType?new ContentType(R):new ContentEmbed(R);let{left:q,right:W,index:X}=F;y._searchMarker&&updateMarkerChanges(y._searchMarker,F.index,G.getLength()),W=new Item(createID(K,getState(U.store,K)),q,q&&q.lastId,W,W&&W.id,y,null,G),W.integrate(D,0),F.right=W,F.index=X,F.forward(),insertNegatedAttributes(D,y,F,B)},formatText=(D,y,F,R,O)=>{const U=D.doc,K=U.clientID;minimizeAttributeChanges(F,O);const B=insertAttributes(D,y,F,O);for(;R>0&&F.right!==null;){if(!F.right.deleted)switch(F.right.content.constructor){case ContentFormat:{const{key:G,value:q}=F.right.content,W=O[G];W!==void 0&&(equalAttrs(W,q)?B.delete(G):B.set(G,q),F.right.delete(D));break}default:R<F.right.length&&getItemCleanStart(D,createID(F.right.id.client,F.right.id.clock+R)),R-=F.right.length;break}F.forward()}if(R>0){let G="";for(;R>0;R--)G+=`
`;F.right=new Item(createID(K,getState(U.store,K)),F.left,F.left&&F.left.lastId,F.right,F.right&&F.right.id,y,null,new ContentString(G)),F.right.integrate(D,0),F.forward()}insertNegatedAttributes(D,y,F,B)},cleanupFormattingGap=(D,y,F,R,O)=>{for(;F&&(!F.countable||F.deleted);)!F.deleted&&F.content.constructor===ContentFormat&&updateCurrentAttributes(O,F.content),F=F.right;let U=0;for(;y!==F;){if(!y.deleted){const K=y.content;switch(K.constructor){case ContentFormat:{const{key:B,value:G}=K;((O.get(B)||null)!==G||(R.get(B)||null)===G)&&(y.delete(D),U++);break}}}y=y.right}return U},cleanupContextlessFormattingGap=(D,y)=>{for(;y&&y.right&&(y.right.deleted||!y.right.countable);)y=y.right;const F=new Set;for(;y&&(y.deleted||!y.countable);){if(!y.deleted&&y.content.constructor===ContentFormat){const R=y.content.key;F.has(R)?y.delete(D):F.add(R)}y=y.left}},cleanupYTextFormatting=D=>{let y=0;return transact(D.doc,F=>{let R=D._start,O=D._start,U=create$4();const K=copy(U);for(;O;){if(O.deleted===!1)switch(O.content.constructor){case ContentFormat:updateCurrentAttributes(K,O.content);break;default:y+=cleanupFormattingGap(F,R,O,U,K),U=copy(K),R=O;break}O=O.right}}),y},deleteText=(D,y,F)=>{const R=F,O=copy(y.currentAttributes),U=y.right;for(;F>0&&y.right!==null;){if(y.right.deleted===!1)switch(y.right.content.constructor){case ContentType:case ContentEmbed:case ContentString:F<y.right.length&&getItemCleanStart(D,createID(y.right.id.client,y.right.id.clock+F)),F-=y.right.length,y.right.delete(D);break}y.forward()}U&&cleanupFormattingGap(D,U,y.right,O,copy(y.currentAttributes));const K=(y.left||y.right).parent;return K._searchMarker&&updateMarkerChanges(K._searchMarker,y.index,-R+F),y};class YTextEvent extends YEvent{constructor(y,F,R){super(y,F),this.childListChanged=!1,this.keysChanged=new Set,R.forEach(O=>{O===null?this.childListChanged=!0:this.keysChanged.add(O)})}get changes(){if(this._changes===null){const y={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=y}return this._changes}get delta(){if(this._delta===null){const y=this.target.doc,F=[];transact(y,R=>{const O=new Map,U=new Map;let K=this.target._start,B=null;const G={};let q="",W=0,X=0;const j=()=>{if(B!==null){let Z;switch(B){case"delete":Z={delete:X},X=0;break;case"insert":Z={insert:q},O.size>0&&(Z.attributes={},O.forEach((J,Q)=>{J!==null&&(Z.attributes[Q]=J)})),q="";break;case"retain":if(Z={retain:W},Object.keys(G).length>0){Z.attributes={};for(const J in G)Z.attributes[J]=G[J]}W=0;break}F.push(Z),B=null}};for(;K!==null;){switch(K.content.constructor){case ContentType:case ContentEmbed:this.adds(K)?this.deletes(K)||(j(),B="insert",q=K.content.getContent()[0],j()):this.deletes(K)?(B!=="delete"&&(j(),B="delete"),X+=1):K.deleted||(B!=="retain"&&(j(),B="retain"),W+=1);break;case ContentString:this.adds(K)?this.deletes(K)||(B!=="insert"&&(j(),B="insert"),q+=K.content.str):this.deletes(K)?(B!=="delete"&&(j(),B="delete"),X+=K.length):K.deleted||(B!=="retain"&&(j(),B="retain"),W+=K.length);break;case ContentFormat:{const{key:Z,value:J}=K.content;if(this.adds(K)){if(!this.deletes(K)){const Q=O.get(Z)||null;equalAttrs(Q,J)?K.delete(R):(B==="retain"&&j(),equalAttrs(J,U.get(Z)||null)?delete G[Z]:G[Z]=J)}}else if(this.deletes(K)){U.set(Z,J);const Q=O.get(Z)||null;equalAttrs(Q,J)||(B==="retain"&&j(),G[Z]=Q)}else if(!K.deleted){U.set(Z,J);const Q=G[Z];Q!==void 0&&(equalAttrs(Q,J)?K.delete(R):(B==="retain"&&j(),J===null?delete G[Z]:G[Z]=J))}K.deleted||(B==="insert"&&j(),updateCurrentAttributes(O,K.content));break}}K=K.right}for(j();F.length>0;){const Z=F[F.length-1];if(Z.retain!==void 0&&Z.attributes===void 0)F.pop();else break}}),this._delta=F}return this._delta}}class YText extends AbstractType{constructor(y){super(),this._pending=y!==void 0?[()=>this.insert(0,y)]:[],this._searchMarker=[]}get length(){return this._length}_integrate(y,F){super._integrate(y,F);try{this._pending.forEach(R=>R())}catch(R){console.error(R)}this._pending=null}_copy(){return new YText}clone(){const y=new YText;return y.applyDelta(this.toDelta()),y}_callObserver(y,F){super._callObserver(y,F);const R=new YTextEvent(this,y,F),O=y.doc;if(callTypeObservers(this,y,R),!y.local){let U=!1;for(const[K,B]of y.afterState.entries()){const G=y.beforeState.get(K)||0;if(B!==G&&(iterateStructs(y,O.store.clients.get(K),G,B,q=>{!q.deleted&&q.content.constructor===ContentFormat&&(U=!0)}),U))break}U||iterateDeletedStructs(y,y.deleteSet,K=>{K instanceof GC||U||K.parent===this&&K.content.constructor===ContentFormat&&(U=!0)}),transact(O,K=>{U?cleanupYTextFormatting(this):iterateDeletedStructs(K,K.deleteSet,B=>{B instanceof GC||B.parent===this&&cleanupContextlessFormattingGap(K,B)})})}}toString(){let y="",F=this._start;for(;F!==null;)!F.deleted&&F.countable&&F.content.constructor===ContentString&&(y+=F.content.str),F=F.right;return y}toJSON(){return this.toString()}applyDelta(y,{sanitize:F=!0}={}){this.doc!==null?transact(this.doc,R=>{const O=new ItemTextListPosition(null,this._start,0,new Map);for(let U=0;U<y.length;U++){const K=y[U];if(K.insert!==void 0){const B=!F&&typeof K.insert=="string"&&U===y.length-1&&O.right===null&&K.insert.slice(-1)===`
`?K.insert.slice(0,-1):K.insert;(typeof B!="string"||B.length>0)&&insertText(R,this,O,B,K.attributes||{})}else K.retain!==void 0?formatText(R,this,O,K.retain,K.attributes||{}):K.delete!==void 0&&deleteText(R,O,K.delete)}}):this._pending.push(()=>this.applyDelta(y))}toDelta(y,F,R){const O=[],U=new Map,K=this.doc;let B="",G=this._start;function q(){if(B.length>0){const W={};let X=!1;U.forEach((Z,J)=>{X=!0,W[J]=Z});const j={insert:B};X&&(j.attributes=W),O.push(j),B=""}}return transact(K,W=>{for(y&&splitSnapshotAffectedStructs(W,y),F&&splitSnapshotAffectedStructs(W,F);G!==null;){if(isVisible(G,y)||F!==void 0&&isVisible(G,F))switch(G.content.constructor){case ContentString:{const X=U.get("ychange");y!==void 0&&!isVisible(G,y)?(X===void 0||X.user!==G.id.client||X.state!=="removed")&&(q(),U.set("ychange",R?R("removed",G.id):{type:"removed"})):F!==void 0&&!isVisible(G,F)?(X===void 0||X.user!==G.id.client||X.state!=="added")&&(q(),U.set("ychange",R?R("added",G.id):{type:"added"})):X!==void 0&&(q(),U.delete("ychange")),B+=G.content.str;break}case ContentType:case ContentEmbed:{q();const X={insert:G.content.getContent()[0]};if(U.size>0){const j={};X.attributes=j,U.forEach((Z,J)=>{j[J]=Z})}O.push(X);break}case ContentFormat:isVisible(G,y)&&(q(),updateCurrentAttributes(U,G.content));break}G=G.right}q()},splitSnapshotAffectedStructs),O}insert(y,F,R){if(F.length<=0)return;const O=this.doc;O!==null?transact(O,U=>{const K=findPosition(U,this,y);R||(R={},K.currentAttributes.forEach((B,G)=>{R[G]=B})),insertText(U,this,K,F,R)}):this._pending.push(()=>this.insert(y,F,R))}insertEmbed(y,F,R={}){const O=this.doc;O!==null?transact(O,U=>{const K=findPosition(U,this,y);insertText(U,this,K,F,R)}):this._pending.push(()=>this.insertEmbed(y,F,R))}delete(y,F){if(F===0)return;const R=this.doc;R!==null?transact(R,O=>{deleteText(O,findPosition(O,this,y),F)}):this._pending.push(()=>this.delete(y,F))}format(y,F,R){if(F===0)return;const O=this.doc;O!==null?transact(O,U=>{const K=findPosition(U,this,y);K.right!==null&&formatText(U,this,K,F,R)}):this._pending.push(()=>this.format(y,F,R))}removeAttribute(y){this.doc!==null?transact(this.doc,F=>{typeMapDelete(F,this,y)}):this._pending.push(()=>this.removeAttribute(y))}setAttribute(y,F){this.doc!==null?transact(this.doc,R=>{typeMapSet(R,this,y,F)}):this._pending.push(()=>this.setAttribute(y,F))}getAttribute(y){return typeMapGet(this,y)}getAttributes(y){return typeMapGetAll(this)}_write(y){y.writeTypeRef(YTextRefID)}}const readYText=D=>new YText;class YXmlTreeWalker{constructor(y,F=()=>!0){this._filter=F,this._root=y,this._currentNode=y._start,this._firstCall=!0}[Symbol.iterator](){return this}next(){let y=this._currentNode,F=y&&y.content&&y.content.type;if(y!==null&&(!this._firstCall||y.deleted||!this._filter(F)))do if(F=y.content.type,!y.deleted&&(F.constructor===YXmlElement||F.constructor===YXmlFragment)&&F._start!==null)y=F._start;else for(;y!==null;)if(y.right!==null){y=y.right;break}else y.parent===this._root?y=null:y=y.parent._item;while(y!==null&&(y.deleted||!this._filter(y.content.type)));return this._firstCall=!1,y===null?{value:void 0,done:!0}:(this._currentNode=y,{value:y.content.type,done:!1})}}class YXmlFragment extends AbstractType{constructor(){super(),this._prelimContent=[]}get firstChild(){const y=this._first;return y?y.content.getContent()[0]:null}_integrate(y,F){super._integrate(y,F),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new YXmlFragment}clone(){const y=new YXmlFragment;return y.insert(0,this.toArray().map(F=>F instanceof AbstractType?F.clone():F)),y}get length(){return this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(y){return new YXmlTreeWalker(this,y)}querySelector(y){y=y.toUpperCase();const R=new YXmlTreeWalker(this,O=>O.nodeName&&O.nodeName.toUpperCase()===y).next();return R.done?null:R.value}querySelectorAll(y){return y=y.toUpperCase(),Array.from(new YXmlTreeWalker(this,F=>F.nodeName&&F.nodeName.toUpperCase()===y))}_callObserver(y,F){callTypeObservers(this,y,new YXmlEvent(this,F,y))}toString(){return typeListMap(this,y=>y.toString()).join("")}toJSON(){return this.toString()}toDOM(y=document,F={},R){const O=y.createDocumentFragment();return R!==void 0&&R._createAssociation(O,this),typeListForEach(this,U=>{O.insertBefore(U.toDOM(y,F,R),null)}),O}insert(y,F){this.doc!==null?transact(this.doc,R=>{typeListInsertGenerics(R,this,y,F)}):this._prelimContent.splice(y,0,...F)}insertAfter(y,F){if(this.doc!==null)transact(this.doc,R=>{const O=y&&y instanceof AbstractType?y._item:y;typeListInsertGenericsAfter(R,this,O,F)});else{const R=this._prelimContent,O=y===null?0:R.findIndex(U=>U===y)+1;if(O===0&&y!==null)throw create$2("Reference item not found");R.splice(O,0,...F)}}delete(y,F=1){this.doc!==null?transact(this.doc,R=>{typeListDelete(R,this,y,F)}):this._prelimContent.splice(y,F)}toArray(){return typeListToArray(this)}push(y){this.insert(this.length,y)}unshift(y){this.insert(0,y)}get(y){return typeListGet(this,y)}slice(y=0,F=this.length){return typeListSlice(this,y,F)}_write(y){y.writeTypeRef(YXmlFragmentRefID)}}const readYXmlFragment=D=>new YXmlFragment;class YXmlElement extends YXmlFragment{constructor(y="UNDEFINED"){super(),this.nodeName=y,this._prelimAttrs=new Map}get nextSibling(){const y=this._item?this._item.next:null;return y?y.content.type:null}get prevSibling(){const y=this._item?this._item.prev:null;return y?y.content.type:null}_integrate(y,F){super._integrate(y,F),this._prelimAttrs.forEach((R,O)=>{this.setAttribute(O,R)}),this._prelimAttrs=null}_copy(){return new YXmlElement(this.nodeName)}clone(){const y=new YXmlElement(this.nodeName),F=this.getAttributes();for(const R in F)y.setAttribute(R,F[R]);return y.insert(0,this.toArray().map(R=>R instanceof AbstractType?R.clone():R)),y}toString(){const y=this.getAttributes(),F=[],R=[];for(const B in y)R.push(B);R.sort();const O=R.length;for(let B=0;B<O;B++){const G=R[B];F.push(G+'="'+y[G]+'"')}const U=this.nodeName.toLocaleLowerCase(),K=F.length>0?" "+F.join(" "):"";return`<${U}${K}>${super.toString()}</${U}>`}removeAttribute(y){this.doc!==null?transact(this.doc,F=>{typeMapDelete(F,this,y)}):this._prelimAttrs.delete(y)}setAttribute(y,F){this.doc!==null?transact(this.doc,R=>{typeMapSet(R,this,y,F)}):this._prelimAttrs.set(y,F)}getAttribute(y){return typeMapGet(this,y)}hasAttribute(y){return typeMapHas(this,y)}getAttributes(y){return typeMapGetAll(this)}toDOM(y=document,F={},R){const O=y.createElement(this.nodeName),U=this.getAttributes();for(const K in U)O.setAttribute(K,U[K]);return typeListForEach(this,K=>{O.appendChild(K.toDOM(y,F,R))}),R!==void 0&&R._createAssociation(O,this),O}_write(y){y.writeTypeRef(YXmlElementRefID),y.writeKey(this.nodeName)}}const readYXmlElement=D=>new YXmlElement(D.readKey());class YXmlEvent extends YEvent{constructor(y,F,R){super(y,R),this.childListChanged=!1,this.attributesChanged=new Set,F.forEach(O=>{O===null?this.childListChanged=!0:this.attributesChanged.add(O)})}}class YXmlHook extends YMap{constructor(y){super(),this.hookName=y}_copy(){return new YXmlHook(this.hookName)}clone(){const y=new YXmlHook(this.hookName);return this.forEach((F,R)=>{y.set(R,F)}),y}toDOM(y=document,F={},R){const O=F[this.hookName];let U;return O!==void 0?U=O.createDom(this):U=document.createElement(this.hookName),U.setAttribute("data-yjs-hook",this.hookName),R!==void 0&&R._createAssociation(U,this),U}_write(y){y.writeTypeRef(YXmlHookRefID),y.writeKey(this.hookName)}}const readYXmlHook=D=>new YXmlHook(D.readKey());class YXmlText extends YText{get nextSibling(){const y=this._item?this._item.next:null;return y?y.content.type:null}get prevSibling(){const y=this._item?this._item.prev:null;return y?y.content.type:null}_copy(){return new YXmlText}clone(){const y=new YXmlText;return y.applyDelta(this.toDelta()),y}toDOM(y=document,F,R){const O=y.createTextNode(this.toString());return R!==void 0&&R._createAssociation(O,this),O}toString(){return this.toDelta().map(y=>{const F=[];for(const O in y.attributes){const U=[];for(const K in y.attributes[O])U.push({key:K,value:y.attributes[O][K]});U.sort((K,B)=>K.key<B.key?-1:1),F.push({nodeName:O,attrs:U})}F.sort((O,U)=>O.nodeName<U.nodeName?-1:1);let R="";for(let O=0;O<F.length;O++){const U=F[O];R+=`<${U.nodeName}`;for(let K=0;K<U.attrs.length;K++){const B=U.attrs[K];R+=` ${B.key}="${B.value}"`}R+=">"}R+=y.insert;for(let O=F.length-1;O>=0;O--)R+=`</${F[O].nodeName}>`;return R}).join("")}toJSON(){return this.toString()}_write(y){y.writeTypeRef(YXmlTextRefID)}}const readYXmlText=D=>new YXmlText;class AbstractStruct{constructor(y,F){this.id=y,this.length=F}get deleted(){throw methodUnimplemented()}mergeWith(y){return!1}write(y,F,R){throw methodUnimplemented()}integrate(y,F){throw methodUnimplemented()}}const structGCRefNumber=0;class GC extends AbstractStruct{get deleted(){return!0}delete(){}mergeWith(y){return this.constructor!==y.constructor?!1:(this.length+=y.length,!0)}integrate(y,F){F>0&&(this.id.clock+=F,this.length-=F),addStruct(y.doc.store,this)}write(y,F){y.writeInfo(structGCRefNumber),y.writeLen(this.length-F)}getMissing(y,F){return null}}class ContentBinary{constructor(y){this.content=y}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new ContentBinary(this.content)}splice(y){throw methodUnimplemented()}mergeWith(y){return!1}integrate(y,F){}delete(y){}gc(y){}write(y,F){y.writeBuf(this.content)}getRef(){return 3}}const readContentBinary=D=>new ContentBinary(D.readBuf());class ContentDeleted{constructor(y){this.len=y}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new ContentDeleted(this.len)}splice(y){const F=new ContentDeleted(this.len-y);return this.len=y,F}mergeWith(y){return this.len+=y.len,!0}integrate(y,F){addToDeleteSet(y.deleteSet,F.id.client,F.id.clock,this.len),F.markDeleted()}delete(y){}gc(y){}write(y,F){y.writeLen(this.len-F)}getRef(){return 1}}const readContentDeleted=D=>new ContentDeleted(D.readLen());class ContentDoc{constructor(y){y._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=y;const F={};this.opts=F,y.gc||(F.gc=!1),y.autoLoad&&(F.autoLoad=!0),y.meta!==null&&(F.meta=y.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new ContentDoc(this.doc)}splice(y){throw methodUnimplemented()}mergeWith(y){return!1}integrate(y,F){this.doc._item=F,y.subdocsAdded.add(this.doc),this.doc.shouldLoad&&y.subdocsLoaded.add(this.doc)}delete(y){y.subdocsAdded.has(this.doc)?y.subdocsAdded.delete(this.doc):y.subdocsRemoved.add(this.doc)}gc(y){}write(y,F){y.writeString(this.doc.guid),y.writeAny(this.opts)}getRef(){return 9}}const readContentDoc=D=>new ContentDoc(new Doc({guid:D.readString(),...D.readAny()}));class ContentEmbed{constructor(y){this.embed=y}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new ContentEmbed(this.embed)}splice(y){throw methodUnimplemented()}mergeWith(y){return!1}integrate(y,F){}delete(y){}gc(y){}write(y,F){y.writeJSON(this.embed)}getRef(){return 5}}const readContentEmbed=D=>new ContentEmbed(D.readJSON());class ContentFormat{constructor(y,F){this.key=y,this.value=F}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new ContentFormat(this.key,this.value)}splice(y){throw methodUnimplemented()}mergeWith(y){return!1}integrate(y,F){F.parent._searchMarker=null}delete(y){}gc(y){}write(y,F){y.writeKey(this.key),y.writeJSON(this.value)}getRef(){return 6}}const readContentFormat=D=>new ContentFormat(D.readString(),D.readJSON());class ContentJSON{constructor(y){this.arr=y}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new ContentJSON(this.arr)}splice(y){const F=new ContentJSON(this.arr.slice(y));return this.arr=this.arr.slice(0,y),F}mergeWith(y){return this.arr=this.arr.concat(y.arr),!0}integrate(y,F){}delete(y){}gc(y){}write(y,F){const R=this.arr.length;y.writeLen(R-F);for(let O=F;O<R;O++){const U=this.arr[O];y.writeString(U===void 0?"undefined":JSON.stringify(U))}}getRef(){return 2}}const readContentJSON=D=>{const y=D.readLen(),F=[];for(let R=0;R<y;R++){const O=D.readString();O==="undefined"?F.push(void 0):F.push(JSON.parse(O))}return new ContentJSON(F)};class ContentAny{constructor(y){this.arr=y}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new ContentAny(this.arr)}splice(y){const F=new ContentAny(this.arr.slice(y));return this.arr=this.arr.slice(0,y),F}mergeWith(y){return this.arr=this.arr.concat(y.arr),!0}integrate(y,F){}delete(y){}gc(y){}write(y,F){const R=this.arr.length;y.writeLen(R-F);for(let O=F;O<R;O++){const U=this.arr[O];y.writeAny(U)}}getRef(){return 8}}const readContentAny=D=>{const y=D.readLen(),F=[];for(let R=0;R<y;R++)F.push(D.readAny());return new ContentAny(F)};class ContentString{constructor(y){this.str=y}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new ContentString(this.str)}splice(y){const F=new ContentString(this.str.slice(y));this.str=this.str.slice(0,y);const R=this.str.charCodeAt(y-1);return R>=55296&&R<=56319&&(this.str=this.str.slice(0,y-1)+"\uFFFD",F.str="\uFFFD"+F.str.slice(1)),F}mergeWith(y){return this.str+=y.str,!0}integrate(y,F){}delete(y){}gc(y){}write(y,F){y.writeString(F===0?this.str:this.str.slice(F))}getRef(){return 4}}const readContentString=D=>new ContentString(D.readString()),typeRefs=[readYArray,readYMap,readYText,readYXmlElement,readYXmlFragment,readYXmlHook,readYXmlText],YArrayRefID=0,YMapRefID=1,YTextRefID=2,YXmlElementRefID=3,YXmlFragmentRefID=4,YXmlHookRefID=5,YXmlTextRefID=6;class ContentType{constructor(y){this.type=y}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new ContentType(this.type._copy())}splice(y){throw methodUnimplemented()}mergeWith(y){return!1}integrate(y,F){this.type._integrate(y.doc,F)}delete(y){let F=this.type._start;for(;F!==null;)F.deleted?y._mergeStructs.push(F):F.delete(y),F=F.right;this.type._map.forEach(R=>{R.deleted?y._mergeStructs.push(R):R.delete(y)}),y.changed.delete(this.type)}gc(y){let F=this.type._start;for(;F!==null;)F.gc(y,!0),F=F.right;this.type._start=null,this.type._map.forEach(R=>{for(;R!==null;)R.gc(y,!0),R=R.left}),this.type._map=new Map}write(y,F){this.type._write(y)}getRef(){return 7}}const readContentType=D=>new ContentType(typeRefs[D.readTypeRef()](D)),followRedone=(D,y)=>{let F=y,R=0,O;do R>0&&(F=createID(F.client,F.clock+R)),O=getItem(D,F),R=F.clock-O.id.clock,F=O.redone;while(F!==null&&O instanceof Item);return{item:O,diff:R}},keepItem=(D,y)=>{for(;D!==null&&D.keep!==y;)D.keep=y,D=D.parent._item},splitItem=(D,y,F)=>{const{client:R,clock:O}=y.id,U=new Item(createID(R,O+F),y,createID(R,O+F-1),y.right,y.rightOrigin,y.parent,y.parentSub,y.content.splice(F));return y.deleted&&U.markDeleted(),y.keep&&(U.keep=!0),y.redone!==null&&(U.redone=createID(y.redone.client,y.redone.clock+F)),y.right=U,U.right!==null&&(U.right.left=U),D._mergeStructs.push(U),U.parentSub!==null&&U.right===null&&U.parent._map.set(U.parentSub,U),y.length=F,U},redoItem=(D,y,F,R)=>{const O=D.doc,U=O.store,K=O.clientID,B=y.redone;if(B!==null)return getItemCleanStart(D,B);let G=y.parent._item,q,W;if(y.parentSub===null)q=y.left,W=y;else{for(q=y;q.right!==null;)if(q=q.right,q.id.client!==K)return null;q.right!==null&&(q=y.parent._map.get(y.parentSub)),W=null}if(G!==null&&G.deleted===!0&&G.redone===null&&(!F.has(G)||redoItem(D,G,F,R)===null))return null;if(G!==null&&G.redone!==null){for(;G.redone!==null;)G=getItemCleanStart(D,G.redone);for(;q!==null;){let J=q;for(;J!==null&&J.parent._item!==G;)J=J.redone===null?null:getItemCleanStart(D,J.redone);if(J!==null&&J.parent._item===G){q=J;break}q=q.left}for(;W!==null;){let J=W;for(;J!==null&&J.parent._item!==G;)J=J.redone===null?null:getItemCleanStart(D,J.redone);if(J!==null&&J.parent._item===G){W=J;break}W=W.right}for(;q!==null&&q.right!==null&&q.right!==W&&R.findIndex(J=>J===q.right)>=0;)q=q.right}const X=getState(U,K),j=createID(K,X),Z=new Item(j,q,q&&q.lastId,W,W&&W.id,G===null?y.parent:G.content.type,y.parentSub,y.content.copy());return y.redone=j,keepItem(Z,!0),Z.integrate(D,0),Z};class Item extends AbstractStruct{constructor(y,F,R,O,U,K,B,G){super(y,G.getLength()),this.origin=R,this.left=F,this.right=O,this.rightOrigin=U,this.parent=K,this.parentSub=B,this.redone=null,this.content=G,this.info=this.content.isCountable()?BIT2:0}set marker(y){(this.info&BIT4)>0!==y&&(this.info^=BIT4)}get marker(){return(this.info&BIT4)>0}get keep(){return(this.info&BIT1)>0}set keep(y){this.keep!==y&&(this.info^=BIT1)}get countable(){return(this.info&BIT2)>0}get deleted(){return(this.info&BIT3)>0}set deleted(y){this.deleted!==y&&(this.info^=BIT3)}markDeleted(){this.info|=BIT3}getMissing(y,F){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=getState(F,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=getState(F,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===ID&&this.id.client!==this.parent.client&&this.parent.clock>=getState(F,this.parent.client))return this.parent.client;if(this.origin&&(this.left=getItemCleanEnd(y,F,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=getItemCleanStart(y,this.rightOrigin),this.rightOrigin=this.right.id),(this.left&&this.left.constructor===GC||this.right&&this.right.constructor===GC)&&(this.parent=null),!this.parent)this.left&&this.left.constructor===Item&&(this.parent=this.left.parent,this.parentSub=this.left.parentSub),this.right&&this.right.constructor===Item&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===ID){const R=getItem(F,this.parent);R.constructor===GC?this.parent=null:this.parent=R.content.type}return null}integrate(y,F){if(F>0&&(this.id.clock+=F,this.left=getItemCleanEnd(y,y.doc.store,createID(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(F),this.length-=F),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let R=this.left,O;if(R!==null)O=R.right;else if(this.parentSub!==null)for(O=this.parent._map.get(this.parentSub)||null;O!==null&&O.left!==null;)O=O.left;else O=this.parent._start;const U=new Set,K=new Set;for(;O!==null&&O!==this.right;){if(K.add(O),U.add(O),compareIDs(this.origin,O.origin)){if(O.id.client<this.id.client)R=O,U.clear();else if(compareIDs(this.rightOrigin,O.rightOrigin))break}else if(O.origin!==null&&K.has(getItem(y.doc.store,O.origin)))U.has(getItem(y.doc.store,O.origin))||(R=O,U.clear());else break;O=O.right}this.left=R}if(this.left!==null){const R=this.left.right;this.right=R,this.left.right=this}else{let R;if(this.parentSub!==null)for(R=this.parent._map.get(this.parentSub)||null;R!==null&&R.left!==null;)R=R.left;else R=this.parent._start,this.parent._start=this;this.right=R}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(y)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),addStruct(y.doc.store,this),this.content.integrate(y,this),addChangedTypeToTransaction(y,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(y)}else new GC(this.id,this.length).integrate(y,0)}get next(){let y=this.right;for(;y!==null&&y.deleted;)y=y.right;return y}get prev(){let y=this.left;for(;y!==null&&y.deleted;)y=y.left;return y}get lastId(){return this.length===1?this.id:createID(this.id.client,this.id.clock+this.length-1)}mergeWith(y){if(this.constructor===y.constructor&&compareIDs(y.origin,this.lastId)&&this.right===y&&compareIDs(this.rightOrigin,y.rightOrigin)&&this.id.client===y.id.client&&this.id.clock+this.length===y.id.clock&&this.deleted===y.deleted&&this.redone===null&&y.redone===null&&this.content.constructor===y.content.constructor&&this.content.mergeWith(y.content)){const F=this.parent._searchMarker;return F&&F.forEach(R=>{R.p===y&&(R.p=this,!this.deleted&&this.countable&&(R.index-=this.length))}),y.keep&&(this.keep=!0),this.right=y.right,this.right!==null&&(this.right.left=this),this.length+=y.length,!0}return!1}delete(y){if(!this.deleted){const F=this.parent;this.countable&&this.parentSub===null&&(F._length-=this.length),this.markDeleted(),addToDeleteSet(y.deleteSet,this.id.client,this.id.clock,this.length),addChangedTypeToTransaction(y,F,this.parentSub),this.content.delete(y)}}gc(y,F){if(!this.deleted)throw unexpectedCase();this.content.gc(y),F?replaceStruct(y,this,new GC(this.id,this.length)):this.content=new ContentDeleted(this.length)}write(y,F){const R=F>0?createID(this.id.client,this.id.clock+F-1):this.origin,O=this.rightOrigin,U=this.parentSub,K=this.content.getRef()&BITS5|(R===null?0:BIT8)|(O===null?0:BIT7)|(U===null?0:BIT6);if(y.writeInfo(K),R!==null&&y.writeLeftID(R),O!==null&&y.writeRightID(O),R===null&&O===null){const B=this.parent;if(B._item!==void 0){const G=B._item;if(G===null){const q=findRootTypeKey(B);y.writeParentInfo(!0),y.writeString(q)}else y.writeParentInfo(!1),y.writeLeftID(G.id)}else B.constructor===String?(y.writeParentInfo(!0),y.writeString(B)):B.constructor===ID?(y.writeParentInfo(!1),y.writeLeftID(B)):unexpectedCase();U!==null&&y.writeString(U)}this.content.write(y,F)}}const readItemContent=(D,y)=>contentRefs[y&BITS5](D),contentRefs=[()=>{unexpectedCase()},readContentDeleted,readContentJSON,readContentBinary,readContentString,readContentEmbed,readContentFormat,readContentType,readContentAny,readContentDoc,()=>{unexpectedCase()}],structSkipRefNumber=10;class Skip extends AbstractStruct{get deleted(){return!0}delete(){}mergeWith(y){return this.constructor!==y.constructor?!1:(this.length+=y.length,!0)}integrate(y,F){unexpectedCase()}write(y,F){y.writeInfo(structSkipRefNumber),writeVarUint(y.restEncoder,this.length-F)}getMissing(y,F){return null}}const glo=typeof window<"u"?window:typeof global<"u"?global:{},importIdentifier="__ $YJS$ __";glo[importIdentifier]===!0&&console.warn("Yjs was already imported. Importing different versions of Yjs often leads to issues.");glo[importIdentifier]=!0;const Y=Object.freeze(Object.defineProperty({__proto__:null,AbstractConnector,AbstractStruct,AbstractType,Array:YArray,ContentAny,ContentBinary,ContentDeleted,ContentEmbed,ContentFormat,ContentJSON,ContentString,ContentType,Doc,GC,ID,Item,Map:YMap,PermanentUserData,RelativePosition,Snapshot,Text:YText,Transaction,UndoManager,XmlElement:YXmlElement,XmlFragment:YXmlFragment,XmlHook:YXmlHook,XmlText:YXmlText,YArrayEvent,YEvent,YMapEvent,YTextEvent,YXmlEvent,applyUpdate,applyUpdateV2,compareIDs,compareRelativePositions,createAbsolutePositionFromRelativePosition,createDeleteSet,createDeleteSetFromStructStore,createDocFromSnapshot,createID,createRelativePositionFromJSON,createRelativePositionFromTypeIndex,createSnapshot,decodeRelativePosition,decodeSnapshot,decodeSnapshotV2,decodeStateVector,diffUpdate,diffUpdateV2,emptySnapshot,encodeRelativePosition,encodeSnapshot,encodeSnapshotV2,encodeStateAsUpdate,encodeStateAsUpdateV2,encodeStateVector,encodeStateVectorFromUpdate,encodeStateVectorFromUpdateV2,equalSnapshots,findIndexSS,findRootTypeKey,getItem,getState,getTypeChildren,isDeleted,isParentOf,iterateDeletedStructs,logType,logUpdate,logUpdateV2,mergeUpdates,mergeUpdatesV2,parseUpdateMeta,parseUpdateMetaV2,readUpdate:readUpdate$1,readUpdateV2,relativePositionToJSON,snapshot,transact,tryGc,typeListToArraySnapshot,typeMapGetSnapshot},Symbol.toStringTag,{value:"Module"})),channels=new Map;class LocalStoragePolyfill{constructor(y){this.room=y,this.onmessage=null,onChange(F=>F.key===y&&this.onmessage!==null&&this.onmessage({data:fromBase64(F.newValue||"")}))}postMessage(y){varStorage.setItem(this.room,toBase64(createUint8ArrayFromArrayBuffer(y)))}}const BC=typeof BroadcastChannel>"u"?LocalStoragePolyfill:BroadcastChannel,getChannel=D=>setIfUndefined(channels,D,()=>{const y=new Set,F=new BC(D);return F.onmessage=R=>y.forEach(O=>O(R.data)),{bc:F,subs:y}}),subscribe=(D,y)=>getChannel(D).subs.add(y),unsubscribe=(D,y)=>getChannel(D).subs.delete(y),publish=(D,y)=>{const F=getChannel(D);F.bc.postMessage(y),F.subs.forEach(R=>R(y))},messageYjsSyncStep1=0,messageYjsSyncStep2=1,messageYjsUpdate=2,writeSyncStep1=(D,y)=>{writeVarUint(D,messageYjsSyncStep1);const F=encodeStateVector(y);writeVarUint8Array(D,F)},writeSyncStep2=(D,y,F)=>{writeVarUint(D,messageYjsSyncStep2),writeVarUint8Array(D,encodeStateAsUpdate(y,F))},readSyncStep1=(D,y,F)=>writeSyncStep2(y,F,readVarUint8Array(D)),readSyncStep2=(D,y,F)=>{try{applyUpdate(y,readVarUint8Array(D),F)}catch(R){console.error("Caught error while handling a Yjs update",R)}},writeUpdate=(D,y)=>{writeVarUint(D,messageYjsUpdate),writeVarUint8Array(D,y)},readUpdate=readSyncStep2,readSyncMessage=(D,y,F,R)=>{const O=readVarUint(D);switch(O){case messageYjsSyncStep1:readSyncStep1(D,y,F);break;case messageYjsSyncStep2:readSyncStep2(D,F,R);break;case messageYjsUpdate:readUpdate(D,F,R);break;default:throw new Error("Unknown message type")}return O},messagePermissionDenied=0,readAuthMessage=(D,y,F)=>{switch(readVarUint(D)){case messagePermissionDenied:F(y,readVarString(D))}},outdatedTimeout=3e4;class Awareness extends Observable{constructor(y){super(),this.doc=y,this.clientID=y.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const F=getUnixTime();this.getLocalState()!==null&&outdatedTimeout/2<=F-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const R=[];this.meta.forEach((O,U)=>{U!==this.clientID&&outdatedTimeout<=F-O.lastUpdated&&this.states.has(U)&&R.push(U)}),R.length>0&&removeAwarenessStates(this,R,"timeout")},floor(outdatedTimeout/10)),y.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(y){const F=this.clientID,R=this.meta.get(F),O=R===void 0?0:R.clock+1,U=this.states.get(F);y===null?this.states.delete(F):this.states.set(F,y),this.meta.set(F,{clock:O,lastUpdated:getUnixTime()});const K=[],B=[],G=[],q=[];y===null?q.push(F):U==null?y!=null&&K.push(F):(B.push(F),equalityDeep(U,y)||G.push(F)),(K.length>0||G.length>0||q.length>0)&&this.emit("change",[{added:K,updated:G,removed:q},"local"]),this.emit("update",[{added:K,updated:B,removed:q},"local"])}setLocalStateField(y,F){const R=this.getLocalState();R!==null&&this.setLocalState({...R,[y]:F})}getStates(){return this.states}}const removeAwarenessStates=(D,y,F)=>{const R=[];for(let O=0;O<y.length;O++){const U=y[O];if(D.states.has(U)){if(D.states.delete(U),U===D.clientID){const K=D.meta.get(U);D.meta.set(U,{clock:K.clock+1,lastUpdated:getUnixTime()})}R.push(U)}}R.length>0&&(D.emit("change",[{added:[],updated:[],removed:R},F]),D.emit("update",[{added:[],updated:[],removed:R},F]))},encodeAwarenessUpdate=(D,y,F=D.states)=>{const R=y.length,O=createEncoder();writeVarUint(O,R);for(let U=0;U<R;U++){const K=y[U],B=F.get(K)||null,G=D.meta.get(K).clock;writeVarUint(O,K),writeVarUint(O,G),writeVarString(O,JSON.stringify(B))}return toUint8Array(O)},applyAwarenessUpdate=(D,y,F)=>{const R=createDecoder(y),O=getUnixTime(),U=[],K=[],B=[],G=[],q=readVarUint(R);for(let W=0;W<q;W++){const X=readVarUint(R);let j=readVarUint(R);const Z=JSON.parse(readVarString(R)),J=D.meta.get(X),Q=D.states.get(X),ee=J===void 0?0:J.clock;(ee<j||ee===j&&Z===null&&D.states.has(X))&&(Z===null?X===D.clientID&&D.getLocalState()!=null?j++:D.states.delete(X):D.states.set(X,Z),D.meta.set(X,{clock:j,lastUpdated:O}),J===void 0&&Z!==null?U.push(X):J!==void 0&&Z===null?G.push(X):Z!==null&&(equalityDeep(Z,Q)||B.push(X),K.push(X)))}(U.length>0||B.length>0||G.length>0)&&D.emit("change",[{added:U,updated:B,removed:G},F]),(U.length>0||K.length>0||G.length>0)&&D.emit("update",[{added:U,updated:K,removed:G},F])},createMutex=()=>{let D=!0;return(y,F)=>{if(D){D=!1;try{y()}finally{D=!0}}else F!==void 0&&F()}},encodeQueryParams=D=>map(D,(y,F)=>`${encodeURIComponent(F)}=${encodeURIComponent(y)}`).join("&"),messageSync=0,messageQueryAwareness=3,messageAwareness=1,messageAuth=2,messageHandlers=[];messageHandlers[messageSync]=(D,y,F,R,O)=>{writeVarUint(D,messageSync);const U=readSyncMessage(y,D,F.doc,F);R&&U===messageYjsSyncStep2&&!F.synced&&(F.synced=!0)};messageHandlers[messageQueryAwareness]=(D,y,F,R,O)=>{writeVarUint(D,messageAwareness),writeVarUint8Array(D,encodeAwarenessUpdate(F.awareness,Array.from(F.awareness.getStates().keys())))};messageHandlers[messageAwareness]=(D,y,F,R,O)=>{applyAwarenessUpdate(F.awareness,readVarUint8Array(y),F)};messageHandlers[messageAuth]=(D,y,F,R,O)=>{readAuthMessage(y,F.doc,permissionDeniedHandler)};const reconnectTimeoutBase=1200,maxReconnectTimeout=2500,messageReconnectTimeout=3e4,permissionDeniedHandler=(D,y)=>console.warn(`Permission denied to access ${D.url}.
${y}`),readMessage=(D,y,F)=>{const R=createDecoder(y),O=createEncoder(),U=readVarUint(R),K=D.messageHandlers[U];return K?K(O,R,D,F,U):console.error("Unable to compute message"),O},setupWS=D=>{if(D.shouldConnect&&D.ws===null){const y=new D._WS(D.url);y.binaryType="arraybuffer",D.ws=y,D.wsconnecting=!0,D.wsconnected=!1,D.synced=!1,y.onmessage=F=>{D.wsLastMessageReceived=getUnixTime();const R=readMessage(D,new Uint8Array(F.data),!0);length$1(R)>1&&y.send(toUint8Array(R))},y.onclose=()=>{D.ws=null,D.wsconnecting=!1,D.wsconnected?(D.wsconnected=!1,D.synced=!1,removeAwarenessStates(D.awareness,Array.from(D.awareness.getStates().keys()).filter(F=>F!==D.doc.clientID),D),D.emit("status",[{status:"disconnected"}])):D.wsUnsuccessfulReconnects++,setTimeout(setupWS,min(log10(D.wsUnsuccessfulReconnects+1)*reconnectTimeoutBase,maxReconnectTimeout),D)},y.onopen=()=>{D.wsLastMessageReceived=getUnixTime(),D.wsconnecting=!1,D.wsconnected=!0,D.wsUnsuccessfulReconnects=0,D.emit("status",[{status:"connected"}]);const F=createEncoder();if(writeVarUint(F,messageSync),writeSyncStep1(F,D.doc),y.send(toUint8Array(F)),D.awareness.getLocalState()!==null){const R=createEncoder();writeVarUint(R,messageAwareness),writeVarUint8Array(R,encodeAwarenessUpdate(D.awareness,[D.doc.clientID])),y.send(toUint8Array(R))}},D.emit("status",[{status:"connecting"}])}},broadcastMessage=(D,y)=>{D.wsconnected&&D.ws.send(y),D.bcconnected&&D.mux(()=>{publish(D.bcChannel,y)})};class WebsocketProvider extends Observable{constructor(y,F,R,{connect:O=!0,awareness:U=new Awareness(R),params:K={},WebSocketPolyfill:B=WebSocket,resyncInterval:G=-1}={}){for(super();y[y.length-1]==="/";)y=y.slice(0,y.length-1);const q=encodeQueryParams(K);this.bcChannel=y+"/"+F,this.url=y+"/"+F+(q.length===0?"":"?"+q),this.roomname=F,this.doc=R,this._WS=B,this.awareness=U,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.wsUnsuccessfulReconnects=0,this.messageHandlers=messageHandlers.slice(),this.mux=createMutex(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=O,this._resyncInterval=0,G>0&&(this._resyncInterval=setInterval(()=>{if(this.ws){const W=createEncoder();writeVarUint(W,messageSync),writeSyncStep1(W,R),this.ws.send(toUint8Array(W))}},G)),this._bcSubscriber=W=>{this.mux(()=>{const X=readMessage(this,new Uint8Array(W),!1);length$1(X)>1&&publish(this.bcChannel,toUint8Array(X))})},this._updateHandler=(W,X)=>{if(X!==this){const j=createEncoder();writeVarUint(j,messageSync),writeUpdate(j,W),broadcastMessage(this,toUint8Array(j))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:W,updated:X,removed:j},Z)=>{const J=W.concat(X).concat(j),Q=createEncoder();writeVarUint(Q,messageAwareness),writeVarUint8Array(Q,encodeAwarenessUpdate(U,J)),broadcastMessage(this,toUint8Array(Q))},this._beforeUnloadHandler=()=>{removeAwarenessStates(this.awareness,[R.clientID],"window unload")},typeof window<"u"?window.addEventListener("beforeunload",this._beforeUnloadHandler):typeof process<"u"&&process.on("exit",()=>this._beforeUnloadHandler),U.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&messageReconnectTimeout<getUnixTime()-this.wsLastMessageReceived&&this.ws.close()},messageReconnectTimeout/10),O&&this.connect()}get synced(){return this._synced}set synced(y){this._synced!==y&&(this._synced=y,this.emit("synced",[y]),this.emit("sync",[y]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),typeof window<"u"?window.removeEventListener("beforeunload",this._beforeUnloadHandler):typeof process<"u"&&process.off("exit",()=>this._beforeUnloadHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){this.bcconnected||(subscribe(this.bcChannel,this._bcSubscriber),this.bcconnected=!0),this.mux(()=>{const y=createEncoder();writeVarUint(y,messageSync),writeSyncStep1(y,this.doc),publish(this.bcChannel,toUint8Array(y));const F=createEncoder();writeVarUint(F,messageSync),writeSyncStep2(F,this.doc),publish(this.bcChannel,toUint8Array(F));const R=createEncoder();writeVarUint(R,messageQueryAwareness),publish(this.bcChannel,toUint8Array(R));const O=createEncoder();writeVarUint(O,messageAwareness),writeVarUint8Array(O,encodeAwarenessUpdate(this.awareness,[this.doc.clientID])),publish(this.bcChannel,toUint8Array(O))})}disconnectBc(){const y=createEncoder();writeVarUint(y,messageAwareness),writeVarUint8Array(y,encodeAwarenessUpdate(this.awareness,[this.doc.clientID],new Map)),broadcastMessage(this,toUint8Array(y)),this.bcconnected&&(unsubscribe(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&this.ws.close()}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(setupWS(this),this.connectBc())}}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */var t$2;const i$2=globalThis.trustedTypes,s$1=i$2?i$2.createPolicy("lit-html",{createHTML:D=>D}):void 0,e$2=`lit$${(Math.random()+"").slice(9)}$`,o$2="?"+e$2,n$2=`<${o$2}>`,l$1=document,h$2=(D="")=>l$1.createComment(D),r$2=D=>D===null||typeof D!="object"&&typeof D!="function",d$1=Array.isArray,u=D=>{var y;return d$1(D)||typeof((y=D)===null||y===void 0?void 0:y[Symbol.iterator])=="function"},c$1=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,v=/-->/g,a=/>/g,f=/>|[ 	\n\r](?:([^\s"'>=/]+)([ 	\n\r]*=[ 	\n\r]*(?:[^ 	\n\r"'`<>=]|("|')|))|$)/g,_=/'/g,m=/"/g,g=/^(?:script|style|textarea)$/i,$$1=D=>(y,...F)=>({_$litType$:D,strings:y,values:F}),p=$$1(1),b=Symbol.for("lit-noChange"),T=Symbol.for("lit-nothing"),x=new WeakMap,w=(D,y,F)=>{var R,O;const U=(R=F==null?void 0:F.renderBefore)!==null&&R!==void 0?R:y;let K=U._$litPart$;if(K===void 0){const B=(O=F==null?void 0:F.renderBefore)!==null&&O!==void 0?O:null;U._$litPart$=K=new N(y.insertBefore(h$2(),B),B,void 0,F!=null?F:{})}return K._$AI(D),K},A=l$1.createTreeWalker(l$1,129,null,!1),C=(D,y)=>{const F=D.length-1,R=[];let O,U=y===2?"<svg>":"",K=c$1;for(let G=0;G<F;G++){const q=D[G];let W,X,j=-1,Z=0;for(;Z<q.length&&(K.lastIndex=Z,X=K.exec(q),X!==null);)Z=K.lastIndex,K===c$1?X[1]==="!--"?K=v:X[1]!==void 0?K=a:X[2]!==void 0?(g.test(X[2])&&(O=RegExp("</"+X[2],"g")),K=f):X[3]!==void 0&&(K=f):K===f?X[0]===">"?(K=O!=null?O:c$1,j=-1):X[1]===void 0?j=-2:(j=K.lastIndex-X[2].length,W=X[1],K=X[3]===void 0?f:X[3]==='"'?m:_):K===m||K===_?K=f:K===v||K===a?K=c$1:(K=f,O=void 0);const J=K===f&&D[G+1].startsWith("/>")?" ":"";U+=K===c$1?q+n$2:j>=0?(R.push(W),q.slice(0,j)+"$lit$"+q.slice(j)+e$2+J):q+e$2+(j===-2?(R.push(void 0),G):J)}const B=U+(D[F]||"<?>")+(y===2?"</svg>":"");return[s$1!==void 0?s$1.createHTML(B):B,R]};class P{constructor({strings:y,_$litType$:F},R){let O;this.parts=[];let U=0,K=0;const B=y.length-1,G=this.parts,[q,W]=C(y,F);if(this.el=P.createElement(q,R),A.currentNode=this.el.content,F===2){const X=this.el.content,j=X.firstChild;j.remove(),X.append(...j.childNodes)}for(;(O=A.nextNode())!==null&&G.length<B;){if(O.nodeType===1){if(O.hasAttributes()){const X=[];for(const j of O.getAttributeNames())if(j.endsWith("$lit$")||j.startsWith(e$2)){const Z=W[K++];if(X.push(j),Z!==void 0){const J=O.getAttribute(Z.toLowerCase()+"$lit$").split(e$2),Q=/([.?@])?(.*)/.exec(Z);G.push({type:1,index:U,name:Q[2],strings:J,ctor:Q[1]==="."?M:Q[1]==="?"?H:Q[1]==="@"?I:S})}else G.push({type:6,index:U})}for(const j of X)O.removeAttribute(j)}if(g.test(O.tagName)){const X=O.textContent.split(e$2),j=X.length-1;if(j>0){O.textContent=i$2?i$2.emptyScript:"";for(let Z=0;Z<j;Z++)O.append(X[Z],h$2()),A.nextNode(),G.push({type:2,index:++U});O.append(X[j],h$2())}}}else if(O.nodeType===8)if(O.data===o$2)G.push({type:2,index:U});else{let X=-1;for(;(X=O.data.indexOf(e$2,X+1))!==-1;)G.push({type:7,index:U}),X+=e$2.length-1}U++}}static createElement(y,F){const R=l$1.createElement("template");return R.innerHTML=y,R}}function V(D,y,F=D,R){var O,U,K,B;if(y===b)return y;let G=R!==void 0?(O=F._$Cl)===null||O===void 0?void 0:O[R]:F._$Cu;const q=r$2(y)?void 0:y._$litDirective$;return(G==null?void 0:G.constructor)!==q&&((U=G==null?void 0:G._$AO)===null||U===void 0||U.call(G,!1),q===void 0?G=void 0:(G=new q(D),G._$AT(D,F,R)),R!==void 0?((K=(B=F)._$Cl)!==null&&K!==void 0?K:B._$Cl=[])[R]=G:F._$Cu=G),G!==void 0&&(y=V(D,G._$AS(D,y.values),G,R)),y}class E{constructor(y,F){this.v=[],this._$AN=void 0,this._$AD=y,this._$AM=F}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}p(y){var F;const{el:{content:R},parts:O}=this._$AD,U=((F=y==null?void 0:y.creationScope)!==null&&F!==void 0?F:l$1).importNode(R,!0);A.currentNode=U;let K=A.nextNode(),B=0,G=0,q=O[0];for(;q!==void 0;){if(B===q.index){let W;q.type===2?W=new N(K,K.nextSibling,this,y):q.type===1?W=new q.ctor(K,q.name,q.strings,this,y):q.type===6&&(W=new L(K,this,y)),this.v.push(W),q=O[++G]}B!==(q==null?void 0:q.index)&&(K=A.nextNode(),B++)}return U}m(y){let F=0;for(const R of this.v)R!==void 0&&(R.strings!==void 0?(R._$AI(y,R,F),F+=R.strings.length-2):R._$AI(y[F])),F++}}class N{constructor(y,F,R,O){var U;this.type=2,this._$AH=T,this._$AN=void 0,this._$AA=y,this._$AB=F,this._$AM=R,this.options=O,this._$Cg=(U=O==null?void 0:O.isConnected)===null||U===void 0||U}get _$AU(){var y,F;return(F=(y=this._$AM)===null||y===void 0?void 0:y._$AU)!==null&&F!==void 0?F:this._$Cg}get parentNode(){let y=this._$AA.parentNode;const F=this._$AM;return F!==void 0&&y.nodeType===11&&(y=F.parentNode),y}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(y,F=this){y=V(this,y,F),r$2(y)?y===T||y==null||y===""?(this._$AH!==T&&this._$AR(),this._$AH=T):y!==this._$AH&&y!==b&&this.$(y):y._$litType$!==void 0?this.T(y):y.nodeType!==void 0?this.S(y):u(y)?this.M(y):this.$(y)}A(y,F=this._$AB){return this._$AA.parentNode.insertBefore(y,F)}S(y){this._$AH!==y&&(this._$AR(),this._$AH=this.A(y))}$(y){this._$AH!==T&&r$2(this._$AH)?this._$AA.nextSibling.data=y:this.S(l$1.createTextNode(y)),this._$AH=y}T(y){var F;const{values:R,_$litType$:O}=y,U=typeof O=="number"?this._$AC(y):(O.el===void 0&&(O.el=P.createElement(O.h,this.options)),O);if(((F=this._$AH)===null||F===void 0?void 0:F._$AD)===U)this._$AH.m(R);else{const K=new E(U,this),B=K.p(this.options);K.m(R),this.S(B),this._$AH=K}}_$AC(y){let F=x.get(y.strings);return F===void 0&&x.set(y.strings,F=new P(y)),F}M(y){d$1(this._$AH)||(this._$AH=[],this._$AR());const F=this._$AH;let R,O=0;for(const U of y)O===F.length?F.push(R=new N(this.A(h$2()),this.A(h$2()),this,this.options)):R=F[O],R._$AI(U),O++;O<F.length&&(this._$AR(R&&R._$AB.nextSibling,O),F.length=O)}_$AR(y=this._$AA.nextSibling,F){var R;for((R=this._$AP)===null||R===void 0||R.call(this,!1,!0,F);y&&y!==this._$AB;){const O=y.nextSibling;y.remove(),y=O}}setConnected(y){var F;this._$AM===void 0&&(this._$Cg=y,(F=this._$AP)===null||F===void 0||F.call(this,y))}}class S{constructor(y,F,R,O,U){this.type=1,this._$AH=T,this._$AN=void 0,this.element=y,this.name=F,this._$AM=O,this.options=U,R.length>2||R[0]!==""||R[1]!==""?(this._$AH=Array(R.length-1).fill(new String),this.strings=R):this._$AH=T}get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}_$AI(y,F=this,R,O){const U=this.strings;let K=!1;if(U===void 0)y=V(this,y,F,0),K=!r$2(y)||y!==this._$AH&&y!==b,K&&(this._$AH=y);else{const B=y;let G,q;for(y=U[0],G=0;G<U.length-1;G++)q=V(this,B[R+G],F,G),q===b&&(q=this._$AH[G]),K||(K=!r$2(q)||q!==this._$AH[G]),q===T?y=T:y!==T&&(y+=(q!=null?q:"")+U[G+1]),this._$AH[G]=q}K&&!O&&this.k(y)}k(y){y===T?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,y!=null?y:"")}}class M extends S{constructor(){super(...arguments),this.type=3}k(y){this.element[this.name]=y===T?void 0:y}}const k=i$2?i$2.emptyScript:"";class H extends S{constructor(){super(...arguments),this.type=4}k(y){y&&y!==T?this.element.setAttribute(this.name,k):this.element.removeAttribute(this.name)}}class I extends S{constructor(y,F,R,O,U){super(y,F,R,O,U),this.type=5}_$AI(y,F=this){var R;if((y=(R=V(this,y,F,0))!==null&&R!==void 0?R:T)===b)return;const O=this._$AH,U=y===T&&O!==T||y.capture!==O.capture||y.once!==O.once||y.passive!==O.passive,K=y!==T&&(O===T||U);U&&this.element.removeEventListener(this.name,this,O),K&&this.element.addEventListener(this.name,this,y),this._$AH=y}handleEvent(y){var F,R;typeof this._$AH=="function"?this._$AH.call((R=(F=this.options)===null||F===void 0?void 0:F.host)!==null&&R!==void 0?R:this.element,y):this._$AH.handleEvent(y)}}class L{constructor(y,F,R){this.element=y,this.type=6,this._$AN=void 0,this._$AM=F,this.options=R}get _$AU(){return this._$AM._$AU}_$AI(y){V(this,y)}}const z=window.litHtmlPolyfillSupport;z==null||z(P,N),((t$2=globalThis.litHtmlVersions)!==null&&t$2!==void 0?t$2:globalThis.litHtmlVersions=[]).push("2.0.2");const MULTI_SELECT_ALPHA=.3;function getCoordinatesWithOffset(D,y){var K,B;const F=D.getBoundingClientRect(),R=D==null?void 0:D.closest(".staff");let O=R==null?void 0:R.getBoundingClientRect(),U=window.scrollY;return{staffX:(K=O==null?void 0:O.x)!=null?K:F.x,staffY:(B=O==null?void 0:O.y)!=null?B:F.y,targetX:F.x-y.offsetWidth,targetY:F.y-y.offsetTop+U,targetBounds:F,staffBounds:O}}function hexToRgbA(D,y){var F;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(D))return F=D.substring(1).split(""),F.length==3&&(F=[F[0],F[0],F[1],F[1],F[2],F[2]]),F="0x"+F.join(""),"rgba("+[F>>16&255,F>>8&255,F&255,y||"1"].join(",")+")";throw new Error("Bad Hex")}function calculateMultiSelectCoordsWithOffset(D,y){if(!D||!Array.isArray(D)||D.length==0){console.log('Argument "selectedNotes" must be an array of elements',D);return}if(!y||!(y instanceof HTMLElement)){console.log('Argument "offsetElem" must be an HTMLElement');return}const F=D.reduce((R,O)=>{const U=O.getBoundingClientRect();return{left:Math.min(R.left,U.left),top:Math.min(R.top,U.top),right:Math.max(R.right,U.right),bottom:Math.max(R.bottom,U.bottom)}},{left:1/0,top:1/0,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY});return withScrollingAndOffset(F,y)}function withScrollingAndOffset(D,y){var O;let F=D.top+window.scrollY-document.getElementById("topnav").getBoundingClientRect().height;const R=(O=document.getElementById("waveforms-display"))==null?void 0:O.getBoundingClientRect();return R&&(F-=R.height),{left:D.left-y.offsetWidth,top:F,width:D.right-D.left,height:D.bottom-D.top}}function timeSince(D){let y=Math.floor((new Date-D)/1e3),F=y/31536e3;return F>1?Math.floor(F)+" years":(F=y/2592e3,F>1?Math.floor(F)+" months":(F=y/86400,F>1?Math.floor(F)+" days":(F=y/3600,F>1?Math.floor(F)+" hours":(F=y/60,F>1?Math.floor(F)+" minutes":Math.floor(y)+" seconds"))))}class Comment{constructor({content:y,createdAt:F,multiSelectElements:R,documentId:O,clientId:U,parentCommentId:K=null,author:B=null}){this.id=crypto.randomUUID(),this.parentCommentId=K,this.content=y,this.createdAt=F,this.multiSelectElements=R,this.documentId=O,this.clientId=U,this.author=B}toJSON(){return JSON.stringify({id:this.id,parentCommentId:this.parentCommentId,content:this.content,createdAt:this.createdAt,multiSelectElements:this.multiSelectElements,documentId:this.documentId,clientId:this.clientId,author:this.author})}toAction(){return JSON.stringify({id:this.id,parentCommentId:this.parentCommentId,content:this.content,createdAt:this.createdAt,multiSelectElements:this.multiSelectElements})}}const ACTION_TYPES={change_pitch:"change_pitch",change_chord:"change_chord",add_comment:"add_comment",undo:"undo",transpose:"transpose",connect:"connect",disconnect:"disconnect",export:"export"};class ActionPayload{constructor({type:y,content:F,username:R,course:O,filename:U}){this.type=y,this.content=F,this.username=R,this.course=O,this.filename=U}}class ActionResponse{constructor({id:y,created_at:F,type:R,content:O,username:U,course:K,filename:B}){this.id=y,this.createdAt=F,this.type=R,this.content=O,this.username=U,this.course=K,this.filename=B}static fromJSON(y){return new this(JSON.parse(y))}}function getQueryData(){var R,O;const{user:D}=yProvider.awareness.getLocalState();if(D)return{username:D.name,course:(R=D.course)!=null?R:null,filename:yProvider.roomname};let{user:y,course:F}=getURLParams();if(y)return{username:y,course:F!=null?F:null,filename:(O=yProvider.roomname)!=null?O:null}}async function sendAction(D){if(!featureIsEnabled("actions")){console.warn('Tried to send an action request, but "actions" feature is disabled. You must enable "actions" feature on features.json for actions to be sent.');return}try{const{username:y,course:F,filename:R}=getQueryData();D.username=y,D.course=F,D.filename=R;const U=await(await fetch(`${baseUrl}api/actions`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(D)})).json();console.log("Received:",U)}catch(y){console.error("Failed to send comment action",y)}}async function getActions(D={}){if(!featureIsEnabled("actions")){console.warn('Tried to send an action request, but "actions" feature is disabled. You must enable "actions" feature on features.json for actions to be sent.');return}try{const{filename:y,course:F}=getQueryData(),R=new URL(`${baseUrl}api/actions`);R.searchParams.set("filename",y),R.searchParams.set("course",F);for(let[K,B]of Object.entries(D))R.searchParams.set(K,B);const U=await(await fetch(R,{headers:{Accept:"application/json"}})).json();return console.log("Received:",U),U.map(({id:K,created_at:B,type:G,content:q,username:W,course:X,filename:j})=>new ActionResponse({id:K,created_at:B,type:G,content:q,username:W,course:X,filename:j}))}catch(y){console.error("Failed to send comment action",y)}}class CommentService{constructor(){ae(this,"_commentsList");this._commentsList=getCommentsList()}addComment({content:y,createdAt:F=new Date,multiSelectElements:R,documentId:O,clientId:U,author:K=null,parentCommentId:B=null}){let G=new Comment({content:y,createdAt:F,multiSelectElements:R,documentId:O,clientId:U,author:K,parentCommentId:B});return console.info("Adding comment to list",G),this._commentsList.push([G.toJSON()]),sendAction(new ActionPayload({type:"add_comment",content:G.toAction()})).then(()=>console.log(`Action for comment with id: ${G.id} was sent.`)).catch(()=>console.error("Failed to send comment action")),G}deleteCommentGroupById(y){const F=this.fromJSON().filter(R=>R.id===y.id||R.parentCommentId===y.id).map(R=>R.id);if(console.info("Deleting comments with ids: ",F),(F==null?void 0:F.length)>0){const R=this.fromJSON().filter(O=>!F.includes(O.id));ydoc.transact(()=>{this._commentsList.delete(0,getCommentsList().length),R.forEach(O=>this._commentsList.push([JSON.stringify(O)]))})}}deleteAll(){console.info("Deleting all comments"),this.fromJSON().map(y=>y.id),this._commentsList.delete(0,this._commentsList.length)}fromJSON(){return this._commentsList.toJSON().map(y=>JSON.parse(y))}}const handleCommentPost=async D=>{D.preventDefault();let y=D.target.querySelector('input[name="comment-text"]');console.log("You sent:",y.value);let{docId:F}=getURLParams(["docId"]),R=yProvider.awareness.getLocalState(),O=R==null?void 0:R.multiSelect;if(Array.isArray(O)&&O.length>0){const K=new CommentService().addComment({content:y.value,createdAt:new Date,multiSelectElements:O.join(","),documentId:F,clientId:yProvider.awareness.clientID,author:R.user});K&&(COMMENTS_VISIBLE||toggleCommentsVisibility(!0),commentsObserver({[K.id]:!0}))}yProvider.awareness.setLocalStateField("multiSelect",null),y.value="",$("#post-comment").modal("hide")};let commentFormTemplate=D=>p` <div class="modal-body">
    <form id="post-comment-form" @submit=${D}>
      <div class="form-group">
        <label for="comment-text" class="col-form-label">Comment:</label>
        <input
          type="text"
          class="form-control"
          id="comment-text"
          name="comment-text"
        />
      </div>
      <div class="form-group float-right">
        <button
          type="button"
          class="btn btn-secondary"
          role="button"
          data-dismiss="modal"
        >
          Close
        </button>
        <button type="submit" class="btn btn-primary" role="button">
          Post
        </button>
      </div>
    </form>
  </div>`,uiCoords={outputSVGHeight:10,set svgHeight(D){this.outputSVGHeight=typeof D=="string"?parseInt(D,10):D,w(commentSectionTemplate(this.outputSVGHeight),document.querySelector(".output-container"))},get svgHeight(){return this.outputSVGHeight}},collabTemplate=(D,...y)=>p`<div id="collab-container" style="height: ${D}px">
    ${y}
  </div>`;const multiSelectCoords=D=>{let y=0;if(featureIsEnabled("videoConference")){let O=document.getElementById("jitsi-meeting-container");O&&(y+=O.getBoundingClientRect().height)}const F=D==null?void 0:D.map(O=>"#"+O).join(",");let R=calculateMultiSelectCoordsWithOffset(Array.from(document.querySelectorAll(F)),document.querySelector("#input"));return R!=null&&R.top&&(R.top-=y),R};let commentSectionTemplate=D=>p`
    <div
      id="comments-section"
      class="col-0 h-100"
      style="min-height: 95vh; max-height: 95vh; position: relative;"
    >
      <div
        id="comments-container"
        style="height: 100vh; background-color: rgba(216, 215, 215, 0.8);"
      ></div>
    </div>
  `;function remToPixels(D){return D*parseFloat(getComputedStyle(document.documentElement).fontSize)}const svgButtonDict={comment:p`<svg
    xmlns="http://www.w3.org/2000/svg"
    id="comment-create-svg"
    width="28"
    height="28"
    fill="currentColor"
    class="bi bi-card-text"
    viewBox="0 0 16 16"
  >
    <path
      d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"
    />
    <path
      d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"
    />
  </svg>`,arrowExpand:p`<svg
    xmlns="http://www.w3.org/2000/svg"
    width="20"
    height="20"
    fill="currentColor"
    class="bi bi-arrows-angle-expand"
    viewBox="0 0 16 16"
  >
    <path
      fill-rule="evenodd"
      d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"
    />
  </svg>`,arrowRetract:p`<svg
    xmlns="http://www.w3.org/2000/svg"
    width="28"
    height="28"
    fill="currentColor"
    class="bi bi-arrows-angle-contract"
    viewBox="0 0 16 16"
  >
    <path
      fill-rule="evenodd"
      d="M.172 15.828a.5.5 0 0 0 .707 0l4.096-4.096V14.5a.5.5 0 1 0 1 0v-3.975a.5.5 0 0 0-.5-.5H1.5a.5.5 0 0 0 0 1h2.768L.172 15.121a.5.5 0 0 0 0 .707zM15.828.172a.5.5 0 0 0-.707 0l-4.096 4.096V1.5a.5.5 0 1 0-1 0v3.975a.5.5 0 0 0 .5.5H14.5a.5.5 0 0 0 0-1h-2.768L15.828.879a.5.5 0 0 0 0-.707z"
    />
  </svg>`},svgButton=D=>D in svgButtonDict?svgButtonDict[D]:null,commentButtonHandler=()=>{w(commentFormTemplate(handleCommentPost),document.querySelector("#post-comment .modal-content"))},selectAreaButtonTemplate=(D,y,F,R=null)=>{let O=2.5,U=2.5;return p`<div
    style="transform: translate(${D.left+D.width-remToPixels(O)}px, ${D.top-remToPixels(U)}px);
  width: ${O}rem; height: ${U}rem; cursor: pointer; position: absolute; pointer-events: all;"
    class="p-2 select-area-button"
    data-toggle="${y==="comment"?"modal":""}"
    data-target="${y==="comment"?"#post-comment":""}"
    data-comment-id="${R!=null?R:""}"
    @click=${F}
  >
    ${svgButton(y)}
  </div>`};let multiSelectTemplate=(D,y=!1,F,R)=>{var U;const O=multiSelectCoords(F);return p`<div
      class="multi-select-area"
      style="transform: translate(${O.left}px, ${O.top}px); width: ${O.width}px; height:${O.height}px; background-color: ${(U=hexToRgbA(R,MULTI_SELECT_ALPHA))!=null?U:"rgba(0, 0, 255, 0.09)"};"
      data-client-id=${D}
    ></div>
    ${y?selectAreaButtonTemplate(O,"comment",commentButtonHandler):null}`},selectAreaTemplate=(D,y,F,R,O=!0)=>p`<div
  id="select-area"
  ?hidden=${O}
  style="transform: translate(${D}px, ${y}px);
    width: ${F}px; height: ${R}px;"
></div>`;class RubberBandSelection{constructor(y){ae(this,"coords",{left:0,top:0,right:0,bottom:0});ae(this,"offsetCoords",{left:0,top:0,right:0,bottom:0});ae(this,"isSelecting",!1);ae(this,"selectAreaElem",document.querySelector("#select-area"));this.coords=y!=null?y:this.coords}setUpperCoords(y){this.coords.left=y.clientX,this.coords.top=y.clientY,this.offsetCoords.left=y.offsetX,this.offsetCoords.top=y.offsetY}setLowerCoords(y){this.coords.right=y.clientX,this.coords.bottom=y.clientY,this.offsetCoords.right=y.offsetX,this.offsetCoords.bottom=y.offsetY}updateElemPosition(){let{left:y,top:F,right:R,bottom:O}=this.coords,U=Math.min(y,R),K=Math.max(y,R),B=Math.min(F,O),G=Math.max(F,O);return this.renderSelectArea(),{left:U,top:B,right:K,bottom:G}}renderSelectArea(){let{left:y,top:F,right:R,bottom:O}=this.offsetCoords,U=Math.min(y,R),K=Math.max(y,R),B=Math.min(F,O),G=Math.max(F,O),q=document.querySelector("#collab-container");q&&w(selectAreaTemplate(U,B,K-U,G-B,!1),q)}reCalculateCoords(){return this.coords=this.updateElemPosition()}resetCoords(){this.coords={left:0,top:0,right:0,bottom:0},this.updateElemPosition()}show(){this.updateElemPosition()}hide(){let y=document.querySelector("#collab-container");y&&w(selectAreaTemplate(0,0,0,0,!0),y)}selectNoteElements(y){return y.filter(F=>{const R=F.getBoundingClientRect();return this.coords.left<=R.left&&this.coords.top<=R.top&&this.coords.right>=R.right&&this.coords.bottom>=R.bottom})}}let contextMenu=(D,y,F,R,O)=>p`
    <div class="dropup btn-group" style="pointer-events: bounding-box">
      <div
        id=${"dropdownMenuButton-"+y}
        class="users-div btn dropdown-toggle p-0"
        data-toggle="dropdown"
        aria-expanded="false"
        style="transform: translate(${F}px, ${R-30}px)"
        data-client-id=${D}
        data-ref-id=${y}
      >
        You
      </div>

      <div
        class="dropdown-menu p-0 border border-rounded shadow"
        aria-labelledby=${"dropdownMenuButton-"+y}
        @click=${O}
      >
        <div class="w-100 d-flex flex-column">
          <a
            id=${"add-comment-"+y}
            class="context-menu-dropdown-item text-decoration-none text-reset p-1 border-bottom border-secondary"
            href="#"
            data-toggle="modal"
            data-target="#post-comment"
            >Add Comment</a
          >
          <a
            class="context-menu-dropdown-item text-decoration-none text-reset p-1 border-bottom border-secondary"
            id=${"details-"+y}
            href="#"
            data-toggle="popover"
            >Element details</a
          >
          <!-- <a
            class="context-menu-dropdown-item text-decoration-none text-reset p-1"
            id=${"history-"+y}
            href="#"
            data-toggle="popover"
            >History</a
          > -->
        </div>
      </div>
    </div>
  `,simpleIndicator=(D,y,F,R,O)=>p`<div
    class="users-div"
    style="transform: translate(${F}px, ${document.querySelector(".dropup.btn-group")?R-50:R-25}px)"
    data-client-id=${D}
    data-ref-id=${y}
  >
    ${O}
  </div> `,userAwarenessTemplate=(D,y,F)=>{let R=document.getElementById(y);if(!R)return p`<div class="users-div"></div>`;let O;const U=G=>{console.log("click",{target:G.target});let q=G.target.id;if(/^details/.test(q))O||(O=formatUserElem(R),$(`#${q}`).popover({container:"body",placement:"auto",content:()=>Object.entries(JSON.parse(O).attrs).map(([W,X])=>`<div>${W}: ${X}</div>`).join(`
`),html:!0}),$(`#${q}`).popover("show"),console.log({details:JSON.parse(O)}));else if(/^add-comment/.test(q)){const W=multiSelectCoords([y]);console.log(W),w(commentFormTemplate(handleSingleComment([y])),document.querySelector("#post-comment .modal-content")),COMMENTS_VISIBLE||toggleCommentsVisibility(!0)}else if(/^history/.test(q)){let X=getAceEditor().getSession().getUndoManager();console.log(X.$undoStack),console.log({elemRefId:y});let[,j,Z,J]=y.match(/-.*L(\d+)F(\d+)S?(\d+)?/);j=parseInt(j,10)-1;for(let Q of X.$undoStack)Q[0].start.row==j&&Q[0].end.row==j&&console.log("change for element line",Q)}else console.log("Element does not have id")},{targetX:K,targetY:B}=getCoordinatesWithOffset(R,document.querySelector("#input"));return p`${D==yProvider.awareness.clientID?contextMenu(D,y,K,B,U):simpleIndicator(D,y,K,B,F)}`},singleSelectTemplate=(D,y,F)=>{let R=document.getElementById(y);if(!R)return p`<div class="single-select"></div>`;const{staffY:O,targetX:U,targetY:K,targetBounds:B}=getCoordinatesWithOffset(R,document.querySelector("#input"));return p`<div
    class="single-select"
    style="transform: translate(${U}px, ${K}px);
    width: ${Math.abs(B.x-B.right)}px;
    height: ${Math.abs(O-B.bottom)}px;
    background-color: ${F}"
    data-client-id=${D}
    data-ref-id=${y}
  ></div>`};const handleSingleComment=(D,y)=>async F=>{F.preventDefault();let R=F.target.querySelector('input[name="comment-text"]');console.log("You sent:",R.value);let{docId:O}=getURLParams(["docId"]);if(Array.isArray(D)&&D.length>0){let{user:U}=yProvider.awareness.getLocalState();const B=new CommentService().addComment({content:R.value,createdAt:new Date,multiSelectElements:D.join(","),documentId:O,clientId:yProvider.awareness.clientID,author:U});B&&commentsObserver({[B.id]:!0})}yProvider.awareness.setLocalStateField("multiSelect",null),R.value="",$("#post-comment").modal("hide")};/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const t$1={ATTRIBUTE:1,CHILD:2,PROPERTY:3,BOOLEAN_ATTRIBUTE:4,EVENT:5,ELEMENT:6},e$1=D=>(...y)=>({_$litDirective$:D,values:y});class i$1{constructor(y){}get _$AU(){return this._$AM._$AU}_$AT(y,F,R){this._$Ct=y,this._$AM=F,this._$Ci=R}_$AS(y,F){return this.update(y,F)}update(y,F){return this.render(...F)}}/**
 * @license
 * Copyright 2018 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const o$1=e$1(class extends i$1{constructor(D){var y;if(super(D),D.type!==t$1.ATTRIBUTE||D.name!=="class"||((y=D.strings)===null||y===void 0?void 0:y.length)>2)throw Error("`classMap()` can only be used in the `class` attribute and must be the only part in the attribute.")}render(D){return" "+Object.keys(D).filter(y=>D[y]).join(" ")+" "}update(D,[y]){var F,R;if(this.st===void 0){this.st=new Set,D.strings!==void 0&&(this.et=new Set(D.strings.join(" ").split(/\s/).filter(U=>U!=="")));for(const U in y)y[U]&&!(!((F=this.et)===null||F===void 0)&&F.has(U))&&this.st.add(U);return this.render(y)}const O=D.element.classList;this.st.forEach(U=>{U in y||(O.remove(U),this.st.delete(U))});for(const U in y){const K=!!y[U];K===this.st.has(U)||((R=this.et)===null||R===void 0?void 0:R.has(U))||(K?(O.add(U),this.st.add(U)):(O.remove(U),this.st.delete(U)))}return b}});let userListTemplate=D=>p`
    <ul class="user-connection-status-list">
      ${D.map(y=>onlineUserTemplate(y))}
    </ul>`,onlineUserTemplate=D=>{let y={"online-status":D.online,"offline-status":!D.online};return p`<li
    class="user-connection-status-item"
    >
      <img
      src=${D.image}
      alt="user profile icon"
      width="55"
      height="55"
      style="border-radius: 50%;"
      />
      <span class=${o$1(y)}></span>
      <span style="color:white;">${D.name}</span>
    </li>`};const renderUserList=D=>{const y=document.getElementById("online-users");y&&(w(p`${userListTemplate(D)}`,y),$('[data-toggle="tooltip"]').tooltip())};let highlightLayerTemplate=(D,...y)=>p`<div id="highlight-container" style="height: ${D}px">
    ${y}
  </div>`;function highlightTemplate(D,{left:y,top:F,width:R,height:O},U={}){let K=D.id in U&&U[D.id];const B={"highlight-area-focus":K},G=()=>{let q=Array.from(document.querySelectorAll(".highlight-area"));if((q==null?void 0:q.length)!=0){q.filter(X=>X.dataset.commentId!=D.id).forEach(X=>X.classList.remove("highlight-area-focus"));let W=q.find(X=>X.dataset.commentId==D.id);if(W){K=W.classList.toggle("highlight-area-focus");const X=K?{[D.id]:!0}:{};commentsObserver(X)}}};return p`
    <div
      class="highlight-area highlight-color ${o$1(B)}"
      style="left: ${y}px; top: ${F}px; width: ${R}px; height:${O}px;"
      data-comment-id=${D.id}
      tabindex="0"
    ></div>
    ${selectAreaButtonTemplate({top:F,left:y,width:R,height:O},K?"arrowRetract":"arrowExpand",G,D.id)}
  `}const fixedCommentReplyContainerTemplate=D=>(D==null?void 0:D.length)==0?null:p` <div
    id="comment-reply-container"
    class="comment-group-container new-comment-reply-container shadow"
    ?hidden=${!COMMENTS_VISIBLE}
  >
    ${D.map(y=>singleComment(y))}
    ${(D==null?void 0:D.length)>0?replyForm(D):null}
  </div>`,singleComment=D=>{const y=()=>{var K;const U=new CommentService;(K=document.querySelector(`#comment-${D.id}`))==null||K.classList.add("deleted-single-comment"),setTimeout(()=>{U.deleteCommentGroupById(D),D.parentCommentId?commentsObserver({[D.parentCommentId]:!0}):commentsObserver()},200)},{user:F}=yProvider.awareness.getLocalState(),R=()=>F.name===D.author.name?p`<div>
          <button type="button" class="btn btn-danger" @click=${y}>
            X
          </button>
        </div>`:null;let O=timeSince(new Date(D.createdAt));return p`<div
    id=${"comment-"+D.id}
    class="comment w-100 p-2 mb-2 border-bottom new-single-comment"
  >
    <div class="d-inline-flex justify-content-between w-100 mb-3">
      <div class="d-flex justify-content-between w-100">
        <div class="d-inline-flex flex-column ml-2">
          <h5 class="m-0">${D.author.name}</h5>
          <small class="text-muted font-italic"
            >${O.charAt(0)==="0"?"Now":O+" ago"}</small
          >
        </div>
        ${R()}
      </div>
    </div>
    <p class="card-text px-2 mb-1">${D.content}</p>
  </div>`},replyForm=D=>p`
    <div>
      <form
        id="comment-reply-form"
        @submit=${F=>{var G;F.preventDefault();const R=Object.fromEntries(new FormData(F.target)),O=F.target["comment-reply"],U=D.slice(0)[0];let{user:K}=yProvider.awareness.getLocalState();new CommentService().addComment({content:R["comment-reply"],createdAt:new Date,parentCommentId:U.id,multiSelectElements:U.multiSelectElements,documentId:U.documentId,clientId:U.clientId,author:K}),O.value="",(G=document.getElementById("comment-reply-form"))==null||G.scrollIntoView(),commentsObserver({[U.id]:!0})}}
        class="form-inline"
      >
        <div class="form-group">
          <input
            class="form-control"
            type="text"
            id="comment-reply"
            name="comment-reply"
          />
        </div>

        <button class="btn btn-primary ml-2">Reply</button>
      </form>
    </div>
  `,chordEditor=document.getElementById("chord-editor"),chordBtns=document.getElementById("show-edit-suggest-buttons"),editBtn=document.getElementById("edit-btn"),suggestBtn=document.getElementById("suggest-btn"),doneBtn=document.getElementById("done-btn"),backBtn=document.getElementById("back-btn");let chord={current:null,new:{root:null,accidental:null,variation:null},reharmonize:!1},chordLocation={},isEditing;const GJTBaseUrl="https://maxim.mus.auth.gr:6001/sending_kern";function showChordEditor(){chordBtns.style.visibility="hidden",$("#show-chord-editor").modal("show"),doneBtn.style.display="none",isEditing||(backBtn.style.display="none")}function setURLParams(D,y){for(let[F,R]of Object.entries(y))typeof R=="object"&&R!==null?setURLParams(D,R):D.searchParams.set(`${F}`,`${R}`)}function cleanUpSelections(){Object.values(chord.new).forEach(D=>null),decolorizeSelections()}function select(D,y){D.style.color="tomato",chord.new[y]=D.innerText,yProvider.awareness.setLocalStateField("chordEdit",{isDisplayed:!0,selection:{component:y,text:D.innerText}}),chord.new.root&&chord.new.variation&&(doneBtn.style.display="block")}function decolorizeSelections(D){let y;D?y=document.querySelectorAll(`td.${D}`):y=document.querySelectorAll("#chord-editor td");for(let F of y)F.style.color="white"}function mapChord(chordText,mapType){const mapping=eval(`${mapType}_mapping`);console.log(mapping);const encodingsInc=[...Object.keys(mapping)].filter(D=>chordText.includes(D));return encodingsInc.forEach(D=>chordText=chordText.replace(D,`${mapping[D]}`)),chordText}function requestChordEdit(D,y){const F=new XMLHttpRequest;F.open("GET",D),F.responseType="json",F.send(),F.onload=function(){var K;let R=F.response;console.log(R);const O=mapChord(chord.current,"display"),U=chord.new.root+mapChord(`${(K=chord.new.accidental)!=null?K:""} `+chord.new.variation,"send");sendAction(new ActionPayload({type:"change_chord",content:JSON.stringify({prevValue:O,newValue:U})})).then(()=>console.log("change_chord action was sent.")).catch(()=>console.error("Failed to send change_chord action")),y.setValue(R.new)}}function editChord(){var K;const D=getAceEditor();if(!D)throw new Error("Ace Editor is undefined");const y=D.session.getValue();let F=new URL(GJTBaseUrl);this==suggestBtn&&(chord.reharmonize=!0),setURLParams(F,{kernfile:y,chordLocation,chord}),requestChordEdit(F,D);const O=mapChord(chord.current,"display"),U=chord.new.root+mapChord(`${(K=chord.new.accidental)!=null?K:""} `+chord.new.variation,"send");sendAction(new ActionPayload({type:"change_chord",content:JSON.stringify({prevValue:O,newValue:U})})).then(()=>console.log("change_chord action was sent.")).catch(()=>console.error("Failed to send change_chord action")),this==suggestBtn?(chord.reharmonize=!1,chordBtns.style.display="none"):this==doneBtn&&(cleanUpSelections(),yProvider.awareness.setLocalStateField("chordEdit",{isDisplayed:!1,selection:null}))}chordEditor.addEventListener("click",D=>{if(D.target.tagName!=="TD"||!isEditing)return;const[y,F]=[D.target,D.target.className];decolorizeSelections(F),select(y,F)});backBtn.addEventListener("click",function(D){cleanUpSelections(),D.isTrusted&&yProvider.awareness.setLocalStateField("chordEdit",{isDisplayed:!1,selection:null}),isEditing=!1});editBtn.addEventListener("click",D=>{isEditing=!0,showChordEditor(),yProvider.awareness.setLocalStateField("chordEdit",{isDisplayed:!0,selection:null})});suggestBtn.addEventListener("click",editChord);doneBtn.addEventListener("click",editChord);/**
 * @license
 * Copyright 2020 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const t=D=>D===null||typeof D!="object"&&typeof D!="function",r$1=D=>D.strings===void 0;/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const e=(D,y)=>{var F,R;const O=D._$AN;if(O===void 0)return!1;for(const U of O)(R=(F=U)._$AO)===null||R===void 0||R.call(F,y,!1),e(U,y);return!0},o=D=>{let y,F;do{if((y=D._$AM)===void 0)break;F=y._$AN,F.delete(D),D=y}while((F==null?void 0:F.size)===0)},n$1=D=>{for(let y;y=D._$AM;D=y){let F=y._$AN;if(F===void 0)y._$AN=F=new Set;else if(F.has(D))break;F.add(D),l(y)}};function r(D){this._$AN!==void 0?(o(this),this._$AM=D,n$1(this)):this._$AM=D}function h$1(D,y=!1,F=0){const R=this._$AH,O=this._$AN;if(O!==void 0&&O.size!==0)if(y)if(Array.isArray(R))for(let U=F;U<R.length;U++)e(R[U],!1),o(R[U]);else R!=null&&(e(R,!1),o(R));else e(this,D)}const l=D=>{var y,F,R,O;D.type==t$1.CHILD&&((y=(R=D)._$AP)!==null&&y!==void 0||(R._$AP=h$1),(F=(O=D)._$AQ)!==null&&F!==void 0||(O._$AQ=r))};class d extends i$1{constructor(){super(...arguments),this._$AN=void 0}_$AT(y,F,R){super._$AT(y,F,R),n$1(this),this.isConnected=y._$AU}_$AO(y,F=!0){var R,O;y!==this.isConnected&&(this.isConnected=y,y?(R=this.reconnected)===null||R===void 0||R.call(this):(O=this.disconnected)===null||O===void 0||O.call(this)),F&&(e(this,y),o(this))}setValue(y){if(r$1(this._$Ct))this._$Ct._$AI(y,this);else{const F=[...this._$Ct._$AH];F[this._$Ci]=y,this._$Ct._$AI(F,this,0)}}disconnected(){}reconnected(){}}/**
 * @license
 * Copyright 2021 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */class s{constructor(y){this.U=y}disconnect(){this.U=void 0}reconnect(y){this.U=y}deref(){return this.U}}class i{constructor(){this.Y=void 0,this.q=void 0}get(){return this.Y}pause(){var y;(y=this.Y)!==null&&y!==void 0||(this.Y=new Promise(F=>this.q=F))}resume(){var y;(y=this.q)===null||y===void 0||y.call(this),this.Y=this.q=void 0}}/**
 * @license
 * Copyright 2017 Google LLC
 * SPDX-License-Identifier: BSD-3-Clause
 */const n=D=>!t(D)&&typeof D.then=="function";class h extends d{constructor(){super(...arguments),this._$Cft=1073741823,this._$Cwt=[],this._$CG=new s(this),this._$CK=new i}render(...y){var F;return(F=y.find(R=>!n(R)))!==null&&F!==void 0?F:b}update(y,F){const R=this._$Cwt;let O=R.length;this._$Cwt=F;const U=this._$CG,K=this._$CK;this.isConnected||this.disconnected();for(let B=0;B<F.length&&!(B>this._$Cft);B++){const G=F[B];if(!n(G))return this._$Cft=B,G;B<O&&G===R[B]||(this._$Cft=1073741823,O=0,Promise.resolve(G).then(async q=>{for(;K.get();)await K.get();const W=U.deref();if(W!==void 0){const X=W._$Cwt.indexOf(G);X>-1&&X<W._$Cft&&(W._$Cft=X,W.setValue(q))}}))}return b}disconnected(){this._$CG.disconnect(),this._$CK.pause()}reconnected(){this._$CG.reconnect(this),this._$CK.resume()}}const c=e$1(h),queryParams={actionType:"null",pageSize:20,lastActionId:null},actionHeaderFilters=()=>p`
    <form>
      <div class="form-group row align-items-center">
        <label for="action-type" class="col-sm-4 p-0 my-0 mr-0 ml-2"
          >Action Type:</label
        >
        <select
          name="action-type"
          required
          class="form-control col-sm-7"
          @change=${y=>{let F=y.target.value;F&&(queryParams.actionType=F,queryParams.lastActionId=null,actions.splice(0,actions.length),renderActions())}}
        >
          <option selected value="null">all</option>
          ${Object.values(ACTION_TYPES).map(y=>p`<option value=${y}>
                <div class="badge badge-primary">${y.replace("_"," ")}</div>
              </option>`)}
        </select>
      </div>
    </form>
  `,actionPanelHeaderTemplate=()=>p`<div
    class="card border-bottom border-top-0 border-right-0 border-left-0"
  >
    <div class="card-header py-0">
      <button
        type="button"
        class="btn btn-lg"
        data-toggle="collapse"
        data-target="#header-collapse"
        aria-expanded="false"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-chevron-down"
          viewBox="0 0 16 16"
        >
          <path
            fill-rule="evenodd"
            d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"
          />
        </svg>
      </button>
      <button
        class="btn btn-lg action-history-close font-weight-bold float-right"
        type="button"
        @click=${()=>{var y;(y=document.getElementById("action-history-container"))==null||y.classList.remove("open")}}
      >
        X
      </button>
    </div>
    <div
      id="header-collapse"
      class="collapse"
      aria-labelledby="heading-header-collapse"
    >
      <div class="card-body">${actionHeaderFilters()}</div>
    </div>
  </div>`;function formatDate(D){if(D===null)return null;let y=new Date(D).toString();if(y==="Invalid Date")return null;let F=Date.parse(y);if(Date.now()-F>1e3*60*60*24){const U=y.split(" ");return`${U[1]} ${U[2]} ${U[3]}, ${U[4]}`}const O=timeSince(F);return(O[0]==="1"?O.slice(0,O.length-1):O)+" ago"}const actionEntry=(D,y)=>{const F={"badge-success":D.type==="connect","badge-danger":D.type==="disconnect","badge-primary":D.type!=="connect"&&D.type!=="disconnect"},R=formatDate(D.createdAt),O=D.type.split("_").join(" "),U=()=>{var K;try{console.log({content:D.content});const B=D.content;if(B===null){console.log("Failed to parse action content from server");return}switch(D.type){case"add_comment":{const G=(K=B.multiSelectElements)==null?void 0:K.split(",").map(X=>"#"+X),q=document.querySelectorAll(G.join(",")),W=multiSelectCoords(B.multiSelectElements.split(","));console.log({elems:q,coords:W});break}}}catch(B){console.error("Faile to parse action content from server",B)}};return p`
    <div class="card border-bottom border-top-0 border-right-0 border-left-0">
      <div class="card-header action-entry-header" id=${"heading"+D.id}>
        <h2 class="mb-0">
          <button
            class="action-history-btn btn text-left d-flex align-items-baseline"
            type="button"
            data-toggle="collapse"
            data-target=${"#collapse-action-"+D.id}
            aria-expanded="true"
            aria-controls=${"#collapse-action-"+D.id}
            data-action-id=${D.id}
            @click=${U}
          >
            <div style="flex: 0 0 20ch;">
              <div style="font-size: 1.1rem;">
                <span
                  class="user-color-index mr-1"
                  style="background-color: ${y[D.username]};"
                ></span
                >${D.username}
              </div>
              <div class="text-muted">${R}</div>
            </div>

            <div class="badge ${o$1(F)}">${O}</div>
          </button>
        </h2>
      </div>

      <div
        id=${"collapse-action-"+D.id}
        class="collapse"
        aria-labelledby=${"heading"+D.id}
        data-parent="#action-history-accordion"
      >
        <div class="card-body">
          Some placeholder content for the first accordion panel. This panel is
          shown by default, thanks to the <code>.show</code> class.
          <div>${D.id}</div>
        </div>
      </div>
    </div>
  `};let actions=[];const actionHistoryTemplate=D=>{const y=()=>{renderActions();const O=document.getElementById("action-history-container"),U=document.getElementById("action-history-accordion");O.scrollBy(0,U.getBoundingClientRect().height)},F=getActions(queryParams).then(O=>(Array.isArray(O)&&O.length>0&&(queryParams.lastActionId=O[O.length-1].id,actions=actions.concat(O),console.log({queryParams,actions})),p`${actions.map(U=>p`${actionEntry(U,D)}`)}
      <div>
        <button @click=${y} class="btn btn-primary w-100">
          <h5>Load more</h5>
          <div class="text-small">(${actions.length} loaded)</div>
        </button>
      </div>`)),R=p`
    <div class="d-flex justify-content-center mt-3">
      <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  `;return p`${c(F,R)}`},renderActions=()=>{const y=Array.from(yProvider.awareness.getStates().values()).map(O=>O.user).reduce((O,U)=>U.name in O?O:{...O,[U.name]:U.color},{}),F=document.getElementById("action-history-accordion"),R=document.getElementById("action-history-header");F&&(w(actionPanelHeaderTemplate(),R),w(actionHistoryTemplate(y),F))},collabMenuSideBar=()=>{let D=COMMENTS_VISIBLE?"Hide Comments":"Show Comments";return p`
      <ul class="collab-menu-toolbar-list">
        <li class="collab-menu-toolbar-item d-flex justify-content-center">
          <button
            class="btn btn-outline-light p-3 rounded-lg w-75 d-inline-flex"
            @click=${()=>{D=toggleCommentsVisibility()?"Hide Comments":"Show Comments",renderCollabMenuSidebar()}}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="currentColor"
              class="bi bi-card-text"
              viewBox="0 0 16 16"
            >
              <path
                d="M14.5 3a.5.5 0 0 1 .5.5v9a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h13zm-13-1A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13z"
              />
              <path
                d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"
              />
            </svg>
            <span class="ml-1 text-nowrap">${D}</span>
          </button>
        </li>
        <li class="collab-menu-toolbar-item d-flex justify-content-center">
          <button
            class="btn btn-outline-light p-3 rounded-lg w-75 d-flex"
            @click=${()=>{var O;((O=document.getElementById("action-history-container"))==null?void 0:O.classList.toggle("open"))&&renderActions()}}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="currentColor"
              class="bi bi-clock-history"
              viewBox="0 0 16 16"
            >
              <path
                d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z"
              />
              <path
                d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z"
              />
              <path
                d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z"
              />
            </svg>
            <span class="ml-1 text-nowrap">Action History</span>
          </button>
        </li>
      </ul>
    </div>`},renderCollabMenuSidebar=()=>{const D=document.getElementById("collab-actions-buttons");D&&w(p`${collabMenuSideBar()}`,D)};let prevStates;function formatUserElem(D){const[,y,F,R,O,U]=D.classList,K={};return K.attrs=formatAttributes({qOn:y,qOff:F,pitchName:R,accidental:O,octave:U}),JSON.stringify(K,null,2)}function formatAttributes(D){let y=parseQuarterTime(D.qOn),R=parseQuarterTime(D.qOff)-y;switch(R){case .25:R="1/4";break;case .5:R="1/2";break;case 1:case 2:case 4:R=R.toString();break}let O=D.accidental.split("-")[1];switch(O){case"n":O="natural";break;case"s":O="sharp";break;case"f":O="flat";break;case"ff":O="double flat";break;case"ss":O="double sharp";break}return{duration:R,pitch:D.pitchName.split("-")[1],accidental:O,octave:D.octave.split("-")[1]}}function parseQuarterTime(D){let[y,F]=D.split(/\D/).filter(Boolean);return y=parseInt(y,10),D.includes("_")?y/F:y}function shareChordEdit(D){const[,{chordEdit:{selection:y},user:{color:F,name:R}}]=D;if(!y)return;const{component:O,text:U}=y;if(console.log(O+" "+U+" "+F+" "+R),!isEditing){const K=Array.from(document.querySelectorAll(`.${O}`)),B=K.find(q=>q.innerText==U);console.log(K);const G=K.find(q=>q.classList.contains("collab-selected"));G&&($(".collab-selected").popover("dispose"),G.classList.remove("collab-selected"),G.style.color="white"),B.style.color=F,B.classList.add("collab-selected"),$(".collab-selected").popover({placement:"top",content:`${R}`}),$(".collab-selected").popover("show")}}function wrapChordEdit(){isEditing?setTimeout(()=>{yProvider.awareness.setLocalStateField("chordEdit",{isDisplayed:null,selection:null})},1500):($(".collab-selected").css("color","white"),$(".collab-selected").popover("dispose"),$(".collab-selected").removeClass("collab-selected"),$("#show-chord-editor").modal("hide"))}function toggleChordEditor(D){let y,F=D.find(([R,O])=>{var U;return typeof((U=O.chordEdit)==null?void 0:U.isDisplayed)=="boolean"});if(F)y=F[1].chordEdit.isDisplayed;else return;if(!y)wrapChordEdit();else if(!isEditing)return showChordEditor(),F}function defaultClients(){return{added:[],updated:[],removed:[]}}function stateChangeHandler(D=defaultClients()){var B;const y=Array.from(yProvider.awareness.getStates().entries());let F=document.querySelector("#output #collab");F||(console.log("Element div#collab is not found. Cannot render collaboration elements."),F=document.createElement("div"),F.id="collab",(B=document.querySelector("#output"))==null||B.prepend(F));let R=p`${y.filter(([G,q])=>{var W;return q.multiSelect!=null&&((W=q==null?void 0:q.user)==null?void 0:W.color)!=null}).map(([G,q])=>multiSelectTemplate(G,G===yProvider.awareness.clientID,q.multiSelect,q.user.color))}`,O=p`${y.filter(([G,q])=>{var W,X;return((W=q==null?void 0:q.singleSelect)==null?void 0:W.elemId)!=null&&((X=q==null?void 0:q.user)==null?void 0:X.color)!=null}).map(([G,q])=>singleSelectTemplate(G,q.singleSelect.elemId,q.user.color))}`,U=p`${y.filter(([G,q])=>{var W,X;return((W=q==null?void 0:q.singleSelect)==null?void 0:W.elemId)!=null&&((X=q==null?void 0:q.user)==null?void 0:X.name)!=null}).map(([G,q])=>userAwarenessTemplate(G,q.singleSelect.elemId,q.user.name))}`;const K=toggleChordEditor(y);K&&shareChordEdit(K),w(p`${collabLayer(R,O,U)}`,F),renderCollabMenuSidebar()}function awaranessUpdateHandler(){const D=formatUserList();renderUserList(D)}function formatUserList(){const D=yProvider.awareness.getStates(),y=[...D.entries()].map(R=>R=R[1].user);if(y.forEach(R=>R.online=!0),!prevStates)return prevStates=[...D],y;const F=prevStates.filter(R=>!D.has(R[0])).map(R=>R=R[1].user);return F.forEach(R=>R.online=!1),prevStates=[...D],[...y,...F]}function collabLayer(...D){var F;document.querySelector("#output");let y=document.querySelector("#output > svg");return uiCoords.svgHeight=(F=y==null?void 0:y.height.baseVal.value)!=null?F:window.innerHeight,collabTemplate(uiCoords.svgHeight,...D)}function commentsObserver(D={}){var B;let y=document.querySelector("#output #comments-layer");y||(y=document.createElement("div"),y.id="comments-layer",(B=document.querySelector("#output"))==null||B.prepend(y));let R=new CommentService().fromJSON(),O=p`${COMMENTS_VISIBLE?R.filter(G=>G.parentCommentId===null).map(G=>({comment:G,coords:multiSelectCoords(G.multiSelectElements.split(","))})).map(G=>highlightTemplate(G.comment,G.coords,D)):null}`;const U=findCommentGroupForFocusedElement(D,R),K=(U==null?void 0:U.length)>0?fixedCommentReplyContainerTemplate(U):null;w(renderHighlightLayer(O,K),y)}function findCommentGroupForFocusedElement(D,y){if(typeof D<"u"){const O=y.find(U=>U.id===Object.keys(D)[0]);if(O){const U=y.filter(K=>K.parentCommentId===O.id);return[].concat(O,U)}}const F=document.querySelector(".highlight-area-focus");if(!F)return[];const R=y.find(O=>O.id===(F==null?void 0:F.dataset.commentId));if(R){const O=y.filter(U=>U.parentCommentId===R.id);return[].concat(R,O)}}function renderHighlightLayer(...D){var O;let y=document.querySelector("#output"),F=document.querySelector("#output > svg");y.querySelector("#collab-container");let R=(O=F==null?void 0:F.height.baseVal.value)!=null?O:window.innerHeight;return highlightLayerTemplate(R,...D)}function addListenersToOutput(D){let y,F,R=!1;const O=new RubberBandSelection;console.log(">>>Adding listeners to output"),document.addEventListener("mousedown",U=>{if(U.target.nodeName!="svg")return;y=performance.now(),O.isSelecting=!0,O.setUpperCoords(U),[...document.querySelectorAll(".multi-select-area")].find(G=>G.dataset.clientId==yProvider.awareness.clientID)&&yProvider.awareness.setLocalStateField("multiSelect",null)}),document.addEventListener("mousemove",U=>{O.isSelecting&&(F=performance.now(),F-y>=300&&(O.setLowerCoords(U),O.show(),R=!0))}),document.addEventListener("mouseup",()=>{var U,K;if(O.reCalculateCoords(),O.isSelecting=!1,R){const B=Array.from(document.querySelectorAll(".note, .beam")),G=O.selectNoteElements(B);setNoteBounds(G);const q=G.map(W=>W.id).filter(W=>/^note/g.test(W));q.length>0&&((U=yProvider==null?void 0:yProvider.awareness)==null||U.setLocalStateField("multiSelect",q),(K=yProvider==null?void 0:yProvider.awareness)==null||K.setLocalStateField("singleSelect",null)),R=!1}O.resetCoords(),O.hide(),y=F=void 0})}function createNoteBounds(){let D=null,y=null;return{setBounds(F,R){F&&(D=F),R&&(y=R)},getBounds(){return{leftMost:D,rightMost:y}}}}let noteBounds=createNoteBounds();function setNoteBounds(D){if(D.length>0){let y=[...D].map(O=>O.classList.contains("beam")?O.querySelector(".note"):O),{leftMost:F,rightMost:R}=findLeftMostAndRightMost(y);F&&R&&noteBounds.setBounds(F,R),console.log({leftMost:F,rightMost:R}),F&&(global_cursor.CursorNote=F)}}function findLeftMostAndRightMost(D){let y=D[0],F=D[0];for(let R of D.slice(1)){let O=R.getBoundingClientRect();O.left<(y==null?void 0:y.getBoundingClientRect().left)&&(y=R),O.left>(F==null?void 0:F.getBoundingClientRect().left)&&(F=R)}return{leftMost:y,rightMost:F}}const simpleDiffString=(D,y)=>{let F=0,R=0;for(;F<D.length&&F<y.length&&D[F]===y[F];)F++;if(F!==D.length||F!==y.length)for(;R+F<D.length&&R+F<y.length&&D[D.length-R-1]===y[y.length-R-1];)R++;return{index:F,remove:D.length-F-R,insert:y.slice(F,y.length-R)}};class AceBinding{constructor(y,F,R,{yUndoManager:O=null}={}){const U=createMutex(),K=y.doc;if(this.mux=U,this.type=y,this.doc=K,this.ace=F,this.ace.session.getUndoManager().reset(),this.yUndoManager=O,O){O.trackedOrigins.add(this);const B=()=>{O.undo()},G=()=>{O.redo()};this.ace.commands.addCommand({name:"undo",bindKey:{win:"Ctrl-Z",mac:"Command-Z"},exec:B}),this.ace.commands.addCommand({name:"redo",bindKey:{win:"Ctrl-Y",mac:"Command-Y"},exec:G}),O.on("stack-item-added",this._onStackItemAdded),O.on("stack-item-popped",this._onStackItemPopped)}this.awareness=R,this._typeObserver=B=>{const G=this.ace.getSession().getDocument();let q=this.ace.session.$undoManager.startNewGroup();U(()=>{const W=B.delta;let X=0;for(const j of W)if(j.retain)X+=j.retain;else if(j.insert){const Z=G.indexToPosition(X,0);G.insert(Z,j.insert),X+=j.insert.length}else if(j.delete){const Z=G.indexToPosition(X,0),J=G.indexToPosition(X+j.delete,0),Q=new Range(Z.row,Z.column,J.row,J.column);G.remove(Q)}}),this.ace.session.$undoManager.markIgnored(q)},y.observe(this._typeObserver),this._aceObserver=(B,G)=>{const q=this.ace.getSession().getDocument();U(()=>{this.type.doc.transact(()=>{if(B.lines.length>1){const W=simpleDiffString(this.type.toString(),q.getValue());console.log(">>>Ace Observer: diff",{diff:W}),this.type.delete(W.index,W.remove),this.type.insert(W.index,W.insert)}else if(B.action==="insert"){const W=q.positionToIndex(B.start,0);y.insert(W,B.lines.join(`
`))}else if(B.action==="remove"){const W=q.positionToIndex(B.start,0),X=B.lines.join(`
`).length;y.delete(W,X)}y.applyDelta(B)},this)})},this.ace.session.on("change",this._aceObserver)}_onStackItemPopped(y){}_onStackItemAdded(y){}destroy(){console.log("destroyed"),this.type.unobserve(this._typeObserver),this.ace.off("change",this._aceObserver),this.yUndoManager&&(this.yUndoManager.off("stack-item-added",this._onStackItemAdded),this.yUndoManager.off("stack-item-popped",this._onStackItemPopped),this.yUndoManager.trackedOrigins.delete(this))}}/*! js-cookie v3.0.1 | MIT */function assign(D){for(var y=1;y<arguments.length;y++){var F=arguments[y];for(var R in F)D[R]=F[R]}return D}var defaultConverter={read:function(D){return D[0]==='"'&&(D=D.slice(1,-1)),D.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(D){return encodeURIComponent(D).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function init(D,y){function F(O,U,K){if(!(typeof document>"u")){K=assign({},y,K),typeof K.expires=="number"&&(K.expires=new Date(Date.now()+K.expires*864e5)),K.expires&&(K.expires=K.expires.toUTCString()),O=encodeURIComponent(O).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var B="";for(var G in K)!K[G]||(B+="; "+G,K[G]!==!0&&(B+="="+K[G].split(";")[0]));return document.cookie=O+"="+D.write(U,O)+B}}function R(O){if(!(typeof document>"u"||arguments.length&&!O)){for(var U=document.cookie?document.cookie.split("; "):[],K={},B=0;B<U.length;B++){var G=U[B].split("="),q=G.slice(1).join("=");try{var W=decodeURIComponent(G[0]);if(K[W]=D.read(q,W),O===W)break}catch{}}return O?K[O]:K}}return Object.create({set:F,get:R,remove:function(O,U){F(O,"",assign({},U,{expires:-1}))},withAttributes:function(O){return init(this.converter,assign({},this.attributes,O))},withConverter:function(O){return init(assign({},this.converter,O),this.attributes)}},{attributes:{value:Object.freeze(y)},converter:{value:Object.freeze(D)}})}var api=init(defaultConverter,{path:"/"});const names=["Michael","John","Jim","Maria","Nick","Jake","Isabella","Kate"],colors=["#30bced","#6eeb83","#ffbc42","#ecd444","#ee6352","#9ac2c9","#8acb88","#1be7ff"];function setUserImageUrl(){const{id:D}=getURLParams(),y="https://musicolab.hmu.gr";return D?new URL(`/moodle/pluginfile.php/${D}/user/icon/fordson/f2`,y).toString():new URL("/images/defaultUser.svg",y).toString()}const oneOf=D=>D[Math.floor(Math.random()*D.length)];let name=oneOf(names),userData={name,color:oneOf(colors),image:setUserImageUrl()},yProvider,ydoc,yUndoManager,permanentUserData,binding;async function setupCollaboration(){var D;if(typeof ydoc>"u"&&(ydoc=new Doc,ydoc.getArray("comments").observe(F=>{var K,B,G,q,W,X,j;const R=document.querySelector(".highlight-area-focus"),O=(X=(W=(q=(G=(B=(K=F==null?void 0:F.changes)==null?void 0:K.added)==null?void 0:B.values())==null?void 0:G.next())==null?void 0:q.value)==null?void 0:W.content)==null?void 0:X.arr;if((O==null?void 0:O.length)>0){const Z=JSON.parse(O[0]);if((Z==null?void 0:Z.parentCommentId)&&Z.parentCommentId===((j=R==null?void 0:R.dataset)==null?void 0:j.commentId)){commentsObserver({[Z.parentCommentId]:!0});return}}const U=R?{[R.dataset.commentId]:!0}:{};commentsObserver(U)})),typeof yProvider>"u"){const{file:y,user:F,course:R,id:O}=getURLInfo();let K=(D=new URLSearchParams(y).get("f"))!=null?D:"test-room";permanentUserData=new PermanentUserData(ydoc),permanentUserData.setUserMapping(ydoc,ydoc.clientID,F),yProvider=new WebsocketProvider(wsBaseUrl,K,ydoc,{params:{username:F,file:y,course:R!=null?R:null}}),yProvider.on("status",G=>{console.log(G.status),G.status==="connected"?document.title=document.title.replace("\u{1F534}","\u{1F7E2}"):G.status==="disconnected"&&(document.title=document.title.replace("\u{1F7E2}","\u{1F534}"))});const B=getAceEditor();if(!B)throw new Error("Ace Editor is undefined");yUndoManager=new UndoManager(ydoc.getText("ace"),{captureTimeout:100}),binding=new AceBinding(ydoc.getText("ace"),B,yProvider.awareness,{yUndoManager}),yProvider.on("synced",G=>{var W,X;console.log("Yjs content was synced with the WebSocket server");const q=Number((X=(W=getAceEditor())==null?void 0:W.getSession())==null?void 0:X.getLength());!Number.isNaN(q)&&q<10&&loadFileFromURLParam().then(j=>{console.log(`Editor content was nearly empty. Fetched and initialized editor from repository with: ${j}`)})}),yProvider.awareness.on("change",stateChangeHandler),yProvider.awareness.on("update",awaranessUpdateHandler),setUserAwarenessData(F,R)}window.example={yProvider,ydoc,type:ydoc.getText("ace")},window.awareness=yProvider.awareness,window.yUndoManager=yUndoManager,window.binding=binding,window.Y=Y,window.permanentUserData=permanentUserData}function getCommentsList(){return ydoc.getArray("comments")}function setUserAwarenessData(D,y){let F=api.get("user");if(F){let R=JSON.parse(F);R.name||(R.name=R.email.split("@")[0]),yProvider.awareness.setLocalStateField("user",{...R,color:oneOf(colors)});return}D&&(userData.name=D,userData.course=y),yProvider.awareness.setLocalStateField("user",userData)}const ACCEPTED_FORMATS=".xml,.musicxml,.mei,.krn";function openFileFromDisk(){let D=document.getElementById("file-input");D||(D=document.createElement("input"),D.setAttribute("id","file-input"),D.setAttribute("type","file"),D.setAttribute("accept",".xml,.musicxml,.mei,.krn"),D.style.display="none",D.addEventListener("change",y=>{if(y.target.files.length==0)return;let F=y.target.files[0],R=F.name.slice(F.name.lastIndexOf("."));if(!ACCEPTED_FORMATS.split(",").includes(R)){console.error("The format of this file is not supported");return}let O=new FileReader;O.addEventListener("load",U=>{let K=U.target.result.toString();getAceEditor().session.setValue(K)}),O.readAsText(F)}),document.body.appendChild(D)),D.click()}async function saveContentAsMIDI(){let D=await getVrvWorker().renderToMidi(),y="data:audio/midi;base64,"+D,F=document.createElement("a");F.setAttribute("download","data.mid"),F.style.display="none",F.setAttribute("href",y),document.body.appendChild(F),F.click(),document.body.removeChild(F)}function exportKernToPrivateFiles(){var B;const D=(B=getAceEditor())==null?void 0:B.session.getValue();if(D===void 0||D.length===0){console.error("Failed to export empty Kern content");return}const{file:y}=getURLInfo();let F=y;const R=sessionStorage.getItem("score-metadata");R===null?console.warn("Could not find metadata for this score. Using URL filename as title."):F=JSON.parse(R).title+".krn";let O=new FormData,U=new File([D],F);O.append("f",U),O.append("action","upload"),O.append("ufolder","private");const K=new XMLHttpRequest;K.addEventListener("load",()=>{alert("File has been exported to your private files!")}),K.addEventListener("error",()=>{alert("Failed to export score to your private files")}),K.open("post","https://musicolab.hmu.gr/apprepository/uploadFileResAjax.php",!0),K.send(O)}async function loadFileFromURLParam(){var F;let D=new URLSearchParams(window.location.search);if(!D.has("file"))return;let y;if(y=await loadFileFromRepository(atob(D.get("file"))),y)return(F=getAceEditor())==null||F.session.setValue(y),featureIsEnabled("collaboration")&&yUndoManager.clear(),D.get("file")}async function promptForFile(){var R;let D=new URLSearchParams(window.location.search),y=D.has("file")?atob(D.get("file")):"",F=window.prompt("Enter the URL of a krn file:",y);try{let O=await loadFileFromRepository(F);O.length>0&&((R=getAceEditor())==null||R.session.setValue(O))}catch{}}async function loadFileFromRepository(D){if(!isValidHttpUrl(D)||!D.endsWith(".krn"))return Promise.reject("Invalid repository URL");try{return await(await fetch(D)).text()}catch(y){console.log(y)}}function isValidHttpUrl(D){let y;try{y=new URL(D)}catch{return!1}return y.protocol==="http:"||y.protocol==="https:"}function getURLParams(D=[]){return Object.fromEntries(new URLSearchParams(window.location.search))}function getURLInfo(){let D=getURLParams(),y=atob(D==null?void 0:D.file);if(y&&isValidHttpUrl(y)){let F=Object.fromEntries(new URL(y).searchParams);y=`f=${F.f}&u=${F.u}`,console.log({file:y,p:F})}return{...D,file:y}}const isSecure=(D="https")=>window.location.protocol.includes(D);let productionOrigin="musicolab.hmu.gr:8080/",baseUrl=`${isSecure()?"https":"http"}://${productionOrigin}`,wsBaseUrl=`${isSecure()?"wss":"ws"}://${productionOrigin}`;function keysEqual(D,y){let F=Object.keys(D).sort(),R=Object.keys(y).sort();if(F.length!==R.length)return!1;for(let O=0;O<F.length;O++)if(F[O]!==R[O])return!1;return!0}const FeatureConfig={score:!1,collaboration:!1,videoConference:!1,soundEditor:!1,actions:!1};let featureForm=document.getElementById("feature-form");featureForm.querySelectorAll('input[type="checkbox"]');function createFeatureToggler(D=FeatureConfig){let y=Object.assign({},D);return{setFeature(F,R){let O;return F in y||(O=new Error(`Feature ${F} not found on feature config ${JSON.stringify(y,null,2)}`)),typeof R!="boolean"&&(O=new Error("Value must be boolean")),new Promise((U,K)=>{O&&K(O);let B=y[F];y[F]=R,U({config:y,changed:B!=R?{[F]:R}:null})})},featureIsEnabled(F){return y[F]}}}let useConfigFile=keysEqual(CONFIG,FeatureConfig);const featureToggler=createFeatureToggler(useConfigFile?CONFIG:FeatureConfig);useConfigFile&&bootstrap().then(()=>console.log("Loaded features from file configuration"));function featureIsEnabled(D){return featureToggler.featureIsEnabled(D)}function getCollabStatus(){const{course:D,collab:y}=getURLInfo();return typeof D=="string"&&D.length>0&&y!=="false"?{enable:!0,reason:`course search parameter specified with value: ${D}`}:typeof y<"u"?{enable:y==="true",reason:`collab search parameter specified with value: ${y}`}:{enable:featureToggler.featureIsEnabled("collaboration"),reason:'Relevant search parameters not specified. Falling back to "features.json" config file'}}async function bootstrap(){featureToggler.featureIsEnabled("score")&&handleScore();const D=getCollabStatus();if(console.log(D.reason),D.enable?(await featureToggler.setFeature("collaboration",!0),handleCollabSetup()):await featureToggler.setFeature("collaboration",!1),featureToggler.featureIsEnabled("videoConference")){let{default:y}=await __vitePreload(()=>import("./index.ea5eed30.js"),[]);handleVideoConfSetup(y)}featureToggler.featureIsEnabled("soundEditor")}function showCommentsInNav(){var D;(D=document.getElementById("comments__menu-item"))==null||D.classList.remove("hidden")}function handleScore(){let D=document.getElementById("score-editor");if(!D){console.error("Score editor element was not found. Check index.html");return}D.style.display="block"}function handleCollabSetup(){console.log("Setting up collaboration feature"),setupCollaboration(),addListenersToOutput(),showCommentsInNav()}function handleVideoConfSetup(D){D.setup()}let COMMENTS_VISIBLE=!1;function toggleCommentsVisibility(D){if(!featureIsEnabled("collaboration")){console.log("Collaboration feature must be enabled to show comments");return}if(typeof D<"u"){COMMENTS_VISIBLE=D,commentsObserver();return}return COMMENTS_VISIBLE=!COMMENTS_VISIBLE,commentsObserver(),COMMENTS_VISIBLE}window.bts=bootstrap;window.FeatureConfig=FeatureConfig;window.toggler=featureToggler;var LASTLINE=-1,DELAY=600;function play_midi(D){D=D||0,D==0,DELAY=600;let y=getVrvWorker();if(!y)throw new Error("Verovio worker is undefined");y.renderToMidi().then(function(F){var R="data:audio/midi;base64,"+F;console.log("Midi song",R),$("#play-button").hide(),$("#midiPlayer_play").show(),$("#midiPlayer_stop").show(),$("#midiPlayer_pause").show(),$("#player").show(),$("#player").midiPlayer.play(R,D),global_playerOptions.PLAY=!0,LASTLINE=-1,document.getElementById("bpm_show").setAttribute("hidden",!0)}).catch(F=>console.log("Error when trying to play midi",F))}var ids=[];const midiUpdate=function(D){let y=getVrvWorker();if(!y)throw new Error("Verovio worker is undefined");var F=Math.max(0,D-DELAY);y.getElementsAtTime(F).then(function(R){var q,W;var O;if(R.page>0&&(R.page!=y.page&&(y.page=R.page,loadPage()),R.notes.length>0&&ids!=R.notes)){if(ids.forEach(function(X){if($.inArray(X,R.notes)==-1){var j=document.querySelector("#"+X);j&&j.classList.remove("highlight")}}),ids=R.notes,ids.includes((W=(q=noteBounds.getBounds())==null?void 0:q.rightMost)==null?void 0:W.id)){console.log("Stopping MIDI player"),window.midiPlayerStop(),midiStop();return}var U=document.querySelector("#output"),K=U.getBoundingClientRect(),B=!1,G=1/3;ids.forEach(function(X){if(O=X.match(/-L(\d+)/)){var j=parseInt(O[1]);j!=LASTLINE&&j>LASTLINE&&(showIdInEditor(X),LASTLINE=j)}var Z=document.querySelector("#"+X);if(Z&&(Z.classList.add("highlight"),!B)){let J=Z.closest(".system"),Q,ee=J.nextElementSibling;if(J){Q=J.getBoundingClientRect();let oe,re,ne,te;ee?(ee.nextElementSibling,oe=ee.getBoundingClientRect(),re=Q.top,ne=oe.top,te=ne-re):(re=Q.top,ne=Q.bottom,te=ne-re),re<K.top?(U.scrollTop=U.scrollTop-(K.top-re)-te*G,B=!0):ne>K.bottom&&(U.scrollTop=U.scrollTop+(re-K.top)-K.height/20,B=!0)}}})}})};window.midiUpdate=midiUpdate;const midiStop=function(){ids.forEach(function(y){var F=document.querySelector("#"+y);if(F){for(var R=F.getAttribute("class"),O=R.split(" "),U="",K=0;K<O.length;K++)O[K]!="highlight"&&(U+=" "+O[K]);F.setAttribute("class",U)}}),document.querySelectorAll(".highlight").forEach(y=>y.classList.remove("highlight")),$("#player").hide(),$("#play-button").show(),global_cursor.CursorNote=null,global_playerOptions.PLAY=!1,LASTLINE=-1,document.getElementById("bpm_show").removeAttribute("hidden")};$.fn.addClassSVG=function(D){return $(this).attr("class",function(y,F){return F+" "+D}),this};$.fn.removeClassSVG=function(D){return $(this).attr("class",function(y,F){}),this};let vrvWorker$6;function getVrvWorker(){return typeof vrvWorker$6>"u"&&downloadVerovioToolkit("true"),vrvWorker$6}function downloadVerovioToolkit(D){console.log("Downloading vrv toolkit from humdrum-notation-plugin-worker.js"),vrvWorker$6=new vrvInterface(D,callbackAfterInitialized)}function callbackAfterInitialized(){console.log("Initialized verovio worker"),initializeVerovioToolkit()}function initializeVerovioToolkit(){let D=getAceEditor();D?(D.session.on("change",function(y){monitorNotationUpdating()}),D.getSession().selection.on("changeCursor",function(){const{row:y,column:F}=D.selection.getCursor(),R=humdrumDataNoteIntoView(y,F);if(((R==null?void 0:R.classList.contains("note"))||(R==null?void 0:R.classList.contains("harm")))&&featureIsEnabled("collaboration")&&yProvider){const U=yProvider.awareness.getLocalState();yProvider.awareness.setLocalState({...U,singleSelect:{elemId:R.id},multiSelect:null})}})):console.log("Warning: Editor not setup yet"),$(window).resize(function(){displayNotation()}),$("#input").mouseup(function(){let y=$(this);(y.outerWidth()!=y.data("x")||y.outerHeight()!=y.data("y"))&&applyZoom(),y.data("x",y.outerWidth()),y.data("y",y.outerHeight())}),global_interface.ShowingIndex||(console.log("Score will be displayed after verovio has finished loading"),displayNotation()),initializeWildWebMidi()}function initializeWildWebMidi(){$("#player").midiPlayer({color:null,onUnpdate:midiUpdate,onStop:midiStop,width:250}),$("#input").keydown(function(){stop()}),window.addEventListener("blur",function(){window.pause()})}function vrvInterface(D,y){this.WIDTH=0,this.HEIGHT=0,this.page=1,this.pageCount=0,this.options={},this.initialized=!1,this.usingWorker=D,D?this.createWorkerInterface(y):this.createDefaultInterface(y)}vrvInterface.prototype.createWorkerInterface=function(D){var y=this;function F(O){switch(O.data.method){case"ready":y.initialized=!0,D();break;default:for(;y.resolvedIdx<=O.data.idx;)y.resolvedIdx===O.data.idx?O.data.success?y.promises[y.resolvedIdx].deferred.resolve(O.data.result):y.promises[y.resolvedIdx].deferred.reject(O.data.result):y.promises[y.resolvedIdx].deferred.reject(),y.promises[y.resolvedIdx].method==="renderData"&&(y.renderDataPending--,y.renderDataPending===0&&y.handleWaitingRenderData()),delete y.promises[y.resolvedIdx],y.resolvedIdx++}}console.log("creating verovio worker interface"),this.promises={},this.promiseIdx=0,this.resolvedIdx=0,this.renderDataPending=0,this.renderDataWaiting=null,this.worker=null;var R=this;try{console.log("Loading production Verovio Worker"),R.worker=new Worker("/apprepository/vhvWs/assets/verovio-worker-prod.79dfb3f9.js"),R.worker.addEventListener("message",F),R.worker.onerror=function(O){O.preventDefault(),console.log(O)}}catch(O){console.log(O)}};vrvInterface.prototype.checkInitialized=function(){if(!this.initialized)throw"Verovio toolkit not (yet) initialized"};vrvInterface.prototype.filterData=function(D,y,F){return this.execute("filterData",arguments)};vrvInterface.prototype.renderData=function(D,y,F){return this.options=D,this.execute("renderData",arguments)};vrvInterface.prototype.getHumdrum=function(){var D=this.execute("getHumdrum",arguments);return D};vrvInterface.prototype.redoLayout=function(D,y,F){return this.options=D,this.execute("redoLayout",arguments)};vrvInterface.prototype.renderPage=function(D){return this.execute("renderPage",arguments)};vrvInterface.prototype.renderAllPages=function(D,y){return this.execute("renderAllPages",arguments)};vrvInterface.prototype.gotoPage=function(D){var y=this;return this.execute("gotoPage",arguments).then(function(F){return y.page=F.page,y.pageCount=F.pageCount,D})};vrvInterface.prototype.getMEI=function(D){return this.execute("getMEI",arguments)};vrvInterface.prototype.renderToMidi=function(){var D=this.execute("renderToMidi",arguments);return D};vrvInterface.prototype.getElementsAtTime=function(D){return this.execute("getElementsAtTime",arguments)};vrvInterface.prototype.getTimeForElement=function(D){return this.execute("getTimeForElement",arguments)};vrvInterface.prototype.execute=function(D,y){var F=this;if(this.usingWorker){var R=Array.prototype.slice.call(y);switch(D){case"renderData":return F.postRenderData(D,R);default:return F.handleWaitingRenderData(),F.post(D,R)}}else return new RSVP.Promise(function(O,U){try{F.checkInitialized(),O(F.verovio[D].apply(F.verovio,y))}catch(K){U(K)}})};vrvInterface.prototype.handleWaitingRenderData=function(){this.renderDataWaiting&&(this.postDeferredMessage("renderData",this.renderDataWaiting.args,this.renderDataWaiting.deferred),this.renderDataWaiting=null,this.renderDataPending++)};vrvInterface.prototype.postRenderData=function(D,y){return this.renderDataPending>0?(this.renderDataWaiting||(this.renderDataWaiting={deferred:new RSVP.defer}),this.renderDataWaiting.args=y,this.renderDataWaiting.deferred.promise):(this.renderDataPending++,this.renderDataWaiting=null,this.post(D,y))};vrvInterface.prototype.post=function(D,y){return this.postDeferredMessage(D,y,new RSVP.defer)};vrvInterface.prototype.postDeferredMessage=function(D,y,F){return this.worker.postMessage({idx:this.promiseIdx,method:D,args:y}),this.promises[this.promiseIdx]={method:D,deferred:F},this.promiseIdx++,F.promise};function HnpMarkup(){return this.clear(),this}HnpMarkup.prototype.clear=function(){this.clearSvgInfo()};HnpMarkup.prototype.clearSvgInfo=function(){this.m_svg=new HnpSvg};HnpMarkup.prototype.loadSvg=function(D){let y=this.m_svg.loadSvg(D);return y||console.warn("Warning: could not load SVG image"),y};HnpMarkup.prototype.getMeasure=function(D){return this.m_svg?this.m_svg.getMeasure(D):null};HnpMarkup.prototype.getMeasureElement=function(D){if(!this.m_svg)return null;let y=this.m_svg.getMeasure(D);return!y||typeof y.element>"u"?null:y.element};HnpMarkup.prototype.getLowerSystemMarkupElement=function(){return this.m_svg.getLowerSystemMarkupElement()};HnpMarkup.prototype.getLowerMeasureMarkupElement=function(){return this.m_svg.getLowerMeasureMarkupElement()};HnpMarkup.prototype.highlightMeasure=function(D){let y,F,R,O;if(typeof D=="number"?(y=D,F="goldenrod",R=.25,O=1):typeof D=="string"?(y=parseInt(D),F="goldenrod",R=.25,O=1):(y=D.measure||1,F=D.color||"goldenrod",R=D.opacity||.25,typeof D.padding<"u"?O=D.padding:O=1),y<0)return null;let U=this.getMeasure(y);if(!U)return null;let K=U.getX(),B=U.getY(),G=U.getWidth(),q=U.getHeight(),W=U.getVuScale();O>0&&W>0&&(K=K-O*W,B=B-O*W,G=G+2*O*W,q=q+2*O*W);let X=document.createElementNS("http://www.w3.org/2000/svg","rect");X.setAttribute("x",K),X.setAttribute("y",B),X.setAttribute("width",G),X.setAttribute("height",q),X.setAttribute("fill",F),X.setAttribute("opacity",R);let j=this.getLowerMeasureMarkupElement();return j?(j.appendChild(X),X):null};function HnpSvg(){return this.clear(),this}HnpSvg.prototype.clear=function(){this.element=null,this.svgSystems=[],this.svgSystemMeasures=[],this.svgMeasures=[],this.pagemargin=null,this.lowerMarkupElement=null,this.lowerSystemMarkupElement=null,this.lowerMeasureMarkupElement=null};HnpSvg.prototype.loadSvg=function(D){if(this.clear(),typeof D=="string"){let R=document.querySelector(D);if(!R)return console.warn("Warning: Selector for SVG element is invalid",D),!1;D=R}if(!D)return console.warn("Warning: SVG element not found"),!1;if(D.nodeName!=="svg")return console.warn("Warning: SVG element is not an SVG element:",D),!1;this.element=D;let F=D.querySelectorAll('g[id^="system-"].system');if(!F)return console.warn("Warning: no systems in SVG image"),!1;this.svgSystems=[];for(let R=0;R<F.length;R++){let O={};O.element=F[R],this.svgSystems.push(O)}this.svgSystemMeasures=[];for(let R=0;R<this.svgSystems.length;R++){let U=this.svgSystems[R].element.querySelectorAll('g[id^="measure-"].measure'),K=[];if(this.svgSystemMeasures.push(K),!!U)for(let B=0;B<U.length;B++){let G=new HnpSvgMeasure;G.element=U[B],G.systemIndex=R,G.systemMeasureIndex=B,G.m_setMeasureNumber(),K.push(G)}}this.svgMeasures=[];for(let R=0;R<this.svgSystemMeasures.length;R++){let O=this.svgSystemMeasures[R];for(let U=0;U<O.length;U++)O[U].measureIndex=this.svgMeasures.length,this.svgMeasures.push(O[U])}this.measures={};for(let R=0;R<this.svgMeasures.length;R++){let O=this.svgMeasures[R],U=O.number,K=this.measures[U];K||(this.measures[U]=[]),K=this.measures[U],K.push(O)}return this.m_insertLowerMarkupLayer(),!0};HnpSvg.prototype.m_insertLowerMarkupLayer=function(){if(!this.element){console.warn("Error: no SVG image");return}let D=this.element,y=D.querySelector(".page-margin");if(!y){console.warn("Error: invalid SVG image",D);return}this.pagemargin=y;let F=y.firstElementChild,R=F.classList,O=!1;for(let K=0;K<R.length;K++)if(R[K]==="lowerMarkupLayer"){O=!0;break}if(O)this.lowerMarkupElement=F;else{let K=document.createElementNS("http://www.w3.org/2000/svg","g");F.parentNode.prepend(K),K.classList.add("lowerMarkupLayer"),this.lowerMarkupElement=K}this.lowerMarkupElement.innerHTML="";let U;U=document.createElementNS("http://www.w3.org/2000/svg","g"),U.classList.add("lowerSystemMarkups"),this.lowerMarkupElement.appendChild(U),this.lowerSystemMarkupElement=U,U=document.createElementNS("http://www.w3.org/2000/svg","g"),U.classList.add("lowerMeasureMarkups"),this.lowerMarkupElement.appendChild(U),this.lowerMeasureMarkupElement=U};HnpSvg.prototype.getLowerSystemMarkupElement=function(){return this.lowerSystemMarkupElement?this.lowerSystemMarkupElement:null};HnpSvg.prototype.getLowerMeasureMarkupElement=function(){return this.lowerMeasureMarkupElement?this.lowerMeasureMarkupElement:null};HnpSvg.prototype.getMeasure=function(D){if(typeof D>"u"){console.log("Warning: no bar number given as input.");return}return this.measures?(typeof D=="string"&&(D=parseInt(D)),this.measures[D][0]):null};function HnpSvgMeasure(){return this.clear(),this}HnpSvgMeasure.prototype.clear=function(){delete this.element,delete this.number};HnpSvgMeasure.prototype.getMeasureNumber=function(){return typeof this.number<"u"?this.number:(this.m_setMeasureNumber(),this.number)};HnpSvgMeasure.prototype.getMeasureElement=function(){return typeof this.element<"u"?this.element:null};HnpSvgMeasure.prototype.m_setMeasureNumber=function(){if(typeof this.number<"u")return this.number;let D=-1,y=this.element;if(!y)return D;let F=y.classList;for(let R=0;R<F.length;R++){let O=F[R].match(/m-(\d+)/);if(O){D=parseInt(O[1]);break}}return this.number=D,D};HnpSvgMeasure.prototype.getX=function(){return typeof this.x<"u"?this.x:(this.m_setMeasureInfo(),this.x)};HnpSvgMeasure.prototype.getY=function(){return typeof this.y<"u"?this.y:(this.m_setMeasureInfo(),this.y)};HnpSvgMeasure.prototype.getHeight=function(){return typeof this.height<"u"?this.height:(this.m_setMeasureInfo(),this.height)};HnpSvgMeasure.prototype.getWidth=function(){return typeof this.width<"u"?this.width:(this.m_setMeasureInfo(),this.width)};HnpSvgMeasure.prototype.getVuScale=function(){return typeof this.vu<"u"?this.vu:(this.m_setMeasureInfo(),this.vu)};HnpSvgMeasure.prototype.m_setMeasureInfo=function(){if(typeof this.x<"u")return!1;if(!this.element)return console.log("NO SVG ELEMENT"),!1;let D=this.element.getBBox(),y=this.element.querySelectorAll(".staff path");if(y.length<=0)return this.width=D.width,console.warn("Warning: NO STAFF LINES IN MEASURE"),!1;this.stafflines=y,this.m_setX(),this.y=D.y,this.height=D.height;let F=this.stafflines[0].getBBox();return this.width=F.width,this.m_setVuScale()};HnpSvgMeasure.prototype.m_setX=function(){let D=this.stafflines;if(D.length<=0)return console.log("STAFFLINES NOT FOUND"),this.x=0,!1;var F=D[0].getAttribute("d").match(/M([\d.+-]+)/);return F?(this.x=parseFloat(F[1]),!0):(this.x=0,console.log("STAFFLINES NOT FOUND B"),!1)};HnpSvgMeasure.prototype.m_setVuScale=function(){let D=this.stafflines;if(D.length<=0)return this.vu=0,!1;let y=D[0].getAttribute("d"),F,R;var O=y.match(/M[\d.+-]+\s+([\d.+-]+)/);if(O)F=parseInt(O[1]);else return this.vu=0,!1;if(O=D[1].getAttribute("d").match(/M[\d.+-]+\s+([\d.+-]+)/),O)R=parseInt(O[1]);else return this.vu=0,!1;let K=Math.abs(R-F);return this.vu=K,!0};let InterfaceSingleNumber=0;function setInterfaceSingleNumber(D){InterfaceSingleNumber=parseInt(D,10)%10}function processNotationKey(D,y){var F=y.id,R;if(R=F.match(/L(\d+)/))var O=parseInt(R[1]);else return;if(R=F.match(/F(\d+)/))var U=parseInt(R[1]);else return;if(R=F.match(/S(\d+)/))var K=parseInt(R[1]);else K=null;if(R=F.match(/N(\d+)/))var B=parseInt(R[1]);else B=1;if(R=F.match(/^([a-z]+)-/))var G=R[1];else return;if(!(O<1||U<1)){var q=0,W=0,X=1;if((R=F.match(/^[^-]+-[^-]+-.*L(\d+)/))&&(q=parseInt(R[1])),(R=F.match(/^[^-]+-[^-]+-.*F(\d+)/))&&(W=parseInt(R[1])),(R=F.match(/^[^-]+-[^-]+-.*S(\d+)/))&&parseInt(R[1]),(R=F.match(/^[^-]+-[^-]+-.*N(\d+)/))&&(X=parseInt(R[1])),D==="esc"){if(getMenu().hideContextualMenus(),global_cursor.HIGHLIGHTQUERY="",!y)return;for(var j=y.getAttribute("class"),Z=j.split(" "),J="",Q=0;Q<Z.length;Q++)Z[Q]!="highlight"&&(J+=" "+Z[Q]);y.setAttribute("class",J),global_cursor.CursorNote="";return}if(G==="note")if(D==="y")toggleVisibility(F,O,U);else if(D==="a")setStemAboveMarker(F,O,U);else if(D==="b")setStemBelowMarker(F,O,U);else if(D==="c")deleteStemMarker(F,O,U);else if(D==="#")toggleSharp(F,O,U,K);else if(D==="-")toggleFlat(F,O,U,K);else if(D==="i")toggleEditorialAccidental(F,O,U,K);else if(D==="n")toggleNatural(F,O,U,K);else if(D==="m")toggleMordent("m",F,O,U,K);else if(D==="M")toggleMordent("M",F,O,U,K);else if(D==="w")toggleMordent("w",F,O,U,K);else if(D==="W")toggleMordent("W",F,O,U,K);else if(D==="X")toggleExplicitAccidental(F,O,U,K);else if(D==="L")startNewBeam(y);else if(D==="J")endNewBeam(y);else{if(D==="transpose-up-step")return transposeNote(F,O,U,K,1);if(D==="transpose-down-step")return transposeNote(F,O,U,K,-1);if(D==="transpose-up-octave")return transposeNote(F,O,U,K,7);if(D==="transpose-down-octave")return transposeNote(F,O,U,K,-7);D==="'"?toggleStaccato(F,O,U):D==="^"?toggleAccent(F,O,U):D==="^^"?toggleMarcato(F,O,U):D==="~"?toggleTenuto(F,O,U):D==="s"?addSlur(F,O,U):D==="q"?toggleGraceNoteType(F,O,U):D==="p"?(console.log("p pressed"),togglePedalStart(F,O,U)):D==="P"?togglePedalEnd(F,O,U):D==="t"?toggleMinorTrill(F,O,U):D==="T"?toggleMajorTrill(F,O,U):D==="`"?toggleStaccatissimo(F,O,U):D===";"?toggleFermata(F,O,U):D===":"?toggleArpeggio(F,O,U):D==="1"?InterfaceSingleNumber=1:D==="2"?InterfaceSingleNumber=2:D==="3"?InterfaceSingleNumber=3:D==="4"?InterfaceSingleNumber=4:D==="5"?InterfaceSingleNumber=5:D==="6"?InterfaceSingleNumber=6:D==="7"?InterfaceSingleNumber=7:D==="8"?InterfaceSingleNumber=8:D==="9"?InterfaceSingleNumber=9:D==="@"&&toggleMarkedNote(F,O,U,K)}else G==="rest"?D==="y"?toggleVisibility(F,O,U):D===";"?toggleFermata(F,O,U):D==="L"?startNewBeam(y):D==="J"&&endNewBeam(y):G==="dynam"?D==="a"?setDynamAboveMarker(F,O,U,B):D==="b"?setDynamBelowMarker(F,O,U,B):D==="c"&&deleteDynamDirectionMarker(F,O,U,B):G==="hairpin"?D==="a"?setHairpinAboveMarker(F,O,U,B):D==="b"?setHairpinBelowMarker(F,O,U,B):D==="c"&&deleteHairpinDirectionMarker(F,O,U,B):G==="slur"?D==="a"?setSlurAboveMarker(F,O,U,B):D==="b"?setSlurBelowMarker(F,O,U,B):D==="c"?deleteSlurDirectionMarker(F,O,U,B):D==="D"||D==="delete"?deleteSlur(F,O,U,B,q,W,X):D==="leftEndMoveBack"?leftEndMoveBack(F,O,U,B,q):D==="leftEndMoveForward"?leftEndMoveForward(F,O,U,B,q):D==="rightEndMoveForward"?rightEndMoveForward(F,O,U,B,q,W,X):D==="rightEndMoveBack"?rightEndMoveBack(F,O,U,B,q,W,X):D==="1"?InterfaceSingleNumber=1:D==="2"?InterfaceSingleNumber=2:D==="3"?InterfaceSingleNumber=3:D==="4"?InterfaceSingleNumber=4:D==="5"?InterfaceSingleNumber=5:D==="6"?InterfaceSingleNumber=6:D==="7"?InterfaceSingleNumber=7:D==="8"?InterfaceSingleNumber=8:D==="9"&&(InterfaceSingleNumber=9):G==="tie"?D==="a"?setTieAboveMarker(F,O,U,K):D==="b"?setTieBelowMarker(F,O,U,K):D==="c"&&deleteTieDirectionMarker(F,O,U,K):G==="beam"&&(D==="a"?setBeamAboveMarker(F,O,U):D==="b"?setBeamBelowMarker(F,O,U):D==="c"&&deleteBeamDirectionMarker(F,O,U))}}function setBeamAboveMarker(D,y,F){var R=getEditorContents(y,F);if(!(R==="."||R[0]=="!"||R[0]=="*")){var O=insertDirectionRdfs(),U=O[0],K=O[1],B=new RegExp("([^LJKk]*)([LJKk]+)(["+U+K+"]*)([^LJKk]*)"),G=B.exec(R);if(G){var q=G[1];q+=G[2],q+=U,q+=G[4]}else return;q!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,q))}}function setBeamBelowMarker(D,y,F){var R=getEditorContents(y,F);if(!(R==="."||R[0]=="!"||R[0]=="*")){var O=insertDirectionRdfs(),U=O[0],K=O[1],B=new RegExp("([^LJKk]*)([LJKk]+)(["+U+K+"]*)([^LJKk]*)"),G=B.exec(R);if(G){var q=G[1];q+=G[2],q+=K,q+=G[4]}else return;q!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,q))}}function deleteBeamDirectionMarker(D,y,F){var R=getEditorContents(y,F);if(!(R==="."||R[0]=="!"||R[0]=="*")){var O=insertDirectionRdfs(),U=O[0],K=O[1],B=new RegExp("([^LJKk]*)([LJKk]+)(["+U+K+"]*)([^LJKk]*)"),G=B.exec(R);if(G){var q=G[1];q+=G[2],q+=G[4]}else return;q!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,q))}}function setDynamAboveMarker(D,y,F,R){setAboveMarker(D,y,F,R,"DY")}function setDynamBelowMarker(D,y,F,R){setBelowMarker(D,y,F,R,"DY")}function deleteDynamDirectionMarker(D,y,F,R){deleteDirectionMarker(D,y,F,R,"DY")}function setHairpinAboveMarker(D,y,F,R){setAboveMarker(D,y,F,R,"HP")}function setHairpinBelowMarker(D,y,F,R){setBelowMarker(D,y,F,R,"HP")}function deleteHairpinDirectionMarker(D,y,F,R){deleteDirectionMarker(D,y,F,R,"HP")}function setAboveMarker(D,y,F,R,O){var U=getEditorContents(y,F);if(!(U==="."||U[0]=="!"||U[0]=="*")){var K=!1,B=y-1,G=getEditorContents(B,F),q=0;G.match(/^!LO/)||(createEmptyLine(y),q=1,y+=1,B=y-1,G="!",K=!0),G.match(/^!LO/)?G.match(/:b(?=:|=|$)/)?(G=G.replace(/:b(?=:|=|$)/,":a"),K=!0):G.match(/:a(:|=|$)/)||(G="!LO:"+O+":a",K=!0):G=="!"?(G="!LO:"+O+":a",K=!0):console.log("ERROR TOGGLING ABOVE DIRECTION"),q!=0&&(D=D.replace("L"+(y-1),"L"+(y+q-1))),K&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(B,F,G))}}function setBelowMarker(D,y,F,R,O){var U=getEditorContents(y,F);if(!(U==="."||U[0]=="!"||U[0]=="*")){var K=!1,B=y-1,G=getEditorContents(B,F),q=0;G.match(/^!LO/)||(createEmptyLine(y),q=1,y+=1,B=y-1,G="!",K=!0),G.match(/^!LO/)?G.match(/:a(?=:|=|$)/)?(G=G.replace(/:a(?=:|=|$)/,":b"),K=!0):G.match(/:b(:|=|$)/)||(G="!LO:"+O+":b",K=!0):G=="!"?(G="!LO:"+O+":b",K=!0):console.log("ERROR TOGGLING ABOVE DIRECTION"),q!=0&&(D=D.replace("L"+(y-1),"L"*+(y+q-1))),K&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(B,F,G))}}const editor$4=getAceEditor();if(!editor$4)throw new Error("Ace Editor is undefined");function deleteDirectionMarker(D,y,F,R,O){y=parseInt(y);var U=getEditorContents(y-1,F);if(U[0]==="!"){var K=!1,B=new RegExp("^!LO:"+O+":");if(U.match(B))U="!",K=!0;else return;if(!!K){setEditorContents(y-1,F,U,D,!0);var G=editor$4.session.getLine(y-2);if(G.match(/^[!\t]+$/)){var q=new Range(y-2,0,y-1,0);editor$4.session.remove(q),global_cursor.RestoreCursorNote=D.replace("L"+y,"L"+(y-1)),displayNotation(),highlightIdInEditor(global_cursor.RestoreCursorNote)}}}}function createEmptyLine(D){var y=global_interface.FreezeRendering;global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0);var F=editor$4.session.getLine(D-1),R="";F[0]=="	"?R+="	":R+="!";var O;for(O=1;O<F.length;O++)F[O]=="	"?R+="	":F[O]!="	"&&F[O-1]=="	"&&(R+="!");R+=`
`+F;var U=new Range(D-1,0,D-1,F.length);editor$4.session.replace(U,R),global_interface.FreezeRendering=y}function setSlurAboveMarker(D,y,F,R){var O=getEditorContents(y,F);if(!(O==="."||O[0]=="!"||O[0]=="*")){for(var U=insertDirectionRdfs(),K=U[0],B=U[1],G=0,q="",W=0;W<O.length;W++)if(O[W]=="("&&G++,q+=O[W],G==R)if(O[W+1]==K){G++;continue}else if(O[W+1]==B){q+=K,W++,G++;continue}else{q+=K,G++;continue}q!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,q))}}function setSlurBelowMarker(D,y,F,R){var O=getEditorContents(y,F);if(!(O==="."||O[0]=="!"||O[0]=="*")){for(var O=getEditorContents(y,F),U=insertDirectionRdfs(),K=U[0],B=U[1],G=0,q="",W=0;W<O.length;W++)if(O[W]=="("&&G++,q+=O[W],G==R)if(O[W+1]==B){G++;continue}else if(O[W+1]==K){q+=B,W++,G++;continue}else{q+=B,G++;continue}q!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,q))}}function deleteSlurDirectionMarker(D,y,F,R){var O=getEditorContents(y,F);if(!(O==="."||O[0]=="!"||O[0]=="*")){for(var U=insertDirectionRdfs(),K=U[0],B=U[1],G=0,q="",W=0;W<O.length;W++)if(O[W]=="("&&G++,q+=O[W],G==R)if(O[W+1]==B){W++,G++;continue}else if(O[W+1]==K){W++,G++;continue}else{G++;continue}q!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,q))}}function leftEndMoveBack(D,y,F,R,O,U,K){console.log("LEFT END MOVE BACK");var B=getEditorContents(y,F);if(!(parseInt(y)>=parseInt(O))){var G=y-2,q=0,W=InterfaceSingleNumber;for(W||(W=1);G>0;){var X=editor$4.session.getLine(G);if(X.match(/^\*/)||X.match(/^=/)||X.match(/^!/)||X===""){G--;continue}var j=getEditorContents(G+1,F);if(j.match(/[A-G]/i)&&q++,q!=W){G--;continue}break}if(console.log("LEFTENDMOVEBACK NEW",B,y,F,R,j,G+1,D),!(G<=0)&&!(X[0]=="*"||X[0]=="!"||X==="")){var Z=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var J=deleteSlurStart(D,y,F,R);J!==""&&addSlurStart(D,G+1,F,J),global_interface.FreezeRendering=Z,displayNotation(),InterfaceSingleNumber=0}}}function addSlur(D,y,F){getEditorContents(y,F);var R=global_interface.FreezeRendering;global_interface.FreezeRendering=!0,addSlurStart(D,y,F,"(");var O=parseInt(y),U=0,K=editor$4.session.getLength(),B=InterfaceSingleNumber;for(B||(B=1);O<K;){var G=editor$4.session.getLine(O);if(G.match(/^\*/)||G.match(/^=/)||G.match(/^!/)||G===""){O++;continue}var q=getEditorContents(O+1,F);if(q.match(/[A-G]/i)&&U++,U!=B){O++;continue}break}if(!(O>=K)&&!(G[0]=="*"||G[0]=="!"||G==="")&&!(O+1<=y)){addSlurEnd(D,O+1,F,")");var W=D.replace(/^note-/,"slur-"),X="-L"+(O+1)+"F"+F+"N"+1;W+=X,global_interface.FreezeRendering=R,global_interface.FreezeRendering||displayNotation(null,null,W),InterfaceSingleNumber=0,setTimeout(function(){var j=document.querySelector("svg g#"+D);if(j){var Z=j.getAttribute("class");Z.match(/\bhighlight\b/)||(Z+=" highlight",j.setAttribute("class",Z)),global_cursor.CursorNote=j}},300)}}function addSlurStart(D,y,F,R){for(var O=getEditorContents(y,F),U="",K=O.length-1;K>=0;K--)if(O[K]=="("){U=O.substring(0,K+1),U+=R,U+=O.substring(K+1);break}U===""&&(U=R+O);var B=0;for(K=0;K<U.length;K++)U[K]=="("&&B++;var G=D.replace(/L\d+/,"L"+y);G=G.replace(/F\d+/,"F"+F),G=G.replace(/N\d+/,"N"+B),U!==O&&(global_cursor.RestoreCursorNote=G,global_cursor.HIGHLIGHTQUERY=G,setEditorContents(y,F,U))}function addSlurEnd(D,y,F,R){for(var O=getEditorContents(y,F),U="",K=0;K<O.length;K++)O[K]=="("&&(U=O.substring(0,K+1),U+=R,U+=O.substring(K+1));for(U===""&&(U=O+R),K=0;K<U.length;K++)U[K]=="(";U!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,U))}function deleteSlurStart(D,y,F,R){for(var O=getEditorContents(y,F),U="",K=0,B="",G=0;G<O.length;G++){if(O[G]=="("&&K++,K!=R){U+=O[G];continue}B+=O[G],O[G+1]==">"?(B+=">",G++):O[G+1]=="<"&&(B+="<",G++),K++}return U!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,U)),B}function deleteSlurEnd(D,y,F,R){for(var O=getEditorContents(y,F),U="",K=0,B="",G=0;G<O.length;G++){if(O[G]==")"&&(K++,B=")"),K==R){K++;continue}U+=O[G]}return U!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,U)),B}function deleteSlur(D,y,F,R,O,U,K){var B=global_interface.FreezeRendering;deleteSlurStart(D,y,F,R),deleteSlurEnd(D,O,U,K),global_interface.FreezeRendering=B,global_cursor.RestoreCursorNote=null,global_cursor.HIGHLIGHTQUERY=null,global_interface.FreezeRendering||displayNotation()}function leftEndMoveForward(D,y,F,R,O,U,K){if(console.log("LEFT END MOVE FORWARD"),getEditorContents(y,F),!(parseInt(y)>=parseInt(O))){var B=parseInt(y),G=0,q=editor$4.session.getLength(),W=InterfaceSingleNumber;for(W||(W=1);B<q;){var X=editor$4.session.getLine(B);if(X.match(/^\*/)||X.match(/^=/)||X.match(/^!/)||X===""){B++;continue}var j=getEditorContents(B+1,F);if(j.match(/[A-G]/i)&&G++,G!=W){B++;continue}break}if(!(B>=q)&&!(X[0]=="*"||X[0]=="!"||X==="")&&!(B+1>=O)){var Z=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var J=deleteSlurStart(D,y,F,R);J!==""&&addSlurStart(D,B+1,F,J),global_interface.FreezeRendering=Z,displayNotation(),InterfaceSingleNumber=0}}}function rightEndMoveForward(D,y,F,R,O,U,K){if(getEditorContents(O,F),!(parseInt(y)>=parseInt(O))){var B=parseInt(O),G=0,q=editor$4.session.getLength(),W=InterfaceSingleNumber;for(W||(W=1);B<q;){var X=editor$4.session.getLine(B);if(X.match(/^\*/)||X.match(/^=/)||X.match(/^!/)||X===""){B++;continue}var j=getEditorContents(B+1,F);if(j.match(/[A-G]/i)&&G++,G!=W){B++;continue}break}if(!(B>=q)&&!(X[0]=="*"||X[0]=="!"||X==="")&&!(B+1<=y)){var Z=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var J=deleteSlurEnd(D,O,U,K);J!==""&&addSlurEnd(D,B+1,F,J);var Q="L"+(B+1)+"F"+U+"N"+K,ee=D.replace(/-[^-]+$/,"-"+Q);global_cursor.RestoreCursorNote=ee,global_cursor.HIGHLIGHTQUERY=ee,global_interface.FreezeRendering=Z,displayNotation(),InterfaceSingleNumber=0}}}function rightEndMoveBack(D,y,F,R,O,U,K){if(getEditorContents(O,F),!(parseInt(y)>=parseInt(O))){var B=parseInt(O)-2,G=0,q=InterfaceSingleNumber;for(q||(q=1);B>=0;){var W=editor$4.session.getLine(B);if(W.match(/^\*/)||W.match(/^=/)||W.match(/^!/)||W===""){B--;continue}var X=getEditorContents(B+1,F);if(X.match(/[A-G]/i)&&G++,G!=q){B--;continue}break}if(!(B<=0)&&!(W[0]=="*"||W[0]=="!"||W==="")&&!(B+1<=y)){var j=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var Z=deleteSlurEnd(D,O,U,K);Z!==""&&addSlurEnd(D,B+1,F,Z);var J="L"+(B+1)+"F"+U+"N"+K,Q=D.replace(/-[^-]+$/,"-"+J);global_cursor.RestoreCursorNote=Q,global_cursor.HIGHLIGHTQUERY=Q,global_interface.FreezeRendering=j,displayNotation(),InterfaceSingleNumber=0}}}function setTieAboveMarker(D,y,F,R){console.log("TIE ABOVE",O,y,F,R,D);var O=getEditorContents(y,F);if(!(O==="."||O[0]=="!"||O[0]=="*")){if(R){var U=O.split(" ");O=U[R-1]}if(!O.match("r")){var K="",B;if(!!(O.match(/[[]/)||O.match("_"))){var G=insertDirectionRdfs(),q=G[0],W=G[1],X=new RegExp("([^_[]*)([_[]+)(["+q+W+"]*)([^_[]*)");(B=X.exec(O))?K=B[1]+B[2]+q+B[4]:K=O,R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}}}function setTieBelowMarker(D,y,F,R){console.log("TIE BELOW",O,y,F,R,D);var O=getEditorContents(y,F);if(!(O==="."||O[0]=="!"||O[0]=="*")){if(R){var U=O.split(" ");O=U[R-1]}if(!O.match("r")){var K="",B;if(!!(O.match(/[[]/)||O.match("_"))){var G=insertDirectionRdfs(),q=G[0],W=G[1],X=new RegExp("([^_[]*)([_[]+)(["+q+W+"]*)([^_[]*)");(B=X.exec(O))?K=B[1]+B[2]+W+B[4]:K=O,R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}}}function deleteTieDirectionMarker(D,y,F,R){console.log("TIE DIRECTION REMOVE",O,y,F,R,D);var O=getEditorContents(y,F);if(!(O==="."||O[0]=="!"||O[0]=="*")){if(R){var U=O.split(" ");O=U[R-1]}if(!O.match("r")){var K="",B;if(!!(O.match(/[[]/)||O.match("_"))){var G=insertDirectionRdfs(),q=G[0],W=G[1],X=new RegExp("([^_[]*)([_[]+)(["+q+W+"]*)([^_[]*)");(B=X.exec(O))?K=B[1]+B[2]+B[4]:K=O,R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}}}function setStemAboveMarker(D,y,F){console.log("STEM ABOVE",y,F,D);var R=getEditorContents(y,F);if(!(R==="."||R[0]=="!"||R[0]=="*")&&!R.match("r")){for(var O,U=R.split(" "),K=0;K<U.length;K++)(O=U[K].match(/([^\\\\\\\/]*)([\\\\\\\/]+)([^\\\\\\\/]*)/))?U[K]=O[1]+"/"+O[3]:(O=U[K].match(/([^A-Ga-g#XxYyTt:'~oOS$MmWw\^<>n-]*)([A-Ga-g#Xx<>yYnTt:'~oOS$MmWw\^-]+)(.*)/))&&(U[K]=O[1]+O[2]+"/"+O[3]);var B=U.join(" ");B!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,B))}}function setStemBelowMarker(D,y,F){console.log("STEM BELOW",y,F,D);var R=getEditorContents(y,F);if(console.log("TOKEN EXTRACTED IS",R),!(R==="."||R[0]=="!"||R[0]=="*")&&!R.match("r")){for(var O,U=R.split(" "),K=0;K<U.length;K++)(O=U[K].match(/([^\\\/]*)([\\\\\\\/]+)([^\\\\\\\/]*)/))?U[K]=O[1]+"\\"+O[3]:(O=U[K].match(/([^A-Ga-g#XxYyTt:'~oOS$MmWw\^<>n-]*)([A-Ga-g#Xx<>yYnTt:'~oOS$MmWw\^-]+)(.*)/))&&(U[K]=O[1]+O[2]+"\\"+O[3]);var B=U.join(" ");B!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,B))}}function deleteStemMarker(D,y,F){console.log("REMOVE STEMS",y,F,D);var R=getEditorContents(y,F);if(!(R==="."||R[0]=="!"||R[0]=="*")&&!R.match("r")){var O=R.replace(/[\\\/]/g,"");O!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,O))}}function transposeNote(D,y,F,R,O){console.log("TRANSPOSE Note",{line:y,column:F,subfield:R,noteId:D});var U=getEditorContents(y,F);O=parseInt(O);var K=InterfaceSingleNumber;if(K||(K=1),K>1&&(O>0?O=K-1:O=-K+1,InterfaceSingleNumber=0),R){var B=U.split(" ");U=B[R-1]}if(!(U==="."||U[0]=="!"||U[0]=="*")&&!U.match("r")){var G,q;if((q=U.match(/([^a-gA-G]*)([a-gA-G]+)([^a-gA-G]*)/))&&(G=q[1],G+=transposeDiatonic(q[2],O),G+=q[3]),R&&(B[R-1]=G,G=B.join(" ")),console.log("OLDTOKEN",U,"NEWTOKEN",G),G!==U)return global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,G),{noteElementId:D,row:y-1,col:F-1,oldValue:U,newValue:G}}}function transposeNotes(D){const y=[];for(let{id:F,line:R,field:O,subfield:U,amount:K}of D){let B=getEditorContents(R,O);K=parseInt(K);let G;if(U&&(G=B.split(" "),B=G[U-1]),B==="."||B[0]=="!"||B[0]=="*"||B.match("r"))continue;let q,W;(W=B.match(/([^a-gA-G]*)([a-gA-G]+)([^a-gA-G]*)/))&&(q=W[1],q+=transposeDiatonic(W[2],K),q+=W[3]),U&&(G[U-1]=q,q=G.join(" ")),q!==B&&y.push({line:R,field:O,oldToken:B,token:q,id:F})}return y}function toggleEditorialAccidental(D,y,F,R){console.log("TOGGLE EDITORIAL ACCIDENTAL",y,F,R,D);var O=getEditorContents(y,F);if(R){var U=O.split(" ");O=U[R-1]}if(!(O==="."||O[0]=="!"||O[0]=="*")&&!O.match("r")){var K=insertEditorialAccidentalRdf(),B,G,q=new RegExp(K);q.exec(O)?B=O.replace(new RegExp(K,"g"),""):O.match(/[-#n]/)?(G=O.match(/(.*[a-gA-Gn#xXyY-]+)(.*)/),B=G[1]+K+G[2]):(G=O.match(/(.*[a-gA-GxXyY]+)(.*)/),B=G[1]+"n"+K+G[2]),R&&(U[R-1]=B,B=U.join(" ")),B!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,B))}}function toggleSharp(D,y,F,R){var O=getEditorContents(y,F);if(R){var U=O.split(" ");O=U[R-1]}if(!(O==="."||O[0]=="!"||O[0]=="*")&&!O.match("r")){var K;InterfaceSingleNumber==2?(O.match("##")?K=O.replace(/#+i?/,""):(K=O.replace(/[#n-]+/,""),K=K.replace(/([a-gA-G]+)/,function(B,G){return G?G+"##":B})),InterfaceSingleNumber=0):O.match("##")||!O.match("#")?(K=O.replace(/[#n-]+/,""),K=K.replace(/([a-gA-G]+)/,function(B,G){return G?G+"#":B})):K=O.replace(/#+i?/,""),R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}function toggleFlat(D,y,F,R){var O=getEditorContents(y,F);if(R){var U=O.split(" ");O=U[R-1]}if(!(O==="."||O[0]=="!"||O[0]=="*")&&!O.match("r")){var K;InterfaceSingleNumber==2?(O.match("--")?K=O.replace(/-+i?/,""):(K=O.replace(/[#n-]+/,""),K=K.replace(/([a-gA-G]+)/,function(B,G){return G?G+"--":B})),InterfaceSingleNumber=0):O.match("--")||!O.match("-")?(K=O.replace(/[#n-]+/,""),K=K.replace(/([a-gA-G]+)/,function(B,G){return G?G+"-":B})):K=O.replace(/-+i?/,""),R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}function toggleNatural(D,y,F,R){console.log("TOGGLE NATURAL ACCIDENTAL",y,F,R,D);var O=getEditorContents(y,F);if(R){var U=O.split(" ");O=U[R-1]}if(!(O==="."||O[0]=="!"||O[0]=="*")&&!O.match("r")){var K;O.match("n")?K=O.replace(/n+i?/,""):(K=O.replace(/[#n-]+/,""),K=K.replace(/([a-gA-G]+)/,function(B,G){return G?G+"n":B})),R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}function toggleExplicitAccidental(D,y,F,R){console.log("TOGGLE EXPLICIT ACCIDENTAL",y,F,R,D);var O=getEditorContents(y,F);if(R){var U=O.split(" ");O=U[R-1]}if(!(O==="."||O[0]=="!"||O[0]=="*")&&!O.match("r")){var K,B;O.match(/n/)?K=O.replace(/n/g,""):(B=O.match(/([^#-]*)([#-]+)(X?)([^#-]*)/))?B[3]==="X"?K=B[1]+B[2]+B[4]:K=B[1]+B[2]+"X"+B[4]:(B=O.match(/([^A-G]*)([A-G]+)([^A-G]*)/i))&&(K=B[1]+B[2]+"n"+B[3]),R&&(U[R-1]=K,K=U.join(" ")),K!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}}function toggleStaccato(D,y,F){var R=0,O=editor$4.session.getLength(),U=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var K=InterfaceSingleNumber;for(K||(K=1);y<O&&R<K;){var B=getEditorContents(y,F);if(B.match(/^\*/)||B.match(/^=/)||B.match(/^!/)||B===""){y++;continue}if(B==="."){y++;continue}if(B.match("r")){y++;continue}B.match("'")?(B=B.replace(/'[<>]*/g,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++):(B=B.replace(/'+/,""),B=B.replace(/([a-gA-G]+[-#nXxYy<>]*)/g,function(G,q){return q?q+"'":G}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++)}InterfaceSingleNumber=0,global_interface.FreezeRendering=U,displayNotation()}function toggleAccent(D,y,F){var R=0,O=editor$4.session.getLength(),U=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var K=InterfaceSingleNumber;for(K||(K=1);y<O&&R<K;){var B=getEditorContents(y,F);if(B.match(/^\*/)||B.match(/^=/)||B.match(/^!/)||B===""){y++;continue}if(B==="."){y++;continue}if(B.match("r")){y++;continue}B.match(/\^+/)?(B=B.replace(/\^+[<>]*/g,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++):(B=B.replace(/\^+/,""),B=B.replace(/([a-gA-G]+[-#nXxYy<>]*)/,function(G,q){return q?q+"^":G}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++)}InterfaceSingleNumber=0,global_interface.FreezeRendering=U,displayNotation()}function toggleMarcato(D,y,F){var R=0,O=editor$4.session.getLength(),U=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var K=InterfaceSingleNumber;for(K||(K=1);y<O&&R<K;){var B=getEditorContents(y,F);if(B.match(/^\*/)||B.match(/^=/)||B.match(/^!/)||B===""){y++;continue}if(B==="."){y++;continue}if(B.match("r")){y++;continue}B.match(/\^+/)?(B=B.replace(/\^+[<>]*/g,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++):(B=B.replace(/\^+/,""),B=B.replace(/([a-gA-G]+[-#nXxYy<>]*)/,function(G,q){return q?q+"^^":G}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++)}InterfaceSingleNumber=0,global_interface.FreezeRendering=U,displayNotation()}function toggleTenuto(D,y,F){var R=0,O=editor$4.session.getLength(),U=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var K=InterfaceSingleNumber;for(K||(K=1);y<O&&R<K;){var B=getEditorContents(y,F);if(B.match(/^\*/)||B.match(/^=/)||B.match(/^!/)||B===""){y++;continue}if(B==="."){y++;continue}if(B.match("r")){y++;continue}B.match(/~/)?(B=B.replace(/~[<>]*/g,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),setEditorContents(y,F,B),R++):(B=B.replace(/~+/g,""),B=B.replace(/([a-gA-G]+[-#nXxYy<>]*)/,function(G,q){return q?q+"~":G}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++)}InterfaceSingleNumber=0,global_interface.FreezeRendering=U,displayNotation()}function toggleStaccatissimo(D,y,F){var R=0,O=editor$4.session.getLength(),U=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var K=InterfaceSingleNumber;for(K||(K=1);y<O&&R<K;){var B=getEditorContents(y,F);if(B.match(/^\*/)||B.match(/^=/)||B.match(/^!/)||B===""){y++;continue}if(B==="."){y++;continue}if(B.match("r")){y++;continue}B.match(/`/)?(B=B.replace(/`[<>]*/g,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++):(B=B.replace(/`/g,""),B=B.replace(/([a-gA-G]+[-#nXxYy<>]*)/,function(G,q){return q?q+"`":G}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,B),R++,y++)}InterfaceSingleNumber=0,global_interface.FreezeRendering=U,displayNotation()}function toggleGraceNoteType(D,y,F){for(var R=getEditorContents(y,F),O=R.split(" "),U=0;U<O.length;U++)O[U].match("qq")?O[U]=O[U].replace(/qq/g,"q"):O[U].match("q")&&(O[U]=O[U].replace(/q/g,"qq"));var K=O.join(" ");K!==R&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,K))}function toggleMinorTrill(D,y,F){var R=getEditorContents(y,F);R!=="."&&(R.match("r")||(R.match(/T/i)?R.match(/T/)?(R=R.replace(/T/g,"t"),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R.replace(/T[<>]*/gi,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R.replace(/T/gi,""),R=R.replace(/([a-gA-G]+[-#nXxYy<>]*)/,function(O,U){return U?U+"t":O}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R))))}function toggleMordent(D,y,F,R,O){console.log("TOGGLE MORDENT",U,F,R,O,y);var U=getEditorContents(F,R);if(!(U==="."||U[0]=="!"||U[0]=="*")){if(O){var K=U.split(" ");U=K[O-1]}if(!U.match("r")){var B="",G,G=U.match(/[MmWw]/),q=!1;G&&(q=!0);var W=!1;if(q){var X=new RegExp(D);X.exec(U)&&(W=!0)}W?B=U.replace(/[MmWw][<>]*/g,""):q?B=U.replace(/[MmWw]/g,D):B=U+D,O&&(K[O-1]=B,B=K.join(" ")),B!==U&&(global_cursor.RestoreCursorNote=y,global_cursor.HIGHLIGHTQUERY=y,setEditorContents(F,R,B))}}}function toggleLigatureStart(D,y,F){var R=!0,O=editor$4.session.getLine(y);if(O.match(/^\*/)&&O.match(/\*lig/)&&(R=!1),R){let K=editor$4.session.getLine(y-1);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let G=K.split(/\t+/).length,q="";for(let W=0;W<G;W++)q+="*",W==F-1&&(q+="lig"),W<G-1&&(q+="	");q+=`
`,editor$4.session.insert({row:y-1,column:0},q),U=D.replace(/L\d+/,"L"+(y+1)),global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}else{let K=editor$4.session.getLine(y);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let B=K.split(/\t+/);B[F-1]==="*"?B[F-1]="*lig":B[F-1]="*";let G=B.join("	");if(G.match(/^[*\t]+$/))console.log("DELETING BLANK LINE"),editor$4.session.replace(new Range(y-2,0,y-1,0),""),U=D.replace(/L\d+/,"L"+(y-1)),global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U;else{console.log("UPDATING LINE:",G),G+=`
`,editor$4.session.replace(new Range(y,0,y+1,0),G);var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}}}function toggleColorationStart(D,y,F){var R=!0,O=editor$4.session.getLine(y);if(O.match(/^\*/)&&O.match(/\*col/)&&(R=!1),R){let K=editor$4.session.getLine(y-1);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let G=K.split(/\t+/).length,q="";for(let W=0;W<G;W++)q+="*",W==F-1&&(q+="col"),W<G-1&&(q+="	");q+=`
`,editor$4.session.insert({row:y-1,column:0},q),U=D.replace(/L\d+/,"L"+(y+1)),global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}else{let K=editor$4.session.getLine(y);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let B=K.split(/\t+/);B[F-1]==="*"?B[F-1]="*col":B[F-1]="*";let G=B.join("	");if(G.match(/^[*\t]+$/))console.log("DELETING BLANK LINE"),editor$4.session.replace(new Range(y-2,0,y-1,0),""),U=D.replace(/L\d+/,"L"+(y-1)),global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U;else{console.log("UPDATING LINE:",G),G+=`
`,editor$4.session.replace(new Range(y,0,y+1,0),G);var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}}}function togglePedalStart(D,y,F){if(InterfaceSingleNumber==4){toggleLigatureStart(D,y,F),InterfaceSingleNumber=0;return}else if(InterfaceSingleNumber==5){toggleColorationStart(D,y,F),InterfaceSingleNumber=0;return}var R=editor$4.session.getLine(y-1);if(!R.match(/^!/)&&!R.match(/^\*/)){var O=!0,U=editor$4.session.getLine(y-2);U.match(/^\*/)&&U.match(/\*ped/)&&(O=!1);var K;if(!O){console.log("DELETING PEDAL START"),editor$4.session.replace(new Range(y-2,0,y-1,0),""),K=D.replace(/L\d+/,"L"+(y-1)),global_cursor.RestoreCursorNote=K,global_cursor.HIGHLIGHTQUERY=K;return}var B=createNullLine("*",R);B=B.replace(/^(\t*)\*(\t*)/,"$1*ped$2"),editor$4.session.insert({row:y-1,column:0},B),K=D.replace(/L\d+/,"L"+(y+1)),global_cursor.RestoreCursorNote=K,global_cursor.HIGHLIGHTQUERY=K}}function toggleColorationEnd(D,y,F){var R=!0,O=editor$4.session.getLine(y);if(O.match(/^\*/)&&O.match(/\*Xcol/)&&(R=!1),R){let K=editor$4.session.getLine(y-1);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let G=K.split(/\t+/).length,q="";for(let X=0;X<G;X++)q+="*",X==F-1&&(q+="Xcol"),X<G-1&&(q+="	");q+=`
`,editor$4.session.replace(new Range(y,0,y,0),q);var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}else{let K=editor$4.session.getLine(y);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let B=K.split(/\t+/);B[F-1]==="*"?B[F-1]="*Xcol":B[F-1]="*";let G=B.join("	");if(G.match(/^[*\t]+$/)){console.log("DELETING BLANK LINE"),editor$4.session.replace(new Range(y,0,y+1,0),"");var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}else{console.log("UPDATING LINE:",G),G+=`
`,editor$4.session.replace(new Range(y,0,y+1,0),G);var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}}}function toggleLigatureEnd(D,y,F){var R=!0,O=editor$4.session.getLine(y);if(O.match(/^\*/)&&O.match(/\*Xlig/)&&(R=!1),R){let K=editor$4.session.getLine(y-1);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let G=K.split(/\t+/).length,q="";for(let X=0;X<G;X++)q+="*",X==F-1&&(q+="Xlig"),X<G-1&&(q+="	");q+=`
`,editor$4.session.replace(new Range(y,0,y,0),q);var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}else{let K=editor$4.session.getLine(y);K=K.replace(/\t+$/,"").replace(/^\t+/,"");let B=K.split(/\t+/);B[F-1]==="*"?B[F-1]="*Xlig":B[F-1]="*";let G=B.join("	");if(G.match(/^[*\t]+$/)){console.log("DELETING BLANK LINE"),editor$4.session.replace(new Range(y,0,y+1,0),"");var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}else{console.log("UPDATING LINE:",G),G+=`
`,editor$4.session.replace(new Range(y,0,y+1,0),G);var U=D;global_cursor.RestoreCursorNote=U,global_cursor.HIGHLIGHTQUERY=U}}}function togglePedalEnd(D,y,F){if(InterfaceSingleNumber==4){toggleLigatureEnd(D,y,F),InterfaceSingleNumber=0;return}else if(InterfaceSingleNumber==5){toggleColorationEnd(D,y,F),InterfaceSingleNumber=0;return}var R=editor$4.session.getLine(y-1);if(!R.match(/^!/)&&!R.match(/^\*/)){var O=!0,U=editor$4.session.getLine(y);U.match(/^\*/)&&U.match(/\*Xped/)&&(O=!1);var K;if(!O){editor$4.session.replace(new Range(y,0,y+1,0),""),K=D,global_cursor.RestoreCursorNote=K,global_cursor.HIGHLIGHTQUERY=K;return}var B=global_interface.FreezeRendering;global_interface.FreezeRendering=!0;var G=createNullLine("*",R);G=G.replace(/^(\t*)\*(\t*)/,"$1*Xped$2"),editor$4.session.replace(new Range(y,0,y,0),G),K=D,console.log("OLDID",D,"NEWID",K),global_cursor.RestoreCursorNote=K,global_cursor.HIGHLIGHTQUERY=K,global_interface.FreezeRendering=B,displayNotation()}}function toggleMajorTrill(D,y,F){var R=getEditorContents(y,F);R!=="."&&(R.match("r")||(R.match(/T/i)?R.match(/t/)?(R=R.replace(/t/g,"T"),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R.replace(/T[<>]*/gi,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R.replace(/T/gi,""),R=R.replace(/([a-gA-G]+[-#nXxYy<>]*)/,function(O,U){return U?U+"T":O}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R))))}function toggleArpeggio(D,y,F){var R=getEditorContents(y,F);R!=="."&&(R.match("r")||(R.match(/:/i)?(R=R.replace(/:/gi,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R.replace(/:/gi,""),R=R.replace(/([a-gA-G]+[-#nXxYy<>]*)/g,function(O,U){return U?U+":":O}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R))))}function toggleFermata(D,y,F){console.log("TOGGLING FERMATA");var R=getEditorContents(y,F);R!=="."&&(R.match(/;/i)?(R=R.replace(/;[<>]*/gi,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R.replace(/;/gi,""),R=R.replace(/([ra-gA-G]+[-#nXxYy<>]*)/,function(O,U){return U?U+";":O}),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)))}function toggleVisibility(D,y,F){var R=getEditorContents(y,F);R!=="."&&(R.match(/yy/)?(R=R.replace(/yy/,""),global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)):(R=R+"yy",global_cursor.RestoreCursorNote=D,setEditorContents(y,F,R)))}function setEditorContents(D,y,F,R,O){var U=global_interface.FreezeRendering;global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0);var K,B=editor$4.session.getLine(D-1),G=new Range(D-1,0,D-1,B.length),q=B.split(/\t+/);q[y-1]=F;var W=[];for(K=0;K<q.length+1;K++)W[K]="";var X=0;for(B[0]!="	"&&X++,K=1;K<B.length;K++)B[K]=="	"?W[X]+="	":B[K]!="	"&&B[K-1]=="	"&&X++;var j="";for(K=0;K<W.length;K++)j+=W[K],q[K]&&(j+=q[K]);var Z=0;for(K=0;K<y-1;K++)Z+=q[K].length,Z+=W[K].length;editor$4.session.replace(G,j),global_interface.FreezeRendering=U,O||displayNotation()}function setEditorContents2(D,y,F,R){var O,U=editor$4.session.getLine(D-1),K=new Range(D-1,0,D-1,U.length),B=U.split(/\t+/);B[y-1]=F;var G=[];for(O=0;O<B.length+1;O++)G[O]="";var q=0;for(U[0]!="	"&&q++,O=1;O<U.length;O++)U[O]=="	"?G[q]+="	":U[O]!="	"&&U[O-1]=="	"&&q++;var W="";for(O=0;O<G.length;O++)W+=G[O],B[O]&&(W+=B[O]);editor$4.session.replace(K,W)}function setEditorContentsMany(D){global_interface.FreezeRendering=!0,D.forEach(y=>setEditorContents2(y.line,y.field,y.token,y.id)),global_interface.FreezeRendering=!1,displayNotation()}function getEditorContents(D,y){var F="",R=editor$4.session.getLine(D-1),O=0;if(y>1){var U=0;for(let B=0;B<R.length&&(O++,R[B]=="	"&&B>0&&R[B-1]!="	"&&U++,U!=y-1);B++);}for(var K=O;K<R.length&&R[K]!="	";K++){if(R[K]==null){console.log("undefined index",K);break}F+=R[K]}return F}window.getEditorContents=getEditorContents;function toggleMarkedNote(D,y,F,R){console.log("TOGGLE MARKED NOTE ",y,F,R,D);var O=getEditorContents(y,F);if(R){var U=O.split(" ");O=U[R-1]}if(!(O==="."||O[0]=="!"||O[0]=="*")&&!O.match("r")){var K=insertMarkedNoteRdf(),B,G=new RegExp(K);G.exec(O)?B=O.replace(new RegExp(K,"g"),""):B=O+K,R&&(U[R-1]=B,B=U.join(" ")),B!==O&&(global_cursor.RestoreCursorNote=D,global_cursor.HIGHLIGHTQUERY=D,setEditorContents(y,F,B))}}function addLocalCommentLineAboveCurrentPosition(){addNullLine("!","**blank")}function addInterpretationLineAboveCurrentPosition(){addNullLine("*","**blank")}function addDataLineAboveCurrentPosition(){addNullLine(".","**dynam")}function addBarlineAboveCurrentPosition(){addNullLine("=","**blank")}function createNullLine(D,y){var F="";y[0]=="	"?F+="	":F+=D;var R;for(R=1;R<y.length;R++)y[R]=="	"?F+="	":y[R]!="	"&&y[R-1]=="	"&&(F+=D);return F+=`
`,F}function addNullLine(D,y,F){if(D||(D="."),y||(y="**blank"),!F){var R=editor$4.getCursorPosition();F=R.row}var O=editor$4.session.getLine(F);if(!O.match(/^!!/)&&!O.match(/^$/)){if(O.match(/^\*\*/)){addSpineToRight(y,O,R);return}var U=createNullLine(D,O);editor$4.session.insert({row:F,column:0},U)}}function addSpineToRight(D,y,F){console.log("EXINTERP",D,"CURRENTLINE",y,"LOCATION",F),F.column;var R=0,O,U=0;for(O=0;O<F.column+1;O++)y[O]=="	"?U==1&&(U=0):U==0&&(U=1,R++);var K=0;for(U=0,O=0;O<y.length;O++)y[O]=="	"?U==1&&(U=0):U==0&&(U=1,K++);console.log("   SPINE NUMBER IS ",R,"TOTAL",K);var B="extract -s ";R==1?K==1?B+="1,0":K==2?B+="1,0,2":B+="1,0,2-$":(B+="1-"+R+",0",R==K||(R+1==K?B+=","+K:B+=","+(R+1)+"-$")),D!=="**blank"&&(B+=" -n "+D),getMenu().applyFilter(B)}function getBeamParent(D){for(var y=D.parentNode;y;){if(y.id.match(/^beam-/))return y;y=y.parentNode}}function getBeamChild(D){for(var y=D;y;){if(y.parentNode&&y.parentNode.id.match(/^beam-/))return y;y=y.parentNode}}function startNewBeam(D,y,F){var R=getBeamParent(D),O=getBeamChild(D);if(!!R){var U=R.id;if(!!U.match(/^beam/)){var K="#"+U+" > g[id^='note']";K+=", #"+U+" > g[id^='rest']",K+=", #"+U+" > g[id^='chord']";for(var B=R.querySelectorAll(K),G=-1,q=0;q<B.length;q++)if(B[q]===O){G=q;break}if(!(G<=0)){var W=global_interface.FreezeRendering;global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0),G==1?(removeBeamInfo(B[0]),B.length==2?removeBeamInfo(B[1]):addBeamStart(B[G])):G<B.length-1?(addBeamStart(B[G]),addBeamEnd(B[G-1])):(addBeamEnd(B[G-1]),removeBeamInfo(B[G])),global_editorOptions.EDITINGID=D.id,global_cursor.RestoreCursorNote=D.id,global_interface.FreezeRendering=W,global_interface.FreezeRendering||displayNotation(),turnOffAllHighlights(),highlightIdInEditor(global_editorOptions.EDITINGID)}}}}function endNewBeam(D,y,F){var R=getBeamParent(D),O=getBeamChild(D);if(!!R){var U=R.id;if(!!U.match(/^beam/)){var K="#"+U+" > g[id^='note']";K+=", #"+U+" > g[id^='rest']",K+=", #"+U+" > g[id^='chord']";for(var B=R.querySelectorAll(K),G=-1,q=0;q<B.length;q++)if(B[q]===O){G=q;break}if(!(G<0)&&B.length!=1&&G!=B.length-1){var W=global_interface.FreezeRendering;global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0),G==0?(removeBeamInfo(B[0]),addBeamStart(B[G+1])):G==B.length-2?(removeBeamInfo(B[G+1]),addBeamEnd(B[G])):(addBeamEnd(B[G]),addBeamStart(B[G+1])),global_editorOptions.EDITINGID=D.id,global_cursor.RestoreCursorNote=D.id,global_interface.FreezeRendering=W,global_interface.FreezeRendering||displayNotation(),turnOffAllHighlights(),highlightIdInEditor(global_editorOptions.EDITINGID)}}}}function removeBeamInfo(D){if(!!D){var y=D.id,F=y.match(/[^-]+-.*L(\d+).*F(\d+)/);if(!!F){var R=parseInt(F[1]),O=parseInt(F[2]),U=getEditorContents(R,O).replace(/[LJKk]+[<>]?/g,"");setEditorContents(R,O,U,y,!0)}}}function addBeamStart(D){if(!!D){var y=D.id,F=y.match(/[^-]+-.*L(\d+).*F(\d+)/);if(!!F){var R=parseInt(F[1]),O=parseInt(F[2]),U=getEditorContents(R,O).replace(/[LJKk]+[<>]?/g,"");U+="L",setEditorContents(R,O,U,y,!0)}}}function addBeamEnd(D){if(!!D){var y=D.id,F=y.match(/[^-]+-.*L(\d+).*F(\d+)/);if(!!F){var R=parseInt(F[1]),O=parseInt(F[2]),U=getEditorContents(R,O).replace(/[LJKk]+[<>]?/g,"");U+="J",setEditorContents(R,O,U,y,!0)}}}function getFilenameBase(D){if(D||(D=getTextFromEditor()),!D)return"";var y=D.match(/^!!!!SEGMENT:\s*([^\s'"!*]+)/),F;return y&&(F=y[1],F=F.replace(/.*\//,"").replace(/\..*?$/,""),F.length>0)||FILEINFO&&FILEINFO.file&&(F=FILEINFO.file,F=F.replace(/.*\//,"").replace(/\..*?$/,""),F.length>0)?F:"data"}function getFilenameExtension(D){if(D||(D=getTextFromEditorRaw()),!D)return"txt";var y=D.substring(0,1e3).replace(/^\s+/,"");if(y.match(/<meiHead/))return"mei";if(y.match(/<score-(part|time)wise/)||y.match(/<opus/))return"musicxml";if(y.match(/^[A-Za-z0-9+\/\s]+$/))return"mime";var F,R,O;return y.match(/^[!*]/)?(F=y.match(/^!!!!SEGMENT:\s*([^\s'"!*]+)/),F&&(O=F[1],O.match(/\./)&&(R=O.replace(/.*\./,""),R&&R.length>0))||FILEINFO&&FILEINFO.file&&(O=FILEINFO.file.replace(/.*\//,""),R=O.replace(/.*\./,""),R&&R.length>0)?R:"krn"):y.match(/group memberships:/i)?".msd":"txt"}function dataIsHumdrum(D){return D||(D=getTextFromEditor()),!!D.match(/^\s*[!*]/)}function trimTabs(D){for(var y=D.split(/\r?\n/),F="",R=0;R<y.length;R++){let O=y[R].replace(/\t+$/,"");O.match(/^\s*$/)||(O.match(/^!!![^\s]+:\t/)&&(O=O.replace(/\t/," ")),F+=O+`
`)}return F}function trimTabsInEditor(D){if(D||(D=getTextFromEditor()),!D){console.log("No content to convert to Humdrum");return}var y=trimTabs(D);setTextInEditor(y)}const Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(D){var y="",F,R,O,U,K,B,G,q=0;for(D=Base64._utf8_encode(D);q<D.length;)F=D.charCodeAt(q++),R=D.charCodeAt(q++),O=D.charCodeAt(q++),U=F>>2,K=(F&3)<<4|R>>4,B=(R&15)<<2|O>>6,G=O&63,isNaN(R)?B=G=64:isNaN(O)&&(G=64),y=y+this._keyStr.charAt(U)+this._keyStr.charAt(K)+this._keyStr.charAt(B)+this._keyStr.charAt(G);return y},decode:function(D){var y="",F,R,O,U,K,B,G,q=0;for(D=D.replace(/[^A-Za-z0-9\+\/\=]/g,"");q<D.length;)U=this._keyStr.indexOf(D.charAt(q++)),K=this._keyStr.indexOf(D.charAt(q++)),B=this._keyStr.indexOf(D.charAt(q++)),G=this._keyStr.indexOf(D.charAt(q++)),F=U<<2|K>>4,R=(K&15)<<4|B>>2,O=(B&3)<<6|G,y=y+String.fromCharCode(F),B!=64&&(y=y+String.fromCharCode(R)),G!=64&&(y=y+String.fromCharCode(O));return y=Base64._utf8_decode(y),y},_utf8_encode:function(D){D=D.replace(/\r\n/g,`
`);for(var y="",F=0;F<D.length;F++){var R=D.charCodeAt(F);R<128?y+=String.fromCharCode(R):R>127&&R<2048?(y+=String.fromCharCode(R>>6|192),y+=String.fromCharCode(R&63|128)):(y+=String.fromCharCode(R>>12|224),y+=String.fromCharCode(R>>6&63|128),y+=String.fromCharCode(R&63|128))}return y},_utf8_decode:function(D){for(var y="",F=0,R=0,O=0;F<D.length;)if(R=D.charCodeAt(F),R<128)y+=String.fromCharCode(R),F++;else if(R>191&&R<224)O=D.charCodeAt(F+1),y+=String.fromCharCode((R&31)<<6|O&63),F+=2;else{O=D.charCodeAt(F+1);var U=D.charCodeAt(F+2);y+=String.fromCharCode((R&15)<<12|(O&63)<<6|U&63),F+=3}return y}};function convertDataToTsv(D){for(var y="",F=0;F<D.length;F++)y+=convertLineToTsv(D[F])+`
`;return y}function convertDataToCsv(D){for(var y="",F=0;F<D.length;F++)y+=convertLineToCsv(D[F])+`
`;return y}function convertLineToTsv(D){var y=D.split(""),F="";if(y.length<1)return F;var R=0;if(y.length>=2&&y[0]=="!"&&y[1]=="!")return D;for(var O=",",U=0;U<y.length;U++){if(y[U]=='"'&&!R){R=1;continue}if(R&&y[U]=='"'&&y[U+1]=='"'&&U<y.length-1){F+='"',U++;continue}if(y[U]=='"'){R=0;continue}if(!R&&D.substr(U,O.length)==O){F+="	",U+=O.length-1;continue}F+=y[U]}return F}function convertLineToCsv(D){if(D.match(/^!!/))return D;for(var y=D.split(/\t/),F="",R=0;R<y.length;R++)F+=convertTokenToCsv(y[R]),R<y.length-1&&(F+=",");return F}function convertTokenToCsv(D){var y="";return D.match(/,/)||D.match(/"/)?(y+='"',y+=D.replace(/"/g,'""'),y+='"',y):D}function restoreEditorContentsLocally(){var D=encodeURIComponent(getTextFromEditorRaw());localStorage.setItem("SAVE0",D);var y=InterfaceSingleNumber;y||(y=1);var F="SAVE"+y,R=localStorage.getItem(F);if(!!R){var O=decodeURIComponent(localStorage.getItem(F));setTextInEditor(O),setInterfaceSingleNumber(0)}}function saveEditorContentsLocally(){var D=InterfaceSingleNumber;D||(D=1);var y="SAVE"+D,F=getTextFromEditorRaw(),R=!1,O="";F.match(/^\s*$/)?(O="",R=!1):(O=encodeURIComponent(F),R=!0),localStorage.setItem(y,O);var U=document.querySelector("#title-info"),K="";U&&(K=U.textContent.replace(/^\s+/,"").replace(/\s+$/,"")),localStorage.setItem(y+"-TITLE",K);var B=document.querySelector("#save-"+D);B&&(B.title=K,R?B.classList.add("filled"):B.classList.remove("filled"));var G=document.querySelector("#load-"+D);G&&(G.title=K,R?G.classList.add("filled"):G.classList.remove("filled")),setInterfaceSingleNumber(0)}let vrvWorker$5=getVrvWorker();if(!vrvWorker$5)throw new Error("Verovio worker is undefined");let editor$3=getAceEditor();if(!editor$3)throw new Error("Ace Editor is undefined");function saveSvgData(){if(!global_interface.ShowingIndex){var D=JSON.parse(JSON.stringify(OPTIONS));console.log("SVG PRINTING OPTIONS",D);var y=getTextFromEditor();if(!y.match(/^\s*$/)){dataIsHumdrum(y);var F=vrvWorker$5.page,R=!0;vrvWorker$5.renderData(D,y,F,R).then(function(O){console.log("buffer vrvWorker.renderData",O);for(var U=global_editorOptions.SAVEFILENAME,K=editor$3.session.getLength(),B,G,q=0;q<K;q++)G=editor$3.session.getLine(q),(B=G.match(/^!!!!SEGMENT:\s*([^\s].*)\s*$/))&&(U=B[1]);U=U.replace(/\.[^.]+/,".svg"),U.match(/svg$/)||(U+=".svg");var W=new Blob([O],{type:"text/plain"});saveAs(W,U),D.adjustPageWidth=0,vrvWorker$5.renderData(D,O,F,R)})}}}function saveEditorContents(){var D=getFilenameBase();D||(D="data");var y=D,F=getFilenameExtension();F&&(y+="."+F);var R=getTextFromEditor(),O=new Blob([R],{type:"text/plain"});saveAs(O,y)}let vrvWorker$4=getVrvWorker();if(!vrvWorker$4)throw new Error("Verovio worker is undefined");function loadPdfFonts(D){return RSVP.all([loadFontResource(D,"Times","/scripts/pdfkit/EBGaramond-Regular.ttf"),loadFontResource(D,"TimesItalic","/scripts/pdfkit/EBGaramond-Italic.ttf"),loadFontResource(D,"TimesBold","/scripts/pdfkit/EBGaramond-Bold.ttf"),loadFontResource(D,"TimesBoldItalic","/scripts/pdfkit/EBGaramond-BoldItalic.ttf"),loadFontResource(D,"VerovioText","/scripts/pdfkit/VerovioText-1.0.ttf")])}function loadFontResource(D,y,F){var R=new RSVP.Promise(function(O,U){var K=new XMLHttpRequest;K.open("GET",F),K.responseType="arraybuffer",K.onreadystatechange=function(){this.readyState===this.DONE&&(this.status===200?O(this.response):U(this))},K.send(null)});return R.then(function(O){return D.registerFont(y,O),!0})}function svgFontCallback(D,y,F,R){return D=="VerovioText"?D:(D.match(/(?:^|,)\s*sans-serif\s*$/),y?F?"TimesBoldItalic":"TimesBold":F?"TimesItalic":"Times")}function generatePdfSnapshot(K,q){$("html").css("cursor","wait");var F=document.querySelector("#output svg"),R=F.getAttribute("width"),O=F.getAttribute("height");R=parseInt(R),O=parseInt(O);var U=O/R,K=K||"letter",B=2159,G=2794;K==="A4"?(B=2100,G=2970):K==="B3"&&(B=2500,G=3530),q||R>O&&(q="landscape");var q=q||"portrait";q==="landscape"&&(B=[G,G=B][0]);var W=G/B,X=.99,j,Z;U<W?(j=B/10*X,Z=B/10*U*X):(Z=G/10*X,j=G/10/U*X);var J=B/10,Q=0,ee=0;j<J&&(Q=J-j),Q+=1;var oe=document.createElement("span");oe.innerHTML=F.outerHTML;var re=oe.querySelector("svg");re.setAttribute("width",j+"mm"),re.setAttribute("height",Z+"mm");var ne={};ne.fontCallback=svgFontCallback;var te=new PDFDocument({useCSS:!0,compress:!0,autoFirstPage:!1,layout:q}),ie=te.pipe(blobStream());ie.on("finish",function(){var le=ie.toBlob("application/pdf"),ce=getFilenameBase(),se=ce;se?se+="-snapshot.pdf":se="snapshot.pdf",saveAs(le,se),$("html").css("cursor","auto")}),loadPdfFonts(te).then(function(){te.addPage({size:K,layout:q}),SVGtoPDF(te,re,Q,ee,ne),te.end()})}function generatePdfFull(R,O){var F=vrvWorker$4.options;F.mmOutput=0,$("html").css("cursor","wait");var R=R||"letter",O=O||"portrait",U=2159,K=2920;R==="A4"?(U=2100,K=2970):R==="B3"&&(U=2500,K=3530),O==="landscape"&&(U=[K,K=U][0]);var B={};B.fontCallback=svgFontCallback;var G=new PDFDocument({useCSS:!0,compress:!0,autoFirstPage:!1,layout:O}),q=G.pipe(blobStream());q.on("finish",function(){var ne=q.toBlob("application/pdf"),te=getFilenameBase(),ie=te;ie?ie+=".pdf":ie="data.pdf",saveAs(ne,ie),$("html").css("cursor","auto")});var W=95;K/=W/100,U/=W/100;var X=10,j=14,Z=100,J=100,Q=50,ee=50,oe={pageHeight:K-Z,pageWidth:U,pageMarginLeft:Q,pageMarginRight:ee,pageMarginTop:Z,pageMarginBottom:J,spacingSystem:j,spacingStaff:X,scale:W,adjustPageHeight:0,justifyVertically:1,breaks:global_verovioOptions.BREAKS?"encoded":"auto",mmOutput:1,header:"auto",footer:"encoded",usePgFooterForAll:1,barLineWidth:.12,staffLineWidth:.12,font:global_verovioOptions.FONT},re=getAceEditor().getValue().replace(/^\s+/,"");getStaffCount(re),oe=cleanOptions2(re,oe),console.log("PRINTING OPTIONS",oe),RSVP.hash({fonts:loadPdfFonts(G),svglist:vrvWorker$4.renderAllPages(re,oe)}).then(function(ne){for(var te=0;te<ne.svglist.length;te++){G.addPage({size:R,layout:O});var ie=0,le=0;SVGtoPDF(G,ne.svglist[te],ie,le,B)}return G.end(),!0}).finally(function(){vrvWorker$4.page,cleanOptions2(re,F),vrvWorker$4.redoLayout(F,!0),vrvWorker$4.options=F})}function cleanOptions2(D,y){var F=D.match(/[^\r\n]+/g),R=y,O=[""],U={};U[""]={};var K;for(K=0;K<F.length;K++){var B=F[K].match(/^!!!verovio([^\s]*):\s*(.*)\s*$/);if(!!B){if(B[1]=="-parameter-group"){O.push(B[2]);continue}var G=B[2].match(/^\s*([^\s]+)\s+(.*)\s*$/);if(!!G){var q=B[1].match(/^-([^\s]+)\s*$/),W="";q&&(W=q[1]),typeof U[W]>"u"&&(U[W]={}),U[W][G[1]]=G[2]}}}for(K=0;K<O.length;K++)if(!!U[O[K]]){var X=Object.keys(U[O[K]]),j;for(j=0;j<X.length;j++)typeof R[X[j]]<"u"&&delete R[X[j]]}return R}let VEROVIOOPTIONS={OPTION:[{NAME:"help",ABBR:"?",INFO:"Display help message.",ARG:"boolean",CLI_ONLY:"true"},{NAME:"allPages",ABBR:"a",INFO:"Output all pages.",ARG:"boolean",CLI_ONLY:"true?"},{NAME:"inputFrom",ABBR:"f",INFO:"Select input data type.",ARG:"string",DEF:"mei",ALT:["auto","darms","pae","xml","humdrum","humdrum-xml"],CLI_ONLY:"true?"},{NAME:"outfile",ABBR:"o",INFO:'Output file name (use "-" for standard output).',ARG:"string",CLI_ONLY:"true"},{NAME:"page",ABBR:"p",INFO:"Select the page to engrave.",ARG:"integer",DEF:"1",MIN:"1",CLI_ONLY:"true"},{NAME:"resources",ABBR:"r",INFO:"Path to SVG resources.",ARG:"string",DEF:"/usr/local/share/verovio",CLI_ONLY:"true"},{NAME:"scale",ABBR:"s",INFO:"Scale percentage",ARG:"integer",DEF:"100",MIN:"1"},{NAME:"minLastJustification",INFO:"Minimum length of last system which can be stretched to 100% width of page.",ARG:"float",DEF:"0.8",MIN:"0.0",MAX:"1.0"},{NAME:"outputTo",ABBR:"t",INFO:"Select output data format",ARG:"string",DEF:"svg",ALT:["mei","midi"]},{NAME:"version",ABBR:"v",INFO:"Display verovio version number.",ARG:"boolean",CLI_ONLY:"true"},{NAME:"xmlIdSeed",ABBR:"x",INFO:"Seed the random number generator for XML IDs.",ARG:"integer"},{NAME:"adjustPageHeight",CAT:"Input and page layout options",INFO:"Crop the page height to the actual height of the content.",ARG:"boolean"},{NAME:"adjustPageWidth",CAT:"Input and page layout options.",INFO:"Crop the page width to the actual width of the content.",ARG:"boolean"},{NAME:"breaks",CAT:"Input and page layout options",INFO:"Define page and system breaks layout.",ARG:"string",DEF:"auto",ALT:["none","line","smart","encoded"]},{NAME:"breaksSmartSb",CAT:"Input and page layout options",INFO:`In smart breaks mode, the portion of the system width usage
	at which an encoded system break will be used.`,ARG:"float",DEF:"0.66",MIN:"0.00",MAX:"1.00"},{NAME:"condense",CAT:"Input and page layout options",INFO:"Control condensed score layout.",ARG:"string",DEF:"auto",ALT:["none","encoded"]},{NAME:"condenseFirstPage",CAT:"Input and page layout options",INFO:"When condensing a score, also condense the first page.",ARG:"boolean"},{NAME:"condenseTempoPages",CAT:"Input and page layout options",INFO:"When condensing a score, also condense pages with a tempo.",ARG:"boolean"},{NAME:"evenNoteSpacing",CAT:"Input and page layout options",INFO:"Specify the linear spacing factor.  This is useful for mensural notation display.",ARG:"boolean"},{NAME:"expand",CAT:"Input and page layout options",INFO:"Expand all referenced elements in the expanion.  Input is an xml:id of the expansion list.",ARG:"string"},{NAME:"humType",CAT:"Input and page layout options",INFO:"Include type attributes when importing rom Humdrum",ARG:"boolean"},{NAME:"justifyVertically",CAT:"Input and page layout options",INFO:"Justify spacing veritcally to fill a page.",ARG:"boolean"},{NAME:"landscape",CAT:"Input and page layout options",INFO:"The landscape paper orientation flag.",ARG:"boolean"},{NAME:"mensuralToMeasure",CAT:"Input and page layout options",INFO:"Convert mensural sections to measure-based MEI.",ARG:"boolean"},{NAME:"mmOutput",CAT:"Input and page layout options",INFO:"Specify that the output in the SVG is given in mm (default is px).",ARG:"boolean"},{NAME:"footer",CAT:"Input and page layout options",INFO:"Do not add any footer, add a footer, use automatic footer.",ARG:"string",DEF:"auto",ALT:["none","encoded","always"]},{NAME:"header",CAT:"Input and page layout options",INFO:"Do not add any header, add a header, use automatic header.",ARG:"string",DEF:"auto",ALT:["none","encoded"]},{NAME:"noJustification",CAT:"Input and page layout options",INFO:"Do not justify the system.",ARG:"boolean"},{NAME:"openControlEvents",CAT:"Input and page layout options",INFO:"Render open control events.",ARG:"boolean"},{NAME:"outputIndent",CAT:"Input and page layout options",INFO:"Output indent value for MEI and SVG.",ARG:"integer",DEF:"3",MIN:"1",MAX:"10"},{NAME:"outputFormatRaw",CAT:"Input and page layout options",INFO:"Output MEI with no line indents or non-content newlines. See svgFormatRaw.",ARG:"boolean"},{NAME:"outputIndentTab",CAT:"Input and page layout options",INFO:"Use tabs rather than spaces for indenting XML output.",ARG:"boolean"},{NAME:"outputSmuflXmlEntities",CAT:"Input and page layout options",INFO:"Output SMuFL characters as XML entities instead of hex byte codes.",ARG:"boolean"},{NAME:"pageHeight",CAT:"Input and page layout options",INFO:"The page height.",ARG:"integer",DEF:"2970",MIN:"100",MAX:"60000"},{NAME:"pageMarginBottom",CAT:"Input and page layout options",INFO:"Bottom margin of pages.",ARG:"integer",DEF:"50",MIN:"0",MAX:"500"},{NAME:"pageMarginLeft",CAT:"Input and page layout options",INFO:"Left margin of pages.",ARG:"integer",DEF:"50",MIN:"0",MAX:"500"},{NAME:"pageMarginRight",CAT:"Input and page layout options",INFO:"Right margin of pages.",ARG:"integer",DEF:"50",MIN:"0",MAX:"500"},{NAME:"pageMarginTop",CAT:"Input and page layout options",INFO:"Top margin of pages.",ARG:"integer",DEF:"50",MIN:"0",MAX:"500"},{NAME:"pageWidth",CAT:"Input and page layout options",INFO:"Page width.",ARG:"integer",DEF:"2100",MIN:"100",MAX:"60000"},{NAME:"preserveAnalyticalMarkup",CAT:"Input and page layout options",INFO:"Preserves the analytical markup in MEI.",ARG:"boolean"},{NAME:"removeIDs",CAT:"Input and page layout options",INFO:"Remove XML IDs in the MEI output when not referenced.",ARG:"boolean"},{NAME:"shrinkToFit",CAT:"Input and page layout options",INFO:"Scale down page content to fit the page height if needed.",ARG:"boolean"},{NAME:"svgBoundingBoxes",CAT:"Input and page layout options",INFO:"Include bounding boxes in SVG output.",ARG:"boolean"},{NAME:"svgViewBox",CAT:"Input and page layout options",INFO:"Use viewbox on SVG root element for easy scaling of document.",ARG:"boolean"},{NAME:"svgHtml5",CAT:"Input and page layout options",INFO:"Write data-id and data-class attributes for JS usage and ID clash avoidance.",ARG:"boolean"},{NAME:"svgFormatRaw",CAT:"Input and page layout options",INFO:"Writes SVG with no line indenting or non-content newlines. See outputFormatRaw.",ARG:"boolean"},{NAME:"svgRemoveXlink",CAT:"Input and page layout options",INFO:'Removes the "xlink:" prefix from href attributes for compatibility with some newer browsers.',ARG:"boolean"},{NAME:"unit",CAT:"Input and page layout options",INFO:"The MEI unit (1/2 of the distance between the staff lines).",ARG:"integer",DEF:"9",MIN:"6",MAX:"20"},{NAME:"useBraceGlyph",CAT:"Input and page layout options",INFO:"Use brace glyph from current font.",ARG:"boolean"},{NAME:"useFacsimile",CAT:"Input and page layout options",INFO:"Use information in the facsimile element to control the layout.",ARG:"boolean"},{NAME:"usePgFooterForAll",CAT:"Input and page layout options",INFO:"Use the pgFooter element for all pages.",ARG:"boolean"},{NAME:"usePgHeaderForAll",CAT:"Input and page layout options",INFO:"Use the pgHeader element for all pages.",ARG:"boolean"},{NAME:"clefChangeFactor",CAT:"Input and page layout options",INFO:"Set the size ratio of normal clefs to changing clefs.",ARG:"float",DEF:"0.66",MIN:"0.25;",MAX:"1.00;"},{NAME:"midiTempoAdjustment",CAT:"General layout",INFO:"MIDI tempo adjustment factor.",ARG:"float",DEF:"1.00",MIN:"0.20",MAX:"4.00"},{NAME:"barLineSeparation",CAT:"General layout",INFO:"Default distance between multiple barlines when locked together.",ARG:"float",DEF:"0.80",MIN:"0.50",MAX:"2.00"},{NAME:"barLineWidth",CAT:"General layout",ARG:"float",INFO:"The width of a barline.",DEF:"0.30",MIN:"0.10",MAX:"0.80"},{NAME:"beamMaxSlope",INFO:"The maximum beam slope.",CAT:"General layout",ARG:"integer",DEF:"10",MIN:"1",MAX:"20"},{NAME:"beamMinSlope",INFO:"The minimum beam slope.",CAT:"General layout",ARG:"integer",DEF:"0",MIN:"0",MAX:"0"},{NAME:"bracketThickness",INFO:"Thickness of the system bracket.",CAT:"General layout",ARG:"float",DEF:"1.0",MIN:"0.5",MAX:"2.0"},{NAME:"dynamDist",INFO:"Default distance from staff to dynamic marks.",CAT:"General layout",ARG:"float",DEF:"1.00",MIN:"0.50",MAX:"16.00"},{NAME:"engravingDefaults",INFO:"JSON describing defaults for engraving SMuFL elements.",CAT:"General layout",ARG:"string"},{NAME:"engravingDefaultsFile",INFO:"Path to JSON file describing defaults for engraving SMuFL elements.",CAT:"General layout",ARG:"string"},{NAME:"font",INFO:"Set the music font.",CAT:"General layout",ARG:"string",DEF:"Leipzig",ALT:["Bravura","Gootville","Leland"]},{NAME:"graceFactor",INFO:"The grace size ratio numerator.",CAT:"General layout",ARG:"float",DEF:"0.75",MIN:"0.50",MAX:"1.00"},{NAME:"graceRhythmAlign",INFO:"Align grace notes rhythmically with all staves.",CAT:"General layout",ARG:"boolean"},{NAME:"graceRightAlign",INFO:"Align the right position of a grace group with all staves.",CAT:"General layout",ARG:"boolean"},{NAME:"hairpinSize",CAT:"General layout",ARG:"float",INFO:"Size of hairpins (crescendo lines).",DEF:"3.00",MIN:"1.00",MAX:"8.00"},{NAME:"hairpinThickness",CAT:"General layout",INFO:"Hairpin thickness (crescendo lines).",ARG:"float",DEF:"0.20",MIN:"0.10",MAX:"0.80"},{NAME:"harmDist",CAT:"General layout",INFO:"Default distance from haromonic labels to the staff.",ARG:"float",DEF:"1.00",MIN:"0.50",MAX:"16.00"},{NAME:"justificationStaff",CAT:"General layout",INFO:"Staff justification.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"10.00"},{NAME:"justificationSystem",CAT:"General layout",INFO:"Vertical system spacing justification.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"10.00"},{NAME:"justificationBracketGroup",CAT:"General layout",INFO:"Space between staves inside a bracket group justification.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"10.00"},{NAME:"justificationBraceGroup",CAT:"General layout",INFO:"Space between staves inside a brace group justification.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"10.00"},{NAME:"ledgerLineThickness",CAT:"General layout",INFO:"Thickness of ledger lines.",ARG:"float",DEF:"0.25",MIN:"0.10",MAX:"0.50"},{NAME:"ledgerLineExtension",CAT:"General layout",INFO:"Amount by which ledger lines should extend on either side of a notehead.",ARG:"float",DEF:"0.54",MIN:"0.20",MAX:"1.00"},{NAME:"lyricSize",CAT:"General layout",ARG:"float",INFO:"Size of lyric text.",DEF:"4.50",MIN:"2.00",MAX:"8.00"},{NAME:"lyricHyphenLength",CAT:"General layout",ARG:"float",INFO:"Lyric hyphen and dash lengths.",DEF:"1.20",MIN:"0.50",MAX:"3.00"},{NAME:"lyricLineThickness",CAT:"General layout",INFO:"Lyric extender line thicknesses.",ARG:"float",DEF:"0.25",MIN:"0.10",MAX:"0.50"},{NAME:"lyricNoStartHyphen",CAT:"General layout",INFO:"Do not show hyphens at system beginnings.",ARG:"boolean"},{NAME:"lyricTopMinMargin",CAT:"General layout",INFO:"The minmal margin above the lyrics",ARG:"float",DEF:"3.00",MIN:"3.00",MAX:"8.00"},{NAME:"lyricWordSpace",CAT:"General layout",INFO:"Minimum width of spaces separating lyric text.",ARG:"float",DEF:"1.20",MIN:"0.50",MAX:"3.00"},{NAME:"minMeasureWidth",INFO:"The minimal measure width.",CAT:"General layout",ARG:"integer",DEF:"15",MIN:"1",MAX:"30"},{NAME:"mnumInterval",INFO:"Repeat measure numbers at the given cycle size.",CAT:"General layout",ARG:"integer"},{NAME:"multiRestStyle",INFO:"Rendering style of multiple measure rests.",CAT:"General layout",ARG:"string",DEF:"auto",ALT:["default","block","symbols"]},{NAME:"repeatBarLineDotSeparation",INFO:"Default horizontal distance between dots and inner repeat barline.",CAT:"General layout",ARG:"float",DEF:"0.30",MIN:"0.10",MAX:"1.00"},{NAME:"repeatEndingLineThickness",INFO:"Repeat and endling line thickness.",CAT:"General layout",ARG:"float",DEF:"0.15",MIN:"0.10",MAX:"2.00"},{NAME:"slurControlPoints",INFO:"Slur control points.  Higher values mean more curvature at endpoints.",CAT:"General layout",ARG:"integer",DEF:"5",MIN:"1",MAX:"10"},{NAME:"slurHeightFactor",INFO:"Slur height factor.  Higher values mean flatter slurs.",CAT:"General layout",ARG:"integer",DEF:"5",MIN:"1",MAX:"100"},{NAME:"slurMinHeight",INFO:"Minimum slur height.",CAT:"General layout",ARG:"float",DEF:"1.20",MIN:"0.30",MAX:"2.00"},{NAME:"slurMaxHeight",INFO:"Maximum slur height.",CAT:"General layout",ARG:"float",DEF:"3.00",MIN:"2.00",MAX:"6.00"},{NAME:"slurMaxSlope",INFO:"Maximum slur slope in degrees.",CAT:"General layout",ARG:"float",DEF:"20",MIN:"0",MAX:"60"},{NAME:"slurEndpointThickness",INFO:"Slur endpoint thickness.",CAT:"General layout",ARG:"float",DEF:"0.10",MIN:"0.05",MAX:"0.25"},{NAME:"slurMidpointThickness",INFO:"Slur midpoint thickness.",CAT:"General layout",ARG:"float",DEF:"0.60",MIN:"0.20",MAX:"1.20"},{NAME:"spacingBraceGroup",INFO:"Minimum space between staves inside of a braced group.",CAT:"General layout",ARG:"float",DEF:"12",MIN:"0",MAX:"48"},{NAME:"spacingBracketGroup",INFO:"Minimum space between staves inside a bracketed group.",CAT:"General layout",ARG:"float",DEF:"12",MIN:"0",MAX:"48"},{NAME:"spacingDurDetection",INFO:"Detect long duration for adjusting spacing.",CAT:"General layout",ARG:"boolean"},{NAME:"slurCurveFactor",INFO:"Slur curve factor.  Higher values mean rounder slurs.",CAT:"General layout",ARG:"integer",DEF:"10",MIN:"1",MAX:"100"},{NAME:"octaveAlternativeSymbols",INFO:"Use alternative symbols for displaying octaves.",CAT:"General layout",ARG:"boolean"},{NAME:"octaveLineThickness",INFO:"Octave line thickness.",CAT:"General layout",ARG:"float",DEF:"0.20",MIN:"0.10",MAX:"1.00"},{NAME:"spacingLinear",CAT:"General layout",ARG:"float",INFO:"Specify the linear spacing factor",DEF:"0.25",MIN:"0.00",MAX:"1.00"},{NAME:"spacingNonLinear",CAT:"General layout",ARG:"float",INFO:"Specify the non-linear spacing factor.",DEF:"0.60",MIN:"0.00",MAX:"1.00"},{NAME:"spacingStaff",ARG:"integer",INFO:"The staff minimal spacing",CAT:"General layout",DEF:"12",MIN:"0",MAX:"48"},{NAME:"spacingSystem",ARG:"integer",INFO:"The system minimal spacing",CAT:"General layout",DEF:"12",MIN:"0",MAX:"48"},{NAME:"staffLineWidth",CAT:"General layout",ARG:"float",INFO:"The staff line width in unit",DEF:"0.15",MIN:"0.10",MAX:"0.30"},{NAME:"stemWidth",CAT:"General layout",ARG:"float",INFO:"The stem width",DEF:"0.20",MIN:"0.10",MAX:"0.50"},{NAME:"subBracketThickness",CAT:"General layout",ARG:"float",INFO:"Thickness of system sub-brackets.",DEF:"0.20",MIN:"0.10",MAX:"2.00"},{NAME:"systemDivider",CAT:"General layout",INFO:"Display style of system dividers",ARG:"string",DEF:"auto",ALT:["none","left","left-right"]},{NAME:"systemMaxPerPage",CAT:"General layout",INFO:"Maximum number of systems per page",ARG:"integer"},{NAME:"textEnclosureThickness",CAT:"General layout",INFO:"Thickness of text-enclosing boxes.",ARG:"float",DEF:"0.20",MIN:"0.10",MAX:"0.80"},{NAME:"thickBarlineThickness",CAT:"General layout",INFO:"Thickness of thick barlines.",ARG:"float",DEF:"1.00",MIN:"0.50",MAX:"2.00"},{NAME:"tieEndpointThickness",CAT:"General layout",INFO:"Endpoint tie thickenesses",ARG:"float",DEF:"0.10",MIN:"0.05",MAX:"0.25"},{NAME:"tieMidpointThickness",CAT:"General layout",INFO:"Tie midpoint thickenesses",ARG:"float",DEF:"0.50",MIN:"0.20",MAX:"1.00"},{NAME:"tupletBracketThickness",CAT:"General layout",INFO:"Tuplet bracket thicknesses.",ARG:"float",DEF:"0.20",MIN:"0.10",MAX:"0.80"},{NAME:"tupletNumHead",CAT:"General layout",INFO:"Placement of tuplet number on the notehead-side.",ARG:"boolean"},{NAME:"defaultBottomMargin",CAT:"element margins",INFO:"Default bottom margin",ARG:"float",DEF:"0.50",MIN:"0.00",MAX:"5.00"},{NAME:"defaultLeftMargin",CAT:"element margins",INFO:"Default left margin.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"defaultRightMargin",CAT:"element margins",INFO:"The default right margin",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"defaultTopMargin",CAT:"element margins",INFO:"The default top margin",ARG:"float",DEF:"0.50",MIN:"0.00",MAX:"6.00"},{NAME:"leftMarginAccid",CAT:"element margins",INFO:"The margin for accid",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"bottomMarginArtic",CAT:"element margins",INFO:"Bottom margin for articulations.",ARG:"float",DEF:"0.75",MIN:"0.00",MAX:"10.00"},{NAME:"bottomMarginHarm",CAT:"element margins",INFO:"Bottom margin for harmony labels.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"10.00"},{NAME:"bottomMarginHeader",CAT:"element margins",INFO:"Bottom margin for page headers.",ARG:"float",DEF:"8.00",MIN:"0.00",MAX:"24.00"},{NAME:"leftMarginBarLine",CAT:"element margins",INFO:"Left margin for barLines.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginBeatRpt",CAT:"element margins",INFO:"Left margin for beatRpt.",ARG:"float",DEF:"2.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginChord",CAT:"element margins",INFO:"Left margin for chords.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginClef",CAT:"element margins",INFO:"Left margin for clefs.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginKeySig",CAT:"element margins",INFO:"Left margin for key signatures.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginLeftBarLine",CAT:"element margins",INFO:"Left margin for left barLines.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginMensur",CAT:"element margins",INFO:"Left margin for mensur.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginMeterSig",CAT:"element margins",INFO:"Left margin for meterSig.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginMRest",CAT:"element margins",INFO:"Left margin for mRest.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginMRpt2",CAT:"element margins",INFO:"Left margin for mRpt2.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginMultiRest",CAT:"element margins",INFO:"Left margin for multiRest.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginMultiRpt",CAT:"element margins",INFO:"Left  margin for multiRpt.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginNote",CAT:"element margins",INFO:"Right margin for note.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginRest",CAT:"element margins",INFO:"Left margin for rest.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginRightBarLine",CAT:"element margins",INFO:"Margin for right barLine.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"leftMarginTabDurSym",CAT:"element margins",INFO:"Margin for tabDurSym.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginAccid",CAT:"element margins",INFO:"Right margin for accid.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginBarLine",CAT:"element margins",INFO:"Right margin for barLine.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginBeatRpt",CAT:"element margins",INFO:"Right margin for beatRpt.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginChord",CAT:"element margins",INFO:"Right margin for chord.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginClef",CAT:"element margins",INFO:"Right margin for clef.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginKeySig",CAT:"element margins",INFO:"Right margin for keySig.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginLeftBarLine",CAT:"element margins",INFO:"Right margin for left barLine.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginMensur",CAT:"element margins",INFO:"Right margin for mensur.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginMeterSig",CAT:"element margins",INFO:"Right margin for meterSig.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginMRest",CAT:"element margins",INFO:"Right margin for mRest.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginMRpt2",CAT:"element margins",INFO:"Right margin for mRpt2.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginMultiRest",CAT:"element margins",INFO:"Right margin for multiRest.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginMultiRpt",CAT:"element margins",INFO:"Right margin for multiRpt.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginNote",CAT:"element margins",INFO:"The right margin for note.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginRest",CAT:"element margins",INFO:"The right margin for rest.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginRightBarLine",CAT:"element margins",ARG:"float",INFO:"The right margin for right barLine.",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"rightMarginTabDurSym",CAT:"element margins",INFO:"Right margin for tabDurSym.",ARG:"float",DEF:"0.00",MIN:"0.00",MAX:"2.00"},{NAME:"topMarginArtic",CAT:"element margins",INFO:"Top margin for articulations.",ARG:"float",DEF:"0.75",MIN:"0.00",MAX:"10.00"},{NAME:"topMarginHarm",CAT:"element margins",INFO:"Top margin for harmony labels.",ARG:"float",DEF:"1.00",MIN:"0.00",MAX:"10.00"}]};function getVerovioDefaultOptions(){let D={};if(!VEROVIOOPTIONS)return D;var y=VEROVIOOPTIONS.OPTION;for(let F=0;F<y.length;F++)typeof y[F].DEF<"u"&&(y[F].NAME,typeof y[F].CLI_ONLY<"u"&&y[F].CLI_ONLY!=="true"&&(D[y[F].NAME]=y[F].DEF));return D}function humdrumToSvgOptions(){var D=getVerovioDefaultOptions();D.adjustPageHeight=1,D.barLineWidth=.12,D.breaks=global_verovioOptions.BREAKS?"encoded":"auto",D.font=global_verovioOptions.FONT,D.inputFrom="auto",D.humType=1,D.tupletNumHead=0,D.justifyVertically=0,D.leftMarginClef=1.5,D.lyricSize=global_verovioOptions.LYRIC_SIZE,D.minLastJustification=.5,D.footer="none",D.header="none",D.pageHeight=6e4,D.pageMarginBottom=40,D.pageMarginLeft=30,D.pageMarginRight=20,D.pageMarginTop=100,D.pageWidth=2500,D.scale=global_verovioOptions.SCALE,D.spacingLinear=.25,D.spacingNonLinear=.6,D.spacingStaff=global_verovioOptions.SPACING_STAFF,D.spacingSystem=global_verovioOptions.SPACING_SYSTEM,D.staffLineWidth=.12,D.outputIndent=1;let y=document.querySelector("#comments-section"),F=0;if(y){F=y.getBoundingClientRect().width;let U=[...y.classList].find(K=>/^col/g.test(K));U!=null&&U.includes("col-0")&&(F=0)}var R=$("#input").outerWidth();$("#input").css("display")=="none"&&(R=0),D.pageWidth=(window.innerWidth-R-F)/(global_verovioOptions.ZOOM*global_verovioOptions.SCALE/40)-100;var O=global_editorOptions.SPACINGADJUSTMENT+D.spacingLinear;return O<.05&&(O=.05),D.spacingLinear=O,D}function musicxmlToHumdrumOptions(){return{inputFrom:"musicxml-hum"}}function musedataToHumdrumOptions(){return{inputFrom:"musedata-hum"}}function meiToHumdrumOptions(){return{inputFrom:"mei-hum",breaks:"auto"}}function esacToHumdrumOptions(){return{inputFrom:"esac"}}function loadEditorFontSizes(){var D=localStorage.INPUT_FONT_SIZE;D?D*=1:D=1,D<.25&&(D=.25),D>3&&(D=3),global_editorOptions.INPUT_FONT_SIZE=D;var y=localStorage.SCALE;y?y*=1:y=40,(y<1||y>1e3)&&(y=40),global_verovioOptions.SCALE=y}var de;(de=document.getElementById("play-button"))==null||de.addEventListener("click",()=>playCurrentMidi(global_cursor.CursorNote));localStorage.FONT&&(global_verovioOptions.FONT=cleanFont(localStorage.FONT));const markup=new HnpMarkup;document.addEventListener("DOMContentLoaded",function(){loadEditorFontSizes();var D=document.querySelector("#input");D&&(D.style.fontSize=global_editorOptions.INPUT_FONT_SIZE+"rem"),setEditorMode("humdrum");var y=new Date().getTime(),F=localStorage.getItem("AUTOSAVE_DATE"),R=y-F,O=localStorage.getItem("AUTOSAVE"),U=decodeURIComponent(O);U||(U=""),!U.match(/^\s*$/)&&R<6e4&&document.querySelector("#input"),getAceEditor()._dispatchEvent("ready"),setupDropArea(),displayNotation(),setupSplitter();var K=document.querySelector("body");K.addEventListener("click",function(q){var W,X;if(inSvgImage(q.target)){(W=q.target)==null||W.closest("[id]");let j=document.getElementById("show-edit-suggest-buttons");j.style.visibility="hidden";let Z=q.target.closest(".harm");if(Z){chordLocation.line=Z.id.split("L")[1].split("F")[0],chordLocation.column=Z.id.split("L")[1].split("F")[1],j.style.visibility="visible";let J=Z.getBoundingClientRect(),Q=J.x+window.scrollX+25,ee=J.y+window.scrollY+25,oe=document.getElementById("jitsi-meeting-container");oe&&(j.style.transform=`translateY(-${oe.getBoundingClientRect().height}px)`),j.style.top=`${ee}px`,j.style.left=`${Q}px`}dataIntoView(q)}(X=q.target)!=null&&X.id.startsWith("details-note")||$('[data-toggle="popover"]').popover("hide")}),window.addEventListener("keydown",processNotationKeyCommand,!0),window.addEventListener("keydown",processInterfaceKeyCommand);const B=document.getElementById("collab-menu-toolbar-toggle"),G=document.getElementById("collaborative-menu-toolbar");B.addEventListener("click",()=>{const q=B.classList.toggle("collab-menu-toolbar-toggle-open");G.classList.toggle("shown",q)}),observeSvgContent()});featureIsEnabled("collaboration")||window.addEventListener("load",()=>{var y,F;const D=Number((F=(y=getAceEditor())==null?void 0:y.getSession())==null?void 0:F.getLength());!Number.isNaN(D)&&D<10&&loadFileFromURLParam().then(R=>console.log(`Editor initialized with: ${R}`))});function extractEditorPosition(D){var y=D.id,F;if(F=y.match(/L(\d+)/))var R=parseInt(F[1]);else return;if(F=y.match(/F(\d+)/))var O=parseInt(F[1]);else return;if(F=y.match(/S(\d+)/))var U=parseInt(F[1]);else U=null;if((F=y.match(/N(\d+)/))&&parseInt(F[1]),F=y.match(/^([a-z]+)-/))F[1];else return;if(!(R<1||O<1))return{id:y,line:R,field:O,subfield:U}}function transposeMultiSelect(D,y){const F=Array.from(document.querySelectorAll(D.multiSelect.map(O=>"#"+O).join(","))).map(O=>extractEditorPosition(O)).filter(Boolean).map(O=>({...O,amount:y})),R=transposeNotes(F);return setEditorContentsMany(R),R}function sendChangePitchAction(D,y="single"){console.log({transposedNote:D}),D&&sendAction(new ActionPayload({type:"change_pitch",content:JSON.stringify({type:y,change:D})})).then(()=>console.log("change_pitch action was sent.")).catch(()=>console.error("Failed to send change_pitch action"))}function processNotationKeyCommand(D){if(D.preventDefault||(D.preventDefault=function(){}),D.altKey||D.target.nodeName=="TEXTAREA"||document.activeElement.nodeName=="INPUT")return;if(D.code===ZKey&&(D.ctrlKey||D.metaKey)){const F=getAceEditor();if(!F)throw new Error("Ace Editor is undefined");featureIsEnabled("collaboration")?yUndoManager==null||yUndoManager.undo():F.undo();return}const y=yProvider==null?void 0:yProvider.awareness.getLocalState();if(y!=null&&y.multiSelect){if(D.code===UpKey&&D.shiftKey){const F=transposeMultiSelect(y,1);sendChangePitchAction(F,"multi");return}else if(D.code===DownKey&&D.shiftKey){const F=transposeMultiSelect(y,-1);sendChangePitchAction(F,"multi");return}else if(D.code===UpKey&&D.ctrlKey){const F=transposeMultiSelect(y,7);sendChangePitchAction(F,"multi");return}else if(D.code===DownKey&&D.ctrlKey){const F=transposeMultiSelect(y,-7);sendChangePitchAction(F,"multi");return}}if(!!global_cursor.CursorNote&&!!global_cursor.CursorNote.id)switch(D.code){case AKey:processNotationKey("a",global_cursor.CursorNote);break;case BKey:processNotationKey("b",global_cursor.CursorNote);break;case CKey:processNotationKey("c",global_cursor.CursorNote);break;case DKey:D.shiftKey&&processNotationKey("D",global_cursor.CursorNote);break;case FKey:processNotationKey("f",global_cursor.CursorNote);break;case IKey:processNotationKey("i",global_cursor.CursorNote);break;case JKey:D.shiftKey&&processNotationKey("J",global_cursor.CursorNote);break;case LKey:D.shiftKey&&processNotationKey("L",global_cursor.CursorNote);break;case MKey:D.shiftKey?processNotationKey("M",global_cursor.CursorNote):processNotationKey("m",global_cursor.CursorNote);break;case NKey:processNotationKey("n",global_cursor.CursorNote);break;case PKey:D.shiftKey?processNotationKey("P",global_cursor.CursorNote):processNotationKey("p",global_cursor.CursorNote);break;case QKey:processNotationKey("q",global_cursor.CursorNote);break;case SKey:processNotationKey("s",global_cursor.CursorNote);break;case TKey:D.shiftKey?processNotationKey("T",global_cursor.CursorNote):processNotationKey("t",global_cursor.CursorNote);break;case VKey:global_cursor.CursorNote.id.match("note-")&&processNotationKey("^",global_cursor.CursorNote);break;case WKey:D.shiftKey?processNotationKey("W",global_cursor.CursorNote):processNotationKey("w",global_cursor.CursorNote);break;case XKey:processNotationKey("X",global_cursor.CursorNote);break;case YKey:processNotationKey("y",global_cursor.CursorNote);break;case OneKey:processNotationKey("1",global_cursor.CursorNote);break;case TwoKey:D.shiftKey?processNotationKey("@",global_cursor.CursorNote):processNotationKey("2",global_cursor.CursorNote);break;case ThreeKey:D.shiftKey?processNotationKey("#",global_cursor.CursorNote):processNotationKey("3",global_cursor.CursorNote);break;case FourKey:processNotationKey("4",global_cursor.CursorNote);break;case FiveKey:processNotationKey("5",global_cursor.CursorNote);break;case SixKey:global_cursor.CursorNote.id.match("note-")&&D.shiftKey?processNotationKey("^^",global_cursor.CursorNote):processNotationKey("6",global_cursor.CursorNote);break;case SevenKey:processNotationKey("7",global_cursor.CursorNote);break;case EightKey:processNotationKey("8",global_cursor.CursorNote);break;case NineKey:processNotationKey("9",global_cursor.CursorNote);break;case MinusKey:processNotationKey("-",global_cursor.CursorNote);break;case SingleQuoteKey:processNotationKey("'",global_cursor.CursorNote);break;case SemiColonKey:D.shiftKey?processNotationKey(":",global_cursor.CursorNote):processNotationKey(";",global_cursor.CursorNote);break;case BackQuoteKey:D.shiftKey?processNotationKey("~",global_cursor.CursorNote):processNotationKey("`",global_cursor.CursorNote);break;case UpKey:if(D.shiftKey){if(D.preventDefault(),D.stopPropagation(),global_cursor.CursorNote.id.match("note-")){console.log("Shift + Up, Current note: ",global_cursor.CursorNote);const F=processNotationKey("transpose-up-step",global_cursor.CursorNote);sendChangePitchAction(F)}}else if(D.ctrlKey){if(D.preventDefault(),D.stopPropagation(),global_cursor.CursorNote.id.match("note-")){const F=processNotationKey("transpose-up-octave",global_cursor.CursorNote);sendChangePitchAction(F)}}else D.preventDefault(),D.stopPropagation(),goUpHarmonically(global_cursor.CursorNote);break;case DownKey:if(D.shiftKey){if(D.preventDefault(),D.stopPropagation(),global_cursor.CursorNote.id.match("note-")){const F=processNotationKey("transpose-down-step",global_cursor.CursorNote);sendChangePitchAction(F)}}else if(D.ctrlKey){if(D.preventDefault(),D.stopPropagation(),global_cursor.CursorNote.id.match("note-")){const F=processNotationKey("transpose-down-octave",global_cursor.CursorNote);sendChangePitchAction(F)}}else D.preventDefault(),D.stopPropagation(),goDownHarmonically(global_cursor.CursorNote);break;case DeleteKey:case BackKey:processNotationKey("delete",global_cursor.CursorNote),D.stopPropagation();break;case LeftKey:global_cursor.CursorNote.id.match("slur-")?(D.preventDefault(),D.stopPropagation(),D.shiftKey?processNotationKey("rightEndMoveBack",global_cursor.CursorNote):processNotationKey("leftEndMoveBack",global_cursor.CursorNote)):(D.preventDefault(),D.stopPropagation(),goToPreviousNoteOrRest(global_cursor.CursorNote.id));break;case RightKey:global_cursor.CursorNote.id.match("slur-")?(D.preventDefault(),D.stopPropagation(),D.shiftKey?processNotationKey("rightEndMoveForward",global_cursor.CursorNote):processNotationKey("leftEndMoveForward",global_cursor.CursorNote)):(D.preventDefault(),D.stopPropagation(),goToNextNoteOrRest(global_cursor.CursorNote.id));break;case EscKey:D.preventDefault(),D.stopPropagation(),yProvider.awareness.setLocalStateField("singleSelect",{elemId:null}),processNotationKey("esc",global_cursor.CursorNote);break}}function processInterfaceKeyCommand(D){var y;if(D.preventDefault||(D.preventDefault=function(){}),!((!D.altKey||!D.ctrlKey)&&((y=D.target)==null?void 0:y.nodeName)=="TEXTAREA")&&!(!D.altKey&&document.activeElement.nodeName=="INPUT")){if(D.metaKey){D.code==ZeroKey&&(getMenu().resetTextFontSize(),global_verovioOptions.SCALE=40,localStorage.SCALE=global_verovioOptions.SCALE,displayNotation());return}switch(D.code){case AKey:break;case BKey:D.altKey&&D.shiftKey&&(addBarlineAboveCurrentPosition(),D.preventDefault());break;case CKey:D.altKey&&(D.shiftKey&&togglePlaceColoring(),D.preventDefault());break;case DKey:D.altKey&&(D.shiftKey&&addDataLineAboveCurrentPosition(),D.preventDefault());break;case EKey:D.altKey&&(clearContent(),D.preventDefault());break;case FKey:D.altKey&&(D.shiftKey?displayNotation(!1,!0):toggleFreeze(),D.preventDefault());break;case GKey:D.altKey&&(saveSvgData(),D.preventDefault());break;case HKey:D.altKey&&(global_interface.ShowingIndex||(showBufferedHumdrumData(),D.preventDefault()));break;case IKey:D.altKey&&D.shiftKey&&(addInterpretationLineAboveCurrentPosition(),D.preventDefault());break;case JKey:break;case KKey:break;case LKey:D.altKey&&(D.shiftKey?addLocalCommentLineAboveCurrentPosition():toggleLayerColoring(),D.preventDefault());break;case MKey:D.altKey&&(setEditorMode("xml"),D.shiftKey?displayMei():displayMeiNoType(),D.preventDefault());break;case NKey:break;case OKey:D.ctrlKey&&(D.preventDefault(),openFileFromDisk()),D.altKey&&(global_interface.OriginalClef=!global_interface.OriginalClef,console.log("Original clef changed to:",global_interface.OriginalClef),global_interface.ShowingIndex||displayNotation(),D.preventDefault());break;case PKey:D.altKey&&(displayPdf(),D.preventDefault());break;case QKey:D.altKey&&(D.shiftKey||toggleAppoggiaturaColoring(),D.preventDefault());break;case RKey:D.altKey&&(D.shiftKey?(restoreEditorContentsLocally(),D.preventDefault()):(reloadData(),D.preventDefault()));break;case SKey:D.altKey&&(D.shiftKey?(saveEditorContentsLocally(),D.preventDefault()):(saveEditorContents(),D.preventDefault()));break;case TKey:D.altKey&&(D.shiftKey?typeof generatePdfFull=="function"&&generatePdfSnapshot():typeof generatePdfSnapshot=="function"&&generatePdfFull(),D.preventDefault());break;case UKey:D.shiftKey?(decreaseTab(),D.preventDefault()):(toggleHumdrumCsvTsv(),D.preventDefault());break;case WKey:D.altKey&&(D.shiftKey?global_editorOptions.SPACINGADJUSTMENT-=.05:global_editorOptions.SPACINGADJUSTMENT+=.05,global_editorOptions.SPACINGADJUSTMENT<=0&&(global_editorOptions.SPACINGADJUSTMENT=0),D.preventDefault(),displayNotation());break;case XKey:break;case YKey:D.altKey&&(global_interface.ShowingIndex||toggleTextVisibility(),D.preventDefault());break;case ZeroKey:setInterfaceSingleNumber(0);break;case OneKey:setInterfaceSingleNumber(1);break;case TwoKey:setInterfaceSingleNumber(2);break;case ThreeKey:setInterfaceSingleNumber(3);break;case FourKey:setInterfaceSingleNumber(4);break;case FiveKey:setInterfaceSingleNumber(5);break;case SixKey:setInterfaceSingleNumber(6);break;case SevenKey:setInterfaceSingleNumber(7);break;case EightKey:setInterfaceSingleNumber(8);break;case NineKey:setInterfaceSingleNumber(9);break;case SpaceKey:global_playerOptions.PLAY?(global_playerOptions.PLAY=!1,global_playerOptions.PAUSE=!0,window.pause()):global_playerOptions.PAUSE?(window.play(),global_playerOptions.PLAY=!0,global_playerOptions.PAUSE=!1):(playCurrentMidi(global_cursor.CursorNote),global_playerOptions.PLAY=!0,global_playerOptions.PAUSE=!1),D.preventDefault();break;case CommaKey:D.shiftKey&&(decreaseTab(),D.preventDefault());break;case DotKey:D.shiftKey&&(increaseTab(),D.preventDefault());break;case UpKey:break;case PgUpKey:case LeftKey:D.shiftKey?displayWork(FILEINFO["previous-work"]):gotoPreviousPage(),D.preventDefault();break;case PgDnKey:case RightKey:D.shiftKey?displayWork(FILEINFO["next-work"]):gotoNextPage(),D.preventDefault();break;case HomeKey:gotoFirstPage(),D.preventDefault();break;case EndKey:gotoLastPage(),D.preventDefault();break;case SlashKey:D.shiftKey&&D.preventDefault();break;case EscKey:hideRepertoryIndex(),D.preventDefault();break}}}window.addEventListener("beforeunload",function(D){var y=encodeURIComponent(getTextFromEditorRaw());localStorage.setItem("AUTOSAVE",y),localStorage.setItem("AUTOSAVE_DATE",new Date().getTime()),localStorage.setItem("FONT",global_verovioOptions.FONT)});setInterval(function(){localStorage.setItem("SAVE0",encodeURIComponent(getTextFromEditorRaw()))},6e4);setInterval(function(){updateEditorMode()},1e3);function verovioCallback(D){if(console.log("SVG updated"),global_verovioOptions.GOTOTOPOFNOTATION){global_verovioOptions.GOTOTOPOFNOTATION=!1;let y=document.querySelector("#output");y&&y.scrollTo(0,0)}markup.loadSvg("svg")}getAceEditor().getSession().on("change",function(){var U,K;let D=getAceEditor(),y=D.getSession().getValue();if(!y){console.log("Kern file does not exist or hasn't yet loaded. Tempo cannot be extracted");return}let F=document.getElementById("tempo-input"),R=(U=y.match(/\*MM(\d+)/))==null?void 0:U[1];if(R)window.TEMPO=parseInt(R),F.placeholder=window.TEMPO;else{window.TEMPO=200;let B=y.match(/^\*\*.*\n/m)[0],G=B.replaceAll(/\*\*[^\t]*/g,`*MM${window.TEMPO}`),q=y.replace(B,B+G+`
`);D.setValue(q),F.placeholder=window.TEMPO}let O=(K=y.match(/\*M(\d)\/\d/))==null?void 0:K[1];O?window.BEATSPERMEASURE=parseInt(O):console.log("Time signature has not been encoded in kern file")});document.getElementById("change-tempo").addEventListener("click",()=>{let D=getAceEditor().getSession().getValue(),y=document.getElementById("tempo-input").value,F=D.replaceAll(/MM\d+/g,`MM${y}`).replaceAll(/t=\[quarter\]=\d+/g,`t=[quarter]=${y}`);getAceEditor().getSession().setValue(F,0)});function HMDIndex(D){return this.clear(),this.parse(D),this}HMDIndex.prototype.clear=function(){this.parameters={},this.items=[],this.groupedItems={},this.sortIndex={}};HMDIndex.prototype.setParameter=function(D,y){this.parameters[D]=y};HMDIndex.prototype.getParameter=function(D){return this.parameters[D]};HMDIndex.prototype.parse=function(D){this.clear();var y=0,F={},R=D.match(/[^\r\n]+/g);if(R.length==1&&R[0].match(/^https?:\/\//))return this.parseURL(R[0]);for(var O=0;O<R.length;O++){var U=R[O];if(!U.match(/^\s*$/)){var K=U.match(/^!!!([^!:\s]+)\s*:\s*(.*)\s*$/);if(K){this.setParameter(K[1],K[2]);continue}if(!U.match(/^!/)){if(U.match(/^\*\*/)){y=1;for(var B=U.split(/\t+/),G=0;G<B.length;G++){var q=B[G].match(/^\*\*(.*)/);q&&(F[q[1]]=G)}}if(!!y&&!U.match(/^\*/)){var W=U.split(/\t+/);if(!(W.length<1)){var X="",j="",Z="",J="",Q="";W[F.file]&&(X=W[F.file]),W[F.sort]&&(j=W[F.sort]),W[F.available]&&(Z=W[F.available]),W[F.pdf]&&(J=W[F.pdf]),W[F.description]&&(Q=cleanTitle(W[F.description])),this.addEntry({filename:X,sortkey:j,available:Z,pdfname:J,description:Q})}}}}}return this.sortEntries(),this};HMDIndex.prototype.sortEntries=function(){this.items.sort(function(D,y){return D.sortkey<y.sortkey?-1:D.sortkey>y.sortkey?1:0})};HMDIndex.prototype.parseURL=function(D){var y=this,F=new XMLHttpRequest;F.open("GET",D),F.onload=function(){F.status==200?y.parse(F.responseText):reject("ERROR:",F.status)},F.send()};HMDIndex.prototype.addEntry=function(D){var y=D.filename,F=D.sortkey,R=D.available,O=D.pdfname,U=cleanTitle(D.description),K;if(!(!y||y===".")){(!R||R===".")&&(R="Y"),R!=="Y"&&R!=="N"&&(R.match(/y/i)?R="Y":R="N"),R||(R="Y"),(!F||F===".")&&(F=y),(!O||O===".")&&(O=""),(!U||U===".")&&(U=y);var B="",G="",q="",W={sortkey:F,description:U,pdfname:O};if(y.match(/^@/)){W.group=y.replace(/^@/,"").split(":");for(var X=0;X<W.group.length;X++)this.groupedItems[W.group[X]]=!0}else K=y.match(/(.*)\//),K&&(B=K[1]),K=y.match(/([^\/]+?)(\.[^\/.]*)?$/),K?(q=K[2],G=K[1]):(K=y.match(/([^\/]+)$/),K&&(G=K[1])),W.available=R,W.file={fullname:y,extension:q,directory:B,basename:G};this.items.push(W),this.sortIndex[F]=W}};HMDIndex.prototype.generatHtml=HMDIndex.prototype.generateHTML;HMDIndex.prototype.generateHTML=function(){console.log("OBJECT HMD",this),this.parameters&&this.parameters.github;var D="";D+=`<table class='index-list'>
`;for(var y=0;y<this.items.length;y++){var F=this.items[y].sortkey;this.groupedItems[F]!==!0&&(this.items[y].file?D+=this.generateFileHTML(this.items[y]):this.items[y].group&&(D+=this.generateGroupHTML(this.items[y])))}return D+=`</table>
`,D};HMDIndex.prototype.cleanTitle=function(D){return cleanRepertoryEntryText(D)};HMDIndex.prototype.generateFileHTML=function(D,y){var F="";F+="<tr>",F+="<td>";var R=cleanTitle(D.description),O=R.match(/(.*)<link>(.*?)<\/link>(.*)/),U="",K="";return O&&(U=O[1],K=O[3],R=O[2]),R.match(/^\s*$/)&&(R=D.file.basename),y&&(F+="<span class='indenter'></span>"),F+=U,F+="<span class='ilink'",F+=` onclick='displayWork("`,F+=this.parameters.githubbase,F+="/",F+=D.file.fullname,F+='");',F+="'>",F+=R,F+="</span>",F+=K,F+="</td>",F+=`</tr>
`,F};HMDIndex.prototype.generateGroupHTML=function(D){var y="";y+=`<tr><td class='igroup'>
`,y+=cleanTitle(D.description),y+=`</td></tr>
`;for(var F=1,R=0;R<D.group.length;R++){var O=this.sortIndex[D.group[R]];y+=this.generateFileHTML(O,F)}return y};let vrvWorker$3=getVrvWorker();if(!vrvWorker$3)throw new Error("Verovio worker is undefined");let recursionCnt=0,hmdIndex;function loadKernScoresFile(D,y){var F=D.file,R=D.measures;D.page;var O=D.next;if(D.previous,F=applyUrlAliases(F),R)var O=!1;if(recursionCnt++,recursionCnt>1e4){console.log("RECURSION TOO LARGE",F);return}var U="",K="",B;F?F.match(/^https?:/)?(U=F,K=F):F.match(/^bb:/)||F.match(/^bitbucket:/)?(B=getBitbucketUrl(F),B&&(U=B.url,K=B.key)):F.match(/^github:/)?(B=getGithubUrl(F),B&&(U=B.url,K=B.key)):(B=kernScoresUrl(F,R),B&&(U=B.url,K=B.url)):D.tasso?(B=getTassoUrl(D.tasso,R),B&&(U=B.url,K=B.key)):D.bb?(B=getBitbucketUrl(D.bb),B&&(U=B.url,K=B.key)):D.github?(B=getGithubUrl(D.bb),B&&(U=B.url,K=B.key)):D.bitbucket&&(B=getBitbucketUrl(D.bitbucket),B&&(U=B.url,K=B.key)),K||(K="DATA");var G=getRequires(U,K),q=commaDuplicate(K);if(y)for(var W=0;W<q.length;W++)basketSession.remove(K[W]),console.log("removed ",K[W]);redrawInputArea();var X=142,j,Z=basketSession.get(q[0]);if(D&&D.file&&D.file.match(/musedata/))basketSession.require(...G).then(function(){for(var J=[],Q=0;Q<q.length;Q++)J[Q]=basketSession.get(q[Q]);var ee="";for(commaDuplicate(K),Q=0;Q<J.length;Q++){ee+=`&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
`;var oe=J[Q].url;ee+="@filename=="+oe+`
`,ee+=`&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
`;var re=J[Q];ee+=re.data,ee+=`/eof
`}if(ee+=`//
`,displayScoreTextInEditor(ee,vrvWorker$3.page),!(J.length>1)){if(J.length==1){if(Z=basketSession.get(K),console.log("INFO = ",Z),Z)try{if(j=JSON.parse(Z.data),y){try{var ne=atob(j.content)}catch{}ne.match(/^\s*$/)&&(ne=`!!!ONB: No data content
`);try{displayScoreTextInEditor(atob(j.content),vrvWorker$3.page)}catch{displayScoreTextInEditor(j.content,vrvWorker$3.page)}}O&&processInfo(j,D,!1,!1)}catch(te){console.log("Error downloading",K,"Error:",te),displayScoreTextInEditor(Z.data,vrvWorker$3.page)}else console.log("Error retrieving",K);redrawInputArea()}}},function(){console.log("Error retrieving",K)});else if(!Z)console.log("Going to download",K),basketSession.require({url:U,key:K,expire:X,execute:!1}).then(function(){if(Z=basketSession.get(K),Z)if(Z.url.match(/\/index.hmd$/))hmdIndex=new HMDIndex(Z.data),hmdIndex.parameters.githubbase=F,displayHmdIndexFinally(hmdIndex,U);else try{if(j=JSON.parse(Z.data),y){var J=atob(j.content);J.match(/^\s*$/)&&(J=`!!!ONB: No data content
`),displayScoreTextInEditor(atob(j.content),vrvWorker$3.page)}O&&processInfo(j,D,!1,!1)}catch(Q){console.log("Error downloading",K,"Error:",Q),displayScoreTextInEditor(Z.data,vrvWorker$3.page)}else console.log("Error1 retrieving",K);redrawInputArea()},function(){console.log("Error2 retrieving",K)});else try{j=JSON.parse(Z.data),O&&processInfo(j,D,!1,!1)}catch{displayScoreTextInEditor(Z.data,vrvWorker$3.page),redrawInputArea()}}function getTassoUrl(D,y){var F=D.replace(/\.krn$/,""),R="https://josquin.stanford.edu/cgi-bin/tasso?&file="+F;R+="&a=humdrum";var O=F;return y&&(R+="&mm="+y,O+="&mm="+y),{url:R,key:O}}function getGithubUrl(D,y){D=D.replace(/^github:\/*/,"");var F="",R="",O="",U="";U="https://raw.githubusercontent.com/";var K=D.match("^/*([^/]+)/([^/]+)/?(.*)");K&&(F=K[1],R=K[2],O=K[3]),U+=F,U+="/",U+=R,U+="/master/",O?U+=O:U+="index.hmd";var B=O,G={url:U,key:B};return G}function getBitbucketUrl(D,y){D=D.replace(/^(bb|bitbucket):/,"");var F="",R="",O="",U="";U="https://bitbucket.org/";var K=D.match("^/?([^/]+)/([^/]+)/(.*)");K&&(F=K[1],R=K[2],O=K[3]),U+=F,U+="/",U+=R,U+="/raw/master/",U+=O;var B=O;return{url:U,key:B}}function kernScoresUrl(D,y){var F,R,O="",U="",K,B=!1,G=!1,q=!1;if((K=D.match(/^(j|jrp):\/?\/?(.*)/))?(B=!0,D=K[2]):(K=D.match(/^(g|gh|github):\/?\/?([^\/]+)\/([^\/]+)\/(.+)/))?(G=!0,O=K[2],U=K[3],D=K[4]):(K=D.match(/^nifc:\/?\/?(?:krn)?(.*)/i))&&(q=!0,D=K[1]),B?(R=D,F=""):G||q?R=D:(K=D.match(/(.*)\/([^\/]+)/))&&(F=K[1],R=K[2]),(!R||!R.match(/\.[a-z][a-z][a-z]$/))&&!B){loadIndexFile(D);return}if(R.match(/^\s*$/)&&!B){loadIndexFile(D);return}var W;B?(W="https://josquin.stanford.edu/cgi-bin/jrp?id="+R,W+="&a=humdrum"):q?W="https://humdrum.nifc.pl/krn/"+R:G?W="https://raw.githubusercontent.com/"+O+"/"+U+"/master/"+R:(W="https://kern.humdrum.org/data?l="+F+"&file="+R,W+="&format=info-json");var X="";return G||(X=F+"/"+R,y&&(W+="&mm="+y,X+="&mm="+y)),{url:W,key:X}}function loadHmdIndexFile(D){var y=new XMLHttpRequest;y.open("GET",url),y.addEventListener("load",function(){y.status==200&&(y.responseText,hmdIndex=new HMDIndex(info.data),$("html").css("cursor","auto"),displayHmdIndexFinally(hmdIndex,D))}),y.send()}function loadIndexFile(D){if(D.match(/index.hmd$/)){loadHmdIndexFile(D);return}var y="https://kern.humdrum.org/data?l="+D;y+="&format=index",console.log("Loading index",y);var F=new XMLHttpRequest;F.open("GET",y),F.addEventListener("load",function(){if(F.status==200){var R=F.responseText;$("html").css("cursor","auto"),displayIndexFinally(R,D)}}),F.send()}function displayIndexFinally(D,y){global_interface.ShowingIndex=!0,global_interface.InputVisible==!0&&(global_interface.UndoHide=!0,global_interface.ApplyZoom=!0);var F=D.split(/\r?\n/),R,O=[],U;for(R=0;R<F.length;R++)if(!F[R].match(/^\s*$/)&&(U=F[R].split(/\t+/),U.length>=3)){U[1].match(/(.*)HIDE$/)&&(U[2]=U[2].replace(/<hlstart>/g,""),U[2]=U[2].replace(/<hlend>/g,""));let Q=U[1]+"	"+U[0]+"	"+U[2];O.push(Q)}O.sort();var K=[];for(R=0;R<O.length;R++){U=O[R].split(/\t+/);var B={};B.sorter=U[0],B.filename=U[1],B.text=cleanRepertoryEntryText$1(U[2]),K.push(B)}var G={},q="<table class='index-list'>";for(R=0;R<K.length;R++)if(!K[R].text.match(/^All /)){if(K[R].text=K[R].text.replace(/\[?<a[^>]*wikipedia[^<]*.*?<\/a>\]?/gi,""),q+="<tr><td>",(G[K[R].sorter]||G[K[R].sorter.replace(/HIDE$/,"")])&&(q+="<span class='indenter'></span>"),K[R].filename.match(/^@/)){K[R].text.replace(/<not>.*?<\/not>/g,""),q+=K[R].text;var W=K[R].filename;W=W.replace(/^@/,"");var X=W.split(/:/);G={};for(var j=0;j<X.length;j++)G[X[j]]="true"}else if(K[R].sorter.match(/HIDE$/)){var Z="";Z+=y,Z+="/"+K[R].filename,Z+=`');">`,K[R].text=K[R].text.replace(/<hlstart>/,Z),q+=K[R].text}else if(!K[R].text.match(/hlstart/))q+=`<span class='ilink' onclick="displayWork('`,q+=y,q+="/"+K[R].filename,q+=`');">`,q+=K[R].text,q+="</span>";else{var Z="";Z+=`<span class='ilink' onclick="displayWork('`,Z+=y,Z+="/"+K[R].filename,Z+=`');">`,K[R].text=K[R].text.replace(/<hlstart>/,Z),K[R].text.match(/<hlend>/)?K[R].text=K[R].text.replace(/<hlend>/,"</span>"):K[R].text+="</span>",q+=K[R].text}q+="</td></tr>"}q+="</table>";var J=document.querySelector("#index");J.innerHTML=q,J.style.visibility="visible",J.style.display="block"}function cleanRepertoryEntryText$1(D){D=D.replace(/-sharp/g,"&sharp;").replace(/-flat/g,"&flat;"),D=D.replace(/<not>.*?<\/not>/g,"");let y=D.match(/@\{link:([^}]+)\}/);if(y){let F=y[1],R="";F.match(/https?:\/\/.*wikipedia/)&&(R+='<a target="_blank" href="'+F+'">',R+=`<span style="float:right; font-size:60%" class="fa-stack fa-1x">
`,R+=`<i class="fas fa-square fa-stack-2x"></i>
`,R+=`<i class="fab fa-wikipedia-w fa-stack-1x fa-inverse"></i>
`,R+=`</span>
`,R+=`</a>
`,D=D.replace(/@\{link:[^}]+\}/,R))}return D}function displayHmdIndexFinally(D,y){if(D.parameters.hmdindexurl||(D.parameters.hmdindexurl=y),D.parameters.hmdindexurl&&!D.parameters.baseurl){var F=D.parameters.hmdindexurl.replace(/\/index.hmd$/,"");D.parameters.baseurl=F}global_interface.ShowingIndex=!0,global_interface.InputVisible==!0&&(global_interface.UndoHide=!0,global_interface.ApplyZoom=!0);var R=document.querySelector("#index");R.innerHTML=D.generateHTML(),R.style.visibility="visible",R.style.display="block"}function applyUrlAliases(D){if(!D)return D;var y;if(y=D.match(/https:\/\/github.com\/([^\/]+)\/([^\/]+)\/blob\/([^\/]+)\/(.*)/),y){var F=y[1],R=y[2],O=y[3],U=y[4];D="https://raw.githubusercontent.com/"+F+"/"+R+"/",D+=O+"/"+U}return D}function getRequires(D,y){var F=172,R;if(!y.match(/,/))return R=[{url:D,key:y,expire:F,execute:!1}],R;var O=commaDuplicate(D),U=commaDuplicate(y);R=[];for(var K=0;K<O.length;K++)R.push({url:O[K],key:U[K],expire:F,execute:!1});return R}function commaDuplicate(D){var y=D.split(/\s*,\s*/),F=y[0],R=F.match(/^(.*\/)([^\/]+)/);if(!R)return D;var O=R[1];y[0]=R[2];for(var U=[],K=0;K<y.length;K++)U.push(O+y[K]);return U}function processInfo(D,y,F,R){var O;if(D)setFileInfo(D),O=Base64.decode(D.content);else{console.log("Impossible error for",D);return}var U;y&&y.file&&(U=y.file.match(/([^\/]+)$/))&&(global_editorOptions.SAVEFILENAME=U[1]),displayScoreTextInEditor(O,vrvWorker$3.page),document.getElementById("bpm_show").removeAttribute("hidden"),y.next=!1,y.previous=!1,y&&(D["next-work"]&&(y.file=D["next-work"],loadKernScoresFile(y)),D["previous-work"]&&(y.file=D["previous-work"],loadKernScoresFile(y)))}function convertToMusicXmlAndSave(){if(document.body.classList.contains("waiting")){alert("Already converting a score");return}let D=new FormData,y=getTextFromEditor();var F=new Blob([y],{type:"text/x-humdrum"});D.append("inputdata",F);for(var R of D.entries())console.log("FORMDATA",R[0]+", "+R[1]);document.body.classList.add("waiting");let O=new XMLHttpRequest;O.open("POST","https://data.musicxml.humdrum.org"),O.responseType="blob",O.onload=function(){document.body.classList.remove("waiting");let U=this.response,K=window.URL.createObjectURL(U),B=document.createElement("a");document.body.appendChild(B),B.style="display: none",B.href=K,B.download="data.musicxml",B.click(),document.body.removeChild(B)},O.send(D)}class MenuInterface{constructor(){this.contextualMenus={}}initialize(){this.contextualMenus=this.getContextualMenus()}hideContextualMenus(){for(var y=Object.keys(this.contextualMenus),F=0;F<y.length;F++)this.contextualMenus[y[F]].style.display="none"}hideMenus(y){this.hideContextualMenu()}showMenu(y){this.showContextualMenu(y)}showContextualMenu(y){for(var F=Object.keys(this.contextualMenus),R=0;R<F.length;R++)y===F[R]?this.contextualMenus[F[R]].style.display="block":this.contextualMenus[F[R]].style.display="none"}showCursorNoteMenu(y){if(!y){this.hideContextualMenus();return}var F=y.id;if(!F){this.hideContextualMenus();return}var R=F.match(/^([A-Z]+)-/i);if(!R){this.hideContextualMenus();return}var O=R[1];O=O.charAt(0).toUpperCase()+O.slice(1),this.showContextualMenu(O)}showComments(){toggleCommentsVisibility(!0)}hideComments(){toggleCommentsVisibility(!1)}getContextualMenus(){var y={},F=document.querySelector("#navbarNavDropdown");if(!F)return y;var R=F.querySelectorAll("li.contextual");if(!R)return y;for(var O=0;O<R.length;O++){var U=R[O].querySelector(".menu-name");if(!!U){var K=U.textContent.trim();y[K]=R[O]}}return y}toggleOriginalClefs(){var y={};y.code=OKey,y.altKey=!0,processInterfaceKeyCommand(y)}displaySvgData(){var y={};y.code=GKey,y.altKey=!0,processInterfaceKeyCommand(y)}saveSvgData(){var y={};y.code=GKey,y.altKey=!0,processInterfaceKeyCommand(y)}loadRepertory(y,F){var R={file:y,next:!0,previous:!0};F&&(R.filter=F),loadKernScoresFile(R)}loadFromRepository(){promptForFile()}exportToPrivateFiles(){exportKernToPrivateFiles()}openScoreFileFromDisk(){var y={};y.code=OKey,y.ctrlKey=!0,processInterfaceKeyCommand(y)}saveAsMIDI(){saveContentAsMIDI()}saveTextEditorContents(){var y={};y.code=SKey,y.altKey=!0,processInterfaceKeyCommand(y)}compileEmbeddedFilters(){var y={};y.code=CKey,y.altKey=!0,processInterfaceKeyCommand(y)}clearEditorContents(){var y={};y.code=EKey,y.altKey=!0,processInterfaceKeyCommand(y)}showSourceScan(){var y={};y.code=PKey,y.altKey=!0,processInterfaceKeyCommand(y)}createPdf(){var y={};y.code=TKey,y.altKey=!0,processInterfaceKeyCommand(y)}reloadFromSource(){var y={};y.code=RKey,y.altKey=!0,processInterfaceKeyCommand(y)}createPdfPage(){var y={};y.code=TKey,y.altKey=!0,y.shiftKey=!0,processInterfaceKeyCommand(y)}increaseNotationSpacing(){var y={};y.code=WKey,y.altKey=!0,processInterfaceKeyCommand(y)}decreaseNotationSpacing(){var y={};y.code=WKey,y.altKey=!0,y.shiftKey=!0,processInterfaceKeyCommand(y)}decreaseStaffSpacing(){global_verovioOptions.SPACING_STAFF-=1,global_verovioOptions.SPACING_STAFF<0&&(global_verovioOptions.SPACING_STAFF=0),displayNotation()}increaseStaffSpacing(){global_verovioOptions.SPACING_STAFF+=1,global_verovioOptions.SPACING_STAFF>24&&(global_verovioOptions.SPACING_STAFF=24),displayNotation()}decreaseSystemSpacing(){global_verovioOptions.SPACING_SYSTEM-=1,global_verovioOptions.SPACING_SYSTEM<0&&(global_verovioOptions.SPACING_SYSTEM=0),displayNotation()}increaseSystemSpacing(){global_verovioOptions.SPACING_SYSTEM+=1,global_verovioOptions.SPACING_SYSTEM>12&&(global_verovioOptions.SPACING_SYSTEM=12),displayNotation()}decreaseLyricSize(){global_verovioOptions.LYRIC_SIZE-=.25,global_verovioOptions.LYRIC_SIZE<2&&(global_verovioOptions.LYRIC_SIZE=2),displayNotation()}increaseLyricSize(){global_verovioOptions.LYRIC_SIZE+=.25,global_verovioOptions.LYRIC_SIZE>8&&(global_verovioOptions.LYRIC_SIZE=8),displayNotation()}useLeipzigFont(){global_verovioOptions.FONT="Leipzig",displayNotation()}useLelandFont(){global_verovioOptions.FONT="Leland",displayNotation()}usePetalumaFont(){global_verovioOptions.FONT="Petaluma",displayNotation()}useBravuraFont(){global_verovioOptions.FONT="Bravura",displayNotation()}useGootvilleFont(){global_verovioOptions.FONT="Gootville",displayNotation()}applyFilter(y,K,R){var O="";K?O=K.replace(/^\s+|\s+$/g,""):O=editor$2.getValue().replace(/^\s+|\s+$/g,"");var U=humdrumToSvgOptions(),K=O+`
!!!filter: `+y+`
`;vrvWorker$2.filterData(U,K,"humdrum").then(function(B){B=B.replace(/\s+$/m,"");for(var G=B.match(/[^\r\n]+/g),q=G.length-1;q>=0;q--)if(G[q].match(/^!!!Xfilter:/)){G[q]="";break}B="";for(var q=0;q<G.length;q++)G[q]!==""&&(B+=G[q]+`
`);editor$2.setValue(B,-1),R&&R(B)})}insertLocalCommentLine(){var y={};y.code=LKey,y.shiftKey=!0,y.altKey=!0,processInterfaceKeyCommand(y)}insertNullDataLine(){var y={};y.code=DKey,y.shiftKey=!0,y.altKey=!0,processInterfaceKeyCommand(y)}insertInterpretationLine(){var y={};y.code=IKey,y.shiftKey=!0,y.altKey=!0,processInterfaceKeyCommand(y)}insertBarline(){var y={};y.code=BKey,y.shiftKey=!0,y.altKey=!0,processInterfaceKeyCommand(y)}toggleDataDisplay(){var y={};y.code=YKey,y.altKey=!0,processInterfaceKeyCommand(y)}toggleToolbarDisplay(){}toggleLogoDisplay(){var y={};y.code=BKey,y.altKey=!0,processInterfaceKeyCommand(y)}toggleLayerHighlighting(){var y={};y.code=LKey,y.altKey=!0,processInterfaceKeyCommand(y)}increaseTabSize(){var y={};y.code=DotKey,y.altKey=!0,y.shiftKey=!0,processInterfaceKeyCommand(y)}decreaseTabSize(){var y={};y.code=CommaKey,y.altKey=!0,y.shiftKey=!0,processInterfaceKeyCommand(y)}fitTabSizeToData(){for(var y=editor$2.getValue().match(/[^\r\n]+/g),F=4,R=0;R<y.length;R++)if(!y[R].match(/^\s*$/)&&!y[R].match(/^!/))for(var O=y[R].split("	"),U=0;U<O.length;U++)O[U].length>25||O[U].length>F&&(F=O[U].length+3);F>25&&(F=25),global_editorOptions.TABSIZE=F,editor$2.getSession().setTabSize(global_editorOptions.TABSIZE)}openUrl(y,F){F||(F="_blank"),window.open(y,F)}toggleCsvTsv(){toggleHumdrumCsvTsv()}toggleVimPlainTextMode(){var y={};y.code=VKey,y.altKey=!0,processInterfaceKeyCommand(y)}displayHumdrumData(){var y={};y.code=HKey,y.altKey=!0,processInterfaceKeyCommand(y)}displayMeiData(){var y={};y.code=MKey,y.altKey=!0,processInterfaceKeyCommand(y)}loadFromBuffer(y){var F={};switch(y){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",y);return}F.altKey=!0,processInterfaceKeyCommand(F),F.code=RKey,F.shiftKey=!0,processInterfaceKeyCommand(F)}saveToBuffer(y){var F={};switch(y){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",y);return}F.altKey=!0,processInterfaceKeyCommand(F),F.code=SKey,F.shiftKey=!0,processInterfaceKeyCommand(F)}goToLastPage(y){y||(y={}),y.code=EndKey,y.altKey=!0,processInterfaceKeyCommand(y)}goToFirstPage(y){y||(y={}),y.code=HomeKey,y.altKey=!0,processInterfaceKeyCommand(y)}goToPreviousWork(y){y||(y={}),y.code=LeftKey,y.altKey=!0,y.shiftKey=!0,processInterfaceKeyCommand(y)}goToNextWork(){var y={};y.code=RightKey,y.altKey=!0,y.shiftKey=!0,processInterfaceKeyCommand(y)}goToNextPage(y){y||(y={}),y.code=RightKey,y.altKey=!0,processInterfaceKeyCommand(y)}goToPreviousPage(y){y||(y={}),y.code=LeftKey,y.altKey=!0,processInterfaceKeyCommand(y)}toggleMidiPlayback(){var y={};y.code=SpaceKey,y.altKey=!0,processInterfaceKeyCommand(y)}toggleNotationFreezing(){var y={};y.code=FKey,y.altKey=!0,processInterfaceKeyCommand(y)}forceNoteStemUp(){processNotationKey("a",global_cursor.CursorNote)}forceNoteStemDown(){processNotationKey("b",global_cursor.CursorNote)}removeStemDirection(){processNotationKey("c",global_cursor.CursorNote)}toggleEditorialAccidental(){processNotationKey("i",global_cursor.CursorNote)}toggleNaturalAccidental(){processNotationKey("n",global_cursor.CursorNote)}toggleSharpAccidental(){processNotationKey("#",global_cursor.CursorNote)}toggleFlatAccidental(){processNotationKey("-",global_cursor.CursorNote)}toggleForcedDisplay(){processNotationKey("X",global_cursor.CursorNote)}toggleStaccato(){processNotationKey("'",global_cursor.CursorNote)}toggleMinorLowerMordent(){processNotationKey("m",global_cursor.CursorNote)}toggleMajorLowerMordent(){processNotationKey("M",global_cursor.CursorNote)}toggleMinorUpperMordent(){processNotationKey("w",global_cursor.CursorNote)}toggleMajorUpperMordent(){processNotationKey("W",global_cursor.CursorNote)}toggleFermata(){processNotationKey(";",global_cursor.CursorNote)}toggleArpeggio(){processNotationKey(":",global_cursor.CursorNote)}toggleAccent(){processNotationKey("^",global_cursor.CursorNote)}toggleMarcato(){processNotationKey("^^",global_cursor.CursorNote)}toggleStaccatissimo(){processNotationKey("`",global_cursor.CursorNote)}toggleTenuto(){processNotationKey("~",global_cursor.CursorNote)}toggleMajorTrill(){processNotationKey("T",global_cursor.CursorNote)}toggleMinorTrill(){processNotationKey("t",global_cursor.CursorNote)}forceSlurAbove(){processNotationKey("a",global_cursor.CursorNote)}forceSlurBelow(){processNotationKey("b",global_cursor.CursorNote)}removeSlurOrientation(){processNotationKey("c",global_cursor.CursorNote)}deleteSlur(){processNotationKey("D",global_cursor.CursorNote)}forceBeamAbove(){processNotationKey("a",global_cursor.CursorNote)}forceBeamBelow(){processNotationKey("b",global_cursor.CursorNote)}removeBeamOrientation(){processNotationKey("c",global_cursor.CursorNote)}forceTieAbove(){processNotationKey("a",global_cursor.CursorNote)}forceTieBelow(){processNotationKey("b",global_cursor.CursorNote)}removeTieOrientation(){processNotationKey("c",global_cursor.CursorNote)}breakBeamAfterNote(){processNotationKey("J",global_cursor.CursorNote)}breakBeamBeforeNote(){processNotationKey("L",global_cursor.CursorNote)}makeRestInvisible(){processNotationKey("y",global_cursor.CursorNote)}togglePedalDown(){processNotationKey("p",global_cursor.CursorNote)}togglePedalUp(){processNotationKey("P",global_cursor.CursorNote)}toggleGraceNoteStyle(){processNotationKey("q",global_cursor.CursorNote)}toggleAtMark(){processNotationKey("@",global_cursor.CursorNote)}addSlur(y){if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("s",global_cursor.CursorNote)}nextHarmonicNote(){goUpHarmonically(global_cursor.CursorNote)}previousHarmonicNote(){goDownHarmonically(global_cursor.CursorNote)}nextMelodicNote(){goToNextNoteOrRest(global_cursor.CursorNote.id)}previousMelodicNote(){goToPreviousNoteOrRest(global_cursor.CursorNote.id)}pitchDownStep(y){if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("transpose-down-step",global_cursor.CursorNote)}pitchUpStep(y){if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("transpose-up-step",global_cursor.CursorNote)}pitchUpOctave(y){if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("transpose-up-octave",global_cursor.CursorNote)}pitchDownOctave(y){if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("transpose-down-octave",global_cursor.CursorNote)}moveSlurStart(y){if(y<0){if(y<10&&y>1){y=-y;var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("leftEndMoveBack",global_cursor.CursorNote)}else{if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("leftEndMoveForward",global_cursor.CursorNote)}}moveSlurEnd(y){if(y<0){if(y=-y,y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("rightEndMoveBack",global_cursor.CursorNote)}else{if(y<10&&y>1){var F={};switch(bufferNumber){case 0:F.code=ZeroKey;break;case 1:F.code=OneKey;break;case 2:F.code=TwoKey;break;case 3:F.code=ThreeKey;break;case 4:F.code=FourKey;break;case 5:F.code=FiveKey;break;case 6:F.code=SixKey;break;case 7:F.code=SevenKey;break;case 8:F.code=EightKey;break;case 9:F.code=NineKey;break;default:console.log("UNKNOWN BUFFER:",bufferNumber);return}F.altKey=!0,processInterfaceKeyCommand(F)}processNotationKey("rightEndMoveForward",global_cursor.CursorNote)}}adjustNotationScale(y,F){y&&y.shiftKey?global_verovioOptions.SCALE=40:(global_verovioOptions.SCALE=parseInt(global_verovioOptions.SCALE*F+.5),global_verovioOptions.SCALE<15?global_verovioOptions.SCALE=15:global_verovioOptions.SCALE>500&&(global_verovioOptions.SCALE=500)),localStorage.SCALE=global_verovioOptions.SCALE,displayNotation()}increaseTextFontSize(y){y.shiftKey?global_editorOptions.INPUT_FONT_SIZE=1:(global_editorOptions.INPUT_FONT_SIZE*=1.05,global_editorOptions.INPUT_FONT_SIZE>3&&(global_editorOptions.INPUT_FONT_SIZE=3));var F=document.querySelector("#input");!F||(F.style.fontSize=global_editorOptions.INPUT_FONT_SIZE+"rem",localStorage.INPUT_FONT_SIZE=global_editorOptions.INPUT_FONT_SIZE)}resetTextFontSize(y){global_editorOptions.INPUT_FONT_SIZE=1;var F=document.querySelector("#input");!F||(F.style.fontSize=global_editorOptions.INPUT_FONT_SIZE+"rem",localStorage.INPUT_FONT_SIZE=global_editorOptions.INPUT_FONT_SIZE)}decreaseTextFontSize(y){y.shiftKey?global_editorOptions.INPUT_FONT_SIZE=1:(global_editorOptions.INPUT_FONT_SIZE*=.95,global_editorOptions.INPUT_FONT_SIZE<.25&&(global_editorOptions.INPUT_FONT_SIZE=.25));var F=document.querySelector("#input");!F||(F.style.fontSize=global_editorOptions.INPUT_FONT_SIZE+"rem",localStorage.INPUT_FONT_SIZE=global_editorOptions.INPUT_FONT_SIZE)}lineBreaksOff(){global_verovioOptions.BREAKS=!0}lineBreaksOn(){global_verovioOptions.BREAKS=!1}singlePageView(){var y=document.querySelector("#page-nav");y&&(y.style.display="none");var F=document.querySelector("#multi-page");F&&(F.style.display="block"),displayNotation()}multiPageView(){}startSplit(y){y||(y=32),MenuInterface.prototype.removeSplits();var F=editor$2.getValue().match(/[^\r\n]+/g),R=editor$2.getCursorPosition(),G,O=0,U=0,K=0,B;for(B=0;B<F.length;B++)if(F[B].match(/^=/)&&(O++,O==y)){F[B]=`!!ignore
`+F[B],B>F.row&&U++,K=1;break}if(!!K){var G="";for(B=0;B<F.length;B++)G+=F[B]+`
`;editor$2.setValue(G,-1),R.row+=U,editor$2.moveCursorToPosition(R)}}nextSplit(y){y||(y=32);var F=editor$2.getValue().match(/[^\r\n]+/g),R=editor$2.getCursorPosition();if(F.length!=0){var O,U=0,K=0,B=-1,G=0;for(O=1;O<F.length;O++)if(F[O]==="!!Xignore"){F[O]="XXX DELETE XXX",K=1;continue}else if(F[O]==="!!ignore"){F[O]="!!Xignore",K=1,B=O;break}if(!!K){for(O=B+1;O<F.length;O++)if(F[O].match(/^=/)&&(G++,G==y)){F[O]=`!!ignore
`+F[O],O>F.row&&U++;break}F[0]!=="!!ignore"&&(F[0]=`!!ignore
`+F[0],U++);var q="";for(O=0;O<F.length;O++)F[O]!=="XXX DELETE XXX"&&(q+=F[O]+`
`);editor$2.setValue(q,-1),R.row+=U,editor$2.moveCursorToPosition(R)}}}previousSplit(y){y||(y=32);var F=editor$2.getValue().match(/[^\r\n]+/g),R=editor$2.getCursorPosition();if(F.length!=0){var O,U=0,K=0,B=-1,G=0;for(O=1;O<F.length;O++)F[O]==="!!Xignore"?(F[O]="!!ignore",K=1,B=O):F[O]==="!!ignore"&&(F[O]="XXX DELETE XXX");if(!!K){for(O=B-2;O>0;O--)if(F[O].match(/^=/)&&(G++,G==y-1)){F[O]=`!!Xignore
`+F[O],O>F.row&&U++;break}F[0]!=="!!ignore"&&(F[0]=`!!ignore
`+F[0],U++);var q="";for(O=0;O<F.length;O++)F[O]!=="XXX DELETE XXX"&&(q+=F[O]+`
`);editor$2.setValue(q,-1),R.row+=U,editor$2.moveCursorToPosition(R)}}}removeSplits(){var y=editor$2.getValue().match(/[^\r\n]+/g),F="",R=editor$2.getCursorPosition(),O=R.row;R.column;for(var U=0,K=0;K<y.length;K++){if(y[K]==="!!ignore"){K<O&&O--,U++;continue}if(y[K]==="!!Xignore"){K<O&&O--,U++;continue}F+=y[K]+`
`}U&&(editor$2.setValue(F,-1),R.row=O,editor$2.moveCursorToPosition(R))}undo(){editor$2.undo()}convertToHumdrum(){replaceEditorContentWithHumdrumFile()}trimTabsInEditor(){trimTabsInEditor()}mimeEncode(){for(var y=getTextFromEditorNoCsvProcessing(),F=btoa(y).match(/.{1,80}/g),R="",O=0;O<F.length;O++)O<F.length-1?R+=F[O]+`
`:R+=F[O].replace(/=/g,"")+`
`;editor$2.setValue(R,-1)}mimeDecode(){var y=getTextFromEditorNoCsvProcessing();editor$2.setValue(y,-1)}convertToMusicXmlAndSave(){convertToMusicXmlAndSave()}}let menuInterface;function getMenu(){return typeof menuInterface>"u"&&(menuInterface=new MenuInterface,menuInterface.initialize()),menuInterface}let vrvWorker$2=getVrvWorker();if(!vrvWorker$2)throw new Error("Verovio worker is undefined");let editor$2=getAceEditor();if(!editor$2)throw new Error("Ace Editor is undefined");function goDownHarmonically(D){moveHarmonically(D,-1)}function goUpHarmonically(D){moveHarmonically(D,1)}function moveHarmonically(D,y){if(!!D){var F=D.id;unhighlightCurrentNote(D);var R=getNextHarmonicNote(F,y);!R||highlightIdInEditor(R)}}function inSvgImage(D){for(var y=D;y;){if(y.nodeName==="svg")return!0;y=y.parentNode}return!1}function observeSvgContent(){var D=document.querySelector("#output"),y,F,R=function(U,K){var B=D.querySelector("svg");if(B){let q=B.querySelectorAll("g.dir.problem tspan.rend tspan.text tspan.text");for(y=0;y<q.length;y++)F=q[y],F.innerHTML==="P"&&(F.innerHTML="&#xf071;",F.classList.add("p"));for(q=B.querySelectorAll("g.dir.sic tspan.rend tspan.text tspan.text"),y=0;y<q.length;y++)F=q[y],F.innerHTML==="S"&&(F.innerHTML="&#xf071;",F.classList.add("s"))}for(var G in U)B&&B.isSameNode(U[G].target)&&document.body.classList.remove("busy")},O=new MutationObserver(R);O.observe(D,{childList:!0,subtree:!0})}function turnOffAllHighlights(){for(var D=document.querySelector("svg"),y=D.querySelectorAll(".highlight"),F=0;F<y.length;F++){var R=y[F].className.baseVal;R=R.replace(/\bhighlight\b/,""),y[F].className.className=R,y[F].className.baseVal=R,y[F].className.animVal=R}}function getNextHarmonicNote(D,y){var F=D.match(/^[^-]+-[^-]*L(\d+)/),R=-1;if(F)R=parseInt(F[1]);else return;if(R!=-1){var O=document.querySelector("svg"),U=O.querySelectorAll('*[id]:not([id=""])'),K=new RegExp("^[^-]+-[^-]*L"+R+"(?!d)"),B=[],G,q;for(q=0;q<U.length;q++)if(U[q].id.match(K)){if(G=U[q].id.replace(/-.*/,""),!(G=="note"||G=="rest"||G=="mrest"))continue;B.push(U[q])}if(B.sort(function(Z,J){var Q=getStaffAndLayerNumbersByElement(Z),ee=getStaffAndLayerNumbersByElement(J),oe=Q.staff|0,re=ee.staff|0,ne=Q.layer|0,te=ee.layer|0;if(oe>re)return-1;if(oe<re)return 1;if(ne>te)return-1;if(ne<te)return 1;var ie,le=0,ce=0,se=0,ue=0;return(ie=Z.className.baseVal.match(/oct-(-?\d+)/))&&(le=parseInt(ie[1])),(ie=J.className.baseVal.match(/oct-(-?\d+)/))&&(ce=parseInt(ie[1])),(ie=Z.className.baseVal.match(/b40c-(\d+)/))&&(se=le*40+parseInt(ie[1])),(ie=J.className.baseVal.match(/b40c-(\d+)/))&&(ue=ce*40+parseInt(ie[1])),se<ue?-1:se>ue?1:0}),B.length!=1){for(var W=0;W<B.length;W++)getStaffAndLayerNumbersByElement(B[W]);var X=-1;for(q=0;q<B.length;q++)if(B[q].id===D){X=q;break}if(!(X<0)){var j=X+y;return j<0?j=B.length-1:j>=B.length&&(j=0),B[j].id}}}}function unhighlightCurrentNote(D){if(D){for(var y=D.getAttribute("class"),F=y.split(" "),R="",O=0;O<F.length;O++)F[O]!="highlight"&&(R+=" "+F[O]);D.setAttribute("class",R)}}function chooseBestId(D,y,F){for(var R=[0,0,0,0,0,0,0,0,0,0,0,0],O=0;O<D.length;O++){var U=getStaffAndLayerNumbers(D[O].id);if(U.staff==y&&(R[U.layer]=D[O],U.layer==F&&!D[O].id.match(/space/)))return D[O].id}if(R.length==1)return R[0].id;for(O=F;O>0;O--)if(!!R[O]&&!(R[O].id&&R[O].id.match(/space/)))return R[O].id;for(O=F;O<R.length;O++)if(!!R[O]&&!(R[O].id&&R[O].id.match(/space/)))return R[O].id;for(O=F;O>0;O--)if(!!R[O])return R[O].id;for(O=F;O<R.length;O++)if(!!R[O])return R[O].id}function getStaffPosition(D){for(var y=0,F=D;F;)F.className.baseVal.match(/staff/)&&y++,F=F.previousElementSibling;return y}function getLayerPosition(D){for(var y=0,F=D;F;)F.className.baseVal.match(/layer/)&&y++,F=F.previousElementSibling;return y}function getStaffAndLayerNumbers(D){var y=document.querySelector("#"+D);return getStaffAndLayerNumbersByElement(y)}function getStaffAndLayerNumbersByElement(D){if(!D)return{};D.id;var y=0,F=0,R=D;for(R=R.parentNode;R&&R.className.baseVal;)R.className.baseVal.match(/layer/)?F=getLayerPosition(R):R.className.baseVal.match(/staff/)&&(y=getStaffPosition(R)),R=R.parentNode;return{layer:F,staff:y}}function getOffClassElements(D){for(var y=document.querySelectorAll("."+D),F=document.querySelectorAll(".r"+D),R=[],O=0;O<y.length;O++){let B=y[O].className.baseVal.match(/qon-([^\s]+)/);if(B)var U=B[1];else U="xyz";if(B=y[O].className.baseVal.match(/qoff-([^\s]+)/),B)var K=B[1];else K="xyz";U!==K&&R.push(y[O])}for(var O=0;O<F.length;O++)R.push(F[O]);return R}function getOnClassElements(D){for(var y=document.querySelectorAll("."+D),F=document.querySelectorAll(".r"+D),R=[],O,U,K,B=0;B<y.length;B++)O=y[B].className.baseVal.match(/qon-([^\s]+)/),O?U=O[1]:U="xyz",O=y[B].className.baseVal.match(/qoff-([^\s]+)/),O?K=O[1]:K="xyz",U!==K&&R.push(y[B]);for(var B=0;B<F.length;B++)R.push(F[B]);return R}let vrvWorker$1=getVrvWorker();if(!vrvWorker$1)throw new Error("Verovio worker is undefined");function goToPreviousNoteOrRest(D){var y=document.querySelector("#"+D);if(!y){console.log("CANNOT FIND ITEM ",D);return}var F=getStaffAndLayerNumbers(y.id),R=y.className.baseVal.match(/qon-([^\s]+)/);if(!R){console.log("CANNOT FIND QON IN",y.className);return}var O=R[1];if(O!=0){var U="qoff-"+O,K=getOffClassElements(U),B;if(!!K)if(unhighlightCurrentNote(y),K.length==1)highlightIdInEditor(K[0].id);else if(K.length==0){if(vrvWorker$1.page==1){console.log("AT FIRST PAGE, so not continuing further");return}vrvWorker$1.gotoPage(vrvWorker$1.page-1).then(function(G){var q=G.page||vrvWorker$1.page;$("#overlay").hide().css("cursor","auto"),$("#jump_text").val(q),vrvWorker$1.renderPage(q).then(function(W){$("#output").html(W)}).then(function(){K=getOnClassElements(U),K.length==1?highlightIdInEditor(K[0].id):(B=chooseBestId(K,F.staff,F.layer),B&&(global_editorOptions.EDITINGID=B,highlightIdInEditor(B)))})})}else B=chooseBestId(K,F.staff,F.layer),B&&(global_editorOptions.EDITINGID=B,highlightIdInEditor(B))}}function goToNextNoteOrRest(D){var y=document.querySelector("#"+D);if(!!y){var F=getStaffAndLayerNumbers(y.id),R=y.className.baseVal.match(/qoff-([^\s]+)/);if(!!R){var O=R[1],U="qon-"+O,K=getOnClassElements(U),B;if(!!K)if(unhighlightCurrentNote(y),K.length==1)highlightIdInEditor(K[0].id);else if(K.length==0){if(vrvWorker$1.pageCount>0&&vrvWorker$1.pageCount==vrvWorker$1.page)return;vrvWorker$1.gotoPage(vrvWorker$1.page+1).then(function(G){var q=G.page||vrvWorker$1.page;$("#overlay").hide().css("cursor","auto"),$("#jump_text").val(q),vrvWorker$1.renderPage(q).then(function(W){$("#output").html(W)}).then(function(){K=getOnClassElements(U),K.length==1?highlightIdInEditor(K[0].id):(B=chooseBestId(K,F.staff,F.layer),B&&(global_editorOptions.EDITINGID=B,highlightIdInEditor(B)))})})}else B=chooseBestId(K,F.staff,F.layer),B&&(global_editorOptions.EDITINGID=B,highlightIdInEditor(B))}}}function toggleAppoggiaturaColoring(){var D=document.querySelector("#appoggiatura-color-stylesheet");if(D){var y=D.parentNode;y.removeChild(D);return}D=document.createElement("style");var F="";F+="g.appoggiatura-start { fill: limegreen; }",F+="g.appoggiatura-stop { fill: forestgreen; }",D.innerHTML=F,D.id="appoggiatura-color-stylesheet",document.body.appendChild(D)}function toggleLayerColoring(){var D=document.querySelector("#layer-color-stylesheet");if(D){var y=D.parentNode;y.removeChild(D);return}D=document.createElement("style");var F="";F+=`g[id^='layer-'][id*='N2'] { fill: #00cc00; }
`,F+=`g[id^='layer-'][id*='N3'] { fill: #cc00aa; }
`,F+=`g[id^='layer-'][id*='N4'] { fill: #0088cc; }
`,F+=`g[id^='layer-'][id*='N5'] { fill: #0000cc; }
`,F+=`g[id^='layer-'][id*='N6'] { fill: #cc0000; }
`,F+=`g[id^='layer-'][id*='N7'] { fill: #00cc00; }
`,F+="g.clef { fill: black !important; }",D.innerHTML=F,D.id="layer-color-stylesheet",document.body.appendChild(D)}function togglePlaceColoring(){var D=document.querySelector("#placed-color-stylesheet");if(D){var y=D.parentNode;y.removeChild(D);return}D=document.createElement("style");var F="g.placed { fill: orange; } ";F+="g.placed path { stroke: orange; } ",D.innerHTML=F,D.id="placed-color-stylesheet",document.body.appendChild(D)}function restoreSelectedSvgElement(D){if(!!D){var y=document.querySelector("#"+D);if(!!y){var F,R=D.match(/L(\d+)/);if(R)F=parseInt(F);else return;markItem(y,F)}}}function markItem(D,y){if(D||(D=global_cursor.CursorNote),!!D){if(global_editorOptions.EditorLine=y,global_cursor.CursorNote){for(var F=global_cursor.CursorNote.getAttribute("class"),R=F.split(" "),O="",U=0;U<R.length;U++)R[U]!="highlight"&&(O+=" "+R[U]);O=O.replace(/^\s+/,""),global_cursor.CursorNote.setAttribute("class",O)}if(D&&setCursorNote(D),global_cursor.CursorNote){for(var F=global_cursor.CursorNote.getAttribute("class"),R=F.split(" "),O="",U=0;U<R.length;U++)R[U]!="highlight"&&(O+=" "+R[U]);O+=" highlight",global_cursor.CursorNote.setAttribute("class",O)}}}function unhighlightAllElements(){if(!!global_cursor.CursorNote)for(var D=document.querySelectorAll("svg .highlight"),y=0;y<D.length;y++){for(var F=global_cursor.CursorNote.getAttribute("class"),R=F.split(" "),O="",y=0;y<R.length;y++)R[y]!="highlight"&&(O+=" "+R[y]);O=O.replace(/^\s+/,""),global_cursor.CursorNote.setAttribute("class",O)}}function highlightIdInEditor(D,y){if(unhighlightAllElements(),!D){console.log("NO ID so not changing to another element");return}let F=D.match(/^([^-]+)-[^-]*L(\d+)F(\d+)/);if(!F)return;F[1];var R=F[2],O=F[3],U=0;(F=D.match(/-.*L\d+F\d+S(\d+)/))&&(U=F[1]);const K=getAceEditor();if(!K)throw new Error("Ace Editor is undefined");var B=K.session.getLine(R-1),G=0;if(O>1){var q=0;for(let Q=0;Q<B.length&&(G++,B[Q]=="	"&&Q>0&&B[Q-1]!="	"&&q++,q!=O-1);Q++);}if(U>=1){for(var W=1;G<B.length&&W<U;)if(G++,B[G]==" "&&(W++,W==U)){G++;break}}let X=G;for(var j=B[X];X<B.length&&(X++,B[X]!=" ");){if(B[X]=="	")break;j+=B[X]}global_cursor.CursorNote=document.querySelector("#"+D),getMenu().showCursorNoteMenu(global_cursor.CursorNote),K.gotoLine(R,G);let Z=document.getElementById(D);if(Z.classList.contains("harm")&&Z.classList.contains("highlight")){let Q=K.session.doc.getLine(R-1),ee=G;for(;ee-G<Q.length;)ee++;chord.current=Q.substring(G,ee)}K.renderer.scrollCursorIntoView({row:R-1,column:G},.5),centerCursorHorizontallyInEditor();let J=K.find("^=\\d+",{backwards:!0,regExp:!0,wrap:!1});if(!J)window.MEASURENO=1;else{let Q=K.session.getTextRange(J).match(/\d+/)[0];window.MEASURENO=parseInt(Q)}}let editor$1=getAceEditor();if(!editor$1)throw new Error("Ace Editor is undefined");function centerCursorHorizontallyInEditor(){let D=getAceEditor().renderer.$cursorLayer.getPixelPosition(0).left,y=editor$1.renderer.$size.scrollerWidth;D>y/2&&editor$1.renderer.scrollToX(D-y/2)}const editorModes={humdrum:{theme:"ace/theme/humdrum_light"},xml:{theme:"ace/theme/solarized_light"},musedata:{theme:"ace/theme/solarized_light"}};function setEditorModeAndKeyboard(){if(editor$1){const D=editorMode();editor$1.setTheme(editorModes[D].theme),editor$1.getSession().setMode("ace/mode/"+D)}}function showIdInEditor(D){if(editorMode()!="xml"){var y=D.match(/-[^-]*L(\d+)/);if(!!y){var F=parseInt(y[1]);editor$1.gotoLine(F,0),editor$1.centerSelection()}}}function getMode(D){return D?D.match(/^\s*</)?"xml":D.substring(0,2e3).match(/Group memberships:/)?"musedata":D.substring(0,2e3).match(/^[A-Za-z0-9+\/\s]+$/)?"mime":"humdrum":"humdrum"}function humdrumDataNoteIntoView(D,y){var F;if(!D||!y){var R=editor$1.selection.getCursor();F=R.row,y=R.column}F=D;var O=editor$1.session.getLine(F),U=getFieldAndSubtoken(O,y),K=U.field,B=U.subspine,G=global_cursor.HIGHLIGHTQUERY;global_cursor.HIGHLIGHTQUERY="",G||(G="L"+(F+1)+"F"+K,B>0&&(G+="S"+B));var q,W=document.getElementById("output").querySelectorAll("g[id$='"+G+"']");if(W.length!=0){for(var X=0;X<W.length;X++)if(W[X].className.baseVal.match(/qon/)){q=W[X];break}return q||(q=W[W.length-1]),q.id.match(/^accid/)&&(q=W[W.length-2]),markItem(q),q}}let vrvWorker=getVrvWorker();if(!vrvWorker)throw new Error("Verovio worker is undefined");function displayNotation(D,y,F){if(!vrvWorker.initialized||global_interface.FreezeRendering&&!y)return;let R=getTextFromEditor();if(!R)return;if(R.match(/^\s*$/)){console.log("Editor contents is empty (2)");return}let O=humdrumToSvgOptions();R.match(/CUT[[]/)&&(O.inputFrom="esac"),R.match(/Group memberships:/)&&(O.inputFrom="musedata"),setOptions(O),$("html").css("cursor","wait"),vrvWorker.renderData(O,R,D,y).then(function(U){let K=!0;(R.charAt(0)=="<"||R.match(/CUT[[]/)||R.match(/Group memberships:/))&&(K=!1);let B=document.querySelector("#output"),G=B.querySelectorAll("svg");G.length>0&&G.forEach(W=>{W.classList.contains("bi")||W.remove()});let q=document.createElement("svg");return B.appendChild(q),q.outerHTML=U,K&&(F?restoreSelectedSvgElement(F):global_cursor.RestoreCursorNote&&restoreSelectedSvgElement(global_cursor.RestoreCursorNote),displayFileTitle(R),y||document.querySelector("body").classList.remove("invalid")),verovioCallback(),!0}).catch(function(U){return document.querySelector("body").classList.add("invalid"),console.log(">>>>>>>>>> ERROR LOG:",U),!1}).finally(function(){let U=document.querySelector("#index");U.style.visibility="invisibile",U.style.display="none",global_interface.UndoHide&&(showInputArea(!0),global_interface.UndoHide=!1),global_interface.ApplyZoom&&(applyZoom(),global_interface.ApplyZoom=!1),global_interface.ApplyZoom&&(applyZoom(),global_interface.ApplyZoom=!1),global_interface.ShowingIndex=!1,$("html").css("cursor","auto")})}window.displayNotation=displayNotation;function toggleFreeze(){global_interface.FreezeRendering=!global_interface.FreezeRendering,document.querySelector("body").classList.toggle("frozen"),global_interface.FreezeRendering||displayNotation();let D=document.querySelector("#text-freeze-icon"),y="";D&&(global_interface.FreezeRendering?y="<div title='Unfreeze notation (alt-f)' class='nav-icon fas fa-lock'></div>":y="<div title='Freeze notation (alt-f)' class='nav-icon fas fa-unlock'></div>",D.innerHTML=y)}const editor=getAceEditor();if(!editor)throw new Error("Ace Editor is undefined");function updateColumnLayout(D,y,F=!0){F?(D.classList.remove("col-4"),D.classList.add("col-0"),y.classList.remove("col-8"),y.classList.add("col-12")):(D.classList.remove("col-0"),D.classList.add("col-4"),y.classList.remove("col-12"),y.classList.add("col-8"))}function toggleTextVisibility(D){let y=document.querySelector("#input");const F=document.querySelector(".output-with-comments");global_interface.InputVisible?(global_interface.LastInputWidth==0&&(global_interface.LastInputWidth=400),updateColumnLayout(y,F,!0)):(global_interface.LastInputWidth=parseInt(y.style.width),updateColumnLayout(y,F,!1)),global_interface.InputVisible=!global_interface.InputVisible,editor.resize(),displayNotation()}window.toggleTextVisibility=toggleTextVisibility;function redrawInputArea(D){let y=document.querySelector("#input");global_interface.InputVisible?(global_interface.LastInputWidth==0&&(global_interface.LastInputWidth=400),splitter.setPositionX(global_interface.LastInputWidth)):(global_interface.LastInputWidth=parseInt(y.style.width),splitter.setPositionX(0)),D||applyZoom(),editor.resize()}function showInputArea(D){global_interface.InputVisible=!0,splitter.setPositionX(global_interface.LastInputWidth),D||applyZoom(),editor.resize()}let erasedWorkNavigator="",erasedFileInfo={};function restoreWorkNavigator(D){if(D||(D="#work-navigator"),erasedWorkNavigator.match(/^\s*$/))return;setFileInfo(erasedFileInfo);let y=document.querySelector(D);y.innerHTML=erasedWorkNavigator,erasedWorkNavigator=""}function removeWorkNavigator(D){D||(D="#work-navigator");let y=document.querySelector(D);erasedWorkNavigator=y.innerHTML,erasedFileInfo=FILEINFO,y.innerHTML=""}function displayWorkNavigation(D){D||(D="#work-navigator");let y="";const F=document.querySelector(D);if(!F){console.log("Error: cannot find work navigator");return}FILEINFO["previous-work"]&&(y+=`<span style="cursor:pointer" onclick="displayWork('`,y+=FILEINFO["previous-work"],y+=`');"`,y+=" title='previous work/movement (&#8679;+&#8592;)'",y+=">",y+="<span class='nav-icon fas fa-arrow-circle-left'></span>",y+="</span>"),FILEINFO["previous-work"]&&FILEINFO["next-work"]&&FILEINFO["has-index"]=="true"&&(y+="&nbsp;"),FILEINFO["has-index"]=="true"&&(y+=`<span style="cursor:pointer" onclick="displayIndex('`,y+=FILEINFO.location,y+=`');"`,y+=" title='repertory index (&#8679;+&#8593;)'",y+=">",y+="<span class='nav-icon fas fa-arrow-circle-up'></span>",y+="</span>"),FILEINFO["previous-work"]&&FILEINFO["next-work"]&&FILEINFO["has-index"]=="true"&&(y+="&nbsp;"),FILEINFO["previous-work"]&&FILEINFO["next-work"]&&FILEINFO["has-index"]!="true"&&(y+="&nbsp;"),FILEINFO["next-work"]&&(y+=`<span style="cursor:pointer" onclick="displayWork('`,y+=FILEINFO["next-work"],y+=`');"`,y+=" title='next work/movement (&#8679;+&#8594;)'",y+=">",y+="<span class='nav-icon fas fa-arrow-circle-right'></span>",y+="</span>"),FILEINFO.file&&(y+='<span style="padding-left:3px; cursor:pointer" onclick="displayKeyscape();"',y+=" title='Keyscape'",y+=">",y+="<span class='nav-icon fa fa-key'></span>",y+="</span>"),FILEINFO["has-index"]=="true"&&(y+=`<span style="padding-left:3px; cursor:pointer" onclick="copyRepertoryUrl('`,y+=FILEINFO.location,y+="/",y+=FILEINFO.file,y+=`')"`,y+=" title='copy link for work'",y+=">",y+="<span class='nav-icon fas fa-link'></span>",y+="</span>"),(FILEINFO["previous-work"]||FILEINFO["next-work"])&&(y+="&nbsp;&nbsp;"),F.innerHTML=y}function displayFileTitle(D){let y=getReferenceRecords(D);D.split(/\r?\n/);let F="",R="",O;y.title&&!y.title.match(/^\s*$/)?F=y.title:y.OTL&&!y.OTL.match(/^\s*$/)&&(F=y.OTL),y.COM&&!y.COM.match(/^\s*$/)&&((O=y.COM.match(/^\s*([^,]+),/))?R=O[1]:R=y.COM),F=F.replace(/-sharp/g,"&#9839;"),F=F.replace(/-flat/g,"&#9837;");let U;U=document.querySelector("#title"),U&&(U.innerHTML=F),U=document.querySelector("#composer");let K="";U&&!R.match(/^\s*$/)&&(K+=R+", "),U.innerHTML=K,sessionStorage.setItem("score-metadata",JSON.stringify({title:F,composer:R})),displayWorkNavigation("#work-navigator")}async function displayWork(D){!D||(console.log(D),moveToTopOfNotation(),vrvWorker.page=1,$("html").css("cursor","wait"),loadKernScoresFile({file:D,previous:!0,next:!0}))}window.displayWork=displayWork;function replaceEditorContentWithHumdrumFile(D,y){if(D||(D=getTextFromEditor()),!D){console.log("No content to convert to Humdrum");return}vrvWorker.page=1,y=y||vrvWorker.page;let F=null;if(getMode(D),D.slice(0,1e3).match(/<score-partwise/))F=musicxmlToHumdrumOptions();else if(D.slice(0,2e3).match(/Group memberships:/))F=musedataToHumdrumOptions();else if(D.slice(0,1e3).match(/<mei/))F=meiToHumdrumOptions();else if(D.slice(0,1e3).match(/CUT[[]/))F=esacToHumdrumOptions();else{alert("Cannot convert data to Humdrum");return}F&&(F.inputFrom=="musedata"||F.inputFrom=="musedata-hum"||F.inputFrom=="musicxml"||F.inputFrom=="musicxml-hum"?vrvWorker.filterData(F,D,"humdrum").then(showMei):vrvWorker.filterData(F,D,"humdrum").then(function(R){let O=global_interface.FreezeRendering;global_interface.FreezeRendering==!1&&(global_interface.FreezeRendering=!0),setTextInEditor(R),global_interface.FreezeRendering=O,displayNotation(y)}))}function applyZoom(){if(!document.querySelector("#output svg"))return;let y=humdrumToSvgOptions();setOptions(y),stop(),vrvWorker.HEIGHT=y.pageHeight,vrvWorker.WIDTH=y.pageWidth,vrvWorker.redoLayout(y,1,vrvWorker.page).then(function(){loadPage(vrvWorker.page)})}function loadPage(D){D=D||vrvWorker.page,$("#overlay").hide().css("cursor","auto"),$("#jump_text").val(D),vrvWorker.renderPage(D).then(function(y){$("#output").html(y),verovioCallback()})}function gotoPreviousPage(){vrvWorker.gotoPage(vrvWorker.page-1).then(function(){loadPage(vrvWorker.page)})}function gotoNextPage(){vrvWorker.gotoPage(vrvWorker.page+1).then(function(){loadPage(vrvWorker.page)})}function gotoLastPage(){vrvWorker.gotoPage(0).then(function(){loadPage(vrvWorker.page)})}function gotoFirstPage(){vrvWorker.gotoPage(1).then(function(){loadPage(vrvWorker.page)})}let bufferedHumdrumFile="";function showBufferedHumdrumData(){editorMode()=="musedata"?(setEditorMode("humdrum"),setEditorModeAndKeyboard(),displayHumdrum()):(setEditorMode("humdrum"),setEditorModeAndKeyboard(),bufferedHumdrumFile.match(/^\s*$/)||(displayScoreTextInEditor(bufferedHumdrumFile,vrvWorker.page),bufferedHumdrumFile=""))}function displayHumdrum(){let D=humdrumToSvgOptions();vrvWorker.filterData(D,getTextFromEditor(),"humdrum").then(showHumdrum)}function showHumdrum(D){editorMode()=="musedata"&&getTextFromEditor(),setTextInEditor(D)}function getTextFromEditor(){let D=editor.getValue();if(!D)return"";if(D=ensureTsv(D),D.length<5)return D;if(D.substring(0,100).match(/^[\nA-Za-z0-9/+=]+$/))try{D=atob(D),D=ensureTsv(D)}catch{}return D}function getTextFromEditorRaw(){return editor.getValue()}function getTextFromEditorNoCsvProcessing(){let D=editor.getValue();if(!D)return"";if(D.length<5)return D;if(D.substring(0,100).match(/^[\nA-Za-z0-9/+=]+$/))try{D=atob(D)}catch{}return D}function ensureTsv(D){let y=D.split(`
`),F=0,R=0;for(let O=0;O<y.length&&!(!y[O].match(/^!!/)&&(R++,y[O].match(/,/)&&F++,R>10));O++);return R&&R==F?convertDataToTsv(y):D}function setTextInEditor(D){console.log("setTextInEditor",{splash:D}),D?D.charAt(D.length-1)===`
`?(editor.setValue(D,-1),console.log("else if")):(editor.setValue(D,-1),console.log("else",{text:D})):editor.setValue(""),editor.getSession().selection.clearSelection()}function showMei(D){global_interface.ShowingIndex||(setEditorMode("xml"),setEditorModeAndKeyboard(),bufferedHumdrumFile.match(/^\s*$/)&&(bufferedHumdrumFile=getTextFromEditor()),displayScoreTextInEditor(D,vrvWorker.page))}function displayMeiNoType(){let D=humdrumToSvgOptions();D.humType=0;let y=getTextFromEditor();vrvWorker.filterData(D,y,"mei").then(function(F){showMei(F)})}function displayMei(){vrvWorker.getMEI().then(function(D){showMei(D)})}function displayPdf(){if(editorMode()==="humdrum"&&displayHumdrumPdf(),!FILEINFO["has-pdf"]||FILEINFO["has-pdf"]!="true")return;let D="https://kern.humdrum.org/data?l="+FILEINFO.location;D+="&file="+FILEINFO.file,D+="&format=pdf&#view=FitH",openPdfAtBottomThirdOfScreen(D)}function displayHumdrumPdf(){let D=getPdfUrlList(),y="",F;if(InterfaceSingleNumber>1){for(F=0;F<D.length;F++)if(D[F].number==InterfaceSingleNumber){y=D[F].url;break}}else for(F=0;F<D.length;F++)if(D[F].number<=1){y=D[F].url;break}return y?(openPdfAtBottomThirdOfScreen(y),1):0}function getPdfUrlList(){if(editorMode()!=="humdrum")return 0;let D=getTextFromEditor();if(!D)return[];let y=D.split(/\r?\n/),F={},R=[],O;O="^!!!URL(\\d*)-pdf:\\s*((?:ftp|https?)://[^\\s]+)",O+="\\s+(.*)\\s*$";let U=new RegExp(O),K;for(K=0;K<y.length;K++){let B=y[K],G=B.match(U);if(G){let q={};G[1]?q.number=parseInt(G[1]):q.number=-1,q.url=G[2],q.title=G[3],R.push(q)}if(G=B.match(/^!!!([^:]+)\s*:\s*(.*)\s*$/),G){let q={};q.key=G[1],q.value=G[2],F[q.key]||(F[q.key]=[]),F[q.key].push(q)}}for(let B=0;B<R.length;B++)R[B].title=templateExpansion(R[B].title,F);return R}function templateExpansion(D,y){let F=D.match(/@{(.*?)}/);if(!F)return D;let R=getReferenceValue(F[1],y),O=new RegExp("@{"+F[1]+"}","g");for(D=D.replace(O,R),F=D.match(/@{(.*?)}/);F;)R=getReferenceValue(F[1],y),O=new RegExp("@{"+F[1]+"}","g"),D=D.replace(O,R),F=D.match(/@{(.*?)}/);return D}function getReferenceValue(D,y){let F=y[D];return F?F[0].value:""}function openPdfAtBottomThirdOfScreen(D,y){if(!D)return;console.log("Loading URL",D);let F="left=0";F+=",top="+parseInt(screen.height*2/3),F+=",width="+screen.width,F+=",height="+parseInt(screen.height/3),F+=",resizeable",F+=",scrollbars",F+=",location=false";let R=window.open(D,"",F);y||window.focus&&R.focus()}function reloadData(){for(let D in sessionStorage)sessionStorage.hasOwnProperty(D)&&/^basket-/.test(D)&&(console.log("DELETING",D),delete sessionStorage[D])}function monitorNotationUpdating(){updateEditorMode(),displayNotation()}function dataIntoView(D){editorMode()=="xml"?xmlDataIntoView(D):humdrumDataIntoView(D)}function xmlDataIntoView(D){let y=D.target;y.id;let F,R;for(;y;){if(!y.id){y=y.parentNode;continue}let O=y.id;if(!O){y=y.parentNode;continue}if(!O.match(/-L\d+F\d+/)){R='xml:id="'+y.id+'"',F=new RegExp(R),editor.find(F,{wrap:!0,caseSensitive:!0,wholeWord:!0});break}R='xml:id="'+y.id+'"',F=new RegExp(R),editor.find(F,{wrap:!0,caseSensitive:!0,wholeWord:!0});break}}function humdrumDataIntoView(D){let y;typeof D=="string"?y=document.querySelector("#"+D):y=D.target;let F;for(;y;){if(!y.id){y=y.parentNode;continue}if(F=y.id.match(/-[^-]*L(\d+)F(\d+)/),!F){y=y.parentNode;continue}if(y.id.match(/^harm-L(\d+)F(\d+)/)){let R=parseInt(F[1],10),O=parseInt(F[2],10);if(Number.isInteger(R)&&Number.isInteger(O)){let U=getEditorContents(R,O);document.getElementById("chord-editor").value=U}}global_cursor.HIGHLIGHTQUERY=y.id,highlightIdInEditor(y.id);break}}function displayScoreTextInEditor(D,y){let F=getMode(D);F!=editorMode()&&(setEditorMode(F),setEditorModeAndKeyboard()),setTextInEditor(D),displayNotation(y)}function toggleHumdrumCsvTsv(){if(console.log("converting from CSV TO TSV"),editorMode()=="xml")return;let y=getTextFromEditorNoCsvProcessing().split(`
`);for(let F=0;F<y.length;F++)if(y[F].match(/^\*\*/)){y[F].match(/,/)?(console.log("CONVERTING TO TSV"),setTextInEditor(convertDataToTsv(y))):(console.log("CONVERTING TO CSV"),setTextInEditor(convertDataToCsv(y)));break}}function decreaseTab(){global_editorOptions.TABSIZE--,global_editorOptions.TABSIZE<1&&(global_editorOptions.TABSIZE=1),editor.getSession().setTabSize(global_editorOptions.TABSIZE)}function increaseTab(){global_editorOptions.TABSIZE++,global_editorOptions.TABSIZE>100&&(global_editorOptions.TABSIZE=100),editor.getSession().setTabSize(global_editorOptions.TABSIZE)}let erasedData="";function clearContent(){let D=getTextFromEditorNoCsvProcessing();if(moveToTopOfNotation(),D.match(/^\s*$/))setTextInEditor(erasedData),displayFileTitle(erasedData),restoreWorkNavigator();else{erasedData=D,setTextInEditor("");let y=document.querySelector("#output");y&&(y.innerHTML=""),displayFileTitle(""),removeWorkNavigator()}editor.focus()}function playCurrentMidi(D){if(!(D!=null&&D.id)){play_midi();return}vrvWorker.getTimeForElement(D.id).then(function(y){play_midi(y)})}function setCursorNote(D,y){global_cursor.CursorNote=D,getMenu().showCursorNoteMenu(global_cursor.CursorNote)}function hideRepertoryIndex(){let D=document.querySelector("#index");if(D&&D.style.display!="none"){D.style.display="none";let y=document.querySelector("#output");y&&(console.log("FOCUSING ON OUTPUT"),y.focus()),global_interface.ShowingIndex=0}}function updateEditorMode(){if(!editor)return;let D=getTextFromEditorRaw();if(!D)return;let y=D.substring(0,2e3),F=getMode(y);F!==editorMode()&&(setEditorMode(F),setEditorModeAndKeyboard(),console.log("Changing to",F,"mode."))}function moveToTopOfNotation(){global_verovioOptions.GOTOTOPOFNOTATION=!0}function cleanFont(D){let y=0;return D.match(/bravura/i)?(D="Bravura",y=1):D.match(/goo?tvil?e?/i)?(D="Gootville",y=1):D.match(/leipzig/i)?(D="Leipzig",y=1):D.match(/leland/i)?(D="Leland",y=1):D.match(/petaluma/i)&&(D="Petaluma",y=1),y||(D="Leland"),D}var DROPAREA="";function setupDropArea(D){D||(D="#dropArea");var y=document.querySelector(D);DROPAREA=y,window.addEventListener("dragenter",function(F){showDropArea()}),y.addEventListener("dragenter",allowDrag),y.addEventListener("dragover",allowDrag),y.addEventListener("dragleave",function(F){hideDropArea()}),y.addEventListener("drop",handleDrop)}function showDropArea(D){D||(D=DROPAREA),D.style.visibility="visible"}function hideDropArea(D){D||(D=DROPAREA),D.style.visibility="hidden"}function allowDrag(D){D.dataTransfer.dropEffect="copy",D.preventDefault()}function handleDrop(D){D.preventDefault(),$("html").css("cursor","wait"),hideDropArea();for(var y,F=D.dataTransfer.files,R=0;R<F.length;R++){y=F[R];var O=new FileReader;O.readAsText(y,"UTF-8");var U=D;O.onload=function(K){var B=O.result;U.shiftKey?replaceEditorContentWithHumdrumFile(B):getAceEditor().setValue(B,-1),$("html").css("cursor","auto")};break}}class ClassWatcher{constructor(y,F,R,O){ae(this,"mutationCallback",y=>{for(let F of y)if(F.type==="attributes"&&F.attributeName==="class"){let R=F.target.classList.contains(this.classToWatch);this.lastClassState!==R&&(this.lastClassState=R,R?this.classAddedCallback():this.classRemovedCallback())}});this.targetNode=y,this.classToWatch=F,this.classAddedCallback=R,this.classRemovedCallback=O,this.observer=null,this.lastClassState=y.classList.contains(this.classToWatch),this.init()}init(){this.observer=new MutationObserver(this.mutationCallback),this.observe()}observe(){this.observer.observe(this.targetNode,{attributes:!0})}disconnect(){this.observer.disconnect()}}const menu=getMenu();document.querySelector("#load-from-repository__submenu-item").addEventListener("click",()=>menu.loadFromRepository());document.querySelector("#export-to-my-private-files__submenu-item").addEventListener("click",()=>menu.exportToPrivateFiles());document.querySelector("#open__submenu-item").addEventListener("click",()=>menu.openScoreFileFromDisk());document.querySelector("#save-editor-contents__submenu-item").addEventListener("click",()=>menu.saveTextEditorContents());document.querySelector("#save-as-midi__submenu-item").addEventListener("click",()=>menu.saveAsMIDI());document.querySelector("#save-as-pdf__submenu-item").addEventListener("click",()=>menu.createPdf());document.querySelector("#save-view-as-pdf__submenu-item").addEventListener("click",()=>menu.createPdfPage());document.querySelector("#save-view-as-svg__submenu-item").addEventListener("click",()=>menu.saveSvgData());document.querySelector("#save-as-musicxml__submenu-item").addEventListener("click",()=>menu.convertToMusicXmlAndSave());document.querySelector("#display-mei-data__submenu-item").addEventListener("click",()=>menu.displayMeiData());document.querySelector("#display-humdrum-data__submenu-item").addEventListener("click",()=>menu.displayHumdrumData());document.querySelector("#save-to-buffer-1__submenu-item").addEventListener("click",()=>menu.saveToBuffer(1));document.querySelector("#save-to-buffer-2__submenu-item").addEventListener("click",()=>menu.saveToBuffer(2));document.querySelector("#save-to-buffer-3__submenu-item").addEventListener("click",()=>menu.saveToBuffer(3));document.querySelector("#save-to-buffer-4__submenu-item").addEventListener("click",()=>menu.saveToBuffer(4));document.querySelector("#save-to-buffer-5__submenu-item").addEventListener("click",()=>menu.saveToBuffer(5));document.querySelector("#save-to-buffer-6__submenu-item").addEventListener("click",()=>menu.saveToBuffer(6));document.querySelector("#save-to-buffer-7__submenu-item").addEventListener("click",()=>menu.saveToBuffer(7));document.querySelector("#save-to-buffer-8__submenu-item").addEventListener("click",()=>menu.saveToBuffer(8));document.querySelector("#save-to-buffer-9__submenu-item").addEventListener("click",()=>menu.saveToBuffer(9));document.querySelector("#load-from-buffer-1__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(1));document.querySelector("#load-from-buffer-2__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(2));document.querySelector("#load-from-buffer-3__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(3));document.querySelector("#load-from-buffer-4__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(4));document.querySelector("#load-from-buffer-5__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(5));document.querySelector("#load-from-buffer-6__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(6));document.querySelector("#load-from-buffer-7__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(7));document.querySelector("#load-from-buffer-8__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(8));document.querySelector("#load-from-buffer-9__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(9));document.querySelector("#load-from-autosave-buffer__submenu-item").addEventListener("click",()=>menu.loadFromBuffer(0));document.querySelector("#reload-data-from-source__submenu-item").addEventListener("click",()=>menu.reloadFromSource());document.querySelector("#convert-to-humdrum__submenu-item").addEventListener("click",()=>menu.convertToHumdrum());document.querySelector("#toggle-csv-tsv__submenu-item").addEventListener("click",()=>menu.toggleCsvTsv());document.querySelector("#play-pause-midi-performance__submenu-item").addEventListener("click",()=>menu.toggleMidiPlayback());document.querySelector("#make-notation-larger__submenu-item").addEventListener("click",()=>menu.adjustNotationScale(event,1.05));document.querySelector("#make-notation-smaller__submenu-item").addEventListener("click",()=>menu.adjustNotationScale(event,.95));document.querySelector("#increase-horizontal-notation-spacing__submenu-item").addEventListener("click",()=>menu.increaseNotationSpacing());document.querySelector("#decrease-horizontal-notation-spacing__submenu-item").addEventListener("click",()=>menu.decreaseNotationSpacing());document.querySelector("#increase-vertical-staff-spacing__submenu-item").addEventListener("click",()=>menu.increaseStaffSpacing());document.querySelector("#decrease-vertical-staff-spacing__submenu-item").addEventListener("click",()=>menu.decreaseStaffSpacing());document.querySelector("#increase-vertical-system-spacing__submenu-item").addEventListener("click",()=>menu.increaseSystemSpacing());document.querySelector("#decrease-vertical-system-spacing__submenu-item").addEventListener("click",()=>menu.decreaseSystemSpacing());document.querySelector("#ignore-encoded-line-breaks__submenu-item").addEventListener("click",()=>menu.lineBreaksOff());document.querySelector("#display-with-encoded-line-breaks__submenu-item").addEventListener("click",()=>menu.lineBreaksOn());document.querySelector("#increase-text-size__submenu-item").addEventListener("click",()=>menu.increaseLyricSize());document.querySelector("#decrease-text-size__submenu-item").addEventListener("click",()=>menu.decreaseLyricSize());document.querySelector("#auto-tab-width__submenu-item").addEventListener("click",()=>menu.fitTabSizeToData());document.querySelector("#increase-tab-width__submenu-item").addEventListener("click",()=>menu.increaseTabSize());document.querySelector("#decrease-tab-width__submenu-item").addEventListener("click",()=>menu.decreaseTabSize());document.querySelector("#start-splitting--32-measure-splits-__submenu-item").addEventListener("click",()=>menu.startSplit(32));document.querySelector("#next-split__submenu-item").addEventListener("click",()=>menu.nextSplit(32));document.querySelector("#previous-split__submenu-item").addEventListener("click",()=>menu.previousSplit(32));document.querySelector("#remove-splits__submenu-item").addEventListener("click",()=>menu.removeSplits());document.querySelector("#bravura__submenu-item").addEventListener("click",()=>menu.useBravuraFont());document.querySelector("#gootville__submenu-item").addEventListener("click",()=>menu.useGootvilleFont());document.querySelector("#leipzig__submenu-item").addEventListener("click",()=>menu.useLeipzigFont());document.querySelector("#leland__submenu-item").addEventListener("click",()=>menu.useLelandFont());document.querySelector("#petaluma__submenu-item").addEventListener("click",()=>menu.usePetalumaFont());document.querySelector("#toggle-text-display__submenu-item").addEventListener("click",()=>menu.toggleDataDisplay());document.querySelector("#increase-font-size__submenu-item").addEventListener("click",()=>menu.increaseTextFontSize());document.querySelector("#decrease-font-size__submenu-item").addEventListener("click",()=>menu.decreaseTextFontSize());document.querySelector("#toggle-csv-tsv-humdrum-display__submenu-item").addEventListener("click",()=>menu.toggleCsvTsv());document.querySelector("#toggle-layer-highlighting__submenu-item").addEventListener("click",()=>menu.toggleLayerHighlighting());document.querySelector("#freeze-unfreeze-notation-rendering__submenu-item").addEventListener("click",()=>menu.toggleNotationFreezing());document.querySelector("#toggle-original-clefs__submenu-item").addEventListener("click",()=>menu.toggleOriginalClefs());document.querySelector("#clear-text-editor__submenu-item").addEventListener("click",()=>menu.clearEditorContents());document.querySelector("#undo-last-change__submenu-item").addEventListener("click",()=>menu.undo());document.querySelector("#compile-embedded-filters__submenu-item").addEventListener("click",()=>menu.compileEmbeddedFilters());document.querySelector("#remove-trailing-tabs__submenu-item").addEventListener("click",()=>menu.trimTabsInEditor());document.querySelector("#beam-by-meter__submenu-item").addEventListener("click",()=>menu.applyFilter("autobeam"));document.querySelector("#split-beams-by-lyrics__submenu-item").addEventListener("click",()=>menu.applyFilter("autobeam -l"));document.querySelector("#remove-beams__submenu-item").addEventListener("click",()=>menu.applyFilter("autobeam -r"));document.querySelector("#sort-chords-highest-note-first__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -d"));document.querySelector("#sort-chords-lowest-note-first__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -u"));document.querySelector("#extract-first-note-in-chord__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -f"));document.querySelector("#extract-last-note-in-chord__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -l"));document.querySelector("#highest-note-in-chord__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -d | chord -f"));document.querySelector("#lowest-note-in-chord__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -u | chord -f"));document.querySelector("#compress-chords__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -m"));document.querySelector("#expand-chords__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -M"));document.querySelector("#bass-melody-chord-notes--for-grand-staff-scores-__submenu-item").addEventListener("click",()=>menu.applyFilter("chord -u | chord -fs1 | chord -ls2"));document.querySelector("#insert-local-comment-line--above-cursor-__submenu-item").addEventListener("click",()=>menu.insertLocalCommentLine());document.querySelector("#insert-interpretation-line--above-cursor-__submenu-item").addEventListener("click",()=>menu.insertInterpretationCommentLine());document.querySelector("#insert-null-data-line--above-cursor-__submenu-item").addEventListener("click",()=>menu.insertNullDataLine());document.querySelector("#insert-barline--above-cursor-__submenu-item").addEventListener("click",()=>menu.insertBarline());document.querySelector("#remove-null-lines__submenu-item").addEventListener("click",()=>menu.applyFilter("rid -glid"));document.querySelector("#remove-null-data-lines__submenu-item").addEventListener("click",()=>menu.applyFilter("rid -d"));document.querySelector("#remove-null-interpretation-lines__submenu-item").addEventListener("click",()=>menu.applyFilter("rid -i"));document.querySelector("#remove-null-local-comment-lines__submenu-item").addEventListener("click",()=>menu.applyFilter("rid -l"));document.querySelector("#remove-accidentals-from-trills-and-ornaments__submenu-item").addEventListener("click",()=>menu.applyFilter("trillspell"));document.querySelector("#remove-non-kern-spines__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -i kern"));document.querySelector("#add-staff-above-system__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -s 1-$,0 | restfill -i blank"));document.querySelector("#add-staff-above-system-with-hidden-rests__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -s 1-$,0 | restfill -yi blank"));document.querySelector("#add-staff-below-system__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -s 0,1-$ | restfill -i blank"));document.querySelector("#add-staff-below-system-with-hidden-rests__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -s 0,1-$ | restfill -yi blank"));document.querySelector("#add-note-stem-directions__submenu-item").addEventListener("click",()=>menu.applyFilter("autostem"));document.querySelector("#remove-note-stem-directions__submenu-item").addEventListener("click",()=>menu.applyFilter("autostem -r"));document.querySelector("#add-lyric-verse-to-top-staff__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -s 1-$,0 -n text"));document.querySelector("#remove-lyric-text__submenu-item").addEventListener("click",()=>menu.applyFilter("extract -I text"));document.querySelector("#split-beams-by-lyrics__submenu-item").addEventListener("click",()=>menu.applyFilter("autobeam -l"));document.querySelector("#tonic-to-c__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k c"));document.querySelector("#tonic-to-c-sharp-__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k c#"));document.querySelector("#tonic-to-d-flat-__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k d-"));document.querySelector("#tonic-to-d__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k d"));document.querySelector("#tonic-to-e-flat-__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k e-"));document.querySelector("#tonic-to-e__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k e"));document.querySelector("#tonic-to-f__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k f"));document.querySelector("#tonic-to-f-sharp-__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k f#"));document.querySelector("#tonic-to-g__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k g"));document.querySelector("#tonic-to-a-flat-__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k a-"));document.querySelector("#tonic-to-a__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k a"));document.querySelector("#tonic-to-b-flat-__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k b-"));document.querySelector("#tonic-to-b__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -k b"));document.querySelector("#up-a-minor-second__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t m2"));document.querySelector("#up-a-major-second__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t M2"));document.querySelector("#up-a-minor-third__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t m3"));document.querySelector("#up-a-major-third__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t M3"));document.querySelector("#up-a-perfect-fourth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t P4"));document.querySelector("#up-an-augmented-fourth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t A4"));document.querySelector("#up-a-diminished-fifth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t d5"));document.querySelector("#up-a-perfect-fifth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t P5"));document.querySelector("#up-a-minor-sixth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t m6"));document.querySelector("#up-a-major-sixth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t M6"));document.querySelector("#up-a-minor-seventh__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t m7"));document.querySelector("#up-a-major-seventh__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t M7"));document.querySelector("#up-a-perfect-octave__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t P8"));document.querySelector("#down-a-minor-second__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -m2"));document.querySelector("#down-a-major-second__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -M2"));document.querySelector("#down-a-minor-third__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -m3"));document.querySelector("#down-a-major-third__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -M3"));document.querySelector("#down-a-perfect-fourth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -P4"));document.querySelector("#down-an-augmented-fourth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -A4"));document.querySelector("#down-an-diminished-fifth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -d5"));document.querySelector("#down-a-perfect-fifth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -P5"));document.querySelector("#down-a-minor-sixth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -m6"));document.querySelector("#down-a-major-sixth__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -M6"));document.querySelector("#down-a-minor-seventh__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -m7"));document.querySelector("#down-a-major-seventh__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -M7"));document.querySelector("#down-a-perfect-octave__submenu-item").addEventListener("click",()=>menu.applyFilter("transpose -t -P8"));document.querySelector("#tassoize__submenu-item").addEventListener("click",()=>menu.applyFilter("tassoize"));document.querySelector("#unfocus-beam__submenu-item").addEventListener("click",()=>menu.unfocusElement());document.querySelector("#force-beam-above__submenu-item").addEventListener("click",()=>menu.forceBeamAbove());document.querySelector("#force-beam-below__submenu-item").addEventListener("click",()=>menu.forceBeamBelow());document.querySelector("#clear-beam-direction__submenu-item").addEventListener("click",()=>menu.removeBeamOrientation());document.querySelector("#unfocus-note__submenu-item").addEventListener("click",()=>menu.unfocusElement());document.querySelector("#next-melodic-note__submenu-item").addEventListener("click",()=>menu.nextMelodicNote());document.querySelector("#previous-melodic-note__submenu-item").addEventListener("click",()=>menu.previousMelodicNote());document.querySelector("#next-harmonic-note__submenu-item").addEventListener("click",()=>menu.nextHarmonicNote());document.querySelector("#previous-harmonic-note__submenu-item").addEventListener("click",()=>menu.previousHarmonicNote());document.querySelector("#up-a-step__submenu-item").addEventListener("click",()=>menu.pitchUpStep(1));document.querySelector("#down-a-step__submenu-item").addEventListener("click",()=>menu.pitchDownStep(1));document.querySelector("#up-an-octave__submenu-item").addEventListener("click",()=>menu.pitchUpOctave(1));document.querySelector("#down-an-octave__submenu-item").addEventListener("click",()=>menu.pitchDownOctave(1));document.querySelector("#up-a-fifth__submenu-item").addEventListener("click",()=>menu.pitchUpStep(5));document.querySelector("#down-a-third__submenu-item").addEventListener("click",()=>menu.pitchDownStep(3));document.querySelector("#force-stem-above__submenu-item").addEventListener("click",()=>menu.forceNoteStemUp());document.querySelector("#force-stem-below__submenu-item").addEventListener("click",()=>menu.forceNoteStemUp());document.querySelector("#clear-stem-direction__submenu-item").addEventListener("click",()=>menu.removeStemDirection());document.querySelector("#toggle-natural-accidental__submenu-item").addEventListener("click",()=>menu.toggleNaturalAccidental());document.querySelector("#toggle-sharp-accidental__submenu-item").addEventListener("click",()=>menu.toggleSharpAccidental());document.querySelector("#toggle-flat-accidental__submenu-item").addEventListener("click",()=>menu.toggleFlatAccidental());document.querySelector("#toggle-forced-display-of-accidental__submenu-item").addEventListener("click",()=>menu.toggleForcedDisplay());document.querySelector("#toggle-editorial-accidental__submenu-item").addEventListener("click",()=>menu.toggleEditorialAccidental());document.querySelector("#toggle-staccato__submenu-item").addEventListener("click",()=>menu.toggleStaccato());document.querySelector("#toggle-staccatissimo__submenu-item").addEventListener("click",()=>menu.toggleStaccatissimo());document.querySelector("#toggle-tenuto__submenu-item").addEventListener("click",()=>menu.toggleTenuto());document.querySelector("#toggle-accent__submenu-item").addEventListener("click",()=>menu.toggleAccent());document.querySelector("#toggle-marcato__submenu-item").addEventListener("click",()=>menu.toggleMarcato());document.querySelector("#toggle-fermata__submenu-item").addEventListener("click",()=>menu.toggleFermata());document.querySelector("#toggle-arpeggio__submenu-item").addEventListener("click",()=>menu.toggleArpeggio());document.querySelector("#toggle-minor-trill__submenu-item").addEventListener("click",()=>menu.toggleMinorTrill());document.querySelector("#toggle-major-trill__submenu-item").addEventListener("click",()=>menu.toggleMajorTrill());document.querySelector("#toggle-minor-lower-mordent__submenu-item").addEventListener("click",()=>menu.toggleMinorLowerMordent());document.querySelector("#toggle-major-lower-mordent__submenu-item").addEventListener("click",()=>menu.toggleMajorLowerMordent());document.querySelector("#toggle-minor-upper-mordent__submenu-item").addEventListener("click",()=>menu.toggleMinorUpperMordent());document.querySelector("#toggle-major-upper-mordent__submenu-item").addEventListener("click",()=>menu.toggleMajorUpperMordent());document.querySelector("#add-slur-to-next-note__submenu-item").addEventListener("click",()=>menu.addSlur(1));document.querySelector("#break-beam-before-note__submenu-item").addEventListener("click",()=>menu.breakBeamBeforeNote());document.querySelector("#break-beam-after-note__submenu-item").addEventListener("click",()=>menu.breakBeamAfterNote());document.querySelector("#toggle-pedal-down-before-note__submenu-item").addEventListener("click",()=>menu.togglePedalDown());document.querySelector("#toggle-pedal-up-after-note__submenu-item").addEventListener("click",()=>menu.togglePedalUp());document.querySelector("#toggle-gracenote-style__submenu-item").addEventListener("click",()=>menu.toggleGraceNoteStyle());document.querySelector("#toggle---mark__submenu-item").addEventListener("click",()=>menu.toggleAtMark());document.querySelector("#unfocus-rest__submenu-item").addEventListener("click",()=>menu.unfocusElement());document.querySelector("#next-melodic-note__submenu-item").addEventListener("click",()=>menu.nextMelodicNote());document.querySelector("#previous-melodic-note__submenu-item").addEventListener("click",()=>menu.previousMelodicNote());document.querySelector("#next-harmonic-note__submenu-item").addEventListener("click",()=>menu.nextHarmonicNote());document.querySelector("#previous-harmonic-note__submenu-item").addEventListener("click",()=>menu.previousHarmonicNote());document.querySelector("#make-rest-invisible__submenu-item").addEventListener("click",()=>menu.makeRestInvisible());document.querySelector("#unfocus-slur__submenu-item").addEventListener("click",()=>menu.unfocusElement());document.querySelector("#force-slur-above__submenu-item").addEventListener("click",()=>menu.forceSlurAbove());document.querySelector("#force-slur-below__submenu-item").addEventListener("click",()=>menu.forceSlurBelow());document.querySelector("#clear-slur-direction__submenu-item").addEventListener("click",()=>menu.removeSlurOrientation());document.querySelector("#delete-slur__submenu-item").addEventListener("click",()=>menu.deleteSlur());document.querySelector("#move-slur-start-left__submenu-item").addEventListener("click",()=>menu.moveSlurStart(-1));document.querySelector("#move-slur-start-right__submenu-item").addEventListener("click",()=>menu.moveSlurStart(1));document.querySelector("#move-slur-end-left__submenu-item").addEventListener("click",()=>menu.moveSlurEnd(-1));document.querySelector("#move-slur-end-right__submenu-item").addEventListener("click",()=>menu.moveSlurEnd(1));document.querySelector("#move-slur-end-3-notes-right__submenu-item").addEventListener("click",()=>menu.moveSlurEnd(3));document.querySelector("#unfocus-slur__submenu-item").addEventListener("click",()=>menu.unfocusElement());document.querySelector("#force-tie-above__submenu-item").addEventListener("click",()=>menu.forceTieAbove());document.querySelector("#force-tie-below__submenu-item").addEventListener("click",()=>menu.forceTieBelow());document.querySelector("#clear-tie-direction__submenu-item").addEventListener("click",()=>menu.removeTieOrientation());document.querySelector("#bach-370-chorales__submenu-item").addEventListener("click",()=>menu.loadRepertory("chorales"));document.querySelector("#bach-wtc-fugues__submenu-item").addEventListener("click",()=>menu.loadRepertory("bach-wtc-fugues"));document.querySelector("#beethoven-piano-sonatas__submenu-item").addEventListener("click",()=>menu.loadRepertory("beethoven/sonatas"));document.querySelector("#beethoven-string-quartets__submenu-item").addEventListener("click",()=>menu.loadRepertory("beethoven/quartets"));document.querySelector("#chopin-first-editions__submenu-item").addEventListener("click",()=>menu.loadRepertory("chopin-first-editions"));document.querySelector("#chopin-mazurkas__submenu-item").addEventListener("click",()=>menu.loadRepertory("chopin/mazurkas"));document.querySelector("#haydn-keyboard-sonatas__submenu-item").addEventListener("click",()=>menu.loadRepertory("haydn/sonatas"));document.querySelector("#hummel-preludes--op--67__submenu-item").addEventListener("click",()=>menu.loadRepertory("hummel/preludes"));document.querySelector("#joplin__submenu-item").addEventListener("click",()=>menu.loadRepertory("joplin"));document.querySelector("#mozart-piano-sonatas__submenu-item").addEventListener("click",()=>menu.loadRepertory("mozart/sonatas"));document.querySelector("#mozart--100-contradances--k-sup-6--sup--anh--c30-01__submenu-item").addEventListener("click",()=>menu.loadRepertory("mozart/sonatas"));document.querySelector("#scarlatti-sonatas__submenu-item").addEventListener("click",()=>menu.loadRepertory("scarlatti/sonatas"));document.querySelector("#barbershop-quartets__submenu-item").addEventListener("click",()=>menu.loadRepertory("osu/barbershop"));document.querySelector("#barbershop-quartets--grand-staff-__submenu-item").addEventListener("click",()=>menu.loadRepertory("osu/barbershop",satb2gs));document.querySelector("#deutscher-liderschatz__submenu-item").addEventListener("click",()=>menu.loadRepertory("liederschatz1"));document.querySelector("#polyrhythm-project__submenu-item").addEventListener("click",()=>menu.loadRepertory("poly"));document.querySelectorAll("li.dropdown").forEach(D=>new ClassWatcher(D,"show",()=>{document.documentElement.style.setProperty("--collab-layer-zIndex",1)},()=>{document.documentElement.style.setProperty("--collab-layer-zIndex","1000")}));const main="",midiplayer="",collab="",chordPlayer="",all="",jitsi="";var GotoSelectionButton$1=document.getElementById("GotoSelectionButton"),wp_s_array,rec_time;let wavesurfer3;document.addEventListener("DOMContentLoaded",function(){});function setupWaveSurfer(){let D=document.querySelector("#PlayPause"),y=document.querySelector("#toggleMute"),F=document.querySelector("#Stop"),R=WaveSurfer.create({container:document.querySelector("#waveform"),waveColor:"#345",cursorWidth:1,progressColor:"#e81",plugins:[WaveSurfer.cursor.create({showTime:!0,opacity:1,customShowTimeStyle:{"background-color":"#345",color:"#0f5",padding:"2px","font-size":"10px"}})]});window.wavesurfer=R,R.on("error",function(O){console.warn(O)}),D.onclick=function(){R.playPause()},y.onclick=function(){R.toggleMute()},F.onclick=function(){R.stop()},GotoSelectionButton$1.onclick=function(){let O=new XMLHttpRequest,U="";O.onreadystatechange=function(){this.readyState==4&&this.status==200&&(U=O.responseText,console.log(U),wp_s_array=U.split(`
`).map(function(K){return K.split(" ")}),score_2_rec_time(wp_s_array,window.MEASURENO,window.TEMPO,window.BEATSPERMEASURE),R.setCurrentTime(rec_time))},O.open("get","https://musicolab.hmu.gr/vhv/wp_s_array.csv"),O.send()}}function score_2_rec_time(D,y,F,R){console.log("score_measure=",y),console.log("score_tempo=",F),console.log("score_beatspermeasure=",R);var O=(y-1)*R*60/F;console.log("score_time=",O);var U=0,K=0;for(wp_s_array[U][0]<=O&&(console.log("something went wrong, score_time should not be greater than wp_s_array[0][0]"),K=wp_s_array[U][1]);wp_s_array[U][0]>O;)K=D[U][1],++U;rec_time=K,console.log("rec_time=",rec_time)}window.setupWaveSurfer=setupWaveSurfer;function setupMicWaveSurfer(D){wavesurfer3=WaveSurfer.create({container:document.querySelector("#waveform3"),waveColor:"#999",progressColor:"#e81",cursorWidth:0,audioContext:D,plugins:[WaveSurfer.microphone.create({bufferSize:4096,numberOfInputChannels:1,numberOfOutputChannels:1,constraints:{audio:{echoCancellation:!1}}})]}),window.wavesurfer3=wavesurfer3,wavesurfer3.microphone.on("deviceReady",function(){console.info("Device ready!")}),wavesurfer3.microphone.on("deviceError",function(y){console.warn("Device error: "+y)}),wavesurfer3.on("error",function(y){console.warn(y)})}window.setupMicWaveSurfer=setupMicWaveSurfer;URL=window.URL||window.webkitURL;var gumStream,rec,input,AudioContext=window.AudioContext||window.webkitAudioContext,audioContext,recordButton=document.getElementById("recordButton"),stopButton=document.getElementById("stopButton"),pauseButton=document.getElementById("pauseButton"),download,syncronizeButton=document.getElementById("Synchronize");console.log("kalohr: adding event listener for the sync button");var fileUrl;const constraints={audio:{echoCancellation:!1}};var theblob;recordButton.addEventListener("click",startRecording);stopButton.addEventListener("click",stopRecording);pauseButton.addEventListener("click",pauseRecording);syncronizeButton.addEventListener("click",doSyncronize);document.getElementById("Download").addEventListener("click",handleFileDownload(),!1);async function doSyncronize(){console.log("rec2wav_2.js: doSynchronize: SYNCRONISE "),console.log(" - getting the song");let y=await getVrvWorker().renderToMidi(),F=new FormData;console.log(" - setting the action"),F.append("action","synchronization"),F.append("theUrl",fileUrl),console.log(" - appeding the audio/midi as BLOB");let R=new Blob([y],{type:"audio/midi"});console.log(R),F.append("themid",R),console.log(" - appeding the wav as FILE"),console.log(" -- recorder.js: ",rec),console.log(" -- theblob ",theblob);let O=theblob;F.append("theaudio",O);var U=new XMLHttpRequest;U.open("post","https://musicolab.hmu.gr/apprepository/synchroniseScoreAudioResp.php",!0),U.onreadystatechange=function(){U.readyState==4&&(GotoSelectionButton.disabled=!1,document.getElementById("syncImg").src="LABstill.png")},U.send(F),document.getElementById("syncImg").src="LAB.webp"}function startRecording(){console.log("recordButton clicked"),document.getElementById("rec_wave").removeAttribute("hidden"),document.getElementById("play_wave").setAttribute("hidden",!0),console.log("enable stopButton"),recordButton.disabled=!0,stopButton.disabled=!1,pauseButton.disabled=!1,PlayPause.disabled=!0,Stop.disabled=!0,toggleMute.disabled=!0,Synchronize.disabled=!0,Analyze.disabled=!0,GotoSelectionButton.disabled=!0,navigator.mediaDevices.getUserMedia(constraints).then(function(F){console.log("recorder.js: getUserMedia() success, stream created, initializing Recorder.js ..."),audioContext=new AudioContext,document.getElementById("formats").innerHTML="Format: 1 channel pcm @ "+audioContext.sampleRate/1e3+"kHz",gumStream=F,input=audioContext.createMediaStreamSource(F),window.wavesurfer||window.setupWaveSurfer(),window.wavesurfer3||window.setupMicWaveSurfer(audioContext),rec=new Recorder(input,{numChannels:1}),rec.record(),window.wavesurfer3.microphone.togglePlay(),console.log("Recording started")}).catch(function(F){recordButton.disabled=!1,stopButton.disabled=!0,pauseButton.disabled=!0,console.log("ERROR: recorder.js maybe? ")})}function pauseRecording(){console.log("pauseButton clicked rec.recording=",rec.recording),rec.recording?(rec.stop(),pauseButton.title="Resume Recording"):(rec.record(),pauseButton.title="Pause Recording")}function stopRecording(){console.log("stopButton clicked"),document.getElementById("rec_wave").setAttribute("hidden",!0),document.getElementById("play_wave").removeAttribute("hidden"),stopButton.disabled=!0,recordButton.disabled=!1,pauseButton.disabled=!0,PlayPause.disabled=!1,Stop.disabled=!1,toggleMute.disabled=!1,Synchronize.disabled=!1,Analyze.disabled=!1,Download.disabled=!1,pauseButton.title="Pause Recording",window.wavesurfer3.microphone.stop(),rec.stop(),gumStream.getAudioTracks()[0].stop(),rec.exportWAV(createDownloadLink),console.log("stop recording: pushing the env data in chunks")}function createDownloadLink(D){theblob=D;var y=URL.createObjectURL(D),F=document.createElement("audio"),R=document.createElement("li"),O=document.createElement("a"),U=new Date().toISOString();F.controls=!0,F.src=y,window.wavesurfer.load(F),O.href=y,O.download=U+".wav",O.innerHTML="Save to disk",download=O.download,fileUrl=y,console.log("create download link: download = ",download.toString()),console.log("create download link: fileUrl = ",fileUrl.toString()),R.appendChild(F),R.appendChild(document.createTextNode(U+".wav ")),R.appendChild(O);var K=document.createElement("a");K.href="#",K.innerHTML="Upload",K.addEventListener("click",function(B){var G=new XMLHttpRequest;G.onload=function(W){this.readyState===4&&console.log("Server returned: ",W.target.responseText)};var q=new FormData;q.append("audio_data",D,U),G.open("POST","upload.php",!0),G.send(q)})}function download_file(D,y){var F=document.createElement("a");F.setAttribute("href",y),F.setAttribute("download",D),document.body.appendChild(F),F.click()}function handleFileDownload(){return function(D){console.log("Download click handler",{download,fileUrl}),download_file(download,fileUrl)}}export{featureIsEnabled as f,getURLParams as g,yProvider as y};
//# sourceMappingURL=index.bf382b7a.js.map
